/*! jQuery v1.11.3 | (c) 2005, 2015 jQuery Foundation, Inc. | jquery.org/license */
!function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("jQuery requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){var c=[],d=c.slice,e=c.concat,f=c.push,g=c.indexOf,h={},i=h.toString,j=h.hasOwnProperty,k={},l="1.11.3",m=function(a,b){return new m.fn.init(a,b)},n=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,o=/^-ms-/,p=/-([\da-z])/gi,q=function(a,b){return b.toUpperCase()};m.fn=m.prototype={jquery:l,constructor:m,selector:"",length:0,toArray:function(){return d.call(this)},get:function(a){return null!=a?0>a?this[a+this.length]:this[a]:d.call(this)},pushStack:function(a){var b=m.merge(this.constructor(),a);return b.prevObject=this,b.context=this.context,b},each:function(a,b){return m.each(this,a,b)},map:function(a){return this.pushStack(m.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(d.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(0>a?b:0);return this.pushStack(c>=0&&b>c?[this[c]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:f,sort:c.sort,splice:c.splice},m.extend=m.fn.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;for("boolean"==typeof g&&(j=g,g=arguments[h]||{},h++),"object"==typeof g||m.isFunction(g)||(g={}),h===i&&(g=this,h--);i>h;h++)if(null!=(e=arguments[h]))for(d in e)a=g[d],c=e[d],g!==c&&(j&&c&&(m.isPlainObject(c)||(b=m.isArray(c)))?(b?(b=!1,f=a&&m.isArray(a)?a:[]):f=a&&m.isPlainObject(a)?a:{},g[d]=m.extend(j,f,c)):void 0!==c&&(g[d]=c));return g},m.extend({expando:"jQuery"+(l+Math.random()).replace(/\D/g,""),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return"function"===m.type(a)},isArray:Array.isArray||function(a){return"array"===m.type(a)},isWindow:function(a){return null!=a&&a==a.window},isNumeric:function(a){return!m.isArray(a)&&a-parseFloat(a)+1>=0},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},isPlainObject:function(a){var b;if(!a||"object"!==m.type(a)||a.nodeType||m.isWindow(a))return!1;try{if(a.constructor&&!j.call(a,"constructor")&&!j.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}if(k.ownLast)for(b in a)return j.call(a,b);for(b in a);return void 0===b||j.call(a,b)},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?h[i.call(a)]||"object":typeof a},globalEval:function(b){b&&m.trim(b)&&(a.execScript||function(b){a.eval.call(a,b)})(b)},camelCase:function(a){return a.replace(o,"ms-").replace(p,q)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b,c){var d,e=0,f=a.length,g=r(a);if(c){if(g){for(;f>e;e++)if(d=b.apply(a[e],c),d===!1)break}else for(e in a)if(d=b.apply(a[e],c),d===!1)break}else if(g){for(;f>e;e++)if(d=b.call(a[e],e,a[e]),d===!1)break}else for(e in a)if(d=b.call(a[e],e,a[e]),d===!1)break;return a},trim:function(a){return null==a?"":(a+"").replace(n,"")},makeArray:function(a,b){var c=b||[];return null!=a&&(r(Object(a))?m.merge(c,"string"==typeof a?[a]:a):f.call(c,a)),c},inArray:function(a,b,c){var d;if(b){if(g)return g.call(b,a,c);for(d=b.length,c=c?0>c?Math.max(0,d+c):c:0;d>c;c++)if(c in b&&b[c]===a)return c}return-1},merge:function(a,b){var c=+b.length,d=0,e=a.length;while(c>d)a[e++]=b[d++];if(c!==c)while(void 0!==b[d])a[e++]=b[d++];return a.length=e,a},grep:function(a,b,c){for(var d,e=[],f=0,g=a.length,h=!c;g>f;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return e},map:function(a,b,c){var d,f=0,g=a.length,h=r(a),i=[];if(h)for(;g>f;f++)d=b(a[f],f,c),null!=d&&i.push(d);else for(f in a)d=b(a[f],f,c),null!=d&&i.push(d);return e.apply([],i)},guid:1,proxy:function(a,b){var c,e,f;return"string"==typeof b&&(f=a[b],b=a,a=f),m.isFunction(a)?(c=d.call(arguments,2),e=function(){return a.apply(b||this,c.concat(d.call(arguments)))},e.guid=a.guid=a.guid||m.guid++,e):void 0},now:function(){return+new Date},support:k}),m.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(a,b){h["[object "+b+"]"]=b.toLowerCase()});function r(a){var b="length"in a&&a.length,c=m.type(a);return"function"===c||m.isWindow(a)?!1:1===a.nodeType&&b?!0:"array"===c||0===b||"number"==typeof b&&b>0&&b-1 in a}var s=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u="sizzle"+1*new Date,v=a.document,w=0,x=0,y=ha(),z=ha(),A=ha(),B=function(a,b){return a===b&&(l=!0),0},C=1<<31,D={}.hasOwnProperty,E=[],F=E.pop,G=E.push,H=E.push,I=E.slice,J=function(a,b){for(var c=0,d=a.length;d>c;c++)if(a[c]===b)return c;return-1},K="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",L="[\\x20\\t\\r\\n\\f]",M="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",N=M.replace("w","w#"),O="\\["+L+"*("+M+")(?:"+L+"*([*^$|!~]?=)"+L+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+N+"))|)"+L+"*\\]",P=":("+M+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+O+")*)|.*)\\)|)",Q=new RegExp(L+"+","g"),R=new RegExp("^"+L+"+|((?:^|[^\\\\])(?:\\\\.)*)"+L+"+$","g"),S=new RegExp("^"+L+"*,"+L+"*"),T=new RegExp("^"+L+"*([>+~]|"+L+")"+L+"*"),U=new RegExp("="+L+"*([^\\]'\"]*?)"+L+"*\\]","g"),V=new RegExp(P),W=new RegExp("^"+N+"$"),X={ID:new RegExp("^#("+M+")"),CLASS:new RegExp("^\\.("+M+")"),TAG:new RegExp("^("+M.replace("w","w*")+")"),ATTR:new RegExp("^"+O),PSEUDO:new RegExp("^"+P),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+L+"*(even|odd|(([+-]|)(\\d*)n|)"+L+"*(?:([+-]|)"+L+"*(\\d+)|))"+L+"*\\)|)","i"),bool:new RegExp("^(?:"+K+")$","i"),needsContext:new RegExp("^"+L+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+L+"*((?:-\\d)?\\d*)"+L+"*\\)|)(?=[^-]|$)","i")},Y=/^(?:input|select|textarea|button)$/i,Z=/^h\d$/i,$=/^[^{]+\{\s*\[native \w/,_=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,aa=/[+~]/,ba=/'|\\/g,ca=new RegExp("\\\\([\\da-f]{1,6}"+L+"?|("+L+")|.)","ig"),da=function(a,b,c){var d="0x"+b-65536;return d!==d||c?b:0>d?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)},ea=function(){m()};try{H.apply(E=I.call(v.childNodes),v.childNodes),E[v.childNodes.length].nodeType}catch(fa){H={apply:E.length?function(a,b){G.apply(a,I.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function ga(a,b,d,e){var f,h,j,k,l,o,r,s,w,x;if((b?b.ownerDocument||b:v)!==n&&m(b),b=b||n,d=d||[],k=b.nodeType,"string"!=typeof a||!a||1!==k&&9!==k&&11!==k)return d;if(!e&&p){if(11!==k&&(f=_.exec(a)))if(j=f[1]){if(9===k){if(h=b.getElementById(j),!h||!h.parentNode)return d;if(h.id===j)return d.push(h),d}else if(b.ownerDocument&&(h=b.ownerDocument.getElementById(j))&&t(b,h)&&h.id===j)return d.push(h),d}else{if(f[2])return H.apply(d,b.getElementsByTagName(a)),d;if((j=f[3])&&c.getElementsByClassName)return H.apply(d,b.getElementsByClassName(j)),d}if(c.qsa&&(!q||!q.test(a))){if(s=r=u,w=b,x=1!==k&&a,1===k&&"object"!==b.nodeName.toLowerCase()){o=g(a),(r=b.getAttribute("id"))?s=r.replace(ba,"\\$&"):b.setAttribute("id",s),s="[id='"+s+"'] ",l=o.length;while(l--)o[l]=s+ra(o[l]);w=aa.test(a)&&pa(b.parentNode)||b,x=o.join(",")}if(x)try{return H.apply(d,w.querySelectorAll(x)),d}catch(y){}finally{r||b.removeAttribute("id")}}}return i(a.replace(R,"$1"),b,d,e)}function ha(){var a=[];function b(c,e){return a.push(c+" ")>d.cacheLength&&delete b[a.shift()],b[c+" "]=e}return b}function ia(a){return a[u]=!0,a}function ja(a){var b=n.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function ka(a,b){var c=a.split("|"),e=a.length;while(e--)d.attrHandle[c[e]]=b}function la(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||C)-(~a.sourceIndex||C);if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function ma(a){return function(b){var c=b.nodeName.toLowerCase();return"input"===c&&b.type===a}}function na(a){return function(b){var c=b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}}function oa(a){return ia(function(b){return b=+b,ia(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function pa(a){return a&&"undefined"!=typeof a.getElementsByTagName&&a}c=ga.support={},f=ga.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?"HTML"!==b.nodeName:!1},m=ga.setDocument=function(a){var b,e,g=a?a.ownerDocument||a:v;return g!==n&&9===g.nodeType&&g.documentElement?(n=g,o=g.documentElement,e=g.defaultView,e&&e!==e.top&&(e.addEventListener?e.addEventListener("unload",ea,!1):e.attachEvent&&e.attachEvent("onunload",ea)),p=!f(g),c.attributes=ja(function(a){return a.className="i",!a.getAttribute("className")}),c.getElementsByTagName=ja(function(a){return a.appendChild(g.createComment("")),!a.getElementsByTagName("*").length}),c.getElementsByClassName=$.test(g.getElementsByClassName),c.getById=ja(function(a){return o.appendChild(a).id=u,!g.getElementsByName||!g.getElementsByName(u).length}),c.getById?(d.find.ID=function(a,b){if("undefined"!=typeof b.getElementById&&p){var c=b.getElementById(a);return c&&c.parentNode?[c]:[]}},d.filter.ID=function(a){var b=a.replace(ca,da);return function(a){return a.getAttribute("id")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(ca,da);return function(a){var c="undefined"!=typeof a.getAttributeNode&&a.getAttributeNode("id");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return"undefined"!=typeof b.getElementsByTagName?b.getElementsByTagName(a):c.qsa?b.querySelectorAll(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if("*"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){return p?b.getElementsByClassName(a):void 0},r=[],q=[],(c.qsa=$.test(g.querySelectorAll))&&(ja(function(a){o.appendChild(a).innerHTML="<a id='"+u+"'></a><select id='"+u+"-\f]' msallowcapture=''><option selected=''></option></select>",a.querySelectorAll("[msallowcapture^='']").length&&q.push("[*^$]="+L+"*(?:''|\"\")"),a.querySelectorAll("[selected]").length||q.push("\\["+L+"*(?:value|"+K+")"),a.querySelectorAll("[id~="+u+"-]").length||q.push("~="),a.querySelectorAll(":checked").length||q.push(":checked"),a.querySelectorAll("a#"+u+"+*").length||q.push(".#.+[+~]")}),ja(function(a){var b=g.createElement("input");b.setAttribute("type","hidden"),a.appendChild(b).setAttribute("name","D"),a.querySelectorAll("[name=d]").length&&q.push("name"+L+"*[*^$|!~]?="),a.querySelectorAll(":enabled").length||q.push(":enabled",":disabled"),a.querySelectorAll("*,:x"),q.push(",.*:")})),(c.matchesSelector=$.test(s=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.oMatchesSelector||o.msMatchesSelector))&&ja(function(a){c.disconnectedMatch=s.call(a,"div"),s.call(a,"[s!='']:x"),r.push("!=",P)}),q=q.length&&new RegExp(q.join("|")),r=r.length&&new RegExp(r.join("|")),b=$.test(o.compareDocumentPosition),t=b||$.test(o.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},B=b?function(a,b){if(a===b)return l=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===g||a.ownerDocument===v&&t(v,a)?-1:b===g||b.ownerDocument===v&&t(v,b)?1:k?J(k,a)-J(k,b):0:4&d?-1:1)}:function(a,b){if(a===b)return l=!0,0;var c,d=0,e=a.parentNode,f=b.parentNode,h=[a],i=[b];if(!e||!f)return a===g?-1:b===g?1:e?-1:f?1:k?J(k,a)-J(k,b):0;if(e===f)return la(a,b);c=a;while(c=c.parentNode)h.unshift(c);c=b;while(c=c.parentNode)i.unshift(c);while(h[d]===i[d])d++;return d?la(h[d],i[d]):h[d]===v?-1:i[d]===v?1:0},g):n},ga.matches=function(a,b){return ga(a,null,null,b)},ga.matchesSelector=function(a,b){if((a.ownerDocument||a)!==n&&m(a),b=b.replace(U,"='$1']"),!(!c.matchesSelector||!p||r&&r.test(b)||q&&q.test(b)))try{var d=s.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return ga(b,n,null,[a]).length>0},ga.contains=function(a,b){return(a.ownerDocument||a)!==n&&m(a),t(a,b)},ga.attr=function(a,b){(a.ownerDocument||a)!==n&&m(a);var e=d.attrHandle[b.toLowerCase()],f=e&&D.call(d.attrHandle,b.toLowerCase())?e(a,b,!p):void 0;return void 0!==f?f:c.attributes||!p?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},ga.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},ga.uniqueSort=function(a){var b,d=[],e=0,f=0;if(l=!c.detectDuplicates,k=!c.sortStable&&a.slice(0),a.sort(B),l){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return k=null,a},e=ga.getText=function(a){var b,c="",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=ga.selectors={cacheLength:50,createPseudo:ia,match:X,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(ca,da),a[3]=(a[3]||a[4]||a[5]||"").replace(ca,da),"~="===a[2]&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),"nth"===a[1].slice(0,3)?(a[3]||ga.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*("even"===a[3]||"odd"===a[3])),a[5]=+(a[7]+a[8]||"odd"===a[3])):a[3]&&ga.error(a[0]),a},PSEUDO:function(a){var b,c=!a[6]&&a[2];return X.CHILD.test(a[0])?null:(a[3]?a[2]=a[4]||a[5]||"":c&&V.test(c)&&(b=g(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(ca,da).toLowerCase();return"*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=y[a+" "];return b||(b=new RegExp("(^|"+L+")"+a+"("+L+"|$)"))&&y(a,function(a){return b.test("string"==typeof a.className&&a.className||"undefined"!=typeof a.getAttribute&&a.getAttribute("class")||"")})},ATTR:function(a,b,c){return function(d){var e=ga.attr(d,a);return null==e?"!="===b:b?(e+="","="===b?e===c:"!="===b?e!==c:"^="===b?c&&0===e.indexOf(c):"*="===b?c&&e.indexOf(c)>-1:"$="===b?c&&e.slice(-c.length)===c:"~="===b?(" "+e.replace(Q," ")+" ").indexOf(c)>-1:"|="===b?e===c||e.slice(0,c.length+1)===c+"-":!1):!0}},CHILD:function(a,b,c,d,e){var f="nth"!==a.slice(0,3),g="last"!==a.slice(-4),h="of-type"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?"nextSibling":"previousSibling",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),s=!i&&!h;if(q){if(f){while(p){l=b;while(l=l[p])if(h?l.nodeName.toLowerCase()===r:1===l.nodeType)return!1;o=p="only"===a&&!o&&"nextSibling"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&s){k=q[u]||(q[u]={}),j=k[a]||[],n=j[0]===w&&j[1],m=j[0]===w&&j[2],l=n&&q.childNodes[n];while(l=++n&&l&&l[p]||(m=n=0)||o.pop())if(1===l.nodeType&&++m&&l===b){k[a]=[w,n,m];break}}else if(s&&(j=(b[u]||(b[u]={}))[a])&&j[0]===w)m=j[1];else while(l=++n&&l&&l[p]||(m=n=0)||o.pop())if((h?l.nodeName.toLowerCase()===r:1===l.nodeType)&&++m&&(s&&((l[u]||(l[u]={}))[a]=[w,m]),l===b))break;return m-=e,m===d||m%d===0&&m/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||ga.error("unsupported pseudo: "+a);return e[u]?e(b):e.length>1?(c=[a,a,"",b],d.setFilters.hasOwnProperty(a.toLowerCase())?ia(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=J(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:ia(function(a){var b=[],c=[],d=h(a.replace(R,"$1"));return d[u]?ia(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),b[0]=null,!c.pop()}}),has:ia(function(a){return function(b){return ga(a,b).length>0}}),contains:ia(function(a){return a=a.replace(ca,da),function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:ia(function(a){return W.test(a||"")||ga.error("unsupported lang: "+a),a=a.replace(ca,da).toLowerCase(),function(b){var c;do if(c=p?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===o},focus:function(a){return a===n.activeElement&&(!n.hasFocus||n.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return Z.test(a.nodeName)},input:function(a){return Y.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&"text"===a.type&&(null==(b=a.getAttribute("type"))||"text"===b.toLowerCase())},first:oa(function(){return[0]}),last:oa(function(a,b){return[b-1]}),eq:oa(function(a,b,c){return[0>c?c+b:c]}),even:oa(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:oa(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:oa(function(a,b,c){for(var d=0>c?c+b:c;--d>=0;)a.push(d);return a}),gt:oa(function(a,b,c){for(var d=0>c?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=d.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=ma(b);for(b in{submit:!0,reset:!0})d.pseudos[b]=na(b);function qa(){}qa.prototype=d.filters=d.pseudos,d.setFilters=new qa,g=ga.tokenize=function(a,b){var c,e,f,g,h,i,j,k=z[a+" "];if(k)return b?0:k.slice(0);h=a,i=[],j=d.preFilter;while(h){(!c||(e=S.exec(h)))&&(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=T.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(R," ")}),h=h.slice(c.length));for(g in d.filter)!(e=X[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return b?h.length:h?ga.error(a):z(a,i).slice(0)};function ra(a){for(var b=0,c=a.length,d="";c>b;b++)d+=a[b].value;return d}function sa(a,b,c){var d=b.dir,e=c&&"parentNode"===d,f=x++;return b.first?function(b,c,f){while(b=b[d])if(1===b.nodeType||e)return a(b,c,f)}:function(b,c,g){var h,i,j=[w,f];if(g){while(b=b[d])if((1===b.nodeType||e)&&a(b,c,g))return!0}else while(b=b[d])if(1===b.nodeType||e){if(i=b[u]||(b[u]={}),(h=i[d])&&h[0]===w&&h[1]===f)return j[2]=h[2];if(i[d]=j,j[2]=a(b,c,g))return!0}}}function ta(a){return a.length>1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function ua(a,b,c){for(var d=0,e=b.length;e>d;d++)ga(a,b[d],c);return c}function va(a,b,c,d,e){for(var f,g=[],h=0,i=a.length,j=null!=b;i>h;h++)(f=a[h])&&(!c||c(f,d,e))&&(g.push(f),j&&b.push(h));return g}function wa(a,b,c,d,e,f){return d&&!d[u]&&(d=wa(d)),e&&!e[u]&&(e=wa(e,f)),ia(function(f,g,h,i){var j,k,l,m=[],n=[],o=g.length,p=f||ua(b||"*",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:va(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=va(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?J(f,l):m[k])>-1&&(f[j]=!(g[j]=l))}}else r=va(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):H.apply(g,r)})}function xa(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],h=g||d.relative[" "],i=g?1:0,k=sa(function(a){return a===b},h,!0),l=sa(function(a){return J(b,a)>-1},h,!0),m=[function(a,c,d){var e=!g&&(d||c!==j)||((b=c).nodeType?k(a,c,d):l(a,c,d));return b=null,e}];f>i;i++)if(c=d.relative[a[i].type])m=[sa(ta(m),c)];else{if(c=d.filter[a[i].type].apply(null,a[i].matches),c[u]){for(e=++i;f>e;e++)if(d.relative[a[e].type])break;return wa(i>1&&ta(m),i>1&&ra(a.slice(0,i-1).concat({value:" "===a[i-2].type?"*":""})).replace(R,"$1"),c,e>i&&xa(a.slice(i,e)),f>e&&xa(a=a.slice(e)),f>e&&ra(a))}m.push(c)}return ta(m)}function ya(a,b){var c=b.length>0,e=a.length>0,f=function(f,g,h,i,k){var l,m,o,p=0,q="0",r=f&&[],s=[],t=j,u=f||e&&d.find.TAG("*",k),v=w+=null==t?1:Math.random()||.1,x=u.length;for(k&&(j=g!==n&&g);q!==x&&null!=(l=u[q]);q++){if(e&&l){m=0;while(o=a[m++])if(o(l,g,h)){i.push(l);break}k&&(w=v)}c&&((l=!o&&l)&&p--,f&&r.push(l))}if(p+=q,c&&q!==p){m=0;while(o=b[m++])o(r,s,g,h);if(f){if(p>0)while(q--)r[q]||s[q]||(s[q]=F.call(i));s=va(s)}H.apply(i,s),k&&!f&&s.length>0&&p+b.length>1&&ga.uniqueSort(i)}return k&&(w=v,j=t),r};return c?ia(f):f}return h=ga.compile=function(a,b){var c,d=[],e=[],f=A[a+" "];if(!f){b||(b=g(a)),c=b.length;while(c--)f=xa(b[c]),f[u]?d.push(f):e.push(f);f=A(a,ya(e,d)),f.selector=a}return f},i=ga.select=function(a,b,e,f){var i,j,k,l,m,n="function"==typeof a&&a,o=!f&&g(a=n.selector||a);if(e=e||[],1===o.length){if(j=o[0]=o[0].slice(0),j.length>2&&"ID"===(k=j[0]).type&&c.getById&&9===b.nodeType&&p&&d.relative[j[1].type]){if(b=(d.find.ID(k.matches[0].replace(ca,da),b)||[])[0],!b)return e;n&&(b=b.parentNode),a=a.slice(j.shift().value.length)}i=X.needsContext.test(a)?0:j.length;while(i--){if(k=j[i],d.relative[l=k.type])break;if((m=d.find[l])&&(f=m(k.matches[0].replace(ca,da),aa.test(j[0].type)&&pa(b.parentNode)||b))){if(j.splice(i,1),a=f.length&&ra(j),!a)return H.apply(e,f),e;break}}}return(n||h(a,o))(f,b,!p,e,aa.test(a)&&pa(b.parentNode)||b),e},c.sortStable=u.split("").sort(B).join("")===u,c.detectDuplicates=!!l,m(),c.sortDetached=ja(function(a){return 1&a.compareDocumentPosition(n.createElement("div"))}),ja(function(a){return a.innerHTML="<a href='#'></a>","#"===a.firstChild.getAttribute("href")})||ka("type|href|height|width",function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)}),c.attributes&&ja(function(a){return a.innerHTML="<input/>",a.firstChild.setAttribute("value",""),""===a.firstChild.getAttribute("value")})||ka("value",function(a,b,c){return c||"input"!==a.nodeName.toLowerCase()?void 0:a.defaultValue}),ja(function(a){return null==a.getAttribute("disabled")})||ka(K,function(a,b,c){var d;return c?void 0:a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),ga}(a);m.find=s,m.expr=s.selectors,m.expr[":"]=m.expr.pseudos,m.unique=s.uniqueSort,m.text=s.getText,m.isXMLDoc=s.isXML,m.contains=s.contains;var t=m.expr.match.needsContext,u=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,v=/^.[^:#\[\.,]*$/;function w(a,b,c){if(m.isFunction(b))return m.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return m.grep(a,function(a){return a===b!==c});if("string"==typeof b){if(v.test(b))return m.filter(b,a,c);b=m.filter(b,a)}return m.grep(a,function(a){return m.inArray(a,b)>=0!==c})}m.filter=function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?m.find.matchesSelector(d,a)?[d]:[]:m.find.matches(a,m.grep(b,function(a){return 1===a.nodeType}))},m.fn.extend({find:function(a){var b,c=[],d=this,e=d.length;if("string"!=typeof a)return this.pushStack(m(a).filter(function(){for(b=0;e>b;b++)if(m.contains(d[b],this))return!0}));for(b=0;e>b;b++)m.find(a,d[b],c);return c=this.pushStack(e>1?m.unique(c):c),c.selector=this.selector?this.selector+" "+a:a,c},filter:function(a){return this.pushStack(w(this,a||[],!1))},not:function(a){return this.pushStack(w(this,a||[],!0))},is:function(a){return!!w(this,"string"==typeof a&&t.test(a)?m(a):a||[],!1).length}});var x,y=a.document,z=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,A=m.fn.init=function(a,b){var c,d;if(!a)return this;if("string"==typeof a){if(c="<"===a.charAt(0)&&">"===a.charAt(a.length-1)&&a.length>=3?[null,a,null]:z.exec(a),!c||!c[1]&&b)return!b||b.jquery?(b||x).find(a):this.constructor(b).find(a);if(c[1]){if(b=b instanceof m?b[0]:b,m.merge(this,m.parseHTML(c[1],b&&b.nodeType?b.ownerDocument||b:y,!0)),u.test(c[1])&&m.isPlainObject(b))for(c in b)m.isFunction(this[c])?this[c](b[c]):this.attr(c,b[c]);return this}if(d=y.getElementById(c[2]),d&&d.parentNode){if(d.id!==c[2])return x.find(a);this.length=1,this[0]=d}return this.context=y,this.selector=a,this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):m.isFunction(a)?"undefined"!=typeof x.ready?x.ready(a):a(m):(void 0!==a.selector&&(this.selector=a.selector,this.context=a.context),m.makeArray(a,this))};A.prototype=m.fn,x=m(y);var B=/^(?:parents|prev(?:Until|All))/,C={children:!0,contents:!0,next:!0,prev:!0};m.extend({dir:function(a,b,c){var d=[],e=a[b];while(e&&9!==e.nodeType&&(void 0===c||1!==e.nodeType||!m(e).is(c)))1===e.nodeType&&d.push(e),e=e[b];return d},sibling:function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c}}),m.fn.extend({has:function(a){var b,c=m(a,this),d=c.length;return this.filter(function(){for(b=0;d>b;b++)if(m.contains(this,c[b]))return!0})},closest:function(a,b){for(var c,d=0,e=this.length,f=[],g=t.test(a)||"string"!=typeof a?m(a,b||this.context):0;e>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&m.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?m.unique(f):f)},index:function(a){return a?"string"==typeof a?m.inArray(this[0],m(a)):m.inArray(a.jquery?a[0]:a,this):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(m.unique(m.merge(this.get(),m(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function D(a,b){do a=a[b];while(a&&1!==a.nodeType);return a}m.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return m.dir(a,"parentNode")},parentsUntil:function(a,b,c){return m.dir(a,"parentNode",c)},next:function(a){return D(a,"nextSibling")},prev:function(a){return D(a,"previousSibling")},nextAll:function(a){return m.dir(a,"nextSibling")},prevAll:function(a){return m.dir(a,"previousSibling")},nextUntil:function(a,b,c){return m.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return m.dir(a,"previousSibling",c)},siblings:function(a){return m.sibling((a.parentNode||{}).firstChild,a)},children:function(a){return m.sibling(a.firstChild)},contents:function(a){return m.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:m.merge([],a.childNodes)}},function(a,b){m.fn[a]=function(c,d){var e=m.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(e=m.filter(d,e)),this.length>1&&(C[a]||(e=m.unique(e)),B.test(a)&&(e=e.reverse())),this.pushStack(e)}});var E=/\S+/g,F={};function G(a){var b=F[a]={};return m.each(a.match(E)||[],function(a,c){b[c]=!0}),b}m.Callbacks=function(a){a="string"==typeof a?F[a]||G(a):m.extend({},a);var b,c,d,e,f,g,h=[],i=!a.once&&[],j=function(l){for(c=a.memory&&l,d=!0,f=g||0,g=0,e=h.length,b=!0;h&&e>f;f++)if(h[f].apply(l[0],l[1])===!1&&a.stopOnFalse){c=!1;break}b=!1,h&&(i?i.length&&j(i.shift()):c?h=[]:k.disable())},k={add:function(){if(h){var d=h.length;!function f(b){m.each(b,function(b,c){var d=m.type(c);"function"===d?a.unique&&k.has(c)||h.push(c):c&&c.length&&"string"!==d&&f(c)})}(arguments),b?e=h.length:c&&(g=d,j(c))}return this},remove:function(){return h&&m.each(arguments,function(a,c){var d;while((d=m.inArray(c,h,d))>-1)h.splice(d,1),b&&(e>=d&&e--,f>=d&&f--)}),this},has:function(a){return a?m.inArray(a,h)>-1:!(!h||!h.length)},empty:function(){return h=[],e=0,this},disable:function(){return h=i=c=void 0,this},disabled:function(){return!h},lock:function(){return i=void 0,c||k.disable(),this},locked:function(){return!i},fireWith:function(a,c){return!h||d&&!i||(c=c||[],c=[a,c.slice?c.slice():c],b?i.push(c):j(c)),this},fire:function(){return k.fireWith(this,arguments),this},fired:function(){return!!d}};return k},m.extend({Deferred:function(a){var b=[["resolve","done",m.Callbacks("once memory"),"resolved"],["reject","fail",m.Callbacks("once memory"),"rejected"],["notify","progress",m.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return m.Deferred(function(c){m.each(b,function(b,f){var g=m.isFunction(a[b])&&a[b];e[f[1]](function(){var a=g&&g.apply(this,arguments);a&&m.isFunction(a.promise)?a.promise().done(c.resolve).fail(c.reject).progress(c.notify):c[f[0]+"With"](this===d?c.promise():this,g?[a]:arguments)})}),a=null}).promise()},promise:function(a){return null!=a?m.extend(a,d):d}},e={};return d.pipe=d.then,m.each(b,function(a,f){var g=f[2],h=f[3];d[f[1]]=g.add,h&&g.add(function(){c=h},b[1^a][2].disable,b[2][2].lock),e[f[0]]=function(){return e[f[0]+"With"](this===e?d:this,arguments),this},e[f[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b=0,c=d.call(arguments),e=c.length,f=1!==e||a&&m.isFunction(a.promise)?e:0,g=1===f?a:m.Deferred(),h=function(a,b,c){return function(e){b[a]=this,c[a]=arguments.length>1?d.call(arguments):e,c===i?g.notifyWith(b,c):--f||g.resolveWith(b,c)}},i,j,k;if(e>1)for(i=new Array(e),j=new Array(e),k=new Array(e);e>b;b++)c[b]&&m.isFunction(c[b].promise)?c[b].promise().done(h(b,k,c)).fail(g.reject).progress(h(b,j,i)):--f;return f||g.resolveWith(k,c),g.promise()}});var H;m.fn.ready=function(a){return m.ready.promise().done(a),this},m.extend({isReady:!1,readyWait:1,holdReady:function(a){a?m.readyWait++:m.ready(!0)},ready:function(a){if(a===!0?!--m.readyWait:!m.isReady){if(!y.body)return setTimeout(m.ready);m.isReady=!0,a!==!0&&--m.readyWait>0||(H.resolveWith(y,[m]),m.fn.triggerHandler&&(m(y).triggerHandler("ready"),m(y).off("ready")))}}});function I(){y.addEventListener?(y.removeEventListener("DOMContentLoaded",J,!1),a.removeEventListener("load",J,!1)):(y.detachEvent("onreadystatechange",J),a.detachEvent("onload",J))}function J(){(y.addEventListener||"load"===event.type||"complete"===y.readyState)&&(I(),m.ready())}m.ready.promise=function(b){if(!H)if(H=m.Deferred(),"complete"===y.readyState)setTimeout(m.ready);else if(y.addEventListener)y.addEventListener("DOMContentLoaded",J,!1),a.addEventListener("load",J,!1);else{y.attachEvent("onreadystatechange",J),a.attachEvent("onload",J);var c=!1;try{c=null==a.frameElement&&y.documentElement}catch(d){}c&&c.doScroll&&!function e(){if(!m.isReady){try{c.doScroll("left")}catch(a){return setTimeout(e,50)}I(),m.ready()}}()}return H.promise(b)};var K="undefined",L;for(L in m(k))break;k.ownLast="0"!==L,k.inlineBlockNeedsLayout=!1,m(function(){var a,b,c,d;c=y.getElementsByTagName("body")[0],c&&c.style&&(b=y.createElement("div"),d=y.createElement("div"),d.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",c.appendChild(d).appendChild(b),typeof b.style.zoom!==K&&(b.style.cssText="display:inline;margin:0;border:0;padding:1px;width:1px;zoom:1",k.inlineBlockNeedsLayout=a=3===b.offsetWidth,a&&(c.style.zoom=1)),c.removeChild(d))}),function(){var a=y.createElement("div");if(null==k.deleteExpando){k.deleteExpando=!0;try{delete a.test}catch(b){k.deleteExpando=!1}}a=null}(),m.acceptData=function(a){var b=m.noData[(a.nodeName+" ").toLowerCase()],c=+a.nodeType||1;return 1!==c&&9!==c?!1:!b||b!==!0&&a.getAttribute("classid")===b};var M=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,N=/([A-Z])/g;function O(a,b,c){if(void 0===c&&1===a.nodeType){var d="data-"+b.replace(N,"-$1").toLowerCase();if(c=a.getAttribute(d),"string"==typeof c){try{c="true"===c?!0:"false"===c?!1:"null"===c?null:+c+""===c?+c:M.test(c)?m.parseJSON(c):c}catch(e){}m.data(a,b,c)}else c=void 0}return c}function P(a){var b;for(b in a)if(("data"!==b||!m.isEmptyObject(a[b]))&&"toJSON"!==b)return!1;

return!0}function Q(a,b,d,e){if(m.acceptData(a)){var f,g,h=m.expando,i=a.nodeType,j=i?m.cache:a,k=i?a[h]:a[h]&&h;if(k&&j[k]&&(e||j[k].data)||void 0!==d||"string"!=typeof b)return k||(k=i?a[h]=c.pop()||m.guid++:h),j[k]||(j[k]=i?{}:{toJSON:m.noop}),("object"==typeof b||"function"==typeof b)&&(e?j[k]=m.extend(j[k],b):j[k].data=m.extend(j[k].data,b)),g=j[k],e||(g.data||(g.data={}),g=g.data),void 0!==d&&(g[m.camelCase(b)]=d),"string"==typeof b?(f=g[b],null==f&&(f=g[m.camelCase(b)])):f=g,f}}function R(a,b,c){if(m.acceptData(a)){var d,e,f=a.nodeType,g=f?m.cache:a,h=f?a[m.expando]:m.expando;if(g[h]){if(b&&(d=c?g[h]:g[h].data)){m.isArray(b)?b=b.concat(m.map(b,m.camelCase)):b in d?b=[b]:(b=m.camelCase(b),b=b in d?[b]:b.split(" ")),e=b.length;while(e--)delete d[b[e]];if(c?!P(d):!m.isEmptyObject(d))return}(c||(delete g[h].data,P(g[h])))&&(f?m.cleanData([a],!0):k.deleteExpando||g!=g.window?delete g[h]:g[h]=null)}}}m.extend({cache:{},noData:{"applet ":!0,"embed ":!0,"object ":"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"},hasData:function(a){return a=a.nodeType?m.cache[a[m.expando]]:a[m.expando],!!a&&!P(a)},data:function(a,b,c){return Q(a,b,c)},removeData:function(a,b){return R(a,b)},_data:function(a,b,c){return Q(a,b,c,!0)},_removeData:function(a,b){return R(a,b,!0)}}),m.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=m.data(f),1===f.nodeType&&!m._data(f,"parsedAttrs"))){c=g.length;while(c--)g[c]&&(d=g[c].name,0===d.indexOf("data-")&&(d=m.camelCase(d.slice(5)),O(f,d,e[d])));m._data(f,"parsedAttrs",!0)}return e}return"object"==typeof a?this.each(function(){m.data(this,a)}):arguments.length>1?this.each(function(){m.data(this,a,b)}):f?O(f,a,m.data(f,a)):void 0},removeData:function(a){return this.each(function(){m.removeData(this,a)})}}),m.extend({queue:function(a,b,c){var d;return a?(b=(b||"fx")+"queue",d=m._data(a,b),c&&(!d||m.isArray(c)?d=m._data(a,b,m.makeArray(c)):d.push(c)),d||[]):void 0},dequeue:function(a,b){b=b||"fx";var c=m.queue(a,b),d=c.length,e=c.shift(),f=m._queueHooks(a,b),g=function(){m.dequeue(a,b)};"inprogress"===e&&(e=c.shift(),d--),e&&("fx"===b&&c.unshift("inprogress"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return m._data(a,c)||m._data(a,c,{empty:m.Callbacks("once memory").add(function(){m._removeData(a,b+"queue"),m._removeData(a,c)})})}}),m.fn.extend({queue:function(a,b){var c=2;return"string"!=typeof a&&(b=a,a="fx",c--),arguments.length<c?m.queue(this[0],a):void 0===b?this:this.each(function(){var c=m.queue(this,a,b);m._queueHooks(this,a),"fx"===a&&"inprogress"!==c[0]&&m.dequeue(this,a)})},dequeue:function(a){return this.each(function(){m.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,b){var c,d=1,e=m.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};"string"!=typeof a&&(b=a,a=void 0),a=a||"fx";while(g--)c=m._data(f[g],a+"queueHooks"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}});var S=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,T=["Top","Right","Bottom","Left"],U=function(a,b){return a=b||a,"none"===m.css(a,"display")||!m.contains(a.ownerDocument,a)},V=m.access=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if("object"===m.type(c)){e=!0;for(h in c)m.access(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,m.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(m(a),c)})),b))for(;i>h;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return e?a:j?b.call(a):i?b(a[0],c):f},W=/^(?:checkbox|radio)$/i;!function(){var a=y.createElement("input"),b=y.createElement("div"),c=y.createDocumentFragment();if(b.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",k.leadingWhitespace=3===b.firstChild.nodeType,k.tbody=!b.getElementsByTagName("tbody").length,k.htmlSerialize=!!b.getElementsByTagName("link").length,k.html5Clone="<:nav></:nav>"!==y.createElement("nav").cloneNode(!0).outerHTML,a.type="checkbox",a.checked=!0,c.appendChild(a),k.appendChecked=a.checked,b.innerHTML="<textarea>x</textarea>",k.noCloneChecked=!!b.cloneNode(!0).lastChild.defaultValue,c.appendChild(b),b.innerHTML="<input type='radio' checked='checked' name='t'/>",k.checkClone=b.cloneNode(!0).cloneNode(!0).lastChild.checked,k.noCloneEvent=!0,b.attachEvent&&(b.attachEvent("onclick",function(){k.noCloneEvent=!1}),b.cloneNode(!0).click()),null==k.deleteExpando){k.deleteExpando=!0;try{delete b.test}catch(d){k.deleteExpando=!1}}}(),function(){var b,c,d=y.createElement("div");for(b in{submit:!0,change:!0,focusin:!0})c="on"+b,(k[b+"Bubbles"]=c in a)||(d.setAttribute(c,"t"),k[b+"Bubbles"]=d.attributes[c].expando===!1);d=null}();var X=/^(?:input|select|textarea)$/i,Y=/^key/,Z=/^(?:mouse|pointer|contextmenu)|click/,$=/^(?:focusinfocus|focusoutblur)$/,_=/^([^.]*)(?:\.(.+)|)$/;function aa(){return!0}function ba(){return!1}function ca(){try{return y.activeElement}catch(a){}}m.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,n,o,p,q,r=m._data(a);if(r){c.handler&&(i=c,c=i.handler,e=i.selector),c.guid||(c.guid=m.guid++),(g=r.events)||(g=r.events={}),(k=r.handle)||(k=r.handle=function(a){return typeof m===K||a&&m.event.triggered===a.type?void 0:m.event.dispatch.apply(k.elem,arguments)},k.elem=a),b=(b||"").match(E)||[""],h=b.length;while(h--)f=_.exec(b[h])||[],o=q=f[1],p=(f[2]||"").split(".").sort(),o&&(j=m.event.special[o]||{},o=(e?j.delegateType:j.bindType)||o,j=m.event.special[o]||{},l=m.extend({type:o,origType:q,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&m.expr.match.needsContext.test(e),namespace:p.join(".")},i),(n=g[o])||(n=g[o]=[],n.delegateCount=0,j.setup&&j.setup.call(a,d,p,k)!==!1||(a.addEventListener?a.addEventListener(o,k,!1):a.attachEvent&&a.attachEvent("on"+o,k))),j.add&&(j.add.call(a,l),l.handler.guid||(l.handler.guid=c.guid)),e?n.splice(n.delegateCount++,0,l):n.push(l),m.event.global[o]=!0);a=null}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,n,o,p,q,r=m.hasData(a)&&m._data(a);if(r&&(k=r.events)){b=(b||"").match(E)||[""],j=b.length;while(j--)if(h=_.exec(b[j])||[],o=q=h[1],p=(h[2]||"").split(".").sort(),o){l=m.event.special[o]||{},o=(d?l.delegateType:l.bindType)||o,n=k[o]||[],h=h[2]&&new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),i=f=n.length;while(f--)g=n[f],!e&&q!==g.origType||c&&c.guid!==g.guid||h&&!h.test(g.namespace)||d&&d!==g.selector&&("**"!==d||!g.selector)||(n.splice(f,1),g.selector&&n.delegateCount--,l.remove&&l.remove.call(a,g));i&&!n.length&&(l.teardown&&l.teardown.call(a,p,r.handle)!==!1||m.removeEvent(a,o,r.handle),delete k[o])}else for(o in k)m.event.remove(a,o+b[j],c,d,!0);m.isEmptyObject(k)&&(delete r.handle,m._removeData(a,"events"))}},trigger:function(b,c,d,e){var f,g,h,i,k,l,n,o=[d||y],p=j.call(b,"type")?b.type:b,q=j.call(b,"namespace")?b.namespace.split("."):[];if(h=l=d=d||y,3!==d.nodeType&&8!==d.nodeType&&!$.test(p+m.event.triggered)&&(p.indexOf(".")>=0&&(q=p.split("."),p=q.shift(),q.sort()),g=p.indexOf(":")<0&&"on"+p,b=b[m.expando]?b:new m.Event(p,"object"==typeof b&&b),b.isTrigger=e?2:3,b.namespace=q.join("."),b.namespace_re=b.namespace?new RegExp("(^|\\.)"+q.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,b.result=void 0,b.target||(b.target=d),c=null==c?[b]:m.makeArray(c,[b]),k=m.event.special[p]||{},e||!k.trigger||k.trigger.apply(d,c)!==!1)){if(!e&&!k.noBubble&&!m.isWindow(d)){for(i=k.delegateType||p,$.test(i+p)||(h=h.parentNode);h;h=h.parentNode)o.push(h),l=h;l===(d.ownerDocument||y)&&o.push(l.defaultView||l.parentWindow||a)}n=0;while((h=o[n++])&&!b.isPropagationStopped())b.type=n>1?i:k.bindType||p,f=(m._data(h,"events")||{})[b.type]&&m._data(h,"handle"),f&&f.apply(h,c),f=g&&h[g],f&&f.apply&&m.acceptData(h)&&(b.result=f.apply(h,c),b.result===!1&&b.preventDefault());if(b.type=p,!e&&!b.isDefaultPrevented()&&(!k._default||k._default.apply(o.pop(),c)===!1)&&m.acceptData(d)&&g&&d[p]&&!m.isWindow(d)){l=d[g],l&&(d[g]=null),m.event.triggered=p;try{d[p]()}catch(r){}m.event.triggered=void 0,l&&(d[g]=l)}return b.result}},dispatch:function(a){a=m.event.fix(a);var b,c,e,f,g,h=[],i=d.call(arguments),j=(m._data(this,"events")||{})[a.type]||[],k=m.event.special[a.type]||{};if(i[0]=a,a.delegateTarget=this,!k.preDispatch||k.preDispatch.call(this,a)!==!1){h=m.event.handlers.call(this,a,j),b=0;while((f=h[b++])&&!a.isPropagationStopped()){a.currentTarget=f.elem,g=0;while((e=f.handlers[g++])&&!a.isImmediatePropagationStopped())(!a.namespace_re||a.namespace_re.test(e.namespace))&&(a.handleObj=e,a.data=e.data,c=((m.event.special[e.origType]||{}).handle||e.handler).apply(f.elem,i),void 0!==c&&(a.result=c)===!1&&(a.preventDefault(),a.stopPropagation()))}return k.postDispatch&&k.postDispatch.call(this,a),a.result}},handlers:function(a,b){var c,d,e,f,g=[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&(!a.button||"click"!==a.type))for(;i!=this;i=i.parentNode||this)if(1===i.nodeType&&(i.disabled!==!0||"click"!==a.type)){for(e=[],f=0;h>f;f++)d=b[f],c=d.selector+" ",void 0===e[c]&&(e[c]=d.needsContext?m(c,this).index(i)>=0:m.find(c,this,null,[i]).length),e[c]&&e.push(d);e.length&&g.push({elem:i,handlers:e})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},fix:function(a){if(a[m.expando])return a;var b,c,d,e=a.type,f=a,g=this.fixHooks[e];g||(this.fixHooks[e]=g=Z.test(e)?this.mouseHooks:Y.test(e)?this.keyHooks:{}),d=g.props?this.props.concat(g.props):this.props,a=new m.Event(f),b=d.length;while(b--)c=d[b],a[c]=f[c];return a.target||(a.target=f.srcElement||y),3===a.target.nodeType&&(a.target=a.target.parentNode),a.metaKey=!!a.metaKey,g.filter?g.filter(a,f):a},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,b){var c,d,e,f=b.button,g=b.fromElement;return null==a.pageX&&null!=b.clientX&&(d=a.target.ownerDocument||y,e=d.documentElement,c=d.body,a.pageX=b.clientX+(e&&e.scrollLeft||c&&c.scrollLeft||0)-(e&&e.clientLeft||c&&c.clientLeft||0),a.pageY=b.clientY+(e&&e.scrollTop||c&&c.scrollTop||0)-(e&&e.clientTop||c&&c.clientTop||0)),!a.relatedTarget&&g&&(a.relatedTarget=g===a.target?b.toElement:g),a.which||void 0===f||(a.which=1&f?1:2&f?3:4&f?2:0),a}},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==ca()&&this.focus)try{return this.focus(),!1}catch(a){}},delegateType:"focusin"},blur:{trigger:function(){return this===ca()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return m.nodeName(this,"input")&&"checkbox"===this.type&&this.click?(this.click(),!1):void 0},_default:function(a){return m.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}},simulate:function(a,b,c,d){var e=m.extend(new m.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?m.event.trigger(e,null,b):m.event.dispatch.call(b,e),e.isDefaultPrevented()&&c.preventDefault()}},m.removeEvent=y.removeEventListener?function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)}:function(a,b,c){var d="on"+b;a.detachEvent&&(typeof a[d]===K&&(a[d]=null),a.detachEvent(d,c))},m.Event=function(a,b){return this instanceof m.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&a.returnValue===!1?aa:ba):this.type=a,b&&m.extend(this,b),this.timeStamp=a&&a.timeStamp||m.now(),void(this[m.expando]=!0)):new m.Event(a,b)},m.Event.prototype={isDefaultPrevented:ba,isPropagationStopped:ba,isImmediatePropagationStopped:ba,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=aa,a&&(a.preventDefault?a.preventDefault():a.returnValue=!1)},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=aa,a&&(a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0)},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=aa,a&&a.stopImmediatePropagation&&a.stopImmediatePropagation(),this.stopPropagation()}},m.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(a,b){m.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return(!e||e!==d&&!m.contains(d,e))&&(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),k.submitBubbles||(m.event.special.submit={setup:function(){return m.nodeName(this,"form")?!1:void m.event.add(this,"click._submit keypress._submit",function(a){var b=a.target,c=m.nodeName(b,"input")||m.nodeName(b,"button")?b.form:void 0;c&&!m._data(c,"submitBubbles")&&(m.event.add(c,"submit._submit",function(a){a._submit_bubble=!0}),m._data(c,"submitBubbles",!0))})},postDispatch:function(a){a._submit_bubble&&(delete a._submit_bubble,this.parentNode&&!a.isTrigger&&m.event.simulate("submit",this.parentNode,a,!0))},teardown:function(){return m.nodeName(this,"form")?!1:void m.event.remove(this,"._submit")}}),k.changeBubbles||(m.event.special.change={setup:function(){return X.test(this.nodeName)?(("checkbox"===this.type||"radio"===this.type)&&(m.event.add(this,"propertychange._change",function(a){"checked"===a.originalEvent.propertyName&&(this._just_changed=!0)}),m.event.add(this,"click._change",function(a){this._just_changed&&!a.isTrigger&&(this._just_changed=!1),m.event.simulate("change",this,a,!0)})),!1):void m.event.add(this,"beforeactivate._change",function(a){var b=a.target;X.test(b.nodeName)&&!m._data(b,"changeBubbles")&&(m.event.add(b,"change._change",function(a){!this.parentNode||a.isSimulated||a.isTrigger||m.event.simulate("change",this.parentNode,a,!0)}),m._data(b,"changeBubbles",!0))})},handle:function(a){var b=a.target;return this!==b||a.isSimulated||a.isTrigger||"radio"!==b.type&&"checkbox"!==b.type?a.handleObj.handler.apply(this,arguments):void 0},teardown:function(){return m.event.remove(this,"._change"),!X.test(this.nodeName)}}),k.focusinBubbles||m.each({focus:"focusin",blur:"focusout"},function(a,b){var c=function(a){m.event.simulate(b,a.target,m.event.fix(a),!0)};m.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=m._data(d,b);e||d.addEventListener(a,c,!0),m._data(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=m._data(d,b)-1;e?m._data(d,b,e):(d.removeEventListener(a,c,!0),m._removeData(d,b))}}}),m.fn.extend({on:function(a,b,c,d,e){var f,g;if("object"==typeof a){"string"!=typeof b&&(c=c||b,b=void 0);for(f in a)this.on(f,b,c,a[f],e);return this}if(null==c&&null==d?(d=b,c=b=void 0):null==d&&("string"==typeof b?(d=c,c=void 0):(d=c,c=b,b=void 0)),d===!1)d=ba;else if(!d)return this;return 1===e&&(g=d,d=function(a){return m().off(a),g.apply(this,arguments)},d.guid=g.guid||(g.guid=m.guid++)),this.each(function(){m.event.add(this,a,d,c,b)})},one:function(a,b,c,d){return this.on(a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,m(a.delegateTarget).off(d.namespace?d.origType+"."+d.namespace:d.origType,d.selector,d.handler),this;if("object"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return(b===!1||"function"==typeof b)&&(c=b,b=void 0),c===!1&&(c=ba),this.each(function(){m.event.remove(this,a,c,b)})},trigger:function(a,b){return this.each(function(){m.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];return c?m.event.trigger(a,b,c,!0):void 0}});function da(a){var b=ea.split("|"),c=a.createDocumentFragment();if(c.createElement)while(b.length)c.createElement(b.pop());return c}var ea="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",fa=/ jQuery\d+="(?:null|\d+)"/g,ga=new RegExp("<(?:"+ea+")[\\s/>]","i"),ha=/^\s+/,ia=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,ja=/<([\w:]+)/,ka=/<tbody/i,la=/<|&#?\w+;/,ma=/<(?:script|style|link)/i,na=/checked\s*(?:[^=]|=\s*.checked.)/i,oa=/^$|\/(?:java|ecma)script/i,pa=/^true\/(.*)/,qa=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,ra={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:k.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]},sa=da(y),ta=sa.appendChild(y.createElement("div"));ra.optgroup=ra.option,ra.tbody=ra.tfoot=ra.colgroup=ra.caption=ra.thead,ra.th=ra.td;function ua(a,b){var c,d,e=0,f=typeof a.getElementsByTagName!==K?a.getElementsByTagName(b||"*"):typeof a.querySelectorAll!==K?a.querySelectorAll(b||"*"):void 0;if(!f)for(f=[],c=a.childNodes||a;null!=(d=c[e]);e++)!b||m.nodeName(d,b)?f.push(d):m.merge(f,ua(d,b));return void 0===b||b&&m.nodeName(a,b)?m.merge([a],f):f}function va(a){W.test(a.type)&&(a.defaultChecked=a.checked)}function wa(a,b){return m.nodeName(a,"table")&&m.nodeName(11!==b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function xa(a){return a.type=(null!==m.find.attr(a,"type"))+"/"+a.type,a}function ya(a){var b=pa.exec(a.type);return b?a.type=b[1]:a.removeAttribute("type"),a}function za(a,b){for(var c,d=0;null!=(c=a[d]);d++)m._data(c,"globalEval",!b||m._data(b[d],"globalEval"))}function Aa(a,b){if(1===b.nodeType&&m.hasData(a)){var c,d,e,f=m._data(a),g=m._data(b,f),h=f.events;if(h){delete g.handle,g.events={};for(c in h)for(d=0,e=h[c].length;e>d;d++)m.event.add(b,c,h[c][d])}g.data&&(g.data=m.extend({},g.data))}}function Ba(a,b){var c,d,e;if(1===b.nodeType){if(c=b.nodeName.toLowerCase(),!k.noCloneEvent&&b[m.expando]){e=m._data(b);for(d in e.events)m.removeEvent(b,d,e.handle);b.removeAttribute(m.expando)}"script"===c&&b.text!==a.text?(xa(b).text=a.text,ya(b)):"object"===c?(b.parentNode&&(b.outerHTML=a.outerHTML),k.html5Clone&&a.innerHTML&&!m.trim(b.innerHTML)&&(b.innerHTML=a.innerHTML)):"input"===c&&W.test(a.type)?(b.defaultChecked=b.checked=a.checked,b.value!==a.value&&(b.value=a.value)):"option"===c?b.defaultSelected=b.selected=a.defaultSelected:("input"===c||"textarea"===c)&&(b.defaultValue=a.defaultValue)}}m.extend({clone:function(a,b,c){var d,e,f,g,h,i=m.contains(a.ownerDocument,a);if(k.html5Clone||m.isXMLDoc(a)||!ga.test("<"+a.nodeName+">")?f=a.cloneNode(!0):(ta.innerHTML=a.outerHTML,ta.removeChild(f=ta.firstChild)),!(k.noCloneEvent&&k.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||m.isXMLDoc(a)))for(d=ua(f),h=ua(a),g=0;null!=(e=h[g]);++g)d[g]&&Ba(e,d[g]);if(b)if(c)for(h=h||ua(a),d=d||ua(f),g=0;null!=(e=h[g]);g++)Aa(e,d[g]);else Aa(a,f);return d=ua(f,"script"),d.length>0&&za(d,!i&&ua(a,"script")),d=h=e=null,f},buildFragment:function(a,b,c,d){for(var e,f,g,h,i,j,l,n=a.length,o=da(b),p=[],q=0;n>q;q++)if(f=a[q],f||0===f)if("object"===m.type(f))m.merge(p,f.nodeType?[f]:f);else if(la.test(f)){h=h||o.appendChild(b.createElement("div")),i=(ja.exec(f)||["",""])[1].toLowerCase(),l=ra[i]||ra._default,h.innerHTML=l[1]+f.replace(ia,"<$1></$2>")+l[2],e=l[0];while(e--)h=h.lastChild;if(!k.leadingWhitespace&&ha.test(f)&&p.push(b.createTextNode(ha.exec(f)[0])),!k.tbody){f="table"!==i||ka.test(f)?"<table>"!==l[1]||ka.test(f)?0:h:h.firstChild,e=f&&f.childNodes.length;while(e--)m.nodeName(j=f.childNodes[e],"tbody")&&!j.childNodes.length&&f.removeChild(j)}m.merge(p,h.childNodes),h.textContent="";while(h.firstChild)h.removeChild(h.firstChild);h=o.lastChild}else p.push(b.createTextNode(f));h&&o.removeChild(h),k.appendChecked||m.grep(ua(p,"input"),va),q=0;while(f=p[q++])if((!d||-1===m.inArray(f,d))&&(g=m.contains(f.ownerDocument,f),h=ua(o.appendChild(f),"script"),g&&za(h),c)){e=0;while(f=h[e++])oa.test(f.type||"")&&c.push(f)}return h=null,o},cleanData:function(a,b){for(var d,e,f,g,h=0,i=m.expando,j=m.cache,l=k.deleteExpando,n=m.event.special;null!=(d=a[h]);h++)if((b||m.acceptData(d))&&(f=d[i],g=f&&j[f])){if(g.events)for(e in g.events)n[e]?m.event.remove(d,e):m.removeEvent(d,e,g.handle);j[f]&&(delete j[f],l?delete d[i]:typeof d.removeAttribute!==K?d.removeAttribute(i):d[i]=null,c.push(f))}}}),m.fn.extend({text:function(a){return V(this,function(a){return void 0===a?m.text(this):this.empty().append((this[0]&&this[0].ownerDocument||y).createTextNode(a))},null,a,arguments.length)},append:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=wa(this,a);b.appendChild(a)}})},prepend:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=wa(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},remove:function(a,b){for(var c,d=a?m.filter(a,this):this,e=0;null!=(c=d[e]);e++)b||1!==c.nodeType||m.cleanData(ua(c)),c.parentNode&&(b&&m.contains(c.ownerDocument,c)&&za(ua(c,"script")),c.parentNode.removeChild(c));return this},empty:function(){for(var a,b=0;null!=(a=this[b]);b++){1===a.nodeType&&m.cleanData(ua(a,!1));while(a.firstChild)a.removeChild(a.firstChild);a.options&&m.nodeName(a,"select")&&(a.options.length=0)}return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return m.clone(this,a,b)})},html:function(a){return V(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a)return 1===b.nodeType?b.innerHTML.replace(fa,""):void 0;if(!("string"!=typeof a||ma.test(a)||!k.htmlSerialize&&ga.test(a)||!k.leadingWhitespace&&ha.test(a)||ra[(ja.exec(a)||["",""])[1].toLowerCase()])){a=a.replace(ia,"<$1></$2>");try{for(;d>c;c++)b=this[c]||{},1===b.nodeType&&(m.cleanData(ua(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=arguments[0];return this.domManip(arguments,function(b){a=this.parentNode,m.cleanData(ua(this)),a&&a.replaceChild(b,this)}),a&&(a.length||a.nodeType)?this:this.remove()},detach:function(a){return this.remove(a,!0)},domManip:function(a,b){a=e.apply([],a);var c,d,f,g,h,i,j=0,l=this.length,n=this,o=l-1,p=a[0],q=m.isFunction(p);if(q||l>1&&"string"==typeof p&&!k.checkClone&&na.test(p))return this.each(function(c){var d=n.eq(c);q&&(a[0]=p.call(this,c,d.html())),d.domManip(a,b)});if(l&&(i=m.buildFragment(a,this[0].ownerDocument,!1,this),c=i.firstChild,1===i.childNodes.length&&(i=c),c)){for(g=m.map(ua(i,"script"),xa),f=g.length;l>j;j++)d=i,j!==o&&(d=m.clone(d,!0,!0),f&&m.merge(g,ua(d,"script"))),b.call(this[j],d,j);if(f)for(h=g[g.length-1].ownerDocument,m.map(g,ya),j=0;f>j;j++)d=g[j],oa.test(d.type||"")&&!m._data(d,"globalEval")&&m.contains(h,d)&&(d.src?m._evalUrl&&m._evalUrl(d.src):m.globalEval((d.text||d.textContent||d.innerHTML||"").replace(qa,"")));i=c=null}return this}}),m.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){m.fn[a]=function(a){for(var c,d=0,e=[],g=m(a),h=g.length-1;h>=d;d++)c=d===h?this:this.clone(!0),m(g[d])[b](c),f.apply(e,c.get());return this.pushStack(e)}});var Ca,Da={};function Ea(b,c){var d,e=m(c.createElement(b)).appendTo(c.body),f=a.getDefaultComputedStyle&&(d=a.getDefaultComputedStyle(e[0]))?d.display:m.css(e[0],"display");return e.detach(),f}function Fa(a){var b=y,c=Da[a];return c||(c=Ea(a,b),"none"!==c&&c||(Ca=(Ca||m("<iframe frameborder='0' width='0' height='0'/>")).appendTo(b.documentElement),b=(Ca[0].contentWindow||Ca[0].contentDocument).document,b.write(),b.close(),c=Ea(a,b),Ca.detach()),Da[a]=c),c}!function(){var a;k.shrinkWrapBlocks=function(){if(null!=a)return a;a=!1;var b,c,d;return c=y.getElementsByTagName("body")[0],c&&c.style?(b=y.createElement("div"),d=y.createElement("div"),d.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",c.appendChild(d).appendChild(b),typeof b.style.zoom!==K&&(b.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:1px;width:1px;zoom:1",b.appendChild(y.createElement("div")).style.width="5px",a=3!==b.offsetWidth),c.removeChild(d),a):void 0}}();var Ga=/^margin/,Ha=new RegExp("^("+S+")(?!px)[a-z%]+$","i"),Ia,Ja,Ka=/^(top|right|bottom|left)$/;a.getComputedStyle?(Ia=function(b){return b.ownerDocument.defaultView.opener?b.ownerDocument.defaultView.getComputedStyle(b,null):a.getComputedStyle(b,null)},Ja=function(a,b,c){var d,e,f,g,h=a.style;return c=c||Ia(a),g=c?c.getPropertyValue(b)||c[b]:void 0,c&&(""!==g||m.contains(a.ownerDocument,a)||(g=m.style(a,b)),Ha.test(g)&&Ga.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f)),void 0===g?g:g+""}):y.documentElement.currentStyle&&(Ia=function(a){return a.currentStyle},Ja=function(a,b,c){var d,e,f,g,h=a.style;return c=c||Ia(a),g=c?c[b]:void 0,null==g&&h&&h[b]&&(g=h[b]),Ha.test(g)&&!Ka.test(b)&&(d=h.left,e=a.runtimeStyle,f=e&&e.left,f&&(e.left=a.currentStyle.left),h.left="fontSize"===b?"1em":g,g=h.pixelLeft+"px",h.left=d,f&&(e.left=f)),void 0===g?g:g+""||"auto"});function La(a,b){return{get:function(){var c=a();if(null!=c)return c?void delete this.get:(this.get=b).apply(this,arguments)}}}!function(){var b,c,d,e,f,g,h;if(b=y.createElement("div"),b.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",d=b.getElementsByTagName("a")[0],c=d&&d.style){c.cssText="float:left;opacity:.5",k.opacity="0.5"===c.opacity,k.cssFloat=!!c.cssFloat,b.style.backgroundClip="content-box",b.cloneNode(!0).style.backgroundClip="",k.clearCloneStyle="content-box"===b.style.backgroundClip,k.boxSizing=""===c.boxSizing||""===c.MozBoxSizing||""===c.WebkitBoxSizing,m.extend(k,{reliableHiddenOffsets:function(){return null==g&&i(),g},boxSizingReliable:function(){return null==f&&i(),f},pixelPosition:function(){return null==e&&i(),e},reliableMarginRight:function(){return null==h&&i(),h}});function i(){var b,c,d,i;c=y.getElementsByTagName("body")[0],c&&c.style&&(b=y.createElement("div"),d=y.createElement("div"),d.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",c.appendChild(d).appendChild(b),b.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;display:block;margin-top:1%;top:1%;border:1px;padding:1px;width:4px;position:absolute",e=f=!1,h=!0,a.getComputedStyle&&(e="1%"!==(a.getComputedStyle(b,null)||{}).top,f="4px"===(a.getComputedStyle(b,null)||{width:"4px"}).width,i=b.appendChild(y.createElement("div")),i.style.cssText=b.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",i.style.marginRight=i.style.width="0",b.style.width="1px",h=!parseFloat((a.getComputedStyle(i,null)||{}).marginRight),b.removeChild(i)),b.innerHTML="<table><tr><td></td><td>t</td></tr></table>",i=b.getElementsByTagName("td"),i[0].style.cssText="margin:0;border:0;padding:0;display:none",g=0===i[0].offsetHeight,g&&(i[0].style.display="",i[1].style.display="none",g=0===i[0].offsetHeight),c.removeChild(d))}}}(),m.swap=function(a,b,c,d){var e,f,g={};for(f in b)g[f]=a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f in b)a.style[f]=g[f];return e};var Ma=/alpha\([^)]*\)/i,Na=/opacity\s*=\s*([^)]*)/,Oa=/^(none|table(?!-c[ea]).+)/,Pa=new RegExp("^("+S+")(.*)$","i"),Qa=new RegExp("^([+-])=("+S+")","i"),Ra={position:"absolute",visibility:"hidden",display:"block"},Sa={letterSpacing:"0",fontWeight:"400"},Ta=["Webkit","O","Moz","ms"];function Ua(a,b){if(b in a)return b;var c=b.charAt(0).toUpperCase()+b.slice(1),d=b,e=Ta.length;while(e--)if(b=Ta[e]+c,b in a)return b;return d}function Va(a,b){for(var c,d,e,f=[],g=0,h=a.length;h>g;g++)d=a[g],d.style&&(f[g]=m._data(d,"olddisplay"),c=d.style.display,b?(f[g]||"none"!==c||(d.style.display=""),""===d.style.display&&U(d)&&(f[g]=m._data(d,"olddisplay",Fa(d.nodeName)))):(e=U(d),(c&&"none"!==c||!e)&&m._data(d,"olddisplay",e?c:m.css(d,"display"))));for(g=0;h>g;g++)d=a[g],d.style&&(b&&"none"!==d.style.display&&""!==d.style.display||(d.style.display=b?f[g]||"":"none"));return a}function Wa(a,b,c){var d=Pa.exec(b);return d?Math.max(0,d[1]-(c||0))+(d[2]||"px"):b}function Xa(a,b,c,d,e){for(var f=c===(d?"border":"content")?4:"width"===b?1:0,g=0;4>f;f+=2)"margin"===c&&(g+=m.css(a,c+T[f],!0,e)),d?("content"===c&&(g-=m.css(a,"padding"+T[f],!0,e)),"margin"!==c&&(g-=m.css(a,"border"+T[f]+"Width",!0,e))):(g+=m.css(a,"padding"+T[f],!0,e),"padding"!==c&&(g+=m.css(a,"border"+T[f]+"Width",!0,e)));return g}function Ya(a,b,c){var d=!0,e="width"===b?a.offsetWidth:a.offsetHeight,f=Ia(a),g=k.boxSizing&&"border-box"===m.css(a,"boxSizing",!1,f);if(0>=e||null==e){if(e=Ja(a,b,f),(0>e||null==e)&&(e=a.style[b]),Ha.test(e))return e;d=g&&(k.boxSizingReliable()||e===a.style[b]),e=parseFloat(e)||0}return e+Xa(a,b,c||(g?"border":"content"),d,f)+"px"}m.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=Ja(a,"opacity");return""===c?"1":c}}}},cssNumber:{columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":k.cssFloat?"cssFloat":"styleFloat"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=m.camelCase(b),i=a.style;if(b=m.cssProps[h]||(m.cssProps[h]=Ua(i,h)),g=m.cssHooks[b]||m.cssHooks[h],void 0===c)return g&&"get"in g&&void 0!==(e=g.get(a,!1,d))?e:i[b];if(f=typeof c,"string"===f&&(e=Qa.exec(c))&&(c=(e[1]+1)*e[2]+parseFloat(m.css(a,b)),f="number"),null!=c&&c===c&&("number"!==f||m.cssNumber[h]||(c+="px"),k.clearCloneStyle||""!==c||0!==b.indexOf("background")||(i[b]="inherit"),!(g&&"set"in g&&void 0===(c=g.set(a,c,d)))))try{i[b]=c}catch(j){}}},css:function(a,b,c,d){var e,f,g,h=m.camelCase(b);return b=m.cssProps[h]||(m.cssProps[h]=Ua(a.style,h)),g=m.cssHooks[b]||m.cssHooks[h],g&&"get"in g&&(f=g.get(a,!0,c)),void 0===f&&(f=Ja(a,b,d)),"normal"===f&&b in Sa&&(f=Sa[b]),""===c||c?(e=parseFloat(f),c===!0||m.isNumeric(e)?e||0:f):f}}),m.each(["height","width"],function(a,b){m.cssHooks[b]={get:function(a,c,d){return c?Oa.test(m.css(a,"display"))&&0===a.offsetWidth?m.swap(a,Ra,function(){return Ya(a,b,d)}):Ya(a,b,d):void 0},set:function(a,c,d){var e=d&&Ia(a);return Wa(a,c,d?Xa(a,b,d,k.boxSizing&&"border-box"===m.css(a,"boxSizing",!1,e),e):0)}}}),k.opacity||(m.cssHooks.opacity={get:function(a,b){return Na.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":b?"1":""},set:function(a,b){var c=a.style,d=a.currentStyle,e=m.isNumeric(b)?"alpha(opacity="+100*b+")":"",f=d&&d.filter||c.filter||"";c.zoom=1,(b>=1||""===b)&&""===m.trim(f.replace(Ma,""))&&c.removeAttribute&&(c.removeAttribute("filter"),""===b||d&&!d.filter)||(c.filter=Ma.test(f)?f.replace(Ma,e):f+" "+e)}}),m.cssHooks.marginRight=La(k.reliableMarginRight,function(a,b){return b?m.swap(a,{display:"inline-block"},Ja,[a,"marginRight"]):void 0}),m.each({margin:"",padding:"",border:"Width"},function(a,b){m.cssHooks[a+b]={expand:function(c){for(var d=0,e={},f="string"==typeof c?c.split(" "):[c];4>d;d++)e[a+T[d]+b]=f[d]||f[d-2]||f[0];return e}},Ga.test(a)||(m.cssHooks[a+b].set=Wa)}),m.fn.extend({css:function(a,b){return V(this,function(a,b,c){var d,e,f={},g=0;if(m.isArray(b)){for(d=Ia(a),e=b.length;e>g;g++)f[b[g]]=m.css(a,b[g],!1,d);return f}return void 0!==c?m.style(a,b,c):m.css(a,b)},a,b,arguments.length>1)},show:function(){return Va(this,!0)},hide:function(){return Va(this)},toggle:function(a){return"boolean"==typeof a?a?this.show():this.hide():this.each(function(){U(this)?m(this).show():m(this).hide()})}});function Za(a,b,c,d,e){
return new Za.prototype.init(a,b,c,d,e)}m.Tween=Za,Za.prototype={constructor:Za,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||"swing",this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(m.cssNumber[c]?"":"px")},cur:function(){var a=Za.propHooks[this.prop];return a&&a.get?a.get(this):Za.propHooks._default.get(this)},run:function(a){var b,c=Za.propHooks[this.prop];return this.options.duration?this.pos=b=m.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):this.pos=b=a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):Za.propHooks._default.set(this),this}},Za.prototype.init.prototype=Za.prototype,Za.propHooks={_default:{get:function(a){var b;return null==a.elem[a.prop]||a.elem.style&&null!=a.elem.style[a.prop]?(b=m.css(a.elem,a.prop,""),b&&"auto"!==b?b:0):a.elem[a.prop]},set:function(a){m.fx.step[a.prop]?m.fx.step[a.prop](a):a.elem.style&&(null!=a.elem.style[m.cssProps[a.prop]]||m.cssHooks[a.prop])?m.style(a.elem,a.prop,a.now+a.unit):a.elem[a.prop]=a.now}}},Za.propHooks.scrollTop=Za.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},m.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2}},m.fx=Za.prototype.init,m.fx.step={};var $a,_a,ab=/^(?:toggle|show|hide)$/,bb=new RegExp("^(?:([+-])=|)("+S+")([a-z%]*)$","i"),cb=/queueHooks$/,db=[ib],eb={"*":[function(a,b){var c=this.createTween(a,b),d=c.cur(),e=bb.exec(b),f=e&&e[3]||(m.cssNumber[a]?"":"px"),g=(m.cssNumber[a]||"px"!==f&&+d)&&bb.exec(m.css(c.elem,a)),h=1,i=20;if(g&&g[3]!==f){f=f||g[3],e=e||[],g=+d||1;do h=h||".5",g/=h,m.style(c.elem,a,g+f);while(h!==(h=c.cur()/d)&&1!==h&&--i)}return e&&(g=c.start=+g||+d||0,c.unit=f,c.end=e[1]?g+(e[1]+1)*e[2]:+e[2]),c}]};function fb(){return setTimeout(function(){$a=void 0}),$a=m.now()}function gb(a,b){var c,d={height:a},e=0;for(b=b?1:0;4>e;e+=2-b)c=T[e],d["margin"+c]=d["padding"+c]=a;return b&&(d.opacity=d.width=a),d}function hb(a,b,c){for(var d,e=(eb[b]||[]).concat(eb["*"]),f=0,g=e.length;g>f;f++)if(d=e[f].call(c,b,a))return d}function ib(a,b,c){var d,e,f,g,h,i,j,l,n=this,o={},p=a.style,q=a.nodeType&&U(a),r=m._data(a,"fxshow");c.queue||(h=m._queueHooks(a,"fx"),null==h.unqueued&&(h.unqueued=0,i=h.empty.fire,h.empty.fire=function(){h.unqueued||i()}),h.unqueued++,n.always(function(){n.always(function(){h.unqueued--,m.queue(a,"fx").length||h.empty.fire()})})),1===a.nodeType&&("height"in b||"width"in b)&&(c.overflow=[p.overflow,p.overflowX,p.overflowY],j=m.css(a,"display"),l="none"===j?m._data(a,"olddisplay")||Fa(a.nodeName):j,"inline"===l&&"none"===m.css(a,"float")&&(k.inlineBlockNeedsLayout&&"inline"!==Fa(a.nodeName)?p.zoom=1:p.display="inline-block")),c.overflow&&(p.overflow="hidden",k.shrinkWrapBlocks()||n.always(function(){p.overflow=c.overflow[0],p.overflowX=c.overflow[1],p.overflowY=c.overflow[2]}));for(d in b)if(e=b[d],ab.exec(e)){if(delete b[d],f=f||"toggle"===e,e===(q?"hide":"show")){if("show"!==e||!r||void 0===r[d])continue;q=!0}o[d]=r&&r[d]||m.style(a,d)}else j=void 0;if(m.isEmptyObject(o))"inline"===("none"===j?Fa(a.nodeName):j)&&(p.display=j);else{r?"hidden"in r&&(q=r.hidden):r=m._data(a,"fxshow",{}),f&&(r.hidden=!q),q?m(a).show():n.done(function(){m(a).hide()}),n.done(function(){var b;m._removeData(a,"fxshow");for(b in o)m.style(a,b,o[b])});for(d in o)g=hb(q?r[d]:0,d,n),d in r||(r[d]=g.start,q&&(g.end=g.start,g.start="width"===d||"height"===d?1:0))}}function jb(a,b){var c,d,e,f,g;for(c in a)if(d=m.camelCase(c),e=b[d],f=a[c],m.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=m.cssHooks[d],g&&"expand"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}function kb(a,b,c){var d,e,f=0,g=db.length,h=m.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=$a||fb(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;i>g;g++)j.tweens[g].run(f);return h.notifyWith(a,[j,f,c]),1>f&&i?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:m.extend({},b),opts:m.extend(!0,{specialEasing:{}},c),originalProperties:b,originalOptions:c,startTime:$a||fb(),duration:c.duration,tweens:[],createTween:function(b,c){var d=m.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;d>c;c++)j.tweens[c].run(1);return b?h.resolveWith(a,[j,b]):h.rejectWith(a,[j,b]),this}}),k=j.props;for(jb(k,j.opts.specialEasing);g>f;f++)if(d=db[f].call(j,a,k,j.opts))return d;return m.map(k,hb,j),m.isFunction(j.opts.start)&&j.opts.start.call(a,j),m.fx.timer(m.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}m.Animation=m.extend(kb,{tweener:function(a,b){m.isFunction(a)?(b=a,a=["*"]):a=a.split(" ");for(var c,d=0,e=a.length;e>d;d++)c=a[d],eb[c]=eb[c]||[],eb[c].unshift(b)},prefilter:function(a,b){b?db.unshift(a):db.push(a)}}),m.speed=function(a,b,c){var d=a&&"object"==typeof a?m.extend({},a):{complete:c||!c&&b||m.isFunction(a)&&a,duration:a,easing:c&&b||b&&!m.isFunction(b)&&b};return d.duration=m.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in m.fx.speeds?m.fx.speeds[d.duration]:m.fx.speeds._default,(null==d.queue||d.queue===!0)&&(d.queue="fx"),d.old=d.complete,d.complete=function(){m.isFunction(d.old)&&d.old.call(this),d.queue&&m.dequeue(this,d.queue)},d},m.fn.extend({fadeTo:function(a,b,c,d){return this.filter(U).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=m.isEmptyObject(a),f=m.speed(b,c,d),g=function(){var b=kb(this,m.extend({},a),f);(e||m._data(this,"finish"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return"string"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var b=!0,e=null!=a&&a+"queueHooks",f=m.timers,g=m._data(this);if(e)g[e]&&g[e].stop&&d(g[e]);else for(e in g)g[e]&&g[e].stop&&cb.test(e)&&d(g[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));(b||!c)&&m.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||"fx"),this.each(function(){var b,c=m._data(this),d=c[a+"queue"],e=c[a+"queueHooks"],f=m.timers,g=d?d.length:0;for(c.finish=!0,m.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;g>b;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}}),m.each(["toggle","show","hide"],function(a,b){var c=m.fn[b];m.fn[b]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(gb(b,!0),a,d,e)}}),m.each({slideDown:gb("show"),slideUp:gb("hide"),slideToggle:gb("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){m.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),m.timers=[],m.fx.tick=function(){var a,b=m.timers,c=0;for($a=m.now();c<b.length;c++)a=b[c],a()||b[c]!==a||b.splice(c--,1);b.length||m.fx.stop(),$a=void 0},m.fx.timer=function(a){m.timers.push(a),a()?m.fx.start():m.timers.pop()},m.fx.interval=13,m.fx.start=function(){_a||(_a=setInterval(m.fx.tick,m.fx.interval))},m.fx.stop=function(){clearInterval(_a),_a=null},m.fx.speeds={slow:600,fast:200,_default:400},m.fn.delay=function(a,b){return a=m.fx?m.fx.speeds[a]||a:a,b=b||"fx",this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},function(){var a,b,c,d,e;b=y.createElement("div"),b.setAttribute("className","t"),b.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",d=b.getElementsByTagName("a")[0],c=y.createElement("select"),e=c.appendChild(y.createElement("option")),a=b.getElementsByTagName("input")[0],d.style.cssText="top:1px",k.getSetAttribute="t"!==b.className,k.style=/top/.test(d.getAttribute("style")),k.hrefNormalized="/a"===d.getAttribute("href"),k.checkOn=!!a.value,k.optSelected=e.selected,k.enctype=!!y.createElement("form").enctype,c.disabled=!0,k.optDisabled=!e.disabled,a=y.createElement("input"),a.setAttribute("value",""),k.input=""===a.getAttribute("value"),a.value="t",a.setAttribute("type","radio"),k.radioValue="t"===a.value}();var lb=/\r/g;m.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=m.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,m(this).val()):a,null==e?e="":"number"==typeof e?e+="":m.isArray(e)&&(e=m.map(e,function(a){return null==a?"":a+""})),b=m.valHooks[this.type]||m.valHooks[this.nodeName.toLowerCase()],b&&"set"in b&&void 0!==b.set(this,e,"value")||(this.value=e))});if(e)return b=m.valHooks[e.type]||m.valHooks[e.nodeName.toLowerCase()],b&&"get"in b&&void 0!==(c=b.get(e,"value"))?c:(c=e.value,"string"==typeof c?c.replace(lb,""):null==c?"":c)}}}),m.extend({valHooks:{option:{get:function(a){var b=m.find.attr(a,"value");return null!=b?b:m.trim(m.text(a))}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f="select-one"===a.type||0>e,g=f?null:[],h=f?e+1:d.length,i=0>e?h:f?e:0;h>i;i++)if(c=d[i],!(!c.selected&&i!==e||(k.optDisabled?c.disabled:null!==c.getAttribute("disabled"))||c.parentNode.disabled&&m.nodeName(c.parentNode,"optgroup"))){if(b=m(c).val(),f)return b;g.push(b)}return g},set:function(a,b){var c,d,e=a.options,f=m.makeArray(b),g=e.length;while(g--)if(d=e[g],m.inArray(m.valHooks.option.get(d),f)>=0)try{d.selected=c=!0}catch(h){d.scrollHeight}else d.selected=!1;return c||(a.selectedIndex=-1),e}}}}),m.each(["radio","checkbox"],function(){m.valHooks[this]={set:function(a,b){return m.isArray(b)?a.checked=m.inArray(m(a).val(),b)>=0:void 0}},k.checkOn||(m.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})});var mb,nb,ob=m.expr.attrHandle,pb=/^(?:checked|selected)$/i,qb=k.getSetAttribute,rb=k.input;m.fn.extend({attr:function(a,b){return V(this,m.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){m.removeAttr(this,a)})}}),m.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(a&&3!==f&&8!==f&&2!==f)return typeof a.getAttribute===K?m.prop(a,b,c):(1===f&&m.isXMLDoc(a)||(b=b.toLowerCase(),d=m.attrHooks[b]||(m.expr.match.bool.test(b)?nb:mb)),void 0===c?d&&"get"in d&&null!==(e=d.get(a,b))?e:(e=m.find.attr(a,b),null==e?void 0:e):null!==c?d&&"set"in d&&void 0!==(e=d.set(a,c,b))?e:(a.setAttribute(b,c+""),c):void m.removeAttr(a,b))},removeAttr:function(a,b){var c,d,e=0,f=b&&b.match(E);if(f&&1===a.nodeType)while(c=f[e++])d=m.propFix[c]||c,m.expr.match.bool.test(c)?rb&&qb||!pb.test(c)?a[d]=!1:a[m.camelCase("default-"+c)]=a[d]=!1:m.attr(a,c,""),a.removeAttribute(qb?c:d)},attrHooks:{type:{set:function(a,b){if(!k.radioValue&&"radio"===b&&m.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}}}),nb={set:function(a,b,c){return b===!1?m.removeAttr(a,c):rb&&qb||!pb.test(c)?a.setAttribute(!qb&&m.propFix[c]||c,c):a[m.camelCase("default-"+c)]=a[c]=!0,c}},m.each(m.expr.match.bool.source.match(/\w+/g),function(a,b){var c=ob[b]||m.find.attr;ob[b]=rb&&qb||!pb.test(b)?function(a,b,d){var e,f;return d||(f=ob[b],ob[b]=e,e=null!=c(a,b,d)?b.toLowerCase():null,ob[b]=f),e}:function(a,b,c){return c?void 0:a[m.camelCase("default-"+b)]?b.toLowerCase():null}}),rb&&qb||(m.attrHooks.value={set:function(a,b,c){return m.nodeName(a,"input")?void(a.defaultValue=b):mb&&mb.set(a,b,c)}}),qb||(mb={set:function(a,b,c){var d=a.getAttributeNode(c);return d||a.setAttributeNode(d=a.ownerDocument.createAttribute(c)),d.value=b+="","value"===c||b===a.getAttribute(c)?b:void 0}},ob.id=ob.name=ob.coords=function(a,b,c){var d;return c?void 0:(d=a.getAttributeNode(b))&&""!==d.value?d.value:null},m.valHooks.button={get:function(a,b){var c=a.getAttributeNode(b);return c&&c.specified?c.value:void 0},set:mb.set},m.attrHooks.contenteditable={set:function(a,b,c){mb.set(a,""===b?!1:b,c)}},m.each(["width","height"],function(a,b){m.attrHooks[b]={set:function(a,c){return""===c?(a.setAttribute(b,"auto"),c):void 0}}})),k.style||(m.attrHooks.style={get:function(a){return a.style.cssText||void 0},set:function(a,b){return a.style.cssText=b+""}});var sb=/^(?:input|select|textarea|button|object)$/i,tb=/^(?:a|area)$/i;m.fn.extend({prop:function(a,b){return V(this,m.prop,a,b,arguments.length>1)},removeProp:function(a){return a=m.propFix[a]||a,this.each(function(){try{this[a]=void 0,delete this[a]}catch(b){}})}}),m.extend({propFix:{"for":"htmlFor","class":"className"},prop:function(a,b,c){var d,e,f,g=a.nodeType;if(a&&3!==g&&8!==g&&2!==g)return f=1!==g||!m.isXMLDoc(a),f&&(b=m.propFix[b]||b,e=m.propHooks[b]),void 0!==c?e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&"get"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){var b=m.find.attr(a,"tabindex");return b?parseInt(b,10):sb.test(a.nodeName)||tb.test(a.nodeName)&&a.href?0:-1}}}}),k.hrefNormalized||m.each(["href","src"],function(a,b){m.propHooks[b]={get:function(a){return a.getAttribute(b,4)}}}),k.optSelected||(m.propHooks.selected={get:function(a){var b=a.parentNode;return b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex),null}}),m.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){m.propFix[this.toLowerCase()]=this}),k.enctype||(m.propFix.enctype="encoding");var ub=/[\t\r\n\f]/g;m.fn.extend({addClass:function(a){var b,c,d,e,f,g,h=0,i=this.length,j="string"==typeof a&&a;if(m.isFunction(a))return this.each(function(b){m(this).addClass(a.call(this,b,this.className))});if(j)for(b=(a||"").match(E)||[];i>h;h++)if(c=this[h],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(ub," "):" ")){f=0;while(e=b[f++])d.indexOf(" "+e+" ")<0&&(d+=e+" ");g=m.trim(d),c.className!==g&&(c.className=g)}return this},removeClass:function(a){var b,c,d,e,f,g,h=0,i=this.length,j=0===arguments.length||"string"==typeof a&&a;if(m.isFunction(a))return this.each(function(b){m(this).removeClass(a.call(this,b,this.className))});if(j)for(b=(a||"").match(E)||[];i>h;h++)if(c=this[h],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(ub," "):"")){f=0;while(e=b[f++])while(d.indexOf(" "+e+" ")>=0)d=d.replace(" "+e+" "," ");g=a?m.trim(d):"",c.className!==g&&(c.className=g)}return this},toggleClass:function(a,b){var c=typeof a;return"boolean"==typeof b&&"string"===c?b?this.addClass(a):this.removeClass(a):this.each(m.isFunction(a)?function(c){m(this).toggleClass(a.call(this,c,this.className,b),b)}:function(){if("string"===c){var b,d=0,e=m(this),f=a.match(E)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else(c===K||"boolean"===c)&&(this.className&&m._data(this,"__className__",this.className),this.className=this.className||a===!1?"":m._data(this,"__className__")||"")})},hasClass:function(a){for(var b=" "+a+" ",c=0,d=this.length;d>c;c++)if(1===this[c].nodeType&&(" "+this[c].className+" ").replace(ub," ").indexOf(b)>=0)return!0;return!1}}),m.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){m.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),m.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)}});var vb=m.now(),wb=/\?/,xb=/(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g;m.parseJSON=function(b){if(a.JSON&&a.JSON.parse)return a.JSON.parse(b+"");var c,d=null,e=m.trim(b+"");return e&&!m.trim(e.replace(xb,function(a,b,e,f){return c&&b&&(d=0),0===d?a:(c=e||b,d+=!f-!e,"")}))?Function("return "+e)():m.error("Invalid JSON: "+b)},m.parseXML=function(b){var c,d;if(!b||"string"!=typeof b)return null;try{a.DOMParser?(d=new DOMParser,c=d.parseFromString(b,"text/xml")):(c=new ActiveXObject("Microsoft.XMLDOM"),c.async="false",c.loadXML(b))}catch(e){c=void 0}return c&&c.documentElement&&!c.getElementsByTagName("parsererror").length||m.error("Invalid XML: "+b),c};var yb,zb,Ab=/#.*$/,Bb=/([?&])_=[^&]*/,Cb=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,Db=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Eb=/^(?:GET|HEAD)$/,Fb=/^\/\//,Gb=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,Hb={},Ib={},Jb="*/".concat("*");try{zb=location.href}catch(Kb){zb=y.createElement("a"),zb.href="",zb=zb.href}yb=Gb.exec(zb.toLowerCase())||[];function Lb(a){return function(b,c){"string"!=typeof b&&(c=b,b="*");var d,e=0,f=b.toLowerCase().match(E)||[];if(m.isFunction(c))while(d=f[e++])"+"===d.charAt(0)?(d=d.slice(1)||"*",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function Mb(a,b,c,d){var e={},f=a===Ib;function g(h){var i;return e[h]=!0,m.each(a[h]||[],function(a,h){var j=h(b,c,d);return"string"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e["*"]&&g("*")}function Nb(a,b){var c,d,e=m.ajaxSettings.flatOptions||{};for(d in b)void 0!==b[d]&&((e[d]?a:c||(c={}))[d]=b[d]);return c&&m.extend(!0,a,c),a}function Ob(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while("*"===i[0])i.shift(),void 0===e&&(e=a.mimeType||b.getResponseHeader("Content-Type"));if(e)for(g in h)if(h[g]&&h[g].test(e)){i.unshift(g);break}if(i[0]in c)f=i[0];else{for(g in c){if(!i[0]||a.converters[g+" "+i[0]]){f=g;break}d||(d=g)}f=f||d}return f?(f!==i[0]&&i.unshift(f),c[f]):void 0}function Pb(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if("*"===f)f=i;else if("*"!==i&&i!==f){if(g=j[i+" "+f]||j["* "+f],!g)for(e in j)if(h=e.split(" "),h[1]===f&&(g=j[i+" "+h[0]]||j["* "+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a["throws"])b=g(b);else try{b=g(b)}catch(l){return{state:"parsererror",error:g?l:"No conversion from "+i+" to "+f}}}return{state:"success",data:b}}m.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:zb,type:"GET",isLocal:Db.test(yb[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Jb,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":m.parseJSON,"text xml":m.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?Nb(Nb(a,m.ajaxSettings),b):Nb(m.ajaxSettings,a)},ajaxPrefilter:Lb(Hb),ajaxTransport:Lb(Ib),ajax:function(a,b){"object"==typeof a&&(b=a,a=void 0),b=b||{};var c,d,e,f,g,h,i,j,k=m.ajaxSetup({},b),l=k.context||k,n=k.context&&(l.nodeType||l.jquery)?m(l):m.event,o=m.Deferred(),p=m.Callbacks("once memory"),q=k.statusCode||{},r={},s={},t=0,u="canceled",v={readyState:0,getResponseHeader:function(a){var b;if(2===t){if(!j){j={};while(b=Cb.exec(f))j[b[1].toLowerCase()]=b[2]}b=j[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return 2===t?f:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return t||(a=s[c]=s[c]||a,r[a]=b),this},overrideMimeType:function(a){return t||(k.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>t)for(b in a)q[b]=[q[b],a[b]];else v.always(a[v.status]);return this},abort:function(a){var b=a||u;return i&&i.abort(b),x(0,b),this}};if(o.promise(v).complete=p.add,v.success=v.done,v.error=v.fail,k.url=((a||k.url||zb)+"").replace(Ab,"").replace(Fb,yb[1]+"//"),k.type=b.method||b.type||k.method||k.type,k.dataTypes=m.trim(k.dataType||"*").toLowerCase().match(E)||[""],null==k.crossDomain&&(c=Gb.exec(k.url.toLowerCase()),k.crossDomain=!(!c||c[1]===yb[1]&&c[2]===yb[2]&&(c[3]||("http:"===c[1]?"80":"443"))===(yb[3]||("http:"===yb[1]?"80":"443")))),k.data&&k.processData&&"string"!=typeof k.data&&(k.data=m.param(k.data,k.traditional)),Mb(Hb,k,b,v),2===t)return v;h=m.event&&k.global,h&&0===m.active++&&m.event.trigger("ajaxStart"),k.type=k.type.toUpperCase(),k.hasContent=!Eb.test(k.type),e=k.url,k.hasContent||(k.data&&(e=k.url+=(wb.test(e)?"&":"?")+k.data,delete k.data),k.cache===!1&&(k.url=Bb.test(e)?e.replace(Bb,"$1_="+vb++):e+(wb.test(e)?"&":"?")+"_="+vb++)),k.ifModified&&(m.lastModified[e]&&v.setRequestHeader("If-Modified-Since",m.lastModified[e]),m.etag[e]&&v.setRequestHeader("If-None-Match",m.etag[e])),(k.data&&k.hasContent&&k.contentType!==!1||b.contentType)&&v.setRequestHeader("Content-Type",k.contentType),v.setRequestHeader("Accept",k.dataTypes[0]&&k.accepts[k.dataTypes[0]]?k.accepts[k.dataTypes[0]]+("*"!==k.dataTypes[0]?", "+Jb+"; q=0.01":""):k.accepts["*"]);for(d in k.headers)v.setRequestHeader(d,k.headers[d]);if(k.beforeSend&&(k.beforeSend.call(l,v,k)===!1||2===t))return v.abort();u="abort";for(d in{success:1,error:1,complete:1})v[d](k[d]);if(i=Mb(Ib,k,b,v)){v.readyState=1,h&&n.trigger("ajaxSend",[v,k]),k.async&&k.timeout>0&&(g=setTimeout(function(){v.abort("timeout")},k.timeout));try{t=1,i.send(r,x)}catch(w){if(!(2>t))throw w;x(-1,w)}}else x(-1,"No Transport");function x(a,b,c,d){var j,r,s,u,w,x=b;2!==t&&(t=2,g&&clearTimeout(g),i=void 0,f=d||"",v.readyState=a>0?4:0,j=a>=200&&300>a||304===a,c&&(u=Ob(k,v,c)),u=Pb(k,u,v,j),j?(k.ifModified&&(w=v.getResponseHeader("Last-Modified"),w&&(m.lastModified[e]=w),w=v.getResponseHeader("etag"),w&&(m.etag[e]=w)),204===a||"HEAD"===k.type?x="nocontent":304===a?x="notmodified":(x=u.state,r=u.data,s=u.error,j=!s)):(s=x,(a||!x)&&(x="error",0>a&&(a=0))),v.status=a,v.statusText=(b||x)+"",j?o.resolveWith(l,[r,x,v]):o.rejectWith(l,[v,x,s]),v.statusCode(q),q=void 0,h&&n.trigger(j?"ajaxSuccess":"ajaxError",[v,k,j?r:s]),p.fireWith(l,[v,x]),h&&(n.trigger("ajaxComplete",[v,k]),--m.active||m.event.trigger("ajaxStop")))}return v},getJSON:function(a,b,c){return m.get(a,b,c,"json")},getScript:function(a,b){return m.get(a,void 0,b,"script")}}),m.each(["get","post"],function(a,b){m[b]=function(a,c,d,e){return m.isFunction(c)&&(e=e||d,d=c,c=void 0),m.ajax({url:a,type:b,dataType:e,data:c,success:d})}}),m._evalUrl=function(a){return m.ajax({url:a,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})},m.fn.extend({wrapAll:function(a){if(m.isFunction(a))return this.each(function(b){m(this).wrapAll(a.call(this,b))});if(this[0]){var b=m(a,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstChild&&1===a.firstChild.nodeType)a=a.firstChild;return a}).append(this)}return this},wrapInner:function(a){return this.each(m.isFunction(a)?function(b){m(this).wrapInner(a.call(this,b))}:function(){var b=m(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=m.isFunction(a);return this.each(function(c){m(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){m.nodeName(this,"body")||m(this).replaceWith(this.childNodes)}).end()}}),m.expr.filters.hidden=function(a){return a.offsetWidth<=0&&a.offsetHeight<=0||!k.reliableHiddenOffsets()&&"none"===(a.style&&a.style.display||m.css(a,"display"))},m.expr.filters.visible=function(a){return!m.expr.filters.hidden(a)};var Qb=/%20/g,Rb=/\[\]$/,Sb=/\r?\n/g,Tb=/^(?:submit|button|image|reset|file)$/i,Ub=/^(?:input|select|textarea|keygen)/i;function Vb(a,b,c,d){var e;if(m.isArray(b))m.each(b,function(b,e){c||Rb.test(a)?d(a,e):Vb(a+"["+("object"==typeof e?b:"")+"]",e,c,d)});else if(c||"object"!==m.type(b))d(a,b);else for(e in b)Vb(a+"["+e+"]",b[e],c,d)}m.param=function(a,b){var c,d=[],e=function(a,b){b=m.isFunction(b)?b():null==b?"":b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(void 0===b&&(b=m.ajaxSettings&&m.ajaxSettings.traditional),m.isArray(a)||a.jquery&&!m.isPlainObject(a))m.each(a,function(){e(this.name,this.value)});else for(c in a)Vb(c,a[c],b,e);return d.join("&").replace(Qb,"+")},m.fn.extend({serialize:function(){return m.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=m.prop(this,"elements");return a?m.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!m(this).is(":disabled")&&Ub.test(this.nodeName)&&!Tb.test(a)&&(this.checked||!W.test(a))}).map(function(a,b){var c=m(this).val();return null==c?null:m.isArray(c)?m.map(c,function(a){return{name:b.name,value:a.replace(Sb,"\r\n")}}):{name:b.name,value:c.replace(Sb,"\r\n")}}).get()}}),m.ajaxSettings.xhr=void 0!==a.ActiveXObject?function(){return!this.isLocal&&/^(get|post|head|put|delete|options)$/i.test(this.type)&&Zb()||$b()}:Zb;var Wb=0,Xb={},Yb=m.ajaxSettings.xhr();a.attachEvent&&a.attachEvent("onunload",function(){for(var a in Xb)Xb[a](void 0,!0)}),k.cors=!!Yb&&"withCredentials"in Yb,Yb=k.ajax=!!Yb,Yb&&m.ajaxTransport(function(a){if(!a.crossDomain||k.cors){var b;return{send:function(c,d){var e,f=a.xhr(),g=++Wb;if(f.open(a.type,a.url,a.async,a.username,a.password),a.xhrFields)for(e in a.xhrFields)f[e]=a.xhrFields[e];a.mimeType&&f.overrideMimeType&&f.overrideMimeType(a.mimeType),a.crossDomain||c["X-Requested-With"]||(c["X-Requested-With"]="XMLHttpRequest");for(e in c)void 0!==c[e]&&f.setRequestHeader(e,c[e]+"");f.send(a.hasContent&&a.data||null),b=function(c,e){var h,i,j;if(b&&(e||4===f.readyState))if(delete Xb[g],b=void 0,f.onreadystatechange=m.noop,e)4!==f.readyState&&f.abort();else{j={},h=f.status,"string"==typeof f.responseText&&(j.text=f.responseText);try{i=f.statusText}catch(k){i=""}h||!a.isLocal||a.crossDomain?1223===h&&(h=204):h=j.text?200:404}j&&d(h,i,j,f.getAllResponseHeaders())},a.async?4===f.readyState?setTimeout(b):f.onreadystatechange=Xb[g]=b:b()},abort:function(){b&&b(void 0,!0)}}}});function Zb(){try{return new a.XMLHttpRequest}catch(b){}}function $b(){try{return new a.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}m.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(a){return m.globalEval(a),a}}}),m.ajaxPrefilter("script",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type="GET",a.global=!1)}),m.ajaxTransport("script",function(a){if(a.crossDomain){var b,c=y.head||m("head")[0]||y.documentElement;return{send:function(d,e){b=y.createElement("script"),b.async=!0,a.scriptCharset&&(b.charset=a.scriptCharset),b.src=a.url,b.onload=b.onreadystatechange=function(a,c){(c||!b.readyState||/loaded|complete/.test(b.readyState))&&(b.onload=b.onreadystatechange=null,b.parentNode&&b.parentNode.removeChild(b),b=null,c||e(200,"success"))},c.insertBefore(b,c.firstChild)},abort:function(){b&&b.onload(void 0,!0)}}}});var _b=[],ac=/(=)\?(?=&|$)|\?\?/;m.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=_b.pop()||m.expando+"_"+vb++;return this[a]=!0,a}}),m.ajaxPrefilter("json jsonp",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(ac.test(b.url)?"url":"string"==typeof b.data&&!(b.contentType||"").indexOf("application/x-www-form-urlencoded")&&ac.test(b.data)&&"data");return h||"jsonp"===b.dataTypes[0]?(e=b.jsonpCallback=m.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(ac,"$1"+e):b.jsonp!==!1&&(b.url+=(wb.test(b.url)?"&":"?")+b.jsonp+"="+e),b.converters["script json"]=function(){return g||m.error(e+" was not called"),g[0]},b.dataTypes[0]="json",f=a[e],a[e]=function(){g=arguments},d.always(function(){a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,_b.push(e)),g&&m.isFunction(f)&&f(g[0]),g=f=void 0}),"script"):void 0}),m.parseHTML=function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1),b=b||y;var d=u.exec(a),e=!c&&[];return d?[b.createElement(d[1])]:(d=m.buildFragment([a],b,e),e&&e.length&&m(e).remove(),m.merge([],d.childNodes))};var bc=m.fn.load;m.fn.load=function(a,b,c){if("string"!=typeof a&&bc)return bc.apply(this,arguments);var d,e,f,g=this,h=a.indexOf(" ");return h>=0&&(d=m.trim(a.slice(h,a.length)),a=a.slice(0,h)),m.isFunction(b)?(c=b,b=void 0):b&&"object"==typeof b&&(f="POST"),g.length>0&&m.ajax({url:a,type:f,dataType:"html",data:b}).done(function(a){e=arguments,g.html(d?m("<div>").append(m.parseHTML(a)).find(d):a)}).complete(c&&function(a,b){g.each(c,e||[a.responseText,b,a])}),this},m.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(a,b){m.fn[b]=function(a){return this.on(b,a)}}),m.expr.filters.animated=function(a){return m.grep(m.timers,function(b){return a===b.elem}).length};var cc=a.document.documentElement;function dc(a){return m.isWindow(a)?a:9===a.nodeType?a.defaultView||a.parentWindow:!1}m.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=m.css(a,"position"),l=m(a),n={};"static"===k&&(a.style.position="relative"),h=l.offset(),f=m.css(a,"top"),i=m.css(a,"left"),j=("absolute"===k||"fixed"===k)&&m.inArray("auto",[f,i])>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),m.isFunction(b)&&(b=b.call(a,c,h)),null!=b.top&&(n.top=b.top-h.top+g),null!=b.left&&(n.left=b.left-h.left+e),"using"in b?b.using.call(a,n):l.css(n)}},m.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){m.offset.setOffset(this,a,b)});var b,c,d={top:0,left:0},e=this[0],f=e&&e.ownerDocument;if(f)return b=f.documentElement,m.contains(b,e)?(typeof e.getBoundingClientRect!==K&&(d=e.getBoundingClientRect()),c=dc(f),{top:d.top+(c.pageYOffset||b.scrollTop)-(b.clientTop||0),left:d.left+(c.pageXOffset||b.scrollLeft)-(b.clientLeft||0)}):d},position:function(){if(this[0]){var a,b,c={top:0,left:0},d=this[0];return"fixed"===m.css(d,"position")?b=d.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),m.nodeName(a[0],"html")||(c=a.offset()),c.top+=m.css(a[0],"borderTopWidth",!0),c.left+=m.css(a[0],"borderLeftWidth",!0)),{top:b.top-c.top-m.css(d,"marginTop",!0),left:b.left-c.left-m.css(d,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||cc;while(a&&!m.nodeName(a,"html")&&"static"===m.css(a,"position"))a=a.offsetParent;return a||cc})}}),m.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(a,b){var c=/Y/.test(b);m.fn[a]=function(d){return V(this,function(a,d,e){var f=dc(a);return void 0===e?f?b in f?f[b]:f.document.documentElement[d]:a[d]:void(f?f.scrollTo(c?m(f).scrollLeft():e,c?e:m(f).scrollTop()):a[d]=e)},a,d,arguments.length,null)}}),m.each(["top","left"],function(a,b){m.cssHooks[b]=La(k.pixelPosition,function(a,c){return c?(c=Ja(a,b),Ha.test(c)?m(a).position()[b]+"px":c):void 0})}),m.each({Height:"height",Width:"width"},function(a,b){m.each({padding:"inner"+a,content:b,"":"outer"+a},function(c,d){m.fn[d]=function(d,e){var f=arguments.length&&(c||"boolean"!=typeof d),g=c||(d===!0||e===!0?"margin":"border");return V(this,function(b,c,d){var e;return m.isWindow(b)?b.document.documentElement["client"+a]:9===b.nodeType?(e=b.documentElement,Math.max(b.body["scroll"+a],e["scroll"+a],b.body["offset"+a],e["offset"+a],e["client"+a])):void 0===d?m.css(b,c,g):m.style(b,c,d,g)},b,f?d:void 0,f,null)}})}),m.fn.size=function(){return this.length},m.fn.andSelf=m.fn.addBack,"function"==typeof define&&define.amd&&define("jquery",[],function(){return m});var ec=a.jQuery,fc=a.$;return m.noConflict=function(b){return a.$===m&&(a.$=fc),b&&a.jQuery===m&&(a.jQuery=ec),m},typeof b===K&&(a.jQuery=a.$=m),m});
 
 
/*!
 * jQuery Migrate - v1.2.1 - 2013-05-08
 * https://github.com/jquery/jquery-migrate
 * Copyright 2005, 2013 jQuery Foundation, Inc. and other contributors; Licensed MIT
 */
(function (jQuery, window, undefined) {
	// See http://bugs.jquery.com/ticket/13335
	// "use strict";


	var warnedAbout = {};

	// List of warnings already given; public read only
	jQuery.migrateWarnings = [];

	// Set to true to prevent console output; migrateWarnings still maintained
	// jQuery.migrateMute = false;

	// Show a message on the console so devs know we're active
	if (!jQuery.migrateMute && window.console && window.console.log) {
		window.console.log("JQMIGRATE: Logging is active");
	}

	// Set to false to disable traces that appear with warnings
	if (jQuery.migrateTrace === undefined) {
		jQuery.migrateTrace = true;
	}

	// Forget any warnings we've already given; public
	jQuery.migrateReset = function () {
		warnedAbout = {};
		jQuery.migrateWarnings.length = 0;
	};

	function migrateWarn(msg) {
		var console = window.console;
		if (!warnedAbout[msg]) {
			warnedAbout[msg] = true;
			jQuery.migrateWarnings.push(msg);
			if (console && console.warn && !jQuery.migrateMute) {
				console.warn("JQMIGRATE: " + msg);
				if (jQuery.migrateTrace && console.trace) {
					console.trace();
				}
			}
		}
	}

	function migrateWarnProp(obj, prop, value, msg) {
		if (Object.defineProperty) {
			// On ES5 browsers (non-oldIE), warn if the code tries to get prop;
			// allow property to be overwritten in case some other plugin wants it
			try {
				Object.defineProperty(obj, prop, {
					configurable: true,
					enumerable: true,
					get: function () {
						migrateWarn(msg);
						return value;
					},
					set: function (newValue) {
						migrateWarn(msg);
						value = newValue;
					}
				});
				return;
			} catch (err) {
				// IE8 is a dope about Object.defineProperty, can't warn there
			}
		}

		// Non-ES5 (or broken) browser; just set the property
		jQuery._definePropertyBroken = true;
		obj[prop] = value;
	}

	if (document.compatMode === "BackCompat") {
		// jQuery has never supported or tested Quirks Mode
		migrateWarn("jQuery is not compatible with Quirks Mode");
	}


	var attrFn = jQuery("<input/>", { size: 1 }).attr("size") && jQuery.attrFn,
		oldAttr = jQuery.attr,
		valueAttrGet = jQuery.attrHooks.value && jQuery.attrHooks.value.get ||
			function () { return null; },
		valueAttrSet = jQuery.attrHooks.value && jQuery.attrHooks.value.set ||
			function () { return undefined; },
		rnoType = /^(?:input|button)$/i,
		rnoAttrNodeType = /^[238]$/,
		rboolean = /^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,
		ruseDefault = /^(?:checked|selected)$/i;

	// jQuery.attrFn
	migrateWarnProp(jQuery, "attrFn", attrFn || {}, "jQuery.attrFn is deprecated");

	jQuery.attr = function (elem, name, value, pass) {
		var lowerName = name.toLowerCase(),
			nType = elem && elem.nodeType;

		if (pass) {
			// Since pass is used internally, we only warn for new jQuery
			// versions where there isn't a pass arg in the formal params
			if (oldAttr.length < 4) {
				migrateWarn("jQuery.fn.attr( props, pass ) is deprecated");
			}
			if (elem && !rnoAttrNodeType.test(nType) &&
				(attrFn ? name in attrFn : jQuery.isFunction(jQuery.fn[name]))) {
				return jQuery(elem)[name](value);
			}
		}

		// Warn if user tries to set `type`, since it breaks on IE 6/7/8; by checking
		// for disconnected elements we don't warn on $( "<button>", { type: "button" } ).
		if (name === "type" && value !== undefined && rnoType.test(elem.nodeName) && elem.parentNode) {
			migrateWarn("Can't change the 'type' of an input or button in IE 6/7/8");
		}

		// Restore boolHook for boolean property/attribute synchronization
		if (!jQuery.attrHooks[lowerName] && rboolean.test(lowerName)) {
			jQuery.attrHooks[lowerName] = {
				get: function (elem, name) {
					// Align boolean attributes with corresponding properties
					// Fall back to attribute presence where some booleans are not supported
					var attrNode,
						property = jQuery.prop(elem, name);
					return property === true || typeof property !== "boolean" &&
						(attrNode = elem.getAttributeNode(name)) && attrNode.nodeValue !== false ?

						name.toLowerCase() :
						undefined;
				},
				set: function (elem, value, name) {
					var propName;
					if (value === false) {
						// Remove boolean attributes when set to false
						jQuery.removeAttr(elem, name);
					} else {
						// value is true since we know at this point it's type boolean and not false
						// Set boolean attributes to the same name and set the DOM property
						propName = jQuery.propFix[name] || name;
						if (propName in elem) {
							// Only set the IDL specifically if it already exists on the element
							elem[propName] = true;
						}

						elem.setAttribute(name, name.toLowerCase());
					}
					return name;
				}
			};

			// Warn only for attributes that can remain distinct from their properties post-1.9
			if (ruseDefault.test(lowerName)) {
				migrateWarn("jQuery.fn.attr('" + lowerName + "') may use property instead of attribute");
			}
		}

		return oldAttr.call(jQuery, elem, name, value);
	};

	// attrHooks: value
	jQuery.attrHooks.value = {
		get: function (elem, name) {
			var nodeName = (elem.nodeName || "").toLowerCase();
			if (nodeName === "button") {
				return valueAttrGet.apply(this, arguments);
			}
			if (nodeName !== "input" && nodeName !== "option") {
				migrateWarn("jQuery.fn.attr('value') no longer gets properties");
			}
			return name in elem ?
				elem.value :
				null;
		},
		set: function (elem, value) {
			var nodeName = (elem.nodeName || "").toLowerCase();
			if (nodeName === "button") {
				return valueAttrSet.apply(this, arguments);
			}
			if (nodeName !== "input" && nodeName !== "option") {
				migrateWarn("jQuery.fn.attr('value', val) no longer sets properties");
			}
			// Does not return so that setAttribute is also used
			elem.value = value;
		}
	};


	var matched, browser,
		oldInit = jQuery.fn.init,
		oldParseJSON = jQuery.parseJSON,
		// Note: XSS check is done below after string is trimmed
		rquickExpr = /^([^<]*)(<[\w\W]+>)([^>]*)$/;

	// $(html) "looks like html" rule change
	jQuery.fn.init = function (selector, context, rootjQuery) {
		var match;

		if (selector && typeof selector === "string" && !jQuery.isPlainObject(context) &&
				(match = rquickExpr.exec(jQuery.trim(selector))) && match[0]) {
			// This is an HTML string according to the "old" rules; is it still?
			if (selector.charAt(0) !== "<") {
				migrateWarn("$(html) HTML strings must start with '<' character");
			}
			if (match[3]) {
				migrateWarn("$(html) HTML text after last tag is ignored");
			}
			// Consistently reject any HTML-like string starting with a hash (#9521)
			// Note that this may break jQuery 1.6.x code that otherwise would work.
			if (match[0].charAt(0) === "#") {
				migrateWarn("HTML string cannot start with a '#' character");
				jQuery.error("JQMIGRATE: Invalid selector string (XSS)");
			}
			// Now process using loose rules; let pre-1.8 play too
			if (context && context.context) {
				// jQuery object as context; parseHTML expects a DOM object
				context = context.context;
			}
			if (jQuery.parseHTML) {
				return oldInit.call(this, jQuery.parseHTML(match[2], context, true),
						context, rootjQuery);
			}
		}
		return oldInit.apply(this, arguments);
	};
	jQuery.fn.init.prototype = jQuery.fn;

	// Let $.parseJSON(falsy_value) return null
	jQuery.parseJSON = function (json) {
		if (!json && json !== null) {
			migrateWarn("jQuery.parseJSON requires a valid JSON string");
			return null;
		}
		return oldParseJSON.apply(this, arguments);
	};

	jQuery.uaMatch = function (ua) {
		ua = ua.toLowerCase();

		var match = /(chrome)[ \/]([\w.]+)/.exec(ua) ||
			/(webkit)[ \/]([\w.]+)/.exec(ua) ||
			/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua) ||
			/(msie) ([\w.]+)/.exec(ua) ||
			ua.indexOf("compatible") < 0 && /(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua) ||
			[];

		return {
			browser: match[1] || "",
			version: match[2] || "0"
		};
	};

	// Don't clobber any existing jQuery.browser in case it's different
	if (!jQuery.browser) {
		matched = jQuery.uaMatch(navigator.userAgent);
		browser = {};

		if (matched.browser) {
			browser[matched.browser] = true;
			browser.version = matched.version;
		}

		// Chrome is Webkit, but Webkit is also Safari.
		if (browser.chrome) {
			browser.webkit = true;
		} else if (browser.webkit) {
			browser.safari = true;
		}

		jQuery.browser = browser;
	}

	// Warn if the code tries to get jQuery.browser
	migrateWarnProp(jQuery, "browser", jQuery.browser, "jQuery.browser is deprecated");

	jQuery.sub = function () {
		function jQuerySub(selector, context) {
			return new jQuerySub.fn.init(selector, context);
		}
		jQuery.extend(true, jQuerySub, this);
		jQuerySub.superclass = this;
		jQuerySub.fn = jQuerySub.prototype = this();
		jQuerySub.fn.constructor = jQuerySub;
		jQuerySub.sub = this.sub;
		jQuerySub.fn.init = function init(selector, context) {
			if (context && context instanceof jQuery && !(context instanceof jQuerySub)) {
				context = jQuerySub(context);
			}

			return jQuery.fn.init.call(this, selector, context, rootjQuerySub);
		};
		jQuerySub.fn.init.prototype = jQuerySub.fn;
		var rootjQuerySub = jQuerySub(document);
		migrateWarn("jQuery.sub() is deprecated");
		return jQuerySub;
	};


	// Ensure that $.ajax gets the new parseJSON defined in core.js
	jQuery.ajaxSetup({
		converters: {
			"text json": jQuery.parseJSON
		}
	});


	var oldFnData = jQuery.fn.data;

	jQuery.fn.data = function (name) {
		var ret, evt,
			elem = this[0];

		// Handles 1.7 which has this behavior and 1.8 which doesn't
		if (elem && name === "events" && arguments.length === 1) {
			ret = jQuery.data(elem, name);
			evt = jQuery._data(elem, name);
			if ((ret === undefined || ret === evt) && evt !== undefined) {
				migrateWarn("Use of jQuery.fn.data('events') is deprecated");
				return evt;
			}
		}
		return oldFnData.apply(this, arguments);
	};


	var rscriptType = /\/(java|ecma)script/i,
		oldSelf = jQuery.fn.andSelf || jQuery.fn.addBack;

	jQuery.fn.andSelf = function () {
		migrateWarn("jQuery.fn.andSelf() replaced by jQuery.fn.addBack()");
		return oldSelf.apply(this, arguments);
	};

	// Since jQuery.clean is used internally on older versions, we only shim if it's missing
	if (!jQuery.clean) {
		jQuery.clean = function (elems, context, fragment, scripts) {
			// Set context per 1.8 logic
			context = context || document;
			context = !context.nodeType && context[0] || context;
			context = context.ownerDocument || context;

			migrateWarn("jQuery.clean() is deprecated");

			var i, elem, handleScript, jsTags,
				ret = [];

			jQuery.merge(ret, jQuery.buildFragment(elems, context).childNodes);

			// Complex logic lifted directly from jQuery 1.8
			if (fragment) {
				// Special handling of each script element
				handleScript = function (elem) {
					// Check if we consider it executable
					if (!elem.type || rscriptType.test(elem.type)) {
						// Detach the script and store it in the scripts array (if provided) or the fragment
						// Return truthy to indicate that it has been handled
						return scripts ?
							scripts.push(elem.parentNode ? elem.parentNode.removeChild(elem) : elem) :
							fragment.appendChild(elem);
					}
				};

				for (i = 0; (elem = ret[i]) != null; i++) {
					// Check if we're done after handling an executable script
					if (!(jQuery.nodeName(elem, "script") && handleScript(elem))) {
						// Append to fragment and handle embedded scripts
						fragment.appendChild(elem);
						if (typeof elem.getElementsByTagName !== "undefined") {
							// handleScript alters the DOM, so use jQuery.merge to ensure snapshot iteration
							jsTags = jQuery.grep(jQuery.merge([], elem.getElementsByTagName("script")), handleScript);

							// Splice the scripts into ret after their former ancestor and advance our index beyond them
							ret.splice.apply(ret, [i + 1, 0].concat(jsTags));
							i += jsTags.length;
						}
					}
				}
			}

			return ret;
		};
	}

	var eventAdd = jQuery.event.add,
		eventRemove = jQuery.event.remove,
		eventTrigger = jQuery.event.trigger,
		oldToggle = jQuery.fn.toggle,
		oldLive = jQuery.fn.live,
		oldDie = jQuery.fn.die,
		ajaxEvents = "ajaxStart|ajaxStop|ajaxSend|ajaxComplete|ajaxError|ajaxSuccess",
		rajaxEvent = new RegExp("\\b(?:" + ajaxEvents + ")\\b"),
		rhoverHack = /(?:^|\s)hover(\.\S+|)\b/,
		hoverHack = function (events) {
			if (typeof (events) !== "string" || jQuery.event.special.hover) {
				return events;
			}
			if (rhoverHack.test(events)) {
				migrateWarn("'hover' pseudo-event is deprecated, use 'mouseenter mouseleave'");
			}
			return events && events.replace(rhoverHack, "mouseenter$1 mouseleave$1");
		};

	// Event props removed in 1.9, put them back if needed; no practical way to warn them
	if (jQuery.event.props && jQuery.event.props[0] !== "attrChange") {
		jQuery.event.props.unshift("attrChange", "attrName", "relatedNode", "srcElement");
	}

	// Undocumented jQuery.event.handle was "deprecated" in jQuery 1.7
	if (jQuery.event.dispatch) {
		migrateWarnProp(jQuery.event, "handle", jQuery.event.dispatch, "jQuery.event.handle is undocumented and deprecated");
	}

	// Support for 'hover' pseudo-event and ajax event warnings
	jQuery.event.add = function (elem, types, handler, data, selector) {
		if (elem !== document && rajaxEvent.test(types)) {
			migrateWarn("AJAX events should be attached to document: " + types);
		}
		eventAdd.call(this, elem, hoverHack(types || ""), handler, data, selector);
	};
	jQuery.event.remove = function (elem, types, handler, selector, mappedTypes) {
		eventRemove.call(this, elem, hoverHack(types) || "", handler, selector, mappedTypes);
	};

	jQuery.fn.error = function () {
		var args = Array.prototype.slice.call(arguments, 0);
		migrateWarn("jQuery.fn.error() is deprecated");
		args.splice(0, 0, "error");
		if (arguments.length) {
			return this.bind.apply(this, args);
		}
		// error event should not bubble to window, although it does pre-1.7
		this.triggerHandler.apply(this, args);
		return this;
	};

	jQuery.fn.toggle = function (fn, fn2) {

		// Don't mess with animation or css toggles
		if (!jQuery.isFunction(fn) || !jQuery.isFunction(fn2)) {
			return oldToggle.apply(this, arguments);
		}
		migrateWarn("jQuery.fn.toggle(handler, handler...) is deprecated");

		// Save reference to arguments for access in closure
		var args = arguments,
			guid = fn.guid || jQuery.guid++,
			i = 0,
			toggler = function (event) {
				// Figure out which function to execute
				var lastToggle = (jQuery._data(this, "lastToggle" + fn.guid) || 0) % i;
				jQuery._data(this, "lastToggle" + fn.guid, lastToggle + 1);

				// Make sure that clicks stop
				event.preventDefault();

				// and execute the function
				return args[lastToggle].apply(this, arguments) || false;
			};

		// link all the functions, so any of them can unbind this click handler
		toggler.guid = guid;
		while (i < args.length) {
			args[i++].guid = guid;
		}

		return this.click(toggler);
	};

	jQuery.fn.live = function (types, data, fn) {
		migrateWarn("jQuery.fn.live() is deprecated");
		if (oldLive) {
			return oldLive.apply(this, arguments);
		}
		jQuery(this.context).on(types, this.selector, data, fn);
		return this;
	};

	jQuery.fn.die = function (types, fn) {
		migrateWarn("jQuery.fn.die() is deprecated");
		if (oldDie) {
			return oldDie.apply(this, arguments);
		}
		jQuery(this.context).off(types, this.selector || "**", fn);
		return this;
	};

	// Turn global events into document-triggered events
	jQuery.event.trigger = function (event, data, elem, onlyHandlers) {
		if (!elem && !rajaxEvent.test(event)) {
			migrateWarn("Global events are undocumented and deprecated");
		}
		return eventTrigger.call(this, event, data, elem || document, onlyHandlers);
	};
	jQuery.each(ajaxEvents.split("|"),
		function (_, name) {
			jQuery.event.special[name] = {
				setup: function () {
					var elem = this;

					// The document needs no shimming; must be !== for oldIE
					if (elem !== document) {
						jQuery.event.add(document, name + "." + jQuery.guid, function () {
							jQuery.event.trigger(name, null, elem, true);
						});
						jQuery._data(this, name, jQuery.guid++);
					}
					return false;
				},
				teardown: function () {
					if (this !== document) {
						jQuery.event.remove(document, name + "." + jQuery._data(this, name));
					}
					return false;
				}
			};
		}
	);


})(jQuery, window); 
 
/*
    http://www.JSON.org/json2.js
    2011-02-23

    Public Domain.

    NO WARRANTY EXPRESSED OR IMPLIED. USE AT YOUR OWN RISK.

    See http://www.JSON.org/js.html


    This code should be minified before deployment.
    See http://javascript.crockford.com/jsmin.html

    USE YOUR OWN COPY. IT IS EXTREMELY UNWISE TO LOAD CODE FROM SERVERS YOU DO
    NOT CONTROL.


    This file creates a global JSON object containing two methods: stringify
    and parse.

        JSON.stringify(value, replacer, space)
            value       any JavaScript value, usually an object or array.

            replacer    an optional parameter that determines how object
                        values are stringified for objects. It can be a
                        function or an array of strings.

            space       an optional parameter that specifies the indentation
                        of nested structures. If it is omitted, the text will
                        be packed without extra whitespace. If it is a number,
                        it will specify the number of spaces to indent at each
                        level. If it is a string (such as '\t' or '&nbsp;'),
                        it contains the characters used to indent at each level.

            This method produces a JSON text from a JavaScript value.

            When an object value is found, if the object contains a toJSON
            method, its toJSON method will be called and the result will be
            stringified. A toJSON method does not serialize: it returns the
            value represented by the name/value pair that should be serialized,
            or undefined if nothing should be serialized. The toJSON method
            will be passed the key associated with the value, and this will be
            bound to the value

            For example, this would serialize Dates as ISO strings.

                Date.prototype.toJSON = function (key) {
                    function f(n) {
                        // Format integers to have at least two digits.
                        return n < 10 ? '0' + n : n;
                    }

                    return this.getUTCFullYear()   + '-' +
                         f(this.getUTCMonth() + 1) + '-' +
                         f(this.getUTCDate())      + 'T' +
                         f(this.getUTCHours())     + ':' +
                         f(this.getUTCMinutes())   + ':' +
                         f(this.getUTCSeconds())   + 'Z';
                };

            You can provide an optional replacer method. It will be passed the
            key and value of each member, with this bound to the containing
            object. The value that is returned from your method will be
            serialized. If your method returns undefined, then the member will
            be excluded from the serialization.

            If the replacer parameter is an array of strings, then it will be
            used to select the members to be serialized. It filters the results
            such that only members with keys listed in the replacer array are
            stringified.

            Values that do not have JSON representations, such as undefined or
            functions, will not be serialized. Such values in objects will be
            dropped; in arrays they will be replaced with null. You can use
            a replacer function to replace those with JSON values.
            JSON.stringify(undefined) returns undefined.

            The optional space parameter produces a stringification of the
            value that is filled with line breaks and indentation to make it
            easier to read.

            If the space parameter is a non-empty string, then that string will
            be used for indentation. If the space parameter is a number, then
            the indentation will be that many spaces.

            Example:

            text = JSON.stringify(['e', {pluribus: 'unum'}]);
            // text is '["e",{"pluribus":"unum"}]'


            text = JSON.stringify(['e', {pluribus: 'unum'}], null, '\t');
            // text is '[\n\t"e",\n\t{\n\t\t"pluribus": "unum"\n\t}\n]'

            text = JSON.stringify([new Date()], function (key, value) {
                return this[key] instanceof Date ?
                    'Date(' + this[key] + ')' : value;
            });
            // text is '["Date(---current time---)"]'


        JSON.parse(text, reviver)
            This method parses a JSON text to produce an object or array.
            It can throw a SyntaxError exception.

            The optional reviver parameter is a function that can filter and
            transform the results. It receives each of the keys and values,
            and its return value is used instead of the original value.
            If it returns what it received, then the structure is not modified.
            If it returns undefined then the member is deleted.

            Example:

            // Parse the text. Values that look like ISO date strings will
            // be converted to Date objects.

            myData = JSON.parse(text, function (key, value) {
                var a;
                if (typeof value === 'string') {
                    a =
/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(value);
                    if (a) {
                        return new Date(Date.UTC(+a[1], +a[2] - 1, +a[3], +a[4],
                            +a[5], +a[6]));
                    }
                }
                return value;
            });

            myData = JSON.parse('["Date(09/09/2001)"]', function (key, value) {
                var d;
                if (typeof value === 'string' &&
                        value.slice(0, 5) === 'Date(' &&
                        value.slice(-1) === ')') {
                    d = new Date(value.slice(5, -1));
                    if (d) {
                        return d;
                    }
                }
                return value;
            });


    This is a reference implementation. You are free to copy, modify, or
    redistribute.
*/

/*jslint evil: true, strict: false, regexp: false */

/*members "", "\b", "\t", "\n", "\f", "\r", "\"", JSON, "\\", apply,
    call, charCodeAt, getUTCDate, getUTCFullYear, getUTCHours,
    getUTCMinutes, getUTCMonth, getUTCSeconds, hasOwnProperty, join,
    lastIndex, length, parse, prototype, push, replace, slice, stringify,
    test, toJSON, toString, valueOf
*/


// Create a JSON object only if one does not already exist. We create the
// methods in a closure to avoid creating global variables.

var JSON;
if (!JSON) {
    JSON = {};
}

(function () {
    "use strict";

    function f(n) {
        // Format integers to have at least two digits.
        return n < 10 ? '0' + n : n;
    }

    if (typeof Date.prototype.toJSON !== 'function') {

        Date.prototype.toJSON = function (key) {

            return isFinite(this.valueOf()) ?
                this.getUTCFullYear()     + '-' +
                f(this.getUTCMonth() + 1) + '-' +
                f(this.getUTCDate())      + 'T' +
                f(this.getUTCHours())     + ':' +
                f(this.getUTCMinutes())   + ':' +
                f(this.getUTCSeconds())   + 'Z' : null;
        };

        String.prototype.toJSON      =
            Number.prototype.toJSON  =
            Boolean.prototype.toJSON = function (key) {
                return this.valueOf();
            };
    }

    var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
        escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
        gap,
        indent,
        meta = {    // table of character substitutions
            '\b': '\\b',
            '\t': '\\t',
            '\n': '\\n',
            '\f': '\\f',
            '\r': '\\r',
            '"' : '\\"',
            '\\': '\\\\'
        },
        rep;


    function quote(string) {

// If the string contains no control characters, no quote characters, and no
// backslash characters, then we can safely slap some quotes around it.
// Otherwise we must also replace the offending characters with safe escape
// sequences.

        escapable.lastIndex = 0;
        return escapable.test(string) ? '"' + string.replace(escapable, function (a) {
            var c = meta[a];
            return typeof c === 'string' ? c :
                '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
        }) + '"' : '"' + string + '"';
    }


    function str(key, holder) {

// Produce a string from holder[key].

        var i,          // The loop counter.
            k,          // The member key.
            v,          // The member value.
            length,
            mind = gap,
            partial,
            value = holder[key];

// If the value has a toJSON method, call it to obtain a replacement value.

        if (value && typeof value === 'object' &&
                typeof value.toJSON === 'function') {
            value = value.toJSON(key);
        }

// If we were called with a replacer function, then call the replacer to
// obtain a replacement value.

        if (typeof rep === 'function') {
            value = rep.call(holder, key, value);
        }

// What happens next depends on the value's type.

        switch (typeof value) {
        case 'string':
            return quote(value);

        case 'number':

// JSON numbers must be finite. Encode non-finite numbers as null.

            return isFinite(value) ? String(value) : 'null';

        case 'boolean':
        case 'null':

// If the value is a boolean or null, convert it to a string. Note:
// typeof null does not produce 'null'. The case is included here in
// the remote chance that this gets fixed someday.

            return String(value);

// If the type is 'object', we might be dealing with an object or an array or
// null.

        case 'object':

// Due to a specification blunder in ECMAScript, typeof null is 'object',
// so watch out for that case.

            if (!value) {
                return 'null';
            }

// Make an array to hold the partial results of stringifying this object value.

            gap += indent;
            partial = [];

// Is the value an array?

            if (Object.prototype.toString.apply(value) === '[object Array]') {

// The value is an array. Stringify every element. Use null as a placeholder
// for non-JSON values.

                length = value.length;
                for (i = 0; i < length; i += 1) {
                    partial[i] = str(i, value) || 'null';
                }

// Join all of the elements together, separated with commas, and wrap them in
// brackets.

                v = partial.length === 0 ? '[]' : gap ?
                    '[\n' + gap + partial.join(',\n' + gap) + '\n' + mind + ']' :
                    '[' + partial.join(',') + ']';
                gap = mind;
                return v;
            }

// If the replacer is an array, use it to select the members to be stringified.

            if (rep && typeof rep === 'object') {
                length = rep.length;
                for (i = 0; i < length; i += 1) {
                    if (typeof rep[i] === 'string') {
                        k = rep[i];
                        v = str(k, value);
                        if (v) {
                            partial.push(quote(k) + (gap ? ': ' : ':') + v);
                        }
                    }
                }
            } else {

// Otherwise, iterate through all of the keys in the object.

                for (k in value) {
                    if (Object.prototype.hasOwnProperty.call(value, k)) {
                        v = str(k, value);
                        if (v) {
                            partial.push(quote(k) + (gap ? ': ' : ':') + v);
                        }
                    }
                }
            }

// Join all of the member texts together, separated with commas,
// and wrap them in braces.

            v = partial.length === 0 ? '{}' : gap ?
                '{\n' + gap + partial.join(',\n' + gap) + '\n' + mind + '}' :
                '{' + partial.join(',') + '}';
            gap = mind;
            return v;
        }
    }

// If the JSON object does not yet have a stringify method, give it one.

    if (typeof JSON.stringify !== 'function') {
        JSON.stringify = function (value, replacer, space) {

// The stringify method takes a value and an optional replacer, and an optional
// space parameter, and returns a JSON text. The replacer can be a function
// that can replace values, or an array of strings that will select the keys.
// A default replacer method can be provided. Use of the space parameter can
// produce text that is more easily readable.

            var i;
            gap = '';
            indent = '';

// If the space parameter is a number, make an indent string containing that
// many spaces.

            if (typeof space === 'number') {
                for (i = 0; i < space; i += 1) {
                    indent += ' ';
                }

// If the space parameter is a string, it will be used as the indent string.

            } else if (typeof space === 'string') {
                indent = space;
            }

// If there is a replacer, it must be a function or an array.
// Otherwise, throw an error.

            rep = replacer;
            if (replacer && typeof replacer !== 'function' &&
                    (typeof replacer !== 'object' ||
                    typeof replacer.length !== 'number')) {
                throw new Error('JSON.stringify');
            }

// Make a fake root object containing our value under the key of ''.
// Return the result of stringifying the value.

            return str('', {'': value});
        };
    }


// If the JSON object does not yet have a parse method, give it one.

    if (typeof JSON.parse !== 'function') {
        JSON.parse = function (text, reviver) {

// The parse method takes a text and an optional reviver function, and returns
// a JavaScript value if the text is a valid JSON text.

            var j;

            function walk(holder, key) {

// The walk method is used to recursively walk the resulting structure so
// that modifications can be made.

                var k, v, value = holder[key];
                if (value && typeof value === 'object') {
                    for (k in value) {
                        if (Object.prototype.hasOwnProperty.call(value, k)) {
                            v = walk(value, k);
                            if (v !== undefined) {
                                value[k] = v;
                            } else {
                                delete value[k];
                            }
                        }
                    }
                }
                return reviver.call(holder, key, value);
            }


// Parsing happens in four stages. In the first stage, we replace certain
// Unicode characters with escape sequences. JavaScript handles many characters
// incorrectly, either silently deleting them, or treating them as line endings.

            text = String(text);
            cx.lastIndex = 0;
            if (cx.test(text)) {
                text = text.replace(cx, function (a) {
                    return '\\u' +
                        ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
                });
            }

// In the second stage, we run the text against regular expressions that look
// for non-JSON patterns. We are especially concerned with '()' and 'new'
// because they can cause invocation, and '=' because it can cause mutation.
// But just to be safe, we want to reject all unexpected forms.

// We split the second stage into 4 regexp operations in order to work around
// crippling inefficiencies in IE's and Safari's regexp engines. First we
// replace the JSON backslash pairs with '@' (a non-JSON character). Second, we
// replace all simple value tokens with ']' characters. Third, we delete all
// open brackets that follow a colon or comma or that begin the text. Finally,
// we look to see that the remaining characters are only whitespace or ']' or
// ',' or ':' or '{' or '}'. If that is so, then the text is safe for eval.

            if (/^[\],:{}\s]*$/
                    .test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, '@')
                        .replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']')
                        .replace(/(?:^|:|,)(?:\s*\[)+/g, ''))) {

// In the third stage we use the eval function to compile the text into a
// JavaScript structure. The '{' operator is subject to a syntactic ambiguity
// in JavaScript: it can begin a block or an object literal. We wrap the text
// in parens to eliminate the ambiguity.

                j = eval('(' + text + ')');

// In the optional fourth stage, we recursively walk the new structure, passing
// each name/value pair to a reviver function for possible transformation.

                return typeof reviver === 'function' ?
                    walk({'': j}, '') : j;
            }

// If the text is not JSON parseable, then a SyntaxError is thrown.

            throw new SyntaxError('JSON.parse');
        };
    }
}());
 
 
/*
Base.js, version 1.1a
Copyright 2006-2010, Dean Edwards
License: http://www.opensource.org/licenses/mit-license.php
*/

var Base = function () {
	// dummy
};

Base.extend = function (_instance, _static) { // subclass
	var extend = Base.prototype.extend;

	// build the prototype
	Base._prototyping = true;
	var proto = new this;
	extend.call(proto, _instance);
	proto.base = function () {
		// call this method from any other method to invoke that method's ancestor
	};
	delete Base._prototyping;

	// create the wrapper for the constructor function
	//var constructor = proto.constructor.valueOf(); //-dean
	var constructor = proto.constructor;
	var klass = proto.constructor = function () {
		if (!Base._prototyping) {
			if (this._constructing || this.constructor == klass) { // instantiation
				this._constructing = true;
				constructor.apply(this, arguments);
				delete this._constructing;
			} else if (arguments[0] != null) { // casting
				return (arguments[0].extend || extend).call(arguments[0], proto);
			}
		}
	};

	// build the class interface
	klass.ancestor = this;
	klass.extend = this.extend;
	klass.forEach = this.forEach;
	klass.implement = this.implement;
	klass.prototype = proto;
	klass.toString = this.toString;
	klass.valueOf = function (type) {
		//return (type == "object") ? klass : constructor; //-dean
		return (type == "object") ? klass : constructor.valueOf();
	};
	extend.call(klass, _static);
	// class initialisation
	if (typeof klass.init == "function") klass.init();
	return klass;
};

Base.prototype = {
	extend: function (source, value) {
		if (arguments.length > 1) { // extending with a name/value pair
			var ancestor = this[source];
			if (ancestor && (typeof value == "function") && // overriding a method?
			// the valueOf() comparison is to avoid circular references
				(!ancestor.valueOf || ancestor.valueOf() != value.valueOf()) &&
				/\bbase\b/.test(value)) {
				// get the underlying method
				var method = value.valueOf();
				// override
				value = function () {
					var previous = this.base || Base.prototype.base;
					this.base = ancestor;
					var returnValue = method.apply(this, arguments);
					this.base = previous;
					return returnValue;
				};
				// point to the underlying method
				value.valueOf = function (type) {
					return (type == "object") ? value : method;
				};
				value.toString = Base.toString;
			}
			this[source] = value;
		} else if (source) { // extending with an object literal
			var extend = Base.prototype.extend;
			// if this object has a customised extend method then use it
			if (!Base._prototyping && typeof this != "function") {
				extend = this.extend || extend;
			}
			var proto = { toSource: null };
			// do the "toString" and other methods manually
			var hidden = ["constructor", "toString", "valueOf"];
			// if we are prototyping then include the constructor
			var i = Base._prototyping ? 0 : 1;
			while (key = hidden[i++]) {
				if (source[key] != proto[key]) {
					extend.call(this, key, source[key]);

				}
			}
			// copy each of the source object's properties to this object
			for (var key in source) {
				if (!proto[key]) extend.call(this, key, source[key]);
			}
		}
		return this;
	}
};

// initialise
Base = Base.extend({
	constructor: function () {
		this.extend(arguments[0]);
	}
}, {
	ancestor: Object,
	version: "1.1",

	forEach: function (object, block, context) {
		for (var key in object) {
			if (this.prototype[key] === undefined) {
				block.call(context, object[key], key, object);
			}
		}
	},

	implement: function () {
		for (var i = 0; i < arguments.length; i++) {
			if (typeof arguments[i] == "function") {
				// if it's a function, call it
				arguments[i](this.prototype);
			} else {
				// add the interface using the extend method
				this.prototype.extend(arguments[i]);
			}
		}
		return this;
	},

	toString: function () {
		return String(this.valueOf());
	}
});
 
 
/*
 * Facebox (for jQuery)
 * version: 1.2 (05/05/2008)
 * @requires jQuery v1.2 or later
 *
 * Examples at http://famspam.com/facebox/
 *
 * Licensed under the MIT:
 *   http://www.opensource.org/licenses/mit-license.php
 *
 * Copyright 2007, 2008 Chris Wanstrath [ chris@ozmm.org ]
 *
 * Usage:
 *  
 *  jQuery(document).ready(function() {
 *    jQuery('a[rel*=facebox]').facebox() 
 *  })
 *
 *  <a href="#terms" rel="facebox">Terms</a>
 *    Loads the #terms div in the box
 *
 *  <a href="terms.html" rel="facebox">Terms</a>
 *    Loads the terms.html page in the box
 *
 *  <a href="terms.png" rel="facebox">Terms</a>
 *    Loads the terms.png image in the box
 *
 *
 *  You can also use it programmatically:
 * 
 *    jQuery.facebox('some html')
 *
 *  The above will open a facebox with "some html" as the content.
 *    
 *    jQuery.facebox(function($) { 
 *      $.get('blah.html', function(data) { $.facebox(data) })
 *    })
 *
 *  The above will show a loading screen before the passed function is called,
 *  allowing for a better ajaxy experience.
 *
 *  The facebox function can also display an ajax page or image:
 *  
 *    jQuery.facebox({ ajax: 'remote.html' })
 *    jQuery.facebox({ image: 'dude.jpg' })
 *
 *  Want to close the facebox?  Trigger the 'close.facebox' document event:
 *
 *    jQuery(document).trigger('close.facebox')
 *
 *  Facebox also has a bunch of other hooks:
 *
 *    loading.facebox
 *    beforeReveal.facebox
 *    reveal.facebox (aliased as 'afterReveal.facebox')
 *    init.facebox
 *
 *  Simply bind a function to any of these hooks:
 *
 *   $(document).bind('reveal.facebox', function() { ...stuff to do after the facebox and contents are revealed... })
 *
 */
(function ($) {
	$.facebox = function (data, klass, id) {
		var undefined;
		if (id == undefined) {
			ts = new Date()
			ts = ts.getTime()
			id = "facebox" + ts
		}
		$.facebox.settings.id = id;
		$.facebox.loading();


		if (data.ajax) fillFaceboxFromAjax(data.ajax)
		else if (data.image) fillFaceboxFromImage(data.image)
		else if (data.div) { fillFaceboxFromHref(data.div); }
		else if ($.isFunction(data)) data.call($)
		else { $.facebox.reveal(data, klass); }

		return id;
	}

	/*
	* Public, $.facebox methods
	*/

	$.extend($.facebox, {
		settings: {
			opacity: .8,
			overlay: true,
			id: 'facebox',
			loadingImage: '', //'/facebox/loading.gif',
			closeImage: '', //'/facebox/closelabel.png',
			imageTypes: ['png', 'jpg', 'jpeg', 'gif'],
			ziBase: 100,
			faceboxHtml: '\
    <div class="facebox" style="display:none;"> \
      <div class="facebox-popup"> \
        <table> \
          <tbody> \
            <tr> \
              <td class="tl"/><td class="b"/><td class="tr"/> \
            </tr> \
            <tr> \
              <td class="b"/> \
              <td class="body"> \
                <div class="footer"> \
                  <a href="#" class="close"> \
                    <img src="" title="close" class="close_image" style="display:none;" /> \
                    <div class="close_image_div"></div> \
                  </a> \
                </div> \
                <div class="content"> \
                </div> \
              </td> \
              <td class="b"/> \
            </tr> \
            <tr> \
              <td class="bl"/><td class="b"/><td class="br"/> \
            </tr> \
          </tbody> \
        </table> \
      </div> \
    </div>'
		},

		loading: function () {
			init()
			if ($('#' + $.facebox.settings.id + ' .loading').length == 1) return true
			showOverlay()

			$('#' + $.facebox.settings.id + ' .content').empty()
			$('#' + $.facebox.settings.id + ' .body').children().hide().end().
        append('<div class="loading"></div>')

			$('#' + $.facebox.settings.id + '').css({
				top: (getPageScroll()[1] + (getPageHeight() / 10)) / 4,
				left: 385.5
			}).show()

			$(document).bind('keydown.facebox', function (e) {
				if (e.keyCode == 27) $.facebox.close()
				return true
			})
			
			$(document).trigger('loading.facebox', $.facebox.settings.id)
		},

		reveal: function (data, klass) {
			$(document).trigger('beforeReveal.facebox')
			if (klass) $('#' + $.facebox.settings.id + ' .content').addClass(klass);
			$('#' + $.facebox.settings.id + ' .content').append(data);
			$('#' + $.facebox.settings.id + ' .loading').remove();
			$('#' + $.facebox.settings.id + ' .body').children().fadeIn(0);
			var zi = $.facebox.settings.ziBase + (($(".facebox").length * 2) + ($(".facebox:visible").length * 2));
			$('#' + $.facebox.settings.id + '').css('z-index', zi)

			var resize = function () { $('#' + $.facebox.settings.id + '').css('left', $(window).width() / 2 - ($('#' + $.facebox.settings.id + ' table').width() / 2) - 10) }
			resize();
			$(window).bind("resize", resize);

			$(document).trigger('reveal.facebox').trigger('afterReveal.facebox')
		},

		close: function () {
			$(document).trigger('close.facebox', $.facebox.settings.id)
			return false
		}
	})

	/*
	* Public, $.fn methods
	*/

	$.fn.facebox = function (settings) {
		init(settings);

		function clickHandler() {
			$.facebox.loading(true)

			// support for rel="facebox.inline_popup" syntax, to add a class
			// also supports deprecated "facebox[.inline_popup]" syntax
			var klass = this.rel.match(/facebox\[?\.(\w+)\]?/)
			if (klass) klass = klass[1]

			fillFaceboxFromHref(this.href, klass)
			return false
		}

		return this.click(clickHandler)
	}

	/*
	* Private methods
	*/

	// called one time to setup facebox on this page
	function init(settings) {
		if ($("#" + $.facebox.settings.id + ".facebox").length > 0) {
			return true;
		}

		$(document).trigger('init.facebox')
		makeCompatible()

		var imageTypes = $.facebox.settings.imageTypes.join('|')
		$.facebox.settings.imageTypesRegexp = new RegExp('\.' + imageTypes + '$', 'i')

		if (settings) $.extend($.facebox.settings, settings)
		$('body').append($($.facebox.settings.faceboxHtml).attr('id', $.facebox.settings.id));

		var preload = [new Image(), new Image()]
		preload[0].src = $.facebox.settings.closeImage
		preload[1].src = $.facebox.settings.loadingImage

		$('#' + $.facebox.settings.id + '').find('.b:first, .bl, .br, .tl, .tr').each(function () {
			preload.push(new Image())
			preload.slice(-1).src = $(this).css('background-image').replace(/url\((.+)\)/, '$1')
		})

		$('#' + $.facebox.settings.id + ' .close').click($.facebox.close)
		$('#' + $.facebox.settings.id + ' .close_image').attr('src', $.facebox.settings.closeImage)
	}

	// getPageScroll() by quirksmode.com
	function getPageScroll() {
		var xScroll, yScroll;
		if (self.pageYOffset) {
			yScroll = self.pageYOffset;
			xScroll = self.pageXOffset;
		} else if (document.documentElement && document.documentElement.scrollTop) {	 // Explorer 6 Strict
			yScroll = document.documentElement.scrollTop;
			xScroll = document.documentElement.scrollLeft;
		} else if (document.body) {// all other Explorers
			yScroll = document.body.scrollTop;
			xScroll = document.body.scrollLeft;
		}
		return new Array(xScroll, yScroll)
	}

	// Adapted from getPageSize() by quirksmode.com
	function getPageHeight() {
		var windowHeight
		if (self.innerHeight) {	// all except Explorer
			windowHeight = self.innerHeight;
		} else if (document.documentElement && document.documentElement.clientHeight) { // Explorer 6 Strict Mode
			windowHeight = document.documentElement.clientHeight;
		} else if (document.body) { // other Explorers
			windowHeight = document.body.clientHeight;
		}
		return windowHeight
	}

	// Backwards compatibility
	function makeCompatible() {
		var $s = $.facebox.settings

		$s.loadingImage = $s.loading_image || $s.loadingImage
		$s.closeImage = $s.close_image || $s.closeImage
		$s.imageTypes = $s.image_types || $s.imageTypes
		$s.faceboxHtml = $s.facebox_html || $s.faceboxHtml
	}

	// Figures out what you want to display and displays it
	// formats are:
	//     div: #id
	//   image: blah.extension
	//    ajax: anything else
	function fillFaceboxFromHref(href, klass) {
		// div
		if (href.match(/#/)) {
			var url = window.location.href.split('#')[0]
			var target = href.replace(url, '')
			$.facebox.reveal($(target).clone().show(), klass)

			// image
		} else if (href.match($.facebox.settings.imageTypesRegexp)) {
			fillFaceboxFromImage(href, klass)
			// ajax
		} else {
			fillFaceboxFromAjax(href, klass)
		}
	}

	function fillFaceboxFromImage(href, klass) {
		var image = new Image()
		image.onload = function () {
			$.facebox.reveal('<div class="image"><img src="' + image.src + '" /></div>', klass)
		}
		image.src = href
	}

	function fillFaceboxFromAjax(href, klass) {
		$.get(href, function (data) { $.facebox.reveal(data, klass) })
	}

	function skipOverlay() {
		return $.facebox.settings.overlay == false || $.facebox.settings.opacity === null
	}

	function showOverlay() {
		if (skipOverlay()) return

		$("body").addClass("overlay-visible");

		if ($('#' + $.facebox.settings.id + '_overlay.facebox_overlay').length == 0)
			$("body").append('<div id="' + $.facebox.settings.id + '_overlay" class="facebox_overlay facebox_hide"></div>')

		var id = $.facebox.settings.id;
		// The corresponding facebox does not exist yet (and is not visible), so add 1 to the current length
		var zi = ($.facebox.settings.ziBase - 1) + (($(".facebox").length * 2) + (($(".facebox_overlay:visible").length) * 2));

		$('#' + id + '_overlay.facebox_overlay').attr("rel", id).hide().addClass("facebox_overlayBG")
      .css('opacity', $.facebox.settings.opacity)
		.css('z-index', zi)
      .click(function () { /*$(document).trigger('close.facebox')*/ })
      .show()
		return false
	}

	function hideOverlay(id) {
		if (skipOverlay()) return

		var faceboxes;
		var undefined;

		if (id != undefined) {
			faceboxes = $('#' + id + '_overlay.facebox_overlay');
		} else {
			faceboxes = $('#facebox_overlay');
		}

		faceboxes
			.hide()
			.removeClass("facebox_overlayBG")
			.addClass("facebox_hide")
			.remove();

		if ($('.facebox_overlay').length == 0) {
			$("body").removeClass("overlay-visible");
		}

		return false
	}

	/*
	* Bindings
	*/

	$(document).bind('close.facebox', function (e, id) {
		$(document).unbind('keydown.facebox')
		var undefined;
		var fb = (id == undefined) ? $('.facebox') : $('#' + id);
		fb.fadeOut(0, function () {
			fb.find('.content').removeClass().addClass('content');
			hideOverlay(id);
			fb.find('.loading').remove();
		})
	})

})(jQuery);
 
 

if ( window && typeof(window.console) == 'undefined' ) {
	window.console = {};
}

if ( window.console ) {

	if (typeof(window.console.log) == 'function') {
		window['orig_log'] = window.console.log;
	}

	window.console.log2 = function() {
		if (typeof (window.sds_debug_log) == 'undefined') {
			window.sds_debug_log = [];
		}

		window.sds_debug_log.push('<li>');
		window.sds_debug_log.push('<span class="timestamp">' + (new Date()).toTimeString() + '</span>');
		for (var i = 0, al = arguments.length, as = arguments; i < al; ++i) {
			window.sds_debug_log.push('<span>');
			window.sds_debug_log.push(as[i]);
			window.sds_debug_log.push('</span>');
		}
		window.sds_debug_log.push('</li>');

		if (window['orig_log']) {
			window['orig_log'].apply(this, arguments);
		}
	};

	// Disable logging.
	window.console.log = function() { };
} 
 

// Utility functions.

// Define this namespace registration function.
// We intend to generate namespaces only through this
// function so as to avoid duplicating code. This
// poses a chicken and egg question which we solve
// by first defining the function outside of any
// namespace and subsequently assigning it to
// its intended namespace, generated by using the
// very function.
var SDS_Utility_registerNamespace = function(ns) {
	if (!/^[_A-Za-z]\w*(\.[_A-Za-z]\w*)*$/.test(ns)) {
		throw 'Malformed namespace.';
	}

	if (typeof (Type) === 'undefined' || Type == null || typeof (Type.registerNamespace) !== 'function') {
		// Do old fashioned namespace registration.
		var names = ns.split('.');
		var previousComponent = window;
		for (var k = 0; k < names.length; k++) {
			var name = names[k];
			var component = previousComponent[name];
			if (typeof (component) === 'undefined' || component === null) {
				component = {};
				previousComponent[name] = component;
			}
			previousComponent = component;
		}
	} else {
		// Register using the ADO.NET type system.
		Type.registerNamespace(ns);
	}
};

// Register my namespace.
SDS_Utility_registerNamespace('SDS.Utility');

// Move the registerNamespace function into the namespace.
SDS.Utility.registerNamespace = SDS_Utility_registerNamespace;
delete SDS_Utility_registerNamespace;

SDS.Utility.registerNamespace('SDS.Utility.Misc');

/**
 * Returns a function that, upon invocation, calls
 * the specified function with the specified context
 * object as context.
 *
 * The code below produces the well known "Hello World!" output.
 * var saySomething = function() { alert(this); };
 * var helloWorld = SDS.Utility.Misc.bind(saySomething, 'Hello World!');
 * helloWorld();
 */
SDS.Utility.Misc.bind = function(fn, context) {
	return function() {
		var result = fn.apply(context, arguments);
		return typeof (result) === 'undefined' ? false : result;
	};
};

Function.prototype.bind = Function.prototype.bind || function(context) {
    return SDS.Utility.Misc.bind(this, context);
   };

Function.prototype.delay = function(timeout, _arguments, context) {
	if (!jQuery.isArray(_arguments)) {
		context = _arguments;
		_arguments = [];
	}
	var fn = this;
	var delayedFn = function() {
		var result = fn.apply(context, _arguments);
		return typeof (result) === 'undefined' ? false : result;
	};

	return window.setTimeout(delayedFn.bind(this), timeout);
};

Function.prototype.interval = function(interval, intervalCheck, _arguments, context) {
	if (!jQuery.isArray(_arguments)) {
		context = _arguments;
		_arguments = [];
	}
	var intervalObject = { intervalId: null, fn: null };
	var delayedFn = function() {
		var isIntervalValid = jQuery.isFunction(intervalCheck) ? intervalCheck.call(context, []) : (intervalCheck !== false);

		if (!isIntervalValid) {
			//clear interval
			window.clearInterval(intervalObject.intervalId);
			return false;
		}

		var fn = this;
		var result = fn.call(context, _arguments);
		return typeof (result) === 'undefined' ? false : result;
	};

	intervalObject.intervalId = window.setInterval(delayedFn.bind(this), interval);
	return intervalObject;
};


/**
 * Traverses the object recursively and produces a query string.
 * If the object is undefined, null, a string, or a number,
 * the method returns the empty string. Otherwise, the object's
 * properties and object's descendants' properties are visited
 * in a breadth-first manner. For each property, its path from
 * the root is added to the query string as name and its value
 * is added as value. If the property is an array, then the 1-based
 * index of each member of the array is appended to the array's
 * path to construct the array member's path and the member is
 * added to the query string.
 * 
 * For example:
 * obj = { name: 'John', child: [ { name: 'Walter' }, 'Nancy' ] };
 * produces:
 * name=John&child.1.name=Walter&child.2=Nancy
 */
SDS.Utility.Misc.toQueryString = function(obj) {
	if (typeof (obj) === 'undefined' || obj == null || typeof (obj) === 'string' || parseFloat(obj) === obj) {
		return '';
	}
	var queryString = [];
	SDS.Utility.Misc.toQueryStringImpl(obj, '', queryString);
	return queryString.join('&').split('%20').join('+');
};

SDS.Utility.Misc.toQueryStringImpl = function(obj, context, queryString) {
	if (typeof (obj) === 'string' || parseFloat(obj) === obj) {
		queryString.push(encodeURIComponent(context) + '=' + encodeURIComponent(obj));
	} else {
		// Try to process the object as an array.
		if (SDS.Utility.Misc.isArray(obj)) {
			for (var k = 0; k < obj.length; k++) {
				SDS.Utility.Misc.toQueryStringImpl(obj[k], context + '.' + (1 + k), queryString);
			}
		} else {
			for (var property in obj) {
				var value = obj[property];
				if (!(value === null || value === undefined) && typeof (value) !== 'function') {
					var valueContext = context ? context + '.' + property : property;
					SDS.Utility.Misc.toQueryStringImpl(value, valueContext, queryString);
				}
			}
		}
	}
};

/**
 * Returns whether the specified object can be treated as an array.
 */
SDS.Utility.Misc.isArray = function(obj) {
	if (typeof (obj.length) !== 'undefined' && parseInt(obj.length) == obj.length && obj.length >= 0) {
		if (obj.length == 0) {
			return true;
		}
		try {
			var value = obj[obj.length - 1];
			return true;
		} catch (e) {
			return false;
		}
	} else {
		return false;
	}
};

SDS.Utility.Misc.uniqueIdentifier = function() {
	var id = ++SDS.Utility.Misc.uniqueIdentifier.value;
	return '' + id + '-' + new Date().getTime();
};

SDS.Utility.Misc.uniqueIdentifier.value = 0;

SDS.Utility.Misc.encodeHtml = function (value, fullEncode) {
	// Check for corner cases.
	if (typeof (value) === 'undefined' || value == null) {
		return null;
	}

	if (!value.replace) return value;

	if (!!!fullEncode) {
		return value.replace(/</g, '&lt;').replace(/>/g, '&gt;');
	}
	//return value.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');


	// Use a class without characters that jQuery selectors interpret
	// when the class is used verbatim as a selector.
	var cssClass = 'sds-utility-misc-escape-html-container';

	// Will store data relative to this function.	
	var thisFunction = SDS.Utility.Misc.encodeHtml;

	// Create a container in the header of the current document.
	// Create it one time.
	if (!thisFunction.valueContainer) {
		thisFunction.valueContainer
			= jQuery('head')
			.append('<span class="' + cssClass + '"></span>')
			.children(':last');
	}

	// Set a text and get a value from the container.
	var result = thisFunction.valueContainer.text(value).html();
	thisFunction.valueContainer.text('');
	// todo: optimize.
	// Regarding the apostrophe and the apos entity, see
	// [ http://www.w3.org/TR/2002/REC-xhtml1-20020801 ], section C.16.
	return result.split('"').join('&quot;').split('\'').join('&#39;');
};


// Array Remove - By John Resig (MIT Licensed)
Array.prototype.remove = function(from, to) {
  var rest = this.slice((to || from) + 1 || this.length);
  this.length = from < 0 ? this.length + from : from;
  return this.push.apply(this, rest);
};

Array.prototype.equals = function(arr) {
    if (this.length != arr.length) return false;
    for (var i = 0; i < arr.length; i++) {
        if (this[i].equals) { //likely nested array
            if (!this[i].equals(arr[i])) return false;
            else continue;
        }
        if (this[i] != arr[i]) return false;
    }
    return true;
}

String.prototype.toTitleCase = function(str) {
    var re = new RegExp(/^(a|about|after|an|and|at|by|for|from|in|into|nor|of|on|onto|over|the|to|up|with|within)$/);        
    return str.toLowerCase().replace(/\b([a-z])(\w*)\b/g, cnvrt);
    function cnvrt() {
        if (re.test(arguments[0]) && arguments[arguments.length-2])
            return arguments[0];
        else
            return arguments[1].toUpperCase() + arguments[2];
    }
   }

   Array.prototype.single = function () {
   	return this[0];
   };


   jQuery.fn.removeAll = function () {
   	this.each(function () {
   		var newEl = this.cloneNode(false);
   		this.parentNode.replaceChild(newEl, this);

   		//Copy back events if they haven't been copied already by IE
   		if (jQuery.support.noCloneEvent) {
   			cloneCopyEvent($(this), $(newEl));
   		}
   	});
   };

   function cloneCopyEvent(orig, ret) {
   	var i = 0;

   	ret.each(function () {
   		if (this.nodeName !== (orig[i] && orig[i].nodeName)) {
   			return;
   		}

   		var oldData = jQuery.data(orig[i++]),
			curData = jQuery.data(this, oldData),
			events = oldData && oldData.events;

   		if (events) {
   			delete curData.handle;
   			curData.events = {};

   			for (var type in events) {
   				for (var handler in events[type]) {
   					jQuery.event.add(this, type, events[type][handler], events[type][handler].data);
   				}
   			}
   		}
   	});
   }

if (jQuery('body').hasClass('msie')) {
	jQuery.propHooks.disabled = {
		set: function (el, value) {
			var instance = jQuery(el).data('select2');
			if (!instance) {
				return;
			}

			if (value === true) {
				instance.trigger('disable');
			}
			else {
				instance.trigger('enable');
			}
		}
	};
} 
 

SDS.Utility.registerNamespace('SDS.Controls');

SDS.Controls.MessageBox = Base.extend({

	constructor: function (message_or_element, options) {
		var defaults = {
			buttons: [{ Type: SDS.Controls.MessageBox.ButtonType.OK, Text: 'OK'}],
			css: {
				border: 'none',
				padding: '15px',
				backgroundColor: '#fff',
				'-webkit-border-radius': '10px',
				'-moz-border-radius': '10px',
				'border-radius': '10px',
				opacity: '.95',
				color: '#000',
				cursor: 'default'
			},

			autoFitToViewport: false,

			overlayCSS: {
				cursor: 'default'
			},

			modal: true
		};

		var isMobile = jQuery('body').hasClass('mobile');

		this.options = jQuery.extend(defaults, options);

		var undefined;
		if (this.options.id == undefined) {
			var ts = (new Date()).getTime();
			this.options.id = "messagebox" + ts;
		}

		this.element = jQuery('#' + this.options.id + ' .message-box').get(0);
		if (this.element != null) {
			jQuery(this.element).remove();
		}

		this.element = document.createElement("DIV");

		this.element = jQuery(this.element).addClass("message-box").get(0);
		this.content = message_or_element;

		jQuery(this.element).bind("click", SDS.Controls.MessageBox.ClickHandler);

		document.body.appendChild(this.element);

		jQuery(this.element).data("MessageBox", this);

		if (!isMobile) {
			var faceboxParents = jQuery('.facebox:last');
			this.makeDraggable(faceboxParents);
		}
	},

	show: function () {
		var self = this;

		jQuery(document).bind('reveal.facebox', function () {
			jQuery(".content", this.element).find("input[type=text]:first").focus();
		});

		var element = jQuery(this.element);

		element.html('<div class="content"><div></div></div>');
		element
			.find(".content")
			.find("div")
			.append(this.content);

		if (this.options.title) {
			var titlePrintButton = this.options && this.options.enablePrint ?
				'<a href="javascript:void(0);" class="facebox-footer-button message-box-print" style="float:right;"><img class="image" style="display:none;" title="print" src="null"><div class="print-image-div"></div></a>' : '';

			element.prepend('<div class="title">' + this.options.title + titlePrintButton + '</div>');
		}

		element.append("<div class=\"dialog-toolbar\"></div>");

		jQuery(this.options.buttons).each(function (i, button) {
			var buttonElement = jQuery("<button class=\"image-button\" value=\"" + (button.Type || button.type) + "\" " + (((button.OnClick || button.click) && !jQuery.isFunction((button.OnClick || button.click))) ? "onclick=\"" + (button.OnClick || button.click) + "\"" : "") + "><span>" + (button.Text || button.text) + "</span></button>");

			if (jQuery.isFunction(button.OnClick || button.click)) {
				buttonElement.data('clickHandler', (button.OnClick || button.click));
			}

			element.find("div.dialog-toolbar").append(buttonElement);
		});

		var dialogId = this.dialogId = jQuery.facebox(this.element, '', this.options.id);
		var dialogElement = jQuery('#' + dialogId);

		dialogElement.find(".facebox-popup .footer").hide();
		var faceboxBody = dialogElement.find(".facebox-popup .body");
		faceboxBody.removeClass();
		faceboxBody.addClass("body");
		faceboxBody.css("padding", "0px");

		dialogElement.css("top", "10px");

		if (!!this.options.autoFitToViewport) {
			this.resizeToViewport();
		}

		jQuery('.message-box-print')
			.off('click')
			.click(function () {
				self.printContent();
		});
	},
	printContent: function () {
		this.initPrint();

		var params = this.getPrintParams();

		SDS.Print.PdfPrint2.printHTML(params, null);
	},

	initPrint: function (callback) {
		var self = this;

		var spinner = new SDS.Controls.Spinner({
			container: $get('show-selected-dialog'),
			text: 'Please wait. . .'
		});
		spinner.show();
	},

	getPrintParams: function () {
		var contentElement = jQuery(this.element).find('.content');
		var container = contentElement.clone();
		container.find('> div').css({ 'max-height': null, 'overflow-y': 'visible' });
		var html = container.html();
		if (this.options.printOnlyContent) {
			html = this.options.printOnlyContent + html;
		}
		if (this.options.printCssClass) {
			html = '<div class="' + this.options.printCssClass + '">' + html + '</div>';
		}
		var auth = REModel.Session.getAuth();
		var entityContext = new REModel.EntityContext(auth.appName, auth.appName, 'Listing', auth.appName);
		var entityKey = entityContext.getEntityKey();

		var params = {
			divClass: '',
			html: html,
			renderEntity: entityKey.entityName,
			entityKey: entityKey,
			userKey: auth,
			orientation: 0,
			keyColumnName: 'n/a',
			connectionKey: entityContext.getConnectionKey()
		};

		return params;
	},

	makeDraggable: function ($el) {
		var self = this;
		$el.on('mousedown', function (e) { self.dragStart(e, this); });
		$el.on('mouseup', function (e) { self.dragStop(e, this); });
	},

	dragStop: function (e, el) {
		this.isDragging = false;
		jQuery(window).die('mouseout, mousemove, mouseover');
	},

	isHandle: function (el, isParent) {
		//Check this element and parent element
		switch (el.tagName.toLowerCase()) {
			case "div":
			case "p":
			case "span":
			case "h1":
			case "h2":
			case "h3":
			case "h4":
			case "h5":
			case "hr":
				//Make sure parent is handle if we haven't already done so
				return isParent ? true : this.isHandle(el.parentElement, true);
				break;
			default:
				return false;
		}
	},

	dragStart: function (e, el) {
		//only allow text/containers to be dragged. Form elements should not be dragged
		var self = this;
		if (!this.isHandle(e.target)) {
			return;
		}

		jQuery(e.target).scroll(function () { self.isDragging = false; });

		this.isDragging = true;

		var self = this;
		var $el = jQuery(el);
		var divOffset = $el.offset();
		var divLeft = divOffset.left;
		var divTop = divOffset.top;

		//Save where mouse is on the element
		this.dragOffset = {
			left: e.clientX - divLeft,
			top:e.clientY - divTop
		}
		jQuery(window).on('mouseout mousemove mouseover', function (e2) { self.dragMove(e2, el); });

		return this.pauseEvent(e);
	},
	pauseEvent: function (e){
		if(e.stopPropagation) e.stopPropagation();
		if(e.preventDefault) e.preventDefault();
		e.cancelBubble=true;
		e.returnValue=false;
		return false;
	},

	dragMove: function (e, el) {
		if (!this.isDragging) {
			return;
		}
		var $el = jQuery(el);

		var divOffset = $el.offset();
		var divLeft = divOffset.left;
		var divTop = divOffset.top;

		var divWidth = $el.outerWidth();
		var divHeight = $el.outerHeight();

		var mouseLeft =  e.clientX;
		var mouseTop =  e.clientY;

		//Make sure mouse stays in same spot on element when dragging
		var newDivLeft = mouseLeft - this.dragOffset.left;
		var newDivTop = mouseTop - this.dragOffset.top;

		var bodyWidth = jQuery(document).width();
		var bodyHeight = jQuery(document).height();

		//Make sure Div is in bounds of the window
		if (newDivTop < 0) { newDivTop = 0; }
		if (newDivTop + divHeight > bodyHeight) { newDivTop = bodyHeight - divHeight }

		if (newDivLeft < 0) { newDivLeft = 0; }
		if (newDivLeft + divWidth > bodyWidth) { newDivLeft = bodyWidth - divWidth; }

		if (divLeft == newDivLeft && divTop == newDivTop) {
			return;
		}

		//Move the element
		el.style.position = 'absolute';
		el.style.top = newDivTop + 'px';
		el.style.left = newDivLeft + 'px';
		return this.pauseEvent(e);
	},

	getDialog: function () {
		return (this.dialogId) ? jQuery('#' + this.dialogId) : null;
	},

	resizeToViewport: function () {
		var dialogElement = this.getDialog();

		if (!dialogElement) return;

		var dialogContainer = dialogElement;

		// We probably should not be referencing the #MasterHeader element by
		// name, but we are doing it above already to calculate the top position...
		//
		// todo: SDS.Page.getHeader(), or better yet: take an instance of SDS.Page in the
		//			constructor.
		var dialogHeight = jQuery(window).height() - jQuery("#MasterHeader").height() - 105;
		var content = dialogContainer.find('.message-box > .content > div > div');
		var contentHeight = content.height();

		var originalHeight = dialogContainer.height();

		if (originalHeight > dialogHeight) {
			var calculatedContentHeight = (contentHeight / originalHeight) * dialogHeight;
			content
						.height(calculatedContentHeight)
						.css('overflow-y', 'auto')
						.css('overflow-x', 'hidden');

		}
	},

	hide: function () {
		jQuery(document).trigger('close.facebox', this.options.id);
		//jQuery(this.element).remove();
		//jQuery.unblockUI();
	}

},
{
	ButtonType: { Yes: 3, No: 2, OK: 1, Cancel: 0 },
	Button: {
		Yes: { Text: 'Yes', Type: 3 },
		No: { Text: 'No', Type: 2 },
		OK: { Text: 'OK', Type: 1 },
		Cancel: { Text: 'Cancel', Type: 0 }
	},
	ClickHandler: function (event, data) {
		// Make a dummy data object if none exists
		data = (data) ? data : {};

		var target = jQuery(data.target || event.target);
		var Namespace = SDS.Controls.MessageBox;

		// If this is not a button click then it does not concern us
		if ((!target.is('button') && !target.parent().is('button'))
            || target.hasClass("mceIcon")
            || target.hasClass("disabled")
            || (target.parent().is('button') && target.parent().hasClass("disabled"))) {
			return;
		}

		// Get the parent dialog element
		var dialog = target.parents("div.message-box"); //jQuery(event.data.element);
		var messageBox = dialog.data('MessageBox');

		// Map to hold our form values
		var valueMap = {};

		// Gather the form values to pass to the button-specific click handlers
		jQuery(":input, :checkbox, :radio, select", dialog).each(function (i, o) {
			var element = jQuery(o);
			if (element.length > 0 && (element.attr('id') || element.attr('name'))) {
				var name = element.attr('id') || element.attr('name');
				var value = element.attr('value');

				if (element.is(":checkbox")) {
					if (!element.val()) {
						value = element.is(":checked");
					} else if (o.checked) {
						value = element.val();
						value = (value == "on") ? true : ((value == "off") ? false : value);
					} else {
						return;
					}
				}
				else if (element.is(":radio")) {
					if (element.is(":checked")) {
						value = element.val();
					} else {
						return;
					}
				}
				else if (element.is('[type=file]')) {
					value = element;
				}
				else {
					value = element.val();
				}

				Namespace.addValueToMap(valueMap, name, value);
			}
		});

		var clickHandler = target.data('clickHandler');
		if (!clickHandler) {
			clickHandler = target.parent().data('clickHandler');
		}

		if (jQuery.isFunction(clickHandler)) {
			if (clickHandler(valueMap) != false) {
				jQuery(document).trigger('close.facebox', messageBox.options.id);
			}
		} else {
			jQuery(document).trigger('close.facebox', messageBox.options.id);
		}
	},

	addValueToMap: function (map, name, value) {
		var currentValue = map[name];

		// Only proceed if we haven't already included this value in our map.
		if (typeof (currentValue) !== 'undefined') {
			if (jQuery.isArray(currentValue)) {
				if (jQuery.inArray(value, currentValue) > -1) {
					return;
				}
				map[name].push(value);
			} else if (value == currentValue) {
				return;
			} else {
				map[name] = [];
				map[name].push(currentValue);
				map[name].push(value);
			}
		} else {
			map[name] = value;
		}
	}
});
 
 
SDS.Utility.registerNamespace('SDS.Controls');

SDS.Controls.PageBox = Base.extend({

	constructor: function (title, content, options) {
		this.title = title;
		this.content = content;

		var defaults = {
			bodyClass: "body",
			id: null
		};

		this.options = jQuery.extend(defaults, options);

	},

	show: function () {
		var id = jQuery.facebox(this.content, '', this.options.id);

		var dialogElement = this.dialog = jQuery('#' + id);

		var b = dialogElement.find(".facebox-popup .body");
		if (b.find('.page-box-title').length) {
			b.find('.page-box-title').html(this.title);
		} else {
			b.prepend('<div class="page-box-title">' + this.title + '</div>');
		}

		var faceboxBody = dialogElement.find(".facebox-popup .body");
		faceboxBody.css("padding", "");
		faceboxBody.removeClass();
		faceboxBody.addClass("body");
		faceboxBody.addClass(this.options.bodyClass);

		dialogElement.find('a.close').bind('click', function () {
			jQuery(document).trigger('close.facebox', id);
		});

		//dialogElement.css("top", (jQuery("#MasterHeader").height() + 10) + "px");
		dialogElement.css("top", jQuery(window).scrollTop() + "px");

		if (this.options.fullscreen) {
			this.onResize();
			jQuery(window).on('resize', jQuery.proxy(this.onResize, this));
		}
	},

	onResize: function () {
		if (this.options.fullscreen) {
			var _width = Math.max(684, jQuery(window).width() - 43);
			var _height = Math.max(450, jQuery(window).height() - 93);
			this.dialog.css({
				top: '0px',
				bottom: '0px',
				left: '0px',
				right: '0px',
				position: 'absolute'
			});

			this.dialog.find(".facebox-popup").css({
				top: '0px',
				bottom: '0px',
				left: '0px',
				right: '0px',
				position: 'absolute'
			});

			jQuery('#PhotosContainer').css({
				width: _width,
				height: _height
			});
		}
	}
}); 
 
SDS.Utility.registerNamespace('SDS.Controls');

SDS.Controls.PrintLinkBox = SDS.Controls.MessageBox.extend({

	printBoxOptions: null,
	constructor: function (printBoxOptions) {
		this.printBoxOptions = printBoxOptions;

		var buttons = [];
		if (printBoxOptions.download) {
			buttons.push({
				Text: 'Download',
				Type: SDS.Controls.MessageBox.ButtonType.OK,
				OnClick: printBoxOptions.downloadCallback
			});
		} else {
			buttons.push({
				Text: 'Print Preview',
				Type: SDS.Controls.MessageBox.ButtonType.OK,
				//OnClick: printResultsPageWithOptions
				OnClick: printBoxOptions.printPreviewCallback //this.showPdfResults
			});
			buttons.push({
				Text: 'Print',
				Type: SDS.Controls.MessageBox.ButtonType.OK,
				//OnClick: printResultsPageWithOptions
				OnClick: printBoxOptions.printCallback
			});
		}
		buttons.push({
			Text: 'Cancel',
			Type: SDS.Controls.MessageBox.ButtonType.Cancel
		});

		var title = 'Print Options';
		if (printBoxOptions.download) {
			title = 'Download';
		}

		var defaults = {
			buttons: buttons,
			id: (printBoxOptions.download) ? 'download-dialog' : 'print-dialog',
			title: title
		};

		// Normalize the list and view print displays
		jQuery("#PrintMessageBox").remove();
		jQuery(".results-container").addClass("print-hidden");
		jQuery("#PrintViewContainer")
		.addClass("print-hidden")
		.empty();

		var content = [];

		var act = 'print';
		if (printBoxOptions.download) {
			act = 'download';
		}

		content.push('<div id="PrintMessageBox">');
		content.push('<div class="print-link-container send-options-container">');


		content.push('   <h4>What would you like to ')
		content.push(act);
		content.push('?</h4>');

		content.push('<div>');
		content.push('   <ul class="content-selection">');

		content.push('<li><label ')
		if (!printBoxOptions.selectedListing) { content.push('disabled="disabled"'); }
		content.push('><input type="radio" name="content" value="this-listing" id="ThisListing" ');
		if (!printBoxOptions.selectedListing) { content.push('disabled="disabled"'); } else {
			content.push('checked="checked"');
		}
		content.push(' /><span class="send-label">This Listing</span></label></li>');

		if (printBoxOptions.numListings > 1) {
			content.push('<li><label><input type="radio" name="content" value="all-listings" id="AllListings" ');
			if (!printBoxOptions.selectedListing) { content.push('checked="checked"'); }
			content.push(' /><span class="send-label">All ' + printBoxOptions.numListings + ' Listing' + (printBoxOptions.numListings == 1 ? '' : 's') + '</span></label></li>');
		}

		content.push('</ul></div>');

		if (printBoxOptions.hasMap) {
			content.push('<div><label style="color:#000;font-weight:normal;"><input type="checkbox" id="IncludeMap" checked="checked"><span>Include map as first page</span></label></div>');
		}
		// Selected listing needs to be propagated through the dialog
		// Handling things this way increases reusability and reduces polluting of the global namespace
		content.push('<input type="hidden" id="CurMlNum" value="' + printBoxOptions.selectedListing + '"/>');

		var ct = content.join('');

		this.base(ct, defaults);
	},
	initialized: false,
	form: null,

	close: function (event, data) {
		this.hide();
		this.dispose();
	},

	initialize: function (callback) {
		this.initialized = true;
		callback.call(this);
	},
	showDialog: function () {
		if (this.initialized) {
			this.show();

			// Fix some display errors
			var overlay = jQuery('#' + this.options.id + '_overlay');
			overlay.removeClass('facebox_overlay');
			overlay.css('position', 'fixed');
			overlay.css('height', '100%');
			overlay.css('width', '100%');
			overlay.css('left', '0px');
			overlay.css('top', '0px');

			jQuery(document).bind('close.facebox', function () {
				var o = jQuery('#' + this.options.id + '_overlay');
				o.addClass('facebox_overlay');
				o.remove();
			} .bind(this));

			var dialog = jQuery('#' + this.options.id);
			dialog.css('top', (jQuery(window).scrollTop() + 10) + 'px');

			if (this.printBoxOptions.showHelp) {
				var path = (this.printBoxOptions.helpPath) ? "'" + this.printBoxOptions.helpPath + "'" : '';
				dialog.find('.dialog-toolbar').prepend("<div class=\"print-link-help actions-container\" style=\"position:absolute;left:10px;bottom:22px;width:50px\"><a onclick=\"SDS.Controls.PrintLinkBox.showHelp(" + path + ");return false;\" class=\"help\">Help</a></div>");
			}

		} else {
			this.initialize(this.showDialog);
		}
	},
	dispose: function () {
		this.initialized = null;
	}
}, {
	showHelp: function (path) {
		HelpUtility.showHelp(null, "Listing", path);
	}
}); 
 


SDS.Controls.Spinner = Base.extend(
{
	constructor: function (container, text, options) {
		if (typeof (container) == 'object') {
			text = container['text'];
			options = jQuery.extend(container.options || options || {},
				{ url: '../../Images/SpinnerWhite.gif', width: 32, height: 32 });
			container = container['container'];
			//				{
			//					url: '../../Images/Spinner-Bar-Blue.gif',
			//					width: 220,
			//					height:19
			//				});
		}
		else {
			container = $get(container);			
		}		

		var that = this;

		this._container = container;
		this._text = text;
		this._handler = null;
		this._handled = false;
		this._delay = typeof options.delay != 'undefined' ? options.delay : 500;
		this._force = options.force === true;

		if (this._force) {
			this._delay = 0;
		}
		
		this._element = document.createElement("DIV");
		this._label = document.createElement("DIV");
		this._iframe = document.createElement("IFRAME");
		this._img = document.createElement("IMG");

		// Setting position: absolute immediately ensures that
		// the width of the container is calculated according to its
		// content, and not to its container. This in turn ensures
		// that, when shown, the spinner is positioned correctly.
		jQuery(this._element)
			.addClass('spinner-container')
			.css({ position: 'absolute' });
		jQuery(this._label).addClass('spinner-label');

		jQuery(this._iframe)
			.attr('marginwidth', '0')
			.attr('marginheight', '0')
			.attr('frameborder', '0')
			.attr('scrolling', 'no')
			.attr('width', options.width)
			.attr('height', options.height);

		jQuery(this._img)
			.attr('width', options.width)
			.attr('height', options.height)
			.attr('src', options.url);


		this._element.appendChild(this._label);
		this._element.appendChild(this._img);
		//this._container.appendChild(this._element);
	},

	setText: function(text) {
		this._text = text;
	},

	show: function() {
		var that = this;

		jQuery(this._label).html(this._text);
		jQuery(this._element).css('visibility', 'hidden');

		var offset = { top: 0, left: 0 };

		try {
			if (this._container && this._container.parentNode) {
				if (this._force) {
					offset = jQuery(this._container).append(this._element).position();
				} else {
					offset = jQuery(((this._container.parentNode && this._container.tagName.toLowerCase() != 'body' && this._container.parentNode) || this._container)).append(this._element).position();
				}
			}
		} catch (error) {
			offset = { top: 0, left: 0 };
		}

		var ch = jQuery(this._container).height();
		var cw = jQuery(this._container).width();
		var eh = jQuery(this._element).height();
		var ew = jQuery(this._element).width();

		var top = offset.top + ((ch - eh) / 2);
		var left = offset.left + ((cw - ew) / 2);
		
		if (this._timeout) { clearTimeout(this._timeout); }
		
		if (this._delay > 0) {			
			var spinner = this;
			this._timeout = setTimeout(function () {
				jQuery(spinner._element).css({
					position: 'absolute',
					top: top,
					left: '50%',
					'margin-left': '-64px',
					visibility: 'visible'
				}).show();
			}, this._delay);
		}
		else {
			jQuery(this._element).css({
				position: 'absolute',
				top: top,
				left: '50%',
				'margin-left': '-64px',
				visibility: 'visible'
			}).show();			
		}

		if (!this._handler) {
			var thatCopy = that;
			this._handler = function() { thatCopy.show(); };
		}

		if (!this._handled) {
			jQuery(window).resize(this._handler);
		}

		that = null;
	},

	hide: function() {
		if (this._timeout) { clearTimeout(this._timeout); }
		jQuery(this._element).hide();
		this._handled = false;
		jQuery(window).unbind("resize", this._handler);
	}
},

{
	BAR: { url: '../../Images/Spinner-Bar-Blue.gif', width: 220, height: 19 },
	CIRCLE: { url: '../../Images/SpinnerWhite.gif', width: 32, height: 32 }
});
 
 
 
 
REModel = {}; 
 
REModel.Services = {}; 
 
REModel.Session = { getAuth: function() { return { appName: window.currentAppName, userID: "_guest" }; } }; 
 
 
function finishShapeDescription(shape, map, columnMap, serviceFactory) {
	function getValue(object, columnName) {
		columnName = columnMap.getAny(columnName);
		return object[columnName];
	}

	shape.photos = shape.photos || [];

	var entityKey = getEntityKey();
	var entity = window.storage.getFromEntityKey(entityKey).get('entity');
	var canLocateSurProps = entity['dynamic.CanLocateSurProps']
	var pushPinListings = shape.getMarkers ? shape.getMarkers() : shape.data;

	var location = shape.getLocation ? shape.getLocation() : shape.position;
	var hasBirdseye = !!!shape.position;
	location = !location ? {} : { latitude: location.latitude ? location.latitude : location.lat(), longitude: location.longitude ? location.longitude : location.lng() };

	var formElements = jQuery('.infobox-form-container', shape.element);
	jQuery.each(pushPinListings, function (i, data) {
		if (data.data) {
			data = data.data[0];
		}
		var id = data.key();
		var formElement = jQuery(formElements[i]);

		if (shape.photos[i]) {
			shape.photos[i].dispose();
		}
		shape.photos[i] = initMultiPhotos(formElement, data, entityKey, serviceFactory, columnMap);

		updateMapPopupToFavorites(formElement.find(".favorites-indicator a").get(0), id);
		updateMapPopupToShoppingCart(formElement.find(".shopping-cart-indicator a").get(0), id);

		var span = jQuery("span:contains('" + shape.mlLabel + "')", formElement).next("span");
		span.html('<a href="javascript:void(0)" onclick="viewListing(\'' + span.text() + '\');">' + span.text() + '</a>');

		/*var link = span.find("a");
		link.click(function () {
			viewListing(id, map);
		});*/

		if (location.latitude && location.longitude) {
			var span = jQuery("span:contains('[BirdsEye]')", formElement).next("span");
			if (getCurrentUserObject().appName === 'MLSLI') {
			} else {
				span.html(hasBirdseye ? '<a class="birds-eye" href="javascript:void(0);">Bird\'s eye</a>': '');
			}

			var link = span.find("a.birds-eye");
			link.click(function () {
				viewBirdsEye(location.latitude, location.longitude, map);
			});

			if (shape.showLspLink !== false) {
				if (canLocateSurProps === 'true') {
					if (!shape.address) {
						shape.address = getValue(data, 'addr') + '<br />' + getValue(data, 'town') + ', ' + getValue(data, 'zip');
					}
					span.append('<br /><a class="locate-surrounding-properties" href="javascript:void(0);">Locate Surrounding Properties</a>')
						.find("a.locate-surrounding-properties")
						.data('shape', shape)
						.click(function () {
							var shape = jQuery(this).data('shape');
							if (!shape) { return; }
							var location = shape.getLocation ? shape.getLocation() : shape.position;
							location = { latitude: location.latitude ? location.latitude : location.lat(), longitude: location.longitude ? location.longitude : location.lng() };
							SDS.Services.MLSLI.EntityReportLinksProvider.handleLocateSurroundingLink(location.latitude, location.longitude, shape.address, id);
						});
				}
			}
		}

		if (data.selected) {
			jQuery("input[type=checkbox]", formElement).prop("checked", true);
			jQuery("input[type=checkbox]", formElement).attr("checked", true);
		}
	});
}

function HideMapInfobox(map, pushpin) {
	map.hideInfobox();
}

function createMapInfoboxContainer(pushpin) {
	var content = document.createElement("div");

	var pushPinListings = pushpin.getMarkers ? pushpin.getMarkers() : pushpin.data;
	if (!jQuery.isArray(pushPinListings)) {
		pushPinListings = [pushPinListings];
	}

	if (pushPinListings.length > 1) {
		var clusterHeader = jQuery('<strong>' + pushPinListings.length + ' Overlapping Listings: </strong>');
		clusterHeader.appendTo(content);
	}

	var listingContainer = jQuery('<div class="infobox-listing-container"></div>');
	if (pushPinListings.length > 2 && !pushpin.getMarkers) {
		listingContainer.css({ 'position': 'relative', 'height': '275px', 'overflow-y': 'scroll', 'overflow-x': 'hidden' });
	}

	listingContainer.appendTo(content);

	appendSeperatorToElement(listingContainer);

	if ('Microsoft' in window) {
		pushpin.content = content;
	}
	else {
		pushpin.infoboxContent = content;
	}

	return listingContainer;
}

function RenderMapInfoboxStaticContent(map, pushpin, content) {
	var listingContainer = createMapInfoboxContainer(pushpin);
	listingContainer.append(content);

	appendSeperatorToElement(listingContainer);

	map.displayInfobox(pushpin);
}

function appendSeperatorToElement(element) {
	var seperator = jQuery('<div style="border-top:1px solid #eeeeee;" />');
	seperator.appendTo(element);
}


function RenderMapInfobox(map, pushpin, forms, columnMap, serviceFactory) {
	var listingContainer = createMapInfoboxContainer(pushpin);

	var pushPinListings = pushpin.getMarkers ? pushpin.getMarkers() : pushpin.data;
	var formsLoaded = 0;
	var pushpinsByListingID = {};

	if (pushpin.getMarkers) {
		for (var i = 0, len = pushPinListings.length; i < len; i++) {
			if (pushPinListings[i].data.length && pushPinListings[i].data.length == 1) {
				pushpinsByListingID[pushPinListings[i].data[0].key()] = pushPinListings[i];
			}
		}
	}

	for (var i = 0, len = pushPinListings.length; i < len; i++) {
		var listing = pushPinListings[i];
		if (pushPinListings[i].data) {
			listing = (pushPinListings[i].data.length && pushPinListings[i].data.length == 1 ? pushPinListings[i].data[0] : pushPinListings[i].data);
		}

		var formContainer = jQuery('<div class="infobox-form-container"></div>');
		formContainer.appendTo(listingContainer);

		appendSeperatorToElement(listingContainer);


		RenderFormForInfobox(pushpin, listing, formContainer.get(0), forms, function () {
			formsLoaded++;
			if (formsLoaded == len) {

				if (pushpin.mouseovercancel) { return; }
				pushpin.element = pushpin.infoboxContent || pushpin.content;
				pushpin.GetID = function () { return 'infobox'; }
				pushpin.GetCustomIcon = function (pinHtml, listingID) {
					var _pushpin = pushpin;
					if (pushpinsByListingID[listingID]) { _pushpin = pushpinsByListingID[listingID]; }

					if (!pinHtml && !_pushpin.getHtmlContent && !_pushpin.getContent) {
						return '';
					}
					var icon = jQuery(pinHtml || _pushpin.getHtmlContent ? _pushpin.getHtmlContent() : _pushpin.getContent());
					return icon.outerHTML();
				}

				postProcessMapDescription(pushpin, columnMap);
				finishShapeDescription(pushpin, map, columnMap, serviceFactory);
				map.displayInfobox(pushpin);
			}
		});
	}

}

function RenderFormForInfobox(pushpin, listing, div, forms, callback) {
	var listingObject = {};
	for (var i = 0; i < requiredMapFields.length; i++) {
		listingObject[requiredMapFields[i]] = listing.get(requiredMapFields[i]);
	}

	var listingClass = (listing.get('class') || '').toLowerCase();

	var template = getTemplateFromForms(forms, listingClass);

	var form = new SDS.Controls.Forms.Form({ element: div });
	SDS.Controls.Forms.Form.deserializeFromXmlString(template, form);

	listingObject = extendListingObject(listingObject);
	if (pushpin.mouseovercancel) { return; }

	form.bindObject(listingObject, callback);
}

function getTemplateFromForms(forms, listingClass) {
	var template = jQuery.grep(forms, function (f) {
		var fc = f.conditions || f.form.filterConditions || [];
		for (var i = 0; i < fc.length; i++) {
			if (fc[i].name == 'class' && fc[i].value == listingClass) return true;
		}
		return false;
	});
	if (template.length == 0) {
		template.push(forms.single());
	}
	template = template.single().data;

	return template;
}

function initShapes(shapes, map, columnMap) {
	console.log2('initShapes');
	init = true;
	for (var i = 0; i < shapes.length; ++i) {
		var shape = shapes[i];
		if (!shape.element) {
			setMapDescription(shape, map, columnMap);
			init = false;
		}
	}
	return init;
}

function initMultiPhotos(element, data, entityKey, serviceFactory, columnMap) {
	var img = jQuery('img', element);
	if (!img.attr('id')) {
		img.attr('id', 'multi-photo-' + data.key());
	}

	//wait until content is visible
	if (typeof google != 'undefined' && google.maps && img.parents('.infobox-container').length == 0) {
		window.setTimeout(function () {
			initMultiPhotos(jQuery('#' + 'multi-photo-' + data.key()).parent(), data, entityKey, serviceFactory, columnMap);
		}, 150);
		return;
	}

	var popupPhotoError = function () {
		img.unbind("error", popupPhotoError).attr("src",
			(window.relativeRootPath ? window.relativeRootPath : '../../') + "Images/PhotoNotAvailable.png");
	};

	img.bind("error", popupPhotoError);

	return new SDS.MultiPhotos(
		img,
		{
			id: data.key(),
			entity: entityKey,
			object: data,
			columnMap: columnMap
		}, serviceFactory);
}

function addMapPopupToFavorites(target, id) {
	SDS.Favorites.toggle(id);
	//updateMapPopupToFavorites(target, id);
}

function addMapPopupToShoppingCart(target, id) {
	SDS.Controls.ListingCartDialog.Show({
		selections: [id],
		caller: null
	});
}

function updateMapPopupToFavorites(target, id) {
	var fn = SDS.Favorites.contains(id) ? 'addClass' : 'removeClass';
	jQuery(target)[fn]('favorite');
}

function updateMapPopupToShoppingCart(target, id) {
	var fn = SDS.ShoppingCart.contains(id) ? 'addClass' : 'removeClass';
	jQuery(target)[fn]('in-cart');
}

function viewBirdsEye(lat, lon, map) {
	lat = lat * 1.0;
	lon = lon * 1.0;

	var latLong = {
		latitude: lat,
		longitude: lon
	};

	if (jQuery("#facebox").css("display") == 'block') {
		Directions.map.SetBirdseyeScene(latLong);
	} else {
		map.isUserPanEvent = map.isUserZoomEvent = true;
		map.setCenter(latLong, 19, Microsoft.Maps.MapTypeId.birdseye);
		map.isUserPanEvent = map.isUserZoomEvent = false;
	}
}

function viewListing(id, map) {
	if (jQuery('#directions-dialog').css('display') != 'none') {
		jQuery(document).trigger('close.facebox', 'directions-dialog');
	}
	SDS.Routes.set('View', { id: id });
}

function selectListing(target, property, id) {
	var key = {};
	key[property] = id;
	resultsList.findByExample(key).setSelected(jQuery(target).prop("checked"), false);
}

function setMapDescription(shape, map, columnMap) {
	var listingObject = {};

	for (var i = 0; i < requiredMapFields.length; i++) {
		listingObject[requiredMapFields[i]] = shape.data.cellAt(columnMap.get(requiredMapFields[i]));
	}

	var listingClass = (shape.data.cellAt(shape.class_column) || '').toLowerCase();

	template = jQuery.grep(map.mapForms, function (f) {
		var fc = f.conditions || f.form.filterConditions || [];
		for (var i = 0; i < fc.length; i++) {
			if (fc[i].name == 'class' && fc[i].value == listingClass) return true;
		}
		return false;
	});

	if (template.length == 0) {
		template.push(map.mapForms.single());
	}

	template = template.single().data;

	shape.element = document.createElement("DIV");
	var form = new SDS.Controls.Forms.Form({ element: shape.element });
	SDS.Controls.Forms.Form.deserializeFromXmlString(template, form);

	listingObject = extendListingObject(listingObject);
	form.bindObject(listingObject, function () { postProcessMapDescription(shape, columnMap); });
}

function postProcessMapDescription(shape, columnMap) {
	var pushPinListings = shape.getMarkers ? shape.getMarkers() : shape.data;

	var formElements = jQuery('.infobox-form-container', shape.element);
	for (var i = 0, l = pushPinListings.length; i < l; i++) {
		var data = pushPinListings[i].data || pushPinListings[i];
		if (data.length == 1) {
			data = data[0];
		}

		var formElement = jQuery(formElements[i]);

		var id = data.key();
		var arn = data.get ? (data.get('arn') || '') : '';
		var pin = data.get ? (data.get('parcel_id') || '') : '';

		formElement.find("span:contains('[Photo]')").next("span").html("<img style=\"width:165px;height:124px;\" class=\"map-description-listing-photo\" src=\""
			+ betterGetPhotoUrl(getFullEntityName(), id) + "\" onerror=\"this.src='../../Images/PhotoNotAvailable.png';this.onerror=null;\" alt=\"\" />");

		// disabled geowarehouse link:
		//(currentAppName === 'TREB' ?
		//'<a style="" target="_blank" href="../../Redirect/Redirect.aspx?n=TREB,GeowarehouseDeeplink,mlNum|' + id + ',arn|' + arn + ',parcelID|' + pin + '" class="geowarehouse-icon geowarehouse-link link">&nbsp;</a>' : ''),

		var spriteIcons = [
			"<span class=\"favorites-indicator column-icon sprite\" style=\"white-space:nowrap;\"><a href=\"javascript:void(0)\" class=\"favorite-" + (id || '').replace('*', '_') + "\" onclick=\"addMapPopupToFavorites(this,'" + id + "');return false;\">Favorites</a></span>",
			"<span class=\"shopping-cart-indicator column-icon sprite\" style=\"white-space:nowrap;\"><a href=\"javascript:void(0)\" class=\"shopping-cart-" + (id || '').replace('*', '_') + "\" onclick=\"addMapPopupToShoppingCart(this,'" + id + "');return false;\">Shopping Cart</a></span>"
		];

		formElement.find("span:contains('[Favorites]')").next("span")
			.html(spriteIcons.join(''));
		formElement.find("span:contains('[ListCheckbox]')").next("span").html("<input type=\"checkbox\" onclick=\"selectListing(this," + data._key + ",'" + id + "');\" />");
		formElement.find("span:contains('[ListNum]')").next("span").html(shape.GetCustomIcon(data.pinHtml, id));

		switch (currentAppName) {
			case 'TREB': postProcessTREBMapDescription(shape, columnMap); break;
			case 'MLSLI': postProcessMLSLIMapDescription(shape, columnMap); break;
		}
	}

	jQuery(shape.element).find('.template-report').attr('shapeID', shape.GetID());

	SDS.Events.trigger("mapShapeProcessed", shape);
}

function postProcessTREBMapDescription(shape, columnMap) {
	shape.mlLabel = 'MLS#';
};

function postProcessMLSLIMapDescription(shape, columnMap) {
	//MLSLI does not use clusters. Instead, use first listing data
	var data = shape.data[0];
	if (getEntityKey().entityName == 'Listing') {
		if (data.cellAt(columnMap.get('lsc')).toLowerCase() == 'cl') {
			jQuery("span:contains('[$listPrice]')", shape.element).parent().css('display', 'none');
			val = data.cellAt(columnMap.get('sp_dol'));
			if (val == null || val.length == 0) {
				jQuery("span:contains('[sp_dol]')", shape.element).parent().css('display', 'none');
			}
		} else if (data.cellAt(columnMap.get('lsc')).toLowerCase() == 're') {
			jQuery("span:contains('[$listPrice]')", shape.element).parent().css('display', 'none');
			val = data.cellAt(columnMap.get('rp_dol'));
			if (val == null || val.length == 0) {
				jQuery("span:contains('[rp_dol]')", shape.element).parent().css('display', 'none');
			}
		} else {
			jQuery("span:contains('[sp_dol]')", shape.element).parent().css('display', 'none');
			jQuery("span:contains('[rp_dol]')", shape.element).parent().css('display', 'none');
		}
		shape.mlLabel = 'ML#';
	} else {
		shape.mlLabel = 'ID#';
	}
};
 
 
if (!('SDS' in window)) { window.SDS = {}; }
SDS.BingMap = Base.extend({
	constructor: function (init) {
		window.__bingMapInstance = this;

		SDS.BingMap.Instances.push(this);
		this.instanceIndex = SDS.BingMap.Instances.length;

		this.container = init.container;
		this.mapContainer = document.createElement('div');
		this.mapContainer.className = 'bing-map-container mapcontainer-' + this.instanceIndex;
		this.mapContainer.id = 'bing-map-' + this.instanceIndex;

		this.toolbarContainer = document.createElement('div');
		this.toolbarContainer.className = 'bing-map-toolbar-container drawingtoolbar-' + this.instanceIndex;

		this.culture = init.culture || 'en-us';
		this.mapControlSource = init.mapControlSource || '//www.bing.com/api/maps/mapcontrol?mkt=' + this.culture + '&onscriptload=SDS.BingMap.MapReady';
		
		this.key = init.key;

		this.location = init.location;
		this.zoom = init.zoom || 14;
		this.zoomForSingleListing = init.zoomForSingleListing;
		this.initialType = init.initialType || 'auto';

		this.modulePath = init.modulePath || '../../';

		this.showDashboard = typeof init.showDashboard != 'undefined' ? init.showDashboard : true;
		this.showMapTypeSelector = typeof init.showMapTypeSelector != 'undefined' ? init.showMapTypeSelector : true;
		this.showScalebar = typeof init.showScalebar != 'undefined' ? init.showScalebar : true;

		//basic events
		this.changeHandler = init.changeHandler || null;
		this.loadHandler = init.loadHandler || null;
		this.clickHandler = init.clickHandler || null;
		this.resizeHandler = init.resizeHandler || null;
		this.mapShapeChangeHandler = init.mapShapeChangeHandler || null;
		this.viewChangeStartHandler = init.viewChangeStartHandler || null;
		this.clearShapeHandler = init.clearShapeHandler || null;

		this.showLegendHandler = init.showLegendHandler || null;

		this.drawingModeChangeHandler = init.drawingModeChangeHandler || null;

		this.features = init.features || {};
		
		this.mapService = init.mapService;

		if ('getElement' in this.container) {
			this.container = this.container.getElement();
		}
		else if (typeof this.element === 'string') {
			this.container = jQuery(this.container);
		}

		this.container.appendChild(this.mapContainer);
		this.container.appendChild(this.toolbarContainer);
		
		this.wktShapes = [];

		this.deferred = init.deferred || false;
		if (!this.deferred) {
			this.initMSMaps();
		}

		if (this.features.logUsage) {
			try {
				(new REModel.Services.LogService()).logMapAccess('newobject');
				(new REModel.Services.LogService()).logMapAccess(this.key, 'credentials');
			}
			catch (e) {
				if ('console' in window && console.log) { console.log(e); }
			}
		}

		this.requiredModules = {};

		this.changeCount = 0;
	},

	show: function () {
		if (!this.mapInitialized && this.deferred) {
			this.initMSMaps();
		}
	},

	createMap: function (reinitialize) {
		var self = this;

		//fix mapcontainer positioning
		$parent = jQuery(this.mapContainer).parent();
		if ($parent.outerWidth() == 0 && $parent.css('position') == 'absolute') {
			$parent.css({
				top: '0px', bottom: '0px', left: '0px', right: '0px'
			});
		}

		this.availableMapTypes = {
			aerial: Microsoft.Maps.MapTypeId.aerial,
			road: Microsoft.Maps.MapTypeId.road,
			birdseye: Microsoft.Maps.MapTypeId.birdseye,
			auto: Microsoft.Maps.MapTypeId.auto
		};

		this.map = new Microsoft.Maps.Map(this.mapContainer, {
			credentials: this.key,
			center: new Microsoft.Maps.Location(this.location.latitude, this.location.longitude),
			zoom: this.zoom,
			enableHighDpi: true,
			enableSearchLogo: false,
			enableClickableLogo: false,
			disableKeyboardInput: typeof this.features.keyboardInput != 'undefined' ? !this.features.keyboardInput : true,
			tileBuffer: 2,
			useInertia: false,
			culture: this.culture,
			showDashboard: this.showDashboard,
			showMapTypeSelector: this.showMapTypeSelector,
			showScalebar: this.showScalebar,
			mapTypeId: this.availableMapTypes[this.initialType || 'auto'],
			navigationBarMode: Microsoft.Maps.NavigationBarMode.compact,
			showLocateMeButton: true,
			disableStreetsideAutoCoverage: !this.showMapTypeSelector
		});

		(function adjustMapControls() {
			var mapControls = jQuery('#MicrosoftNav');

			if (mapControls.length) {
				mapControls.css('left', '60px').css('width', '300px');
				mapControls.find('#RadialMenu').css('left', -60);
			} else {
				setTimeout(adjustMapControls, 100);
			}
		})();

		if (this.clickHandler) {
			var kbEvent;

			function copyKbEvent(ev) {
				kbEvent = ev;
			}

			jQuery(document)
			.on('keydown', copyKbEvent)
			.on('keyup', copyKbEvent);

			Microsoft.Maps.Events.addHandler(this.map, 'click', function (ev) {
				if (ev.targetType == 'map') {
					ev.originalEvent = kbEvent;
					self.clickHandler(ev);
				}
			});
		}

		if (this.resizeHandler) {
			Microsoft.Maps.Events.addHandler(this.map, 'viewchangeend', function (ev) { //resize
				self.resizeHandler(ev);
			});
		}

		if (self.viewChangeStartHandler) {
			Microsoft.Maps.Events.addHandler(this.map, 'viewchangestart', function (e) {
				self.viewChangeStartHandler();
			});
		}

		Microsoft.Maps.Events.addHandler(this.map, 'maptypechanged', function (e) { //imagerychanged
			var imageryID = self.map.getImageryId();
			self.mapTypeChange(imageryID);

			if (imageryID === 'Streetside') {
				jQuery('#ShowLegend, .drawingToolsToolbar').hide();
				(function hackBingReportImageDomain() {
					var $report = jQuery('a.streetsideReportAProblemText');

					if (!$report.length) {
						return setTimeout(hackBingReportImageDomain, 100);
					}

					$report.prop('href', $report.prop('href').replace(/https:\/\/.+?\//, 'https://www.bing.com/'));
				})();
			} else {
				jQuery('#ShowLegend, .drawingToolsToolbar').show();
			}
		});

		Microsoft.Maps.Events.addHandler(this.map, 'viewchangeend', function (e) {
			if (!self.mapInitialized) {
				self.mapInitialized = true;
				self.mapLoaded();
			}

			//when the map is shown or hidden viewchangeend is fired erroneously
			if (self.hidden && jQuery(self.container).is(':visible')) {
				self.hidden = false;
				return;
			}

			if (!jQuery(self.container).is(':visible')) {
				self.hidden = true;
				return;
			}

			self.mapChanged();
		});

		//Create an instance of the custom infobox control
		if (this.requiredModules['CustomInfoboxModule']) {
			this.infobox = new CustomInfobox(this.map,
			{
				arrowColor: '#fff',     //Color of the arrow
				arrowLength: 20,        //Length of the arrow
				arrowWidth: 30,         //Width of the arrow
				borderColor: '#fff',    //Color of the infobox border
				color: '#fff',          //Background color of infobox
				minHeight: 50,          //Minium height of the content area of the infobox
				minWidth: 385,          //Minimium width of the content area of the infobox
				offset: { x: 12, y: 12 }, //Offset distance of the infobox
				orientation: 0,         //Orientation of the infobox: 0 - horizontal, 1 - vertical
				showArrow: true,
				showCloseButton: false,
				tether: false
			});
		}
		this.layers = {};
		
		if (this.features.drawing) {
			this.addLayer('editDecoration');
			this.addLayer('shapeLayer');
		}
		//add layers for pushpins and infobox
		this.addLayer('customTileLayer');
		this.addLayer('standardShapeLayer');
		this.addLayer('placesLayer', undefined, undefined, true);
		this.addLayer('pinLayer', undefined, undefined, true);
		this.addLayer('infoLayer');
		this.addLayer('locationsLayer', undefined, undefined, true);

		if (this.features.drawing) {
			this.addLayer('edittingLayer');
			this.addDrawingTools(this.features.drawing, reinitialize);
		}

		// update HTMLPin positions on map resize
		function untilResize(oldBounds) {
			function getBoundsToken() { return JSON.stringify(self.map.getBounds()); }

			if (!oldBounds) { oldBounds=getBoundsToken(); }

			var newBounds = getBoundsToken();

			if (oldBounds !== newBounds) {
				setTimeout(function () {
					Object.keys(__bingMapInstance.layers)
					.map(function (key) { return __bingMapInstance.layers[key]; })
					.filter(function (layer) { return layer.updatePositions; })
					.forEach(function (layer) { layer.updatePositions(); });
				}, 100);
			} else setTimeout(function () {
				untilResize(oldBounds);
			}, 100);
		}
		jQuery('#MapSplitPane').on('pageResize', function () { untilResize(); });
	},

	createPinLayerCluster: function () {
		var self = this;
		self.pinLayerCluster = new ClusteredEntityCollection(self.map, {
			singlePinCallback: function (pin) {
				var lt = pin.Latitude;
				var ln = pin.Longitude;
				var pushPin = self.createPushpin(pin.options);
				return pushPin;
			},
			clusteredPinCallback: function (cluster, latlong) {
				var pushPins = self.createClusteredPin(cluster, latlong, { width: 24, height: 24, draggable: false, textOffset: new Microsoft.Maps.Point(0, 4) })
				pushPins.cluster = cluster;
				return pushPins;
			}
		});

		return self.pinLayerCluster.GetLayer();
	},

	createClusteredPin: function (cluster, latlong, options) {
		options.cssClass = options.typeName || 'map-overlapping-marker';

		var pin = new Microsoft.Maps.Pushpin(latlong, {
			htmlContent: options.htmlContent || this.getPinHtml(options),
			width: options.width,
			height: options.height,
			draggable: options.draggable
		});

		var data = [];
		for (var i = 0, l = cluster.length; i < l; i++) {
			var item = cluster[i];
			item.options.data.pinHtml = this.getPinHtml(item.options);
			data.push(item.options.data);
		}

		pin.data = data;

		var options = cluster[0].options;
		this.pushPinBindEvents(pin, options)

		return pin;
	},

	getPinHtml: function (options) {
		var baseName = options.iconCssBase || 'map-pushpin';
		var typeName = options.cssClass || '';

		var label = options.label || '';
		var width = options.width || 24;
		var height = options.height || 24;

		return '<div class="' + baseName + ' ' + typeName + '" style="pointer-events: all; width: ' + width + 'px;height: ' + height + 'px;"><div class="text">' + label + '</div></div>';
	},

	clear: function (layerName) {
		if (!this.layers) { return; }
		if (!layerName) {
			for (var prop in this.layers) {
				this.layers[layerName].clear();
			}
		}
		else if (this.layers[layerName] && this.layers[layerName].clear) {
			this.layers[layerName].clear();
		}
	},

	clearShapes: function (quiet) {
		if (this.drawingTools) {
			this.drawingTools.clear(quiet);
		}
	},

	clearPushpins: function () {
		this.clear('pinLayer');

		if (this.features.clusters) {
			this.clusterablePins = [];
			this.pinLayerCluster.SetData([]);
		}
	},

	removePushpin: function (pin, layer) {
	    this.layers[layer || 'pinLayer'].remove(pin);
	},

	addPushpin: function (options) {

		var self = this;
		if (this.features.clusters) {
			this.clusterablePins = this.clusterablePins || [];
			var location = options.location;
			this.clusterablePins.push({
				Name: '',
				Latitude: options.location[0],
				Longitude: options.location[1],
				options: options
			});

			//We have to wait until all pushpins are added before setting to pinLayer
			clearTimeout(this.setClusterPinsTimeout);
			this.setClusterPinsTimeout = setTimeout(function () {
				self.pinLayerCluster.SetData(self.clusterablePins);
			}, 1);
		}
		else {
			var pin = this.createPushpin(options);
			if (!options.layer) {
				this.layers.pinLayer.push(pin);
			}			
		}
	},

	createPushpin: function (options, clustered) {
		var self = this;

		if (typeof options == 'undefined') { options = {}; }

		if (options.basic) {
			var pin = new Microsoft.Maps.Pushpin(options.location, { 'draggable': options.draggable });
			this.layers['pinLayer'].push(pin);
			return;
		}
	
		var location = options.location || null;
		
		var data = options.data;
		var infoboxContent = options.infoboxContent || null;

		if (options.title && options.body) {
			infoboxContent = '<div class="VE_Pushpin_Popup_Title">' + options.title + '</div>' +
				'<div class="VE_Pushpin_Popup_Body">' + options.body + '</div>'
		}
		
		var draggable = typeof options.draggable != 'undefined' ? options.draggable : false;

		//location is required
		if (!location) {
			return;
		}

		//support location in the formats of { latitude: x, longitude: y } or [x, y]
		if (location.length && location.length == 2) {
			location = new Microsoft.Maps.Location(location[0], location[1]);
		} else if (location.latitude && location.longitude) {
			location = new Microsoft.Maps.Location(location.latitude, location.longitude);
		}

		if (!data) {
			data = {};
		}
		
		var pin = new HtmlPushpin(location, options.htmlContent || this.getPinHtml(options), new Microsoft.Maps.Point(24, 24));

		pin._element.className = 'MapPushpinBase';

		// v7 compat
		pin._element.pin = pin;
		pin.getLocation = function () { return this.location; };
		pin.getHtmlContent = function () { return this._element.innerHTML; };
		
		if (infoboxContent) {
		    pin.content = infoboxContent;

		    if (options.infoboxHandleClick) {
		        pin.infoboxHandleClick = options.infoboxHandleClick;
		    }
		}

		if (data) {
			pin.data = [data];
		}

		if (options.layer) {
			this.layers[options.layer].push(pin);
		}

		this.pushPinBindEvents(pin, options);

		return pin;
		
	},

	addLayer: function (layerName, index, overwrite, makeHtmlLayer) {
		if (layerName === 'listingsLayer') {
			makeHtmlLayer = true;
		}

		if (!this.layerIndexMap) {
			this.layerIndexMap = {};
		}

		if (!this.layers[layerName] || overwrite) {
			var layer;

			if (layerName == 'pinLayer' && this.features.clusters) {
				layer = this.createPinLayerCluster();
			}
			else if (!makeHtmlLayer) {
				layer = new Microsoft.Maps.Layer(layerName);

				// v7 compat
				layer.push = layer.add;
				layer.getLength = function () {
					return layer.getPrimitives().length;
				};
				layer.get = function (i) {
					return layer.getPrimitives()[i];
				};
			} else {
				layer = new HtmlPushpinLayer();
			}

			this.layers[layerName] = layer;
			
			if (typeof index != 'undefined') {
				this.map.layers.insert(layer, index);
				this.layerIndexMap[layerName] = index;
				return this.map.layers[index];
			}
			else {
				if (!(layerName == 'pinLayer' && this.features.clusters)) {
					this.map.layers.insert(layer);
				}
				this.layerIndexMap[layerName] = this.map.layers.length - 1;

				return this.map.layers[this.map.layers.length - 1];
			}

			return layer;
		}
	},

	pushPinBindEvents: function (pin, options) {
		var self = this;

		function addHandler(element, event, handler) {
			if (element.parentElement) { // is added to DOM
				jQuery(element).on(event, function (ev) {
					ev.target = ev.currentTarget.pin; // simulate v7 events
					handler(ev);
				});
			} else {
				setTimeout(function () { addHandler(element, event, handler) }, 0);
			}
		};

		if (pin.content) {
			addHandler(pin._element, 'click', function (ev) {
				self.displayInfobox(ev);
				if (ev.preventDefault) {
					ev.preventDefault();
				}
				if (ev.originalEvent) {
					ev.originalEvent.returnValue = false;
				}
				return false;

			});
			addHandler(pin._element, 'mouseover', function (ev) {
				self.displayInfobox(ev);
			});
			addHandler(pin._element, 'mouseout', function (ev) {
				self.hideInfobox(ev);
			});
		}
		else {
			var handleClick = options.click || null;
			var handleMouseover = options.mouseover || null;
			var handleMouseout = options.mouseout || null;

			if (handleClick) {
				addHandler(pin._element, 'click', function (ev) {
					handleClick(ev);
					if (ev.preventDefault) {
						ev.preventDefault();
					}
					if (ev.originalEvent) {
						ev.originalEvent.returnValue = false;
					}
					return false;
				});
			}
			if (handleMouseover) {
				addHandler(pin._element, 'mouseover', function (ev) {
					handleMouseover(ev);
				});
			}
			if (handleMouseout) {
				addHandler(pin._element, 'mouseout', function (ev) {
					handleMouseout(ev);
				});
			}
		}
	},

	// for use with Directions
	// use DrawingTools for other usages 
	addPolyline: function (coordinates, options) {
		if (!options) {
			options = {
				strokeThickness: 5,
				strokeColor: new Microsoft.Maps.Color(175, 36, 80, 128)
			}
		}

		// Bing wants a "pure" Array with no extra methods due to bad use of instanceOf - Array.from would be better but not in IE11
		coordinates = coordinates.reduce(function (prev, current) {
			prev.push(current);
			return prev;
		}, []);

		if (coordinates.length && coordinates.length > 0) {
			this.layers['standardShapeLayer'].push(new Microsoft.Maps.Polyline(coordinates, options ? options : null));
		}
	},

	displayInfobox: function (ev) {
		var self = this;
		var pin = null;

		//do not show infoboxes while drawing
		if (this.isDrawing) {
			return;
		}

		if (ev.targetType == "pushpin") {
			pin = ev.target;
		}
		else if ('content' in ev){
			pin = ev;
		}
		else if (ev.target) {
			pin = ev.target
		}

		if (pin) {
			//do not show listings pins when hide-listings-map is present
			if (jQuery('#MasterDynamicBody.hide-listings-map').length > 0 && pin._htmlContent && pin._htmlContent.indexOf('show-when-listing-hidden') == -1) {
				return;
			}

			if (this.__hideTimeout) {
				window.clearTimeout(this.__hideTimeout);
			}

			this.infobox.show(pin.getLocation(), pin.content, function (infoContainer) {
				self.infoboxVisible = true;
				jQuery(infoContainer)
					.off('mouseover')
					.off('mouseout')
                    .off('click')
					.on('mouseover', function () {
						if (self.__hideTimeout) {
							window.clearTimeout(self.__hideTimeout);
						}
					})
					.on('mouseout', function () {
						self.hideInfobox();
					});

				if (pin.infoboxHandleClick) {
				    jQuery(infoContainer)
                        .on('click', function (e) {
                            pin.infoboxHandleClick(e, pin);
                        });
				}
			});
		}
	},

	hideInfobox: function (ev) {
		this.infoboxVisible = false;

		var self = this;
		if (this.__hideTimeout) {
			window.clearTimeout(this.__hideTimeout);
		}
		this.__hideTimeout = window.setTimeout(function () {
			self.infobox.hide();
		}, 250);
	},

	toggleDrawingTools: function (visible) {
		if (visible) {
			jQuery('.drawingtoolbar-' + this.instanceIndex).show();
		}
		else {
			jQuery('.drawingtoolbar-' + this.instanceIndex).hide();
		}
	},

	reinitMap: function () {
		var layerData = [];
		
		for (layerName in this.layers) {
			layerData.push(this.getLayerDataByName(layerName));
		}

		this.layers = {};
		this.layerIndexMap = {};

		jQuery('.drawingToolsToolbar', '.drawingtoolbar-' + this.instanceIndex).remove();

		this.location = this.map.getCenter();
		this.zoom = this.map.getZoom();
		this.initialType = this.map.getMapTypeId();

		this.createMap(true);
		this.restoreLayers(layerData);
	},

	getLayerDataByName: function (layerName) {
		var layerEntities = [];
		var layerIndex = this.layerIndexMap[layerName];
		var layer = this.map.entities.get(layerIndex);
		for (var i = 0, l = layer.getLength() ; i < l; i++) {
			layerEntities.push(layer.removeAt(i));
		}

		return {
			index: layerIndex,
			name: layerName,
			entities: layerEntities
		};
	},

	restoreLayers: function (layerData) {
		layerData.sort(function (a, b) {
			return a.index > b.index ? 1 : a.index < b.index ? -1 : 0;
		});

		for (var i = 0; i < layerData.length; i++) {
			var layer = this.layers[layerData[i].name];
			if (layer) {
				for (var x = 0; x < layerData[i].entities.length; x++) {
					if (layerData[i].entities[x]) {
						layer.push(layerData[i].entities[x]);
					}
				}
			}
		}
	},

	addDrawingTools: function (mode, reinitialize) {
		var self = this;

		if (this._drawingToolsAdded && !reinitialize) {
			return;
		}

		this._drawingToolsAdded = true;
		if (mode == 'hidden') {
			this.hidden = true;
			jQuery('.drawingtoolbar-' + this.instanceIndex).hide();
		}

		this.drawingTools = new DrawingTools.DrawingManager(this.map, {
			toolbarContainer: jQuery('.drawingtoolbar-' + self.instanceIndex).get(0),
			toolbarOptions: {
				drawingModes: ['polygon', 'circle', 'rectangle', 'edit', 'erase', 'excludeshape', 'unionshapes'],
				styleTools: []
			},
			shapeLayer: this.layers['shapeLayer'],
			edittingLayer: this.layers['edittingLayer'],
			editDecorationLayer: this.layers['editDecoration'],
			defaultUnits: this.features.defaultUnits || 'mi',
			shapeOptions: {
				strokeThickness: 1,
				strokeColor: new Microsoft.Maps.Color(200, 36, 80, 128),
				fillColor: new Microsoft.Maps.Color(51, 66, 139, 202)
			},
			events: {
			    drawingModeChanged: function (mode) { self.drawingModeChanged(mode); },
				drawingChanged: function (e) { self.drawingChanged('changed', e); },
				drawingErased: function (e) {
					self.drawingCleared();
				},
				drawingStarted: function (e) {
				},
				drawingEnded: function (e) {
					self.drawingChanged('ended', e);
				}
			}
		});

		if (this.mapService) {
			this.drawingTools.unionHandler = function (currentShape) {
				var allShapes = self.getShapes();
				var currentWKT = WKTModule.Write(currentShape);
				var shapes = [];
				for (var i = 0, l = allShapes.length; i < l; i++) {
					if (allShapes[i] != currentWKT) {
						shapes.push(allShapes[i]);
					}
				}
				self.mapService.unionShapes(currentWKT, shapes, function (wktShapes) {
					if (wktShapes && wktShapes.length > 0) {
						self.drawingTools.clear();
						var shapeLayer = self.drawingTools.getShapeLayer();
						for (var i = 0, l = wktShapes.length; i < l; i++) {
							var shape = WKTModule.Read(wktShapes[i]);
							shape.setOptions(self.drawingTools.getShapeOptions());
							shapeLayer.push(shape);
						}

						self.mapChanged(true);
					}
				});
			};

			this.drawingTools.excludeHandler = function (currentShape) {
				var allShapes = self.getShapes();
				var currentWKT = WKTModule.Write(currentShape);
				var shapes = [];
				for (var i = 0, l = allShapes.length; i < l; i++) {
					if (allShapes[i] != currentWKT) {
						shapes.push(allShapes[i]);
					}
				}

				self.mapService.excludeShapes(currentWKT, shapes, function (wktShapes) {
					if (wktShapes && wktShapes.length > 0) {
						self.drawingTools.clear();
						var shapeLayer = self.drawingTools.getShapeLayer();
						for (var i = 0, l = wktShapes.length; i < l; i++) {
							var shape = WKTModule.Read(wktShapes[i]);
							shape.setOptions(self.drawingTools.getShapeOptions());
							shapeLayer.push(shape);
						}

						self.mapChanged(true);
					}
				});
			};
		}
	},

	drawingChanged: function (evtType, ev) {
		if (this.mapShapeChangeHandler) {
			this.mapShapeChangeHandler(this.getShapes());
		}
		else {
			this.mapChanged(true);
		}
	},

	drawingCleared: function () {
		this.clearPushpins();
		if (this.clearShapeHandler) {
			this.clearShapeHandler();
		}
	},

	drawingModeChanged: function (mode) {
		if (this.previousDrawingMode != mode) {
			this.previousDrawingMode = mode;
			if (this.drawingModeChangeHandler) {
				this.drawingModeChangeHandler(mode);
			}
		}
		
		
		if (mode == 'polygon' || mode == 'circle' || mode == 'rectangle' || mode == 'edit') {
			this.isDrawing = true;
		}
		else {
			this.isDrawing = false;
		}
	},

	getShapes: function (asShapes) {
		if (!this.drawingTools) {
			return [];
		}

		var _shapes = [];
		var shapes = this.drawingTools.getShapeLayer();

		var length = shapes.getPrimitives().length;
		for (var i = 0; i < length; i++) {
			var shape = shapes.getPrimitives()[i];
			if (shape && shape.getLocations().length > 3) {
				_shapes.push(asShapes ? shape : WKTModule.Write(shape));
			}
		}

		return _shapes;
	},

	hasShapes: function () {
		if (!this.drawingTools) { return false; }
		var shapes = this.drawingTools.getShapeLayer();
		return shapes.getPrimitives().length > 0;
	},

	mapLoaded: function () {
		if (this.layers.pinLayer.container === null) {
			var self = this;
			return setTimeout(function () { self.mapLoaded() }, 100);
		}

		if (this.loadHandler) {
			this.loadHandler();
		}

		this.addCustomMapControls();
	},

	addCustomMapControls: function () {
		var self = this;
		var topBar = jQuery('#MicrosoftNav');
		if (topBar.length > 0) {
			if (this.features.mapArt) {
				this.addMapArtButtons();
			}

			if (this.showLegendHandler) {
				this.addLegendButton();
			}

			jQuery('.NavBar_modeSelectorControlContainer:not(.adjusted)').on('mouseover', function (e) {
				var self = this;
				if (!jQuery(e.target).parent().hasClass('NavBar_modeSelectorControlContainer')) { return; }
				jQuery(this).addClass('adjusted');

				window.setTimeout(function () {
					jQuery('.NavBar_itemContainer.NavBar_itemContainer_be', self).attr('href', 'javascript:void(0);');
				}, 100);
			});

		}
		else {
			window.setTimeout(function () {
				self.addCustomMapControls();
			}, 200);
		}
		
	},

	addLegendButton: function () {
		var self = this;
		var msNav = jQuery('#MicrosoftNav'),
			topBar = msNav.parent();

		if (topBar) {
			self.legendButton = jQuery('<span class="NavBar_button NavBar_typeButton" id="ShowLegend" style="width: 60px;background: #fff;display: block;text-align: center;border-bottom: 2px solid #555;padding: 6px 0 6px 0;cursor: pointer;float:left; pointer-events: all;">Legend</span>');
			
			//msNav.css('top', '29px');
			topBar.prepend(self.legendButton);

			jQuery(self.legendButton).on('click', function () {
				self.showLegend();
			});
		}
	},

	showLegend: function () {
		if (this.showLegendHandler) {
			this.showLegendHandler();
		}
	},

	addMapArtButtons: function () {
		var self = this;
		jQuery(this.mapContainer).addClass('hasMapArt');

		this.mapServer = location.href.toLowerCase().indexOf('/live') == 0 ? 'http://dev2.stratusmls.com/' : 'http://www.torontomls.net/';
		var customLayers = [
			{ name: "art",  label: "MapArt", index: 0, tileURL: this.mapServer + "Maps/MapArt/Layer_MapArt/{quadkey}.png" },
			{ name: "grid", label: "Grid", index: 1, tileURL: this.mapServer + "Maps/MapArt/Layer_GridLayer/{quadkey}.png" },
			{ name: "area", label: "Areas", index: 2, tileURL: this.mapServer + "BingCommunitiesMap/BingMapData/Layer_Areas/{quadkey}.png" },
			{ name: "muni", label: "Municipalities", index: 3, tileURL: this.mapServer + "BingCommunitiesMap/BingMapData/Layer_Municipalities/{quadkey}.png" },
			{ name: "comm", label: "Communities", index: 4, tileURL: this.mapServer + "BingCommunitiesMap/BingMapData/Layer_Communities/{quadkey}.png" }
		];
		

		var $topBar = jQuery('.NavBar_modeSelectorControlContainer');

		if ($topBar.length > 0) {
			var $seperator = jQuery('<span class="NavBar_separator"/>');
				
			var $mapArtButton = jQuery('<li class="button_artmenu NavBar_button">Map Layers<a class="NavBar_dropIconContainer" href="#"><span class="NavBar_dropIcon"></span></a></li>');
			var $container = jQuery('<ul style="display:none; max-width: 150px; position: absolute; z-index: 1" class="MicrosoftMap_NavBar_typeMenu MicrosoftMap_NavBar_artMenu"></ul>');
			$mapArtButton.append($container);

			self.layers['customTileLayer'].setOptions({ visible: false });
			self.mapArtLayers = {};

			for (var i = 0, l = customLayers.length; i < l; i++) {

				$menuItem = jQuery('<li data-name="' + customLayers[i].name + '" id="NavBar_button" class="NavBar_menuitem ' + customLayers[i].name + '"><a class="NavBar_button NavBar_itemContainer NavBar_itemContainer_auto">' + customLayers[i].label + '</a></li>');
				$menuItem
					.on('click', function () {
						var name = jQuery(this).data('name');
						self.showHideMapArt(jQuery.grep(customLayers, function (layer) {
							return name == layer.name;
						})[0]);
					});

				$container.append($menuItem);

				var tileSource = new Microsoft.Maps.TileSource({ uriConstructor: customLayers[i].tileURL });
				var tileLayer = new Microsoft.Maps.TileLayer({ mercator: tileSource });
				tileLayer.setOptions({ visible: false, zIndex: customLayers[i].index });

				self.mapArtLayers[customLayers[i].name] = tileLayer;

				self.layers['customTileLayer'].push(tileLayer);

			}
				
			$topBar.append($seperator);
			$topBar.append($mapArtButton);

			$mapArtButton
				.on('mouseover', function (ev) {
					$container.show();
				})
				.on('mouseout', function (ev) {
					$container.hide();
				})
				.on('click', function () {
					if ($container.is(':visible')) {
						$container.hide();
					}
					else {
						$container.show();
					}
				});
		}
	},

	showHideMapArt: function (layer) {
		if (!this.layers['customTileLayer'].getVisible()) {
			this.layers['customTileLayer'].setOptions({ visible: true });
		}
		var visible = this.mapArtLayers[layer.name].getVisible();

		jQuery('.NavBar_menuitem.' + layer.name).toggleClass('active', !visible);
		this.mapArtLayers[layer.name].setOptions({
			visible: !visible,
			zIndex: layer.index
		});
	},

	mapChanged: function (shapesChanged) {
		var self = this;
		this.changeCount++;

		if (this.changeCount == 1) {
			//ignore first change, this is always fired on map load
			return;
		}
		if (shapesChanged) {
			this.wktShapes = this.getShapes();
		}
		
		if (SDS.BingMap.__searchTimeout) {
			clearTimeout(SDS.BingMap.__searchTimeout);
		}

		SDS.BingMap.__searchTimeout = window.setTimeout(function () {
			self.bounds = self.map.getBounds();
			self.northwest = self.bounds.getNorthwest();
			self.southeast = self.bounds.getSoutheast();
			self.center = self.bounds.center;

			if (self.changeHandler) {
				self.changeHandler({
					bounds: {
						northwest: [self.northwest.latitude, self.northwest.longitude],
						southeast: [self.southeast.latitude, self.southeast.longitude],
						center: [self.southeast.latitude, self.southeast.longitude]
					},
					zoom: self.map.getZoom(),
					shapes: self.wktShapes
				});
			}

			Microsoft.Maps.Events.invoke(self.map, "viewchange", {});
		}, 500);
	},

	mapTypeChange: function (mapType) {
		if (this.drawingTools) {
			var curMapType = (mapType || '').indexOf('Birdseye') != -1 ? 'Birdseye' : mapType;
			if (curMapType != this._prevMapType) {
				this._prevMapType = curMapType;
				var shapeOptions = {};

				if (curMapType == 'Birdseye' || curMapType == 'Aerial') {
					shapeOptions = {
						strokeThickness: 1,
						strokeColor: new Microsoft.Maps.Color(200, 255, 255, 255),
						fillColor: new Microsoft.Maps.Color(100, 255, 255, 255)
					};

					if (curMapType == 'Birdseye') {
						if (this.layers['customTileLayer'].getVisible()) {
							this.layers['customTileLayer'].setOptions({ visible: false });
							this.enableMapArtWhenAvailable = true;
						}
					}
					else {
						if (this.enableMapArtWhenAvailable) {
							this.layers['customTileLayer'].setOptions({ visible: true });
						}
					}
				}
				else {
					shapeOptions = {
						strokeThickness: 1,
						strokeColor: new Microsoft.Maps.Color(200, 36, 80, 128),
						fillColor: new Microsoft.Maps.Color(51, 66, 139, 202)
					};

					if (this.enableMapArtWhenAvailable) {
						this.layers['customTileLayer'].setOptions({ visible: true });
					}
				}

				this.drawingTools.setShapeOptions(shapeOptions);
			}
		}

		jQuery('#ShowLegend').css('background', mapType !== 'Road' ? 'rgba(0,0,0,0.6)' : '#fff').css('color', mapType !== 'Road' ? '#fff' : '#000');
	},

	initMSMaps: function () {
		var self = this;
		if ((!('Microsoft' in window) || !('Microsoft.Maps' in window))) {
			jQuery.ajaxSetup({ cache: true });
			jQuery.getScript(this.mapControlSource, function () {
				self._loadInterval = window.setInterval(function () {
					if ('Microsoft' in window && Microsoft.Maps && Microsoft.Maps.Map && Microsoft.Maps.loadModule) {
						window.clearInterval(self._loadInterval);
						self.loadModules();
					}
				}, 100)
			});
			jQuery.ajaxSetup({ cache: false });
		}
	},

	loadModules: function () {
		var self = this;
		this.requiredModules['Microsoft.Maps.AdvancedShapes'] = false;
		this.requiredModules['CustomInfoboxModule'] = false;
		this.requiredModules['HtmlPushpinLayerModule'] = false;

		if (this.features.clusters) {
			this.requiredModules['ClientSideClusteringModule'] = false;
		}

		if (this.features.drawing) {
			this.requiredModules['WKTModule'] = false;
			this.requiredModules['DrawingToolsModule'] = false;
		}
		
		if (this.features.directions) {
			this.requiredModules['Microsoft.Maps.Directions'] = false;
		}

		function loadMapsModule(name) {
			Microsoft.Maps.loadModule(name, {
				callback: function () {
					self.modulesLoaded(name);
				}
			});
		}

		loadMapsModule('Microsoft.Maps.AdvancedShapes');

		Microsoft.Maps.registerModule('HtmlPushpinLayerModule', this.modulePath + 'External/BingMaps/V7/HTMLPushPins/HtmlPushpinLayerModule.js');
		loadMapsModule('HtmlPushpinLayerModule');

		if (this.features.drawing) {
			Microsoft.Maps.registerModule("DrawingToolsModule", this.modulePath + "External/BingMaps/V7/DrawingTools/DrawingToolsModule.js?c=3.43.61");

			loadMapsModule("DrawingToolsModule");

			//register and load the Well Known Text Module
			Microsoft.Maps.registerModule("WKTModule", this.modulePath + "External/BingMaps/V7/WellKnownText/WKTModule.js");
			loadMapsModule("WKTModule");
		}

		//Register and load the Custom Infobox Module
		Microsoft.Maps.registerModule("CustomInfoboxModule", this.modulePath + "External/BingMaps/V7/CustomInfoBox/V7CustomInfobox.js?v=3.43.7");
		loadMapsModule("CustomInfoboxModule");

		if (this.features.clusters) {
			Microsoft.Maps.registerModule("ClientSideClusteringModule", this.modulePath + "External/BingMaps/V7/ClientSideClustering/V7ClientSideClustering.js?v=3.43.6");
			loadMapsModule("ClientSideClusteringModule");
		}

		if (this.features.directions) {
			loadMapsModule("Microsoft.Maps.Directions");
		}
	},

	//verify all required modules are loaded and call createMap
	modulesLoaded: function (moduleName) {
		this.requiredModules[moduleName] = true;

		for (var prop in this.requiredModules) {
			if (this.requiredModules[prop] === false) {
				return false;
			}
		}
		
		if (!this._modulesLoaded) {
			this._modulesLoaded = true;

			this.createMap();

			//cache session credentials for this instance
			this.getCredentials(function () { return; });
		}
	},

	getBounds: function () {
		return this.map.getBounds();
	},

	getBoundingRectangle: function (asBinaryString) {
		var bounds = this.map.getBounds();
		var nw = bounds.getNorthwest();
		var se = bounds.getSoutheast();

		var points = [];
		points.push([nw.longitude, nw.latitude]);
		points.push([se.longitude, nw.latitude]);
		points.push([se.longitude, se.latitude]);
		points.push([nw.longitude, se.latitude]);
		points.push([nw.longitude, nw.latitude]);

		if (asBinaryString) {
			return [points[0].join(' '), points[1].join(' '), points[2].join(' '), points[3].join(' '), points[4].join(' ')].join(', ');
		}
		else {
			return points;
		}
	},

	getCenter: function () {
		return this.map.getCenter();
	},

	getZoomLevel: function () {
		return this.map.getZoom();
	},

	getMapStyle: function () {
		return this.map.getMapTypeId();
	},

	setCenter: function (latLng, zoom, mapTypeId) {
		var self = this;
		//MapLocation can sometimes attempt to access this before it is loaded
		// wait for the load
		if (!this.map) {
			if (this._setCenterTimeout) {
				window.clearTimeout(this._setCenterTimeout);
			}
			this._setCenterTimeout = window.setTimeout(function () {
				self.setCenter(latLng, zoom, mapTypeId);
			}, 100);
			return;
		}

		var viewOptions = this.map.getOptions();
		viewOptions.zoom = this.map.getZoom();
		if (latLng) {
			viewOptions.center = new Microsoft.Maps.Location(latLng.latitude, latLng.longitude);
			delete viewOptions.bounds;
		}
		if (zoom && !isNaN(parseFloat(zoom))) {
			viewOptions.zoom = parseFloat(zoom);
		}
		if (mapTypeId) {
		    viewOptions.mapTypeId = mapTypeId;
		}
		this.map.setView(viewOptions);
	},

	setCenterFromGeocodeResults: function (results, zoomLevel) {
		if (results && results.resourceSets && results.resourceSets.length > 0 && results.resourceSets[0].resources && results.resourceSets[0].resources.length > 0) {
			var coordinates = results.resourceSets[0].resources[0].point.coordinates;
			var latLng = { latitude: coordinates[0], longitude: coordinates[1] };
			this.setCenter(latLng, zoomLevel);
		}
	},

	SetScaleBarDistanceUnit: function (val) {
		//depreciated
		//if ('console' in window && console.log) { console.log('DEPRECIATED', 'SetScaleBarDistanceUnit', val); }
	},

	getCredentials: function (callback) {
		var self = this;

		if (this.sessionID) {
			callback();
			return;
		}

		this.map.getCredentials(function (sessionID) {
			self.sessionID = sessionID;
			callback()
		});
	},

	getDirections: function (addresses, options, callback) {
		var self = this;
		options = options || {};

		//A map instance is required to use this method
		if (!this.map) {
			return;
		}
		
		if (!this.sessionID) {
			this.getCredentials(function () {
				self.getDirections(addresses, options, callback);
			});
			return;
		}

		if (!options.travelMode) {
			options.travelMode = 'Driving';
		}

		if (!options.optimize) {
			options.optimize = 'time';
		}

		//path tolerance
		if (!options.tl) {
			options.tl = 0.00000344978;
		}

		//?o=json&wp.0=london&wp.1=leeds&avoid=minimizeTolls&key=' + this.sessionID
		var directionsAPIURL = 'http://dev.virtualearth.net/REST/V1/Routes/Driving';
		var urlParams = jQuery.extend({}, options);

		for (var i = 0; i < addresses.length; i++) {
			var urlParamKey = 'wp.' + i;

			//address is an array [latitude, longitude]
			if (addresses[i].length && addresses[i].length == 2) {
				urlParams[urlParamKey] = addresses[i][0] + ',' + addresses[i][1];
			}
			//address is a string
			else {
				urlParams[urlParamKey] = addresses[i];
			}
		}

		var url = directionsAPIURL + '?key=' + this.sessionID + '&routePathOutput=Points&o=json';
		for (var param in urlParams) {
			url += '&' + param + '=' + encodeURIComponent(urlParams[param]);
		}

		jQuery.getJSON(url + '&jsonp=?', function (data) {
			callback(data);
		});
	},

	geocode: function (addressOrQuery, centerResults, callback, zoomLevel) {
		var self = this;
		
		if (!this.geocodeResults) {
			this.geocodeResults = {};
		}

		if (centerResults && this.geocodeResults[addressOrQuery]) {
			this.setCenterFromGeocodeResults(this.geocodeResults[addressOrQuery], zoomLevel);

			if (callback) {
				callback(this.geocodeResults[addressOrQuery]);
			}
			return;
		}

		this.getCredentials(function () {
			var geocodeRequest = "http://dev.virtualearth.net/REST/v1/Locations?query=" + encodeURI(addressOrQuery) + "&output=json&key=" + self.sessionID;
			jQuery.getJSON(geocodeRequest + '&jsonp=?', function (data) {
				if (data) {
					self.geocodeResults[addressOrQuery] = data;
				}

				if (centerResults) {
					self.setCenterFromGeocodeResults(data, zoomLevel);
				}

				if (callback) {
					callback(data);
				}
			});
		});
	},

	find: function (query, callback, failure) {
		function news2senw(bounds) { 
			return [bounds[2], bounds[3], bounds[0], bounds[1]]; 
		}

		// from https://msdn.microsoft.com/en-us/library/hh478191.aspx
		var POITypes = { "Winery": 2084, "ATM": 3578, "Train Station": 4013, "Commuter Rail Station": 4100, "Bus Station": 4170, "Named Place": 4444, "Ferry Terminal": 4482, "Marina": 4493, "Airport": 4581, "Business Facility": 5000, "Grocery Store": 5400, "Auto Dealerships": 5511, "Petrol/Gasoline Station": 5540, "Motorcycle Dealership": 5571, "Restaurant": 5800, "Historical Monument": 5999, "Bank": 6000, "Shopping": 6512, "Hotel": 7011, "Ski Resort": 7012, "Tourist Information": 7389, "Rental Car Agency": 7510, "Parking Lot": 7520, "Parking Garage/House": 7521, "Park & Ride": 7522, "Auto Service & Maintenance": 7538, "Cinema": 7832, "Rest Area": 7897, "Performing Arts": 7929, "Sports Complex": 7940, "Park/Recreation Area": 7947, "Casino": 7985, "Convention/Exhibition Centre": 7990, "Golf Course": 7992, "Civic/Community Centre": 7994, "Amusement Park": 7996, "Tourist Attraction": 7999, "Hospital": 8060, "Higher Education": 8200, "School": 8211, "Library": 8231, "Museum": 8410, "Automobile Club": 8699, "City Hall": 9121, "Court House": 9211, "Police Station": 9221, "Campground": 9517, "Truck Stop/Plaza": 9522, "Post Office": 9530, "Convenience Store": 9535, "Clothing Store": 9537, "Department Store": 9545, "Home Specialty Store": 9560, "Pharmacy": 9565, "Specialty Store": 9567, "Sporting Goods Store": 9568, "Highway Exit": 9592, "Transportation Service": 9593, "Weigh Station": 9710, "Cargo Centre": 9714, "Military Base": 9715, "Animal Park": 9718, "Home Improvement & Hardware Store": 9986, "Consumer Electronics Store": 9987, "Office Supply & Services Store": 9988, "Bookstore": 9995, "Coffee Shop": 9996, "Hamlet": 9998, "Border Crossing": 9999 };

		POITypes.Gas = 5540;
		POITypes.Parks = 7947;
		POITypes.Restaurants = 5800;
		POITypes.Pizza = 5800;
		POITypes.Sushi = 5800;
		POITypes.Schools = 8211;
		POITypes.Supermarkets = 5400;

		function places(bounds) { 
			return [
				'http://spatial.virtualearth.net/REST/v1/data/f22876ec257b474b82fe2ffcb8393150/NavteqNA/NavteqPOIs?spatialFilter=bbox(',
				news2senw(bounds).join(),
				')&$format=json&key=',
				__bingMapInstance.key,
				'&$filter=EntityTypeID eq ',
				POITypes[query.what] || -1,
				'&jsonp=?'
			].join('');
		}

		jQuery.getJSON(places(query.bounds.bounds), function (response) {
			response.d.searchResults = response.d.results
			.filter(function (r) {
				return (query.what !== 'Pizza' || r.Name.toLowerCase().indexOf('pizz') !== -1)
				&& (query.what !== 'Sushi' || r.Name.toLowerCase().indexOf('sushi') !== -1);
			});
			response.d.searchResults.forEach(function (r) {
				r.location = [r.Latitude, r.Longitude];
				r.name = r.DisplayName;
				r.address = r.AddressLine;
				r.city = r.Locality.split(',')[0];
				r.state = r.AdminDistrict;
				r.phone = r.Phone.replace(/(\d{3})-(\d{3})(\d{4})/, '($1) $2-$3');
			});
			callback(response.d);
		});
	},

	setShapes: function (shape) {
		
	},

	shapeFromWKT: function (str) {
		return WKTModule.Read(str);
	},

	setPolygon: function (polygonPointsArray) {

		//support Well Known Text representation
		if (typeof polygonPointsArray == 'string') {
			var shapeData = polygonPointsArray
			//legacy polygons are not WKT representations
			if (shapeData.indexOf('((') == -1) {
				shapeData = 'POLYGON((' + shapeData + '))';
			}
			var shape = this.shapeFromWKT(shapeData);
			if (shape != null) {
				this.drawingTools.addShape(shape);
			}
		}
		else {
			//convert individual arrays to Locations
			if (!polygonPointsArray[0].latitude) {
				var newPolygon = jQuery.map(polygonPointsArray, function (point, n) {
					return new Microsoft.Maps.Location(point[0], point[1]);
				});
				this.drawingTools.addPolygon(newPolygon);
				return;
			}
			//array of locations
			this.drawingTools.addPolygon(polygonPointsArray);
		}
	},

	setRadius: function (radius, centerPoint) {
	},

	getShapeBounds: function () {
		var _shapes = this.getShapes(true);
		if (_shapes && _shapes.length && _shapes.length > 0) {
			var allLocations = [];
			for (var i = 0, l = _shapes.length; i < l; i++) {
				allLocations = allLocations.concat(_shapes[i].getLocations());
			}
			//gather all points for all shapes and get bounds
			return Microsoft.Maps.LocationRect.fromLocations(allLocations)
		}
		return null;
	},

	setBoundsFromPushpins: function () {
		var pinLayer = this.layers['pinLayer'];
		var pinLen = pinLayer.getLength();
		var self = this;
		var mapWidth = this.map.getWidth();

		//if the map state is not fully initialized, wait.
		if (!mapWidth || mapWidth < 10) {
			window.setTimeout(function () {
				self.setBoundsFromPushpins();
			}, 100);
			return;
		}

		this.clusterablePins = this.clusterablePins || [];
		if (pinLen > 0 || this.clusterablePins.length > 0) {
			var locations = [];
			for (var i = 0; i < pinLen; i++) {
				var location = pinLayer.get(i).getLocation();
				if (location.latitude) {
					locations.push(pinLayer.get(i).getLocation());
				}
			}

			for (var i = 0, l = this.clusterablePins.length; i < l; i++) {
				var pin = this.clusterablePins[i];
				if (pin.Latitude) {
					locations.push(new Microsoft.Maps.Location(pin.Latitude, pin.Longitude));
				}
			}

			var bounds = Microsoft.Maps.LocationRect.fromLocations(locations);


			if (bounds) {
				var viewOptions = {};
				var zoomForSingleListing = this.zoomForSingleListing && this.zoomForSingleListing();

				if (locations.length == 1 && zoomForSingleListing) {
					viewOptions.zoom = zoomForSingleListing;
					viewOptions.center = bounds.center;
				}
				else {
					viewOptions.bounds = bounds;
				}

				this.map.setView(viewOptions);
			}
		}
	},

	setBoundsFromShapes: function () {
		var bounds = this.getShapeBounds();
		if (bounds) {
			this.map.setView({ bounds: bounds });
		}
	},

	setBoundsFromBoundingBox: function (bbox) {
		var bounds = Microsoft.Maps.LocationRect.fromLocations(new Microsoft.Maps.Location(bbox[0], bbox[1]),
			new Microsoft.Maps.Location(bbox[2], bbox[3]));

		this.map.setView({ bounds: bounds });
	},

	initPrint: function () {
		var viewNum = 0;

		var mapStyle = this.map.getMapTypeId();

		switch (mapStyle) {
			case Microsoft.Maps.MapTypeId.aerial:
				viewNum = 3;
				break;
			case 'b': // does not appear in Microsoft.Maps.MapTypeId
			case Microsoft.Maps.MapTypeId.birdseye:
				alert("Printing from Bird's Eye maps is not supported. You must change to Automatic or Road Maps before printing.");
				return;
				break;
			case Microsoft.Maps.MapTypeId.hybrid: // does not appear in Microsoft.Maps.MapTypeId
			case Microsoft.Maps.MapTypeId.auto:
				this.map.setMapType(Microsoft.Maps.MapTypeId.road);
				break;
		}

		return viewNum;
	}

}, {
	Instances: [],
	//JSONP callback expected in mapControlSource, currently unusued
	MapReady: function () {
		return true;
	},

	// standard pushpins (depreciated)
	// use cssClass
	PushpinIcons: {
		'red': 'Images/Icons/PNG/24/84.png',
		'magenta': 'Images/Icons/PNG/24/150.png',
		'cyan': 'Images/Icons/PNG/24/152.png',
		'green': 'Images/Icons/PNG/24/86.png',
		'blue': 'Images/Icons/PNG/24/88.png',
		'yellow': 'Images/Icons/PNG/24/82.png',
		'gray': 'Images/Icons/PNG/24/151.png'
	}
});













if (!('SDS' in window)) { window.SDS = {}; }
SDS.BingMapIFrame = Base.extend({
	constructor: function (init) {
		window.__bingMapInstance = this;

		SDS.BingMap.Instances.push(this);
		this.instanceIndex = SDS.BingMap.Instances.length;

		this.container = init.container;

		//basic events
		this.changeHandler = init.changeHandler || null;
		this.loadHandler = init.loadHandler || null;
		this.clickHandler = init.clickHandler || null;
		this.resizeHandler = init.resizeHandler || null;
		this.mapShapeChangeHandler = init.mapShapeChangeHandler || null;
		this.viewChangeStartHandler = init.viewChangeStartHandler || null;
		this.clearShapeHandler = init.clearShapeHandler || null;
		this.drawingModeChangeHandler = init.drawingModeChangeHandler || null;
		this.features = init.features;

		this.init = init;

		//one frame at a time
		window.SDSBingMapInitialization = init;
		this.modulePath = init.modulePath || '../../';
		this.initIFrame();
	},
	initIFrame: function () {
		this.iframeID = 'sds-bingmap-frame-' + this.instanceIndex;
		jQuery(this.container.$getElement ? this.container.$getElement() : this.container)
			.append('<iframe name="' + this.iframeID + '" id="' + this.iframeID + '" src="' + this.modulePath + 'Controls/Map/BingMapIFrame.html" width="100%" height="100%" style="display:none" onload="this.style.display=\'block\';" allowTransparency="true" frameborder="0" marginheight="0" marginwidth="0" style=""></iframe>');

	},
	getInstance: function () {
		if (!this.iframe) {
			this.iframe = jQuery('#' + this.iframeID).get(0).contentWindow.SDSBingMapInstance;
		}
		return this.iframe;
	},

	clear: function (layerName) {
		this.getInstance().clear(layerName);
	},

	clearShapes: function (quiet) {
		this.getInstance().clearShapes(quiet);
	},

	clearPushpins: function () {
		this.getInstance().clearPushpins();
	},


	removePushpin: function (pin, layer) {
		this.getInstance().removePushpin(pin, layer);
	},

	addPushpin: function (options) {
		this.getInstance().addPushpin(options);
	},
	
	createPushpin: function (options, clustered) {
		this.getInstance().createPushpin(options, clustered);
	},

	addLayer: function (layerName, index, overwrite) {
		this.getInstance().addLayer(layerName, index, overwrite);
	},

	addPolyline: function (coordinates, options) {
		this.getInstance().addPolyline(coordinates, options);
	},

	toggleDrawingTools: function (visible) {
		this.getInstance().toggleDrawingTools(visible);
	},

	getShapes: function (asShapes) {
		return this.getInstance().getShapes();
	},

	hasShapes: function () {
		return this.getInstance().hasShapes();
	},

	mapLoaded: function () {
		if (this.loadHandler) {
			this.loadHandler();
		}
	},

	mapChanged: function (changeObject) {
		if (this.changeHandler) {
			this.changeHandler(changeObject);
		}
	},

	drawingChanged: function (evtType, ev) {
		if (this.mapShapeChangeHandler) {
			this.mapShapeChangeHandler(this.getShapes());
		}
		else {
			this.mapChanged(true);
		}
	},

	drawingCleared: function () {
		this.clearPushpins();
		if (this.clearShapeHandler) {
			this.clearShapeHandler();
		}
	},

	drawingModeChanged: function () {
		if (this.drawingModeChangeHandler) {
			this.drawingModeChangeHandler();
		}
	},

	getBounds: function () {
		return this.getInstance().getBounds();
	},

	getBoundingRectangle: function (asBinaryString) {
		return this.getInstance().getBoundingRectangle(asBinaryString);
	},

	getCenter: function () {
		return this.getInstance().getCenter();
	},

	getZoomLevel: function () {
		return this.getInstance().getZoomLevel();
	},

	getMapStyle: function () {
		return this.getInstance().getMapStyle();
	},

	setCenter: function (latLng, zoom, mapTypeId) {
		this.getInstance().setCenter(latLng, zoom, mapTypeId);
	},

	setCenterFromGeocodeResults: function (results, zoomLevel) {
		this.getInstance().setCenterFromGeocodeResults(results, zoomLevel);
	},

	SetScaleBarDistanceUnit: function (val) {
		this.getInstance().SetScaleBarDistanceUnit(val);
	},

	getCredentials: function (callback) {
		throw new Exception("cannot get credentials on iframe instance");
	},

	getDirections: function (addresses, options, callback) {
		this.getInstance().getDirections(addresses, options, callback);
	},

	geocode: function (addressOrQuery, centerResults, callback, zoomLevel) {
		this.getInstance().geocode(addressOrQuery, centerResults, callback, zoomLevel);
	},

	find: function (query, callback, failure) {
		this.getInstance().find(query, callback, failure);
	},
	
	setShapes: function (shape) {
		this.getInstance().setShapes(shape);
	},

	shapeFromWKT: function (str) {
		this.getInstance().shapeFromWKT(str);
	},

	setPolygon: function (polygonPointsArray) {
		this.getInstance().setPolygon(polygonPointsArray);
	},

	setRadius: function (radius, centerPoint) {
		this.getInstance().setRadius(polygonPointsArray);
	},

	getShapeBounds: function () {
		return this.getInstance().getShapeBounds();
	},

	setBoundsFromPushpins: function () {
		this.getInstance().setBoundsFromPushpins();
	},

	setBoundsFromShapes: function () {
		this.getInstance().setBoundsFromShapes();
	},

	setBoundsFromBoundingBox: function (bbox) {
		this.getInstance().setBoundsFromBoundingBox(bbox);
	},

	getDirections: function (addresses, options, callback) {
		this.getInstance().getDirections(addresses, options, callback);
	},

	geocode: function (addressOrQuery, centerResults, callback, zoomLevel) {
		this.getInstance().geocode(addressOrQuery, centerResults, callback, zoomLevel);
	},

	displayInfobox: function (ev) {
		this.getInstance().displayInfobox(ev);
	}
}); 
 
if (!('SDS' in window)) { window.SDS = {}; }
SDS.GoogleMap = Base.extend({
	constructor: function (init) {
		window.__bingMapInstance = this;

		SDS.GoogleMap.Instances.push(this);
		this.instanceIndex = SDS.GoogleMap.Instances.length;

		this.container = init.container;
		this.mapContainer = document.createElement('div');
		this.mapContainer.className = 'google-map-container mapcontainer-' + this.instanceIndex;
		this.mapContainer.id = 'google-map-' + this.instanceIndex;

		this.toolbarContainer = document.createElement('div');
		this.toolbarContainer.className = 'google-map-toolbar-container drawingtoolbar-' + this.instanceIndex;
		this.clientID = init.clientID || REModel.Session.getSetting('Google.Maps.ClientID');
		this.channelID = init.channelID || REModel.Session.getSetting("Google.Maps.Channel");

		this.culture = init.culture || 'en-us';
		this.mapControlSource = init.mapControlSource || 'https://maps.googleapis.com/maps/api/js?client=' + this.clientID + '&channel=' + this.channelID + '&libraries=drawing,geometry,places&v=3.26&callback=SDS.GoogleMap.MapReady';
		this.key = init.key;

		this.location = init.location;
		this.zoom = init.zoom || 14;
		this.zoomForSingleListing = init.zoomForSingleListing;
		this.initialType = init.initialType || 'auto';

		this.modulePath = init.modulePath || '../../';

		this.showDashboard = typeof init.showDashboard != 'undefined' ? init.showDashboard : true;
		this.showMapTypeSelector = typeof init.showMapTypeSelector != 'undefined' ? init.showMapTypeSelector : true;
		this.showScalebar = typeof init.showScalebar != 'undefined' ? init.showScalebar : true;

		//basic events
		this.changeHandler = init.changeHandler || null;
		this.loadHandler = init.loadHandler || null;
		this.clickHandler = init.clickHandler || null;
		this.resizeHandler = init.resizeHandler || null;
		this.mapShapeChangeHandler = init.mapShapeChangeHandler || null;
		this.viewChangeStartHandler = init.viewChangeStartHandler || null;
		this.clearShapeHandler = init.clearShapeHandler || null;

		this.showLegendHandler = init.showLegendHandler || null;

		this.drawingModeChangeHandler = init.drawingModeChangeHandler || null;

		this.features = init.features || {};

		this.mapService = init.mapService;

		if ('getElement' in this.container) {
			this.container = this.container.getElement();
		}
		else if (typeof this.element === 'string') {
			this.container = jQuery(this.container);
		}

		this.container.appendChild(this.mapContainer);
		this.container.appendChild(this.toolbarContainer);

		this.wktShapes = [];

		this.deferred = init.deferred || false;
		if (!this.deferred) {
			this.initMaps();
		}

		if (this.features.logUsage) {
			try {
				(new REModel.Services.LogService()).logMapAccess('newobject');
				(new REModel.Services.LogService()).logMapAccess(this.key, 'credentials');
			}
			catch (e) {
				_log(e);
			}
		}

		this.requiredModules = {};
		this.auth = REModel.Session.getAuth() || {};

		this.changeCount = 0;
	},

	show: function () {
		if (!this.mapInitialized && this.deferred) {
			this.initMaps();
		}
	},

	createMap: function (reinitialize) {
		var self = this;

		//fix mapcontainer positioning
		$parent = jQuery(this.mapContainer).parent();
		if ($parent.outerWidth() == 0 && $parent.css('position') == 'absolute') {
			$parent.css({
				top: '0px', bottom: '0px', left: '0px', right: '0px'
			});
		}

		this.availableMapTypes = {
			//aerial: Microsoft.Maps.MapTypeId.aerial,
			//road: Microsoft.Maps.MapTypeId.road,
			//birdseye: Microsoft.Maps.MapTypeId.birdseye,
			//auto: Microsoft.Maps.MapTypeId.auto
		};

		var center = this.location;
		if (typeof this.location.latitude != 'undefined') {
			center = new google.maps.LatLng(this.location.latitude, this.location.longitude);
		}

		this.map = new google.maps.Map(this.mapContainer, {
			center: center,
			zoom: this.zoom,
			contextMenu: true,
			streetViewControl: true,
			scaleControl: true,
			tilt: 0
			//credentials: this.key,
			//enableHighDpi: true,
			//enableSearchLogo: false,
			//enableClickableLogo: false,
			//disableKeyboardInput: typeof this.features.keyboardInput != 'undefined' ? !this.features.keyboardInput : true,
			//tileBuffer: 2,
			//useInertia: false,
			//culture: this.culture,
			//showDashboard: this.showDashboard,
			//showMapTypeSelector: this.showMapTypeSelector,
			//showScalebar: this.showScalebar,
			//mapTypeId: this.availableMapTypes[this.initialType || 'auto']
		});

		if (this.clickHandler) {
			this.map.addListener('click', function (ev) {
				self.clickHandler(ev);
			});
		}

		if (this.resizeHandler) {
			this.map.addListener('resize', function (ev) {
				self.resizeHandler(ev);
			});
		}

		if (self.viewChangeStartHandler) {
			this.map.addListener('bounds_changed', function (ev) {
				self.viewChangeStartHandler();
			});
		}

		this.map.addListener('maptypeid_changed', function (ev) {
			self.mapTypeChange(self.map.getMapTypeId());
		});

		this.map.addListener('idle', function (e) {
			if (!self.mapInitialized) {
				self.mapInitialized = true;
				self.mapLoaded();
			}

			//when the map is shown or hidden viewchangeend is fired erroneously
			if (self.hidden && jQuery(self.container).is(':visible')) {
				self.hidden = false;
				return;
			}

			if (!jQuery(self.container).is(':visible')) {
				self.hidden = true;
				return;
			}

			self.mapChanged();
		});

		

		this.infobox = new InfoBox(
		{
			//boxStyle: { },
			closeBoxURL: '',
			infoBoxClearance: new google.maps.Size(1, 1),
			//isHidden: false,
			//pane: "floatPane",
			enableEventPropagation: false,
			disableAutoPan: true
		});
		
		
		this.layers = {};
		
		if (this.features.drawing) {
		//	this.addLayer('editDecoration');
		//	this.addLayer('shapeLayer');
		}
		//add layers for pushpins and infobox
		//this.addLayer('customTileLayer');
		this.addLayer('standardShapeLayer');
		this.addLayer('placesLayer');
		this.addLayer('pinLayer');
		this.addLayer('infoLayer');
		this.addLayer('locationsLayer');

		if (this.features.drawing) {
			//this.addLayer('edittingLayer');
			this.addDrawingTools(this.features.drawing, reinitialize);
		}
		
	},

	getPinHtml: function (options) {
		var baseName = options.iconCssBase || 'map-pushpin';
		var typeName = options.cssClass || '';

		var label = options.label || '';
		var width = options.width || 24;
		var height = options.height || 24;

		return '<div class="' + baseName + ' ' + typeName + '" style="pointer-events: all; width: ' + width + 'px;height: ' + height + 'px;"><div class="text">' + label + '</div></div>';
	},

	clear: function (layerName) {
		if (!this.layers) { return; }
		if (layerName && !this.layers[layerName]) { return; }

		if (!layerName) {
			for (var prop in this.layers) {
				this.clear(layerName);
			}
		}
		else if (this.layers[layerName] && this.layers[layerName].clear) {
			this.layers[layerName].clear();
		}
		else {

			if (layerName == 'pinLayer' && this.markerClusterer) { this.markerClusterer.setMap(null); this.markerClusterer = null; }

			for (var i = 0, l = this.layers[layerName].length; i < l; i++) {
				this.layers[layerName][i].setMap(null);
			}
			this.layers[layerName] = [];
		}
	},

	clearShapes: function () {
		if (this.drawingTools) {
			this.drawingTools.clearShapes();
		}
	},

	clearPushpins: function () {
		this.clear('pinLayer');
	},

	removePushpin: function (pin, layer) {
		pin.setMap(null);
		if (this.layers[layer || 'pinLayer'].length == 1) {
			this.layers[layer || 'pinLayer'] = [];
		}
	},

	addPushpin: function (options) {
		
		var self = this;
		var pin = this.createPushpin(options);
		
		if (this.features.clusters) {
			if (!this.markerClusterer) { 
				this.markerClusterer = new MarkerClusterer(this.map, this.layers['pinLayer'], {
					gridSize: 35,
					clusterClass: 'map-pushpin map-overlapping-marker icon-24',
					imageSizes: [24, 24, 24, 24, 24],
					styles: [],
					zoomOnClick: false,
					ignoreHidden: true,
					zIndex: 20
				});

				/*google.maps.event.addListener(this.markerClusterer, 'click', function(cluster) {
					_log('cluster click');
				});
				google.maps.event.addListener(this.markerClusterer, 'mouseover', function(cluster) {
					_log('cluster mouseover');
				});
				google.maps.event.addListener(this.markerClusterer, 'mouseout', function(cluster) {
					_log('cluster mouseout');
				});*/
				this.pushPinBindEvents(this.markerClusterer, options);
			}

			this.markerClusterer.addMarker(pin);
		}
		
		this.layers.pinLayer.push(pin);
	},

	createPushpin: function (options, clustered) {
		var self = this;
		if (typeof options == 'undefined') { options = {}; }
		var location = options.location || null;

		if (options.basic) {
			var pin = new google.maps.Marker({
				map: self.map,
				position: { lat: location[0], lng: location[1] },
				draggable: options.draggable
			});
			return pin;
		}

		var data = options.data;
		var infoboxContent = options.infoboxContent || null;

		if (options.title && options.body) {
			infoboxContent = '<div class="VE_Pushpin_Popup_Title">' + options.title + '</div>' +
				'<div class="VE_Pushpin_Popup_Body">' + options.body + '</div>'
		}

		var draggable = typeof options.draggable != 'undefined' ? options.draggable : false;

		//location is required
		if (!location) {
			return;
		}

		if (!data) {
			data = {};
		}

		var pin = new RichMarker({
			map: self.map,
			position: new google.maps.LatLng(location[0], location[1]),
			draggable: options.draggable,
			flat: true,
			anchor: RichMarkerPosition.MIDDLE,
			contextMenu: true,
			content: options.htmlContent || this.getPinHtml(options),
			zIndex: 20
		});

		if (infoboxContent) {
			pin.infoboxContent = infoboxContent;

			if (options.infoboxHandleClick) {
				pin.infoboxHandleClick = options.infoboxHandleClick;
			}
		}
		if (options.infoboxLoader) {
			pin.infoboxLoader = options.infoboxLoader;
		}

		if (data) {
			pin.data = [data];
		}

		//pin.setLocation(location);

		if (options.layer) {
			if (!this.layers[options.layer]) {
				this.layers[options.layer] = [];
			}
			this.layers[options.layer].push(pin);
		}

		this.pushPinBindEvents(pin, options);

		return pin;

	},

	addLayer: function (layerName, index, overwrite) {
		if (!this.layerIndexMap) {
			this.layerIndexMap = {};
		}

		this.layers[layerName] = [];
	},

	pushPinBindEvents: function (pin, options) {
		var self = this;

		if (pin.infoboxContent) {
			google.maps.event.addListener(pin, 'click', function (ev) {
				self.displayInfobox(ev || pin);
			});
			google.maps.event.addListener(pin, 'mouseover', function (ev) {
				self.displayInfobox(ev || pin);
			});
			google.maps.event.addListener(pin, 'mouseout', function (ev) {
				self.hideInfobox(ev || pin);
			});
		}
		else {
			var handleClick = options.click || null;
			var handleMouseover = options.mouseover || null;
			var handleMouseout = options.mouseout || null;

			if (handleClick) {
				google.maps.event.addListener(pin, 'click', function (ev) {
					handleClick(ev || pin);
				});
			}
			if (handleMouseover) {
				google.maps.event.addListener(pin, 'mouseover', function (ev) {
					handleMouseover(ev || pin);
				});
			}
			if (handleMouseout) {
				google.maps.event.addListener(pin, 'mouseout', function (ev) {
					handleMouseout(ev || pin);
				});
			}
		}
	},

	// for use with Directions
	// use DrawingTools for other usages 
	addPolyline: function (coordinates, options) {
		options = options || {};
		options.geodesic = true;
		options.strokeColor = options.strokeColor || '#245080';
		options.strokeWeight = options.strokeWeight || 5;
		options.strokeOpacity = options.strokeOpacity || 0.7;

		if (coordinates.length && coordinates.length > 0) {
			options.path = coordinates;
			var polyline = new google.maps.Polyline(options);

			this.layers['standardShapeLayer'].push(polyline);
			polyline.setMap(this.map);
		}
	},

	displayInfobox: function (pin) {
		var self = this;

		//do not show infoboxes while drawing
		if (this.isDrawing || this.drawingTools && this.drawingTools.isEditing) {
			return;
		}

		if (pin) {

			//do not show listings pins when hide-listings-map is present
			if (jQuery('#MasterDynamicBody.hide-listings-map').length > 0 && pin._htmlContent && pin._htmlContent.indexOf('show-when-listing-hidden') == -1) {
				return;
			}

			if (this.__hideTimeout) {
				window.clearTimeout(this.__hideTimeout);
			} 

			if (pin.infoboxLoader) {
				pin.infoboxLoader(function (content) {
					pin.infoboxContent = content;
					self.displayInfobox(pin);
				});
				pin.infoboxLoader = null;
				return;
			}

			var infoID = new Date().getTime();
			var htmlContent = pin.infoboxContent || pin.content;
			var $infoContent = jQuery('<div class="infobox-content"></div>').append(htmlContent);
			var $infoContainer = jQuery('<div class="infobox-container" id="ib' + infoID + '"><div class="infobox-arrow"></div></div>').append($infoContent);

			var $content = jQuery('<div class="prerender" style="position: absolute; left: -1000px; top: -1000px;"></div')
				.append($infoContainer)
				.appendTo('body');

			var width = $content.width();
			var height = $content.height();
			if (!pin.getPosition && pin.getCenter) {
				pin.getPosition = pin.getCenter;
			}
			var coordinates = this.getLatLngPosition(pin.getCenter ? pin.getCenter() : pin.position);
			var quadrant = coordinates.quadrant;
			var markerSize = 24;

			switch (quadrant) {
				case 0:
					jQuery('.infobox-arrow', $content).addClass('top-left');
					coordinates.y -= (markerSize / 2);
					coordinates.x += (markerSize / 2);
					break;
				case 1:
					jQuery('.infobox-arrow', $content).addClass('top-right');
					coordinates.y -= (markerSize / 2);
					coordinates.x -= width + (markerSize / 2);
					break;
				case 2: 
					jQuery('.infobox-arrow', $content).addClass('bottom-left');
					coordinates.y -= height - (markerSize / 2);
					coordinates.x += (markerSize / 2);
					break;
				case 3:
					jQuery('.infobox-arrow', $content).addClass('bottom-right');
					coordinates.y -= height - (markerSize / 2);
					coordinates.x -= width + (markerSize / 2);
					break;
			}

			this.infobox.setVisible(false);
			this.infobox.setContent($content.html());
			this.infobox.open(self.map, pin);
			this.infobox.setPosition(this.pointToLatLng(coordinates));
			this.infobox.setVisible(true);
			this.map.setOptions({ scrollwheel: false });
			$content.remove();
			window.setTimeout(function () {
				var ib = '#ib' + infoID;
				jQuery(ib)
					.off('mouseover')
					.off('mouseout')
					.off('click')
					.on('mouseover', function () {
						if (self.__hideTimeout) {
							window.clearTimeout(self.__hideTimeout);
						}
					})
					.on('mouseout', function () {
						self.hideInfobox();
					});
				if (pin.infoboxHandleClick) {
					jQuery(ib)
                        .on('click', function (e) {
                        	pin.infoboxHandleClick(e, pin);
                        });
				}
			}, 10);

		}
	},

	getLatLngPosition: function (latLng) {
		var topRight = this.map.getProjection().fromLatLngToPoint(this.map.getBounds().getNorthEast());
		var bottomLeft = this.map.getProjection().fromLatLngToPoint(this.map.getBounds().getSouthWest());
		var scale = Math.pow(2, this.map.getZoom());
		var worldPoint = this.map.getProjection().fromLatLngToPoint(latLng);
		var point =  new google.maps.Point((worldPoint.x - bottomLeft.x) * scale, (worldPoint.y - topRight.y) * scale);
		var width = Math.abs((topRight.x - bottomLeft.x) * scale);
		var height = Math.abs((topRight.y - bottomLeft.y) * scale);
		
		var quadrant = 0;
		if (point.y <= height / 2) {
			quadrant = (point.x <= width / 2) ? 0 : 1;
		}
		else {
			quadrant = (point.x <= width / 2) ? 2 : 3;
		}
		return {
			map: {
				width: width,
				height: height
			},
			x: point.x,
			y: point.y,
			quadrant: quadrant
		};
	},

	pointToLatLng: function(point) {
		var topRight = this.map.getProjection().fromLatLngToPoint(this.map.getBounds().getNorthEast());
		var bottomLeft = this.map.getProjection().fromLatLngToPoint(this.map.getBounds().getSouthWest());
		var scale = Math.pow(2, this.map.getZoom());
		var worldPoint = new google.maps.Point(point.x / scale + bottomLeft.x, point.y / scale + topRight.y);
		return this.map.getProjection().fromPointToLatLng(worldPoint);
	},

	hideInfobox: function (ev) {
		this.infoboxVisible = false;

		var self = this;
		if (this.__hideTimeout) {
			window.clearTimeout(this.__hideTimeout);
		}
		this.__hideTimeout = window.setTimeout(function () {
			self.infobox.hide();
			self.map.setOptions({ scrollwheel: true });
		}, 250);
	},

	toggleDrawingTools: function (visible) {
		if (visible) {
			jQuery('.drawingtoolbar-' + this.instanceIndex).show();
		}
		else {
			jQuery('.drawingtoolbar-' + this.instanceIndex).hide();
		}
	},

	reinitMap: function () {
		var layerData = [];

		for (layerName in this.layers) {
			layerData.push(this.getLayerDataByName(layerName));
		}

		this.layers = {};
		this.layerIndexMap = {};

		jQuery('.drawingToolsToolbar', '.drawingtoolbar-' + this.instanceIndex).remove();

		this.location = this.map.getCenter();
		this.zoom = this.map.getZoom();
		this.initialType = this.map.getMapTypeId();

		this.createMap(true);
		this.restoreLayers(layerData);
	},

	getLayerDataByName: function (layerName) {
		var layerEntities = [];
		var layerIndex = this.layerIndexMap[layerName];
		var layer = this.map.entities.get(layerIndex);
		for (var i = 0, l = layer.getLength() ; i < l; i++) {
			layerEntities.push(layer.removeAt(i));
		}

		return {
			index: layerIndex,
			name: layerName,
			entities: layerEntities
		};
	},

	restoreLayers: function (layerData) {
		layerData.sort(function (a, b) {
			return a.index > b.index ? 1 : a.index < b.index ? -1 : 0;
		});

		for (var i = 0; i < layerData.length; i++) {
			var layer = this.layers[layerData[i].name];
			if (layer) {
				for (var x = 0; x < layerData[i].entities.length; x++) {
					if (layerData[i].entities[x]) {
						layer.push(layerData[i].entities[x]);
					}
				}
			}
		}
	},

	addDrawingTools: function (mode, reinitialize) {
		var self = this;
		if (this._drawingToolsAdded && !reinitialize) {
			return;
		}

		this._drawingToolsAdded = true;
		//if (mode == 'hidden') {
		//	this.hidden = true;
		//	jQuery('.drawingtoolbar-' + this.instanceIndex).hide();
		//}

		

		this.drawingTools = new SDS.GoogleMap.DrawingTools({
			map: this.map,
			modulePath: this.modulePath,
			changed: function (shapes) {
				self.drawingChanged('changed', shapes);
			},
			drawingModeChanged: function (mode) {
				self.drawingModeChanged(mode);
			},
			drawingCleared: function () {
				self.drawingCleared();
			},
			defaultUnits: this.features.defaultUnits || 'mi',

			unionHandler: !this.mapService ? false : function (currentShape) {
				var allShapes = self.getShapes();
				var shapes = [];
				for (var i = 0, l = allShapes.length; i < l; i++) {
					if (allShapes[i] != currentShape) {
						shapes.push(allShapes[i]);
					}
				}

				self.mapService.unionShapes(currentShape, shapes, function (newShapes) {
					if (newShapes && newShapes.length > 0) {
						self.drawingTools.clearShapes();
						for (var i = 0, l = newShapes.length; i < l; i++) {
							self.drawingTools.addShape(newShapes[i]);
						}

						self.mapChanged(true);
					}
				});
			},

			excludeHandler: !this.mapService ? false : function (currentShape) {
				var allShapes = self.getShapes();
				var shapes = [];
				for (var i = 0, l = allShapes.length; i < l; i++) {
					if (allShapes[i] != currentShape) {
						shapes.push(allShapes[i]);
					}
				}

				self.mapService.excludeShapes(currentShape, shapes, function (newShapes) {
					if (newShapes && newShapes.length > 0) {
						self.drawingTools.clearShapes();
						for (var i = 0, l = newShapes.length; i < l; i++) {
							self.drawingTools.addShape(newShapes[i]);
						}

						self.mapChanged(true);
					}
				});
			}
		});
	},

	drawingChanged: function (evtType, shapes) {
		if (this.mapShapeChangeHandler) {
			this.mapShapeChangeHandler(shapes);
		}
		else {
			this.mapChanged(true);
		}
	},

	drawingCleared: function () {
		this.clearPushpins();
		if (this.clearShapeHandler) {
			this.clearShapeHandler();
		}
	},

	drawingModeChanged: function (mode) {
		mode = (mode || '').toLowerCase();

		if (mode == 'polygon' || mode == 'circle' || mode == 'rectangle') {
			this.isDrawing = true;
		}
		else {
			this.isDrawing = false;
		}

		if (this.drawingModeChangeHandler) {
			this.drawingModeChangeHandler(mode);
		}
	},

	getShapes: function () {
		if (!this.drawingTools || !this.drawingTools.shapes) {
			return [];
		}

		return this.drawingTools.shapes;
	},

	hasShapes: function () {
		return this.getShapes().length > 0;
	},

	mapLoaded: function () {
		if (this.loadHandler) {
			this.loadHandler();
		}

		this.addCustomMapControls();
	},

	addCustomMapControls: function () {
		var self = this;

		if (this.showLegendHandler || this.features.mapArt) {
			var group = jQuery('<ul class="legend-control custom"></ul>');

			if (this.showLegendHandler) {
				var legendButton = jQuery('<li class="legend" title="Display Legend"><span>Legend</span></li>');
				group.append(legendButton);
				legendButton.on('click', function () { self.showLegendHandler(); })
			}

			if (this.features.mapArt) {

				this.mapServer = location.href.toLowerCase().indexOf('/live') == 0 ? 'http://dev2.stratusmls.com/' : 'http://www.torontomls.net/';
				this.customLayers = [
					{ name: "art", label: "MapArt", index: 0, tileURL: this.mapServer + "Maps/MapArt/Layer_MapArt/{quadkey}.png" },
					{ name: "grid", label: "Grid", index: 1, tileURL: this.mapServer + "Maps/MapArt/Layer_GridLayer/{quadkey}.png" },
					{ name: "area", label: "Areas", index: 2, tileURL: this.mapServer + "BingCommunitiesMap/BingMapData/Layer_Areas/{quadkey}.png" },
					{ name: "muni", label: "Municipalities", index: 3, tileURL: this.mapServer + "BingCommunitiesMap/BingMapData/Layer_Municipalities/{quadkey}.png" },
					{ name: "comm", label: "Communities", index: 4, tileURL: this.mapServer + "BingCommunitiesMap/BingMapData/Layer_Communities/{quadkey}.png" }
				];

				var mapArtContainer = jQuery('<li class="art-container menu" title="Display MapArt"><span>Map Layers</span></li>');
				var artGroup = jQuery('<ul class="art-control custom"></ul>');
				for (var i = 0; i < this.customLayers.length; i++) {
					jQuery('<li data-name="' + this.customLayers[i].name + '" title="Display ' + this.customLayers[i].label + '"><span>' + this.customLayers[i].label + '</span></li>')
						.appendTo(artGroup)
						.click(function () {
							self.showMapArt(jQuery(this).data('name'));
							jQuery(this).toggleClass('selected');
						})
				}
				mapArtContainer.append(artGroup);
				group.append(mapArtContainer);
			}

			this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(group.get(0));
		}
		
	},


	showLegend: function () {
		if (this.showLegendHandler) {
			this.showLegendHandler();
		}
	},

	_tileToQuadKey: function (x, y, zoom) {
		var quad = "";
		for (var i = zoom; i > 0; i--) {
			var mask = 1 << (i - 1);
			var cell = 0;
			if ((x & mask) != 0) cell++;
			if ((y & mask) != 0) cell += 2;
			quad += cell;
		}
		return quad;
	},

	showMapArt: function (name) {
		var self = this;

		for (var i = 0; i < this.map.overlayMapTypes.length; i++) {
			this.map.overlayMapTypes.setAt(i, null);
		}

		//enable / disable
		for (var i = 0; i < this.customLayers.length; i++) {
			if (this.customLayers[i].name == name) {
				this.customLayers[i].enabled = !this.customLayers[i].enabled;
			}

			if (this.customLayers[i].enabled) {
				this.insertMapOverlay(this.customLayers[i]);
			}
			if (this.map.overlayMapTypes.length < this.customLayers[i].index) {
				this.map.overlayMapTypes.insertAt(this.customLayers[i].index, null);
			}
		}
	},

	insertMapOverlay: function (config) {
		var self = this;
		var tileArtLayer = new google.maps.ImageMapType({
			getTileUrl: function (coord, zoom) {
				return config.tileURL.replace("{quadkey}", self._tileToQuadKey(coord.x, coord.y, zoom));
			},
			tileSize: new google.maps.Size(256, 256),
			name: config.name
		});
		this.map.overlayMapTypes.insertAt(config.index, tileArtLayer);
	},

	triggerResize: function () {
		if (jQuery(this.mapContainer).is(':visible')) {
			google.maps.event.trigger(this.map, 'resize');
		}
	},

	mapChanged: function (shapesChanged) {
		var self = this;

		this.changeCount++;

		//for debugging purposes: uncomment to show bounds shape
		/*var _bounds = this.map.getBounds();
		if (!this._boundsRectangle) {
			this._boundsRectangle = new google.maps.Rectangle({ bounds: _bounds, map: this.map });
		}
		this._boundsRectangle.setBounds(_bounds);
		*/
		
		if (this.changeCount == 1) {
			//ignore first change, this is always fired on map load
			return;
		}

		if (SDS.GoogleMap.__searchTimeout) {
			clearTimeout(SDS.GoogleMap.__searchTimeout);
		}

		SDS.GoogleMap.__searchTimeout = window.setTimeout(function () {

			self.bounds = self.map.getBounds();

			self.northeast = self.bounds.getNorthEast();
			self.southwest = self.bounds.getSouthWest();
			self.center = self.bounds.getCenter();

			if (self.changeHandler) {
				self.changeHandler({
					bounds: {
						northwest: [self.northeast.lat(), self.southwest.lng()],
						southeast: [self.southwest.lat(), self.northeast.lng()],
						center: [self.center.lat(), self.center.lng()]
					},
					zoom: self.map.getZoom(),
					shapes: self.getShapes()
				});
			}
		}, 500);
	},

	mapTypeChange: function (mapType) {
		if (this.drawingTools) {
			if (!('Microsoft' in window)) {
				return;
			}
			var curMapType = (mapType || '').indexOf('Birdseye') != -1 ? 'Birdseye' : mapType;
			if (curMapType != this._prevMapType) {
				this._prevMapType = curMapType;
				var shapeOptions = {};

				if (curMapType == 'Birdseye' || curMapType == 'Aerial') {
					shapeOptions = {
						strokeThickness: 1,
						strokeColor: new Microsoft.Maps.Color(200, 255, 255, 255),
						fillColor: new Microsoft.Maps.Color(100, 255, 255, 255)
					};

					if (curMapType == 'Birdseye') {
						if (this.layers['customTileLayer'].getVisible()) {
							this.layers['customTileLayer'].setOptions({ visible: false });
							this.enableMapArtWhenAvailable = true;
						}
					}
					else {
						if (this.enableMapArtWhenAvailable) {
							this.layers['customTileLayer'].setOptions({ visible: true });
						}
					}
				}
				else {
					shapeOptions = {
						strokeThickness: 1,
						strokeColor: new Microsoft.Maps.Color(200, 36, 80, 128),
						fillColor: new Microsoft.Maps.Color(51, 66, 139, 202)
					};

					if (this.enableMapArtWhenAvailable) {
						this.layers['customTileLayer'].setOptions({ visible: true });
					}
				}

				this.drawingTools.setShapeOptions(shapeOptions);
			}
		}
	},

	initMaps: function () {
		var self = this;
		var cacheBreaker = '3.46.4';
		this.scriptResources = [
			//note: googlemapsapi should always be the first item in this list
			{
				name: 'googlemapsapi',
				src: this.mapControlSource,
				loaded: function () {
					return 'google' in window && google.maps && google.maps.Map;
				}
			},
			{
				name: 'infobox',
				src: this.modulePath + 'External/GoogleMaps/infobox.js?c=' + cacheBreaker,
				loaded: function () {
					return typeof InfoBox != 'undefined';
				}
			},
			{
				name: 'richmarker',
				src: this.modulePath + 'External/GoogleMaps/richmarker.js?c=' + cacheBreaker,
				loaded: function () {
					return typeof RichMarkerPosition != 'undefined';
				}
			},
			{
				name: 'markerclusterer',
				src: this.modulePath + 'External/GoogleMaps/markerclusterer.js?c=' + cacheBreaker,
				loaded: function () {
					return typeof MarkerClusterer != 'undefined';
				}
			}
		];

		if (!this.mapResourcesLoaded()) {
			//load google map first, then call loadresources
			jQuery.ajaxSetup({ cache: true });

			jQuery.getScript(this.scriptResources[0].src, function () {
				self._mapLoadInterval = window.setInterval(function () {
					if (self.scriptResources[0].loaded()) {
						window.clearInterval(self._mapLoadInterval);
						self.loadResources();
					}
				}, 150);
			});

			jQuery.ajaxSetup({ cache: false });

			this._loadInterval = window.setInterval(function () {
				if (self.mapResourcesLoaded()) {
					window.clearInterval(self._loadInterval);
					self.createMap();
				}
			}, 150);
		}
		else {
			this.createMap();
		}
	},

	loadResources: function () {
		for (var x = 1, xl = this.scriptResources.length; x < xl; x++) {
			jQuery.ajaxSetup({ cache: true });
			jQuery.getScript(this.scriptResources[x].src, function () {
				
			});
			jQuery.ajaxSetup({ cache: false });
		}
	},

	mapResourcesLoaded: function () {
		var loaded = true;
		if (this.scriptResources) {
			for (var x = 0, xl = this.scriptResources.length; x < xl; x++) {
				if (!this.scriptResources[x].loaded()) {
					loaded = false;
					break;
				}
			}
		}
		return loaded;
	},

	getBounds: function () {
		return this.map.getBounds();
	},

	getBoundingRectangle: function (asBinaryString) {
		var bounds = this.map.getBounds();

		var ne = bounds.getNorthEast();
		var sw = bounds.getSouthWest();
		var nw = new google.maps.LatLng(ne.lat(), sw.lng());
		var se = new google.maps.LatLng(sw.lat(), ne.lng());
		
		var points = [];
		points.push([nw.lng(), nw.lat()]);
		points.push([se.lng(), nw.lat()]);
		points.push([se.lng(), se.lat()]);
		points.push([nw.lng(), se.lat()]);
		points.push([nw.lng(), nw.lat()]);

		if (asBinaryString) {
			return [points[0].join(' '), points[1].join(' '), points[2].join(' '), points[3].join(' '), points[4].join(' ')].join(', ');
		}
		else {
			return points;
		}
	},

	getCenter: function () {
		return this.map.getBounds().getCenter();
	},

	getZoomLevel: function () {
		return this.map.getZoom();
	},

	getMapStyle: function () {
		return this.map.getMapTypeId();
	},

	setCenter: function (latLng, zoom, mapTypeId) {
		var self = this;
		
		//MapLocation can sometimes attempt to access this before it is loaded
		// wait for the load
		if (!this.map) {
			if (this._setCenterTimeout) {
				window.clearTimeout(this._setCenterTimeout);
			}
			this._setCenterTimeout = window.setTimeout(function () {
				self.setCenter(latLng, zoom, mapTypeId);
			}, 100);
			return;
		}

		var viewOptions = {};
		if (latLng) {
			viewOptions.center = latLng.lat ? latLng : new google.maps.LatLng(latLng.latitude, latLng.longitude);
		}
		if (zoom && !isNaN(parseFloat(zoom))) {
			viewOptions.zoom = parseFloat(zoom);
		}

		if (mapTypeId) {
			_log('not implemented setCenter, mapTypeID ', mapTypeID);
		}
		if (viewOptions.center) {
			this.map.setCenter(viewOptions.center);
		}
		if (viewOptions.zoom) {
			this.map.setZoom(viewOptions.zoom);
		}
	},

	setCenterFromGeocodeResults: function (results, zoomLevel) {
		if (results && results.resourceSets && results.resourceSets.length > 0 && results.resourceSets[0].resources && results.resourceSets[0].resources.length > 0) {
			var coordinates = results.resourceSets[0].resources[0].point.coordinates;
			var latLng = { latitude: coordinates[0], longitude: coordinates[1] };
			this.setCenter(latLng, zoomLevel);
		}
	},

	SetScaleBarDistanceUnit: function (val) {
		//depreciated
		//if ('console' in window && console.log) { console.log('DEPRECIATED', 'SetScaleBarDistanceUnit', val); }
	},

	getCredentials: function (callback) {
		var self = this;
		_log('not implemented', 'getCredentials');
		return '';
	},

	getDirections: function (addresses, options, callback) {
		var self = this;
		var request = {};
		options = options || {};
		if (!options.optimize) {
			options.optimize = 'time';
		}

		//A map instance is required to use this method
		if (!this.map) {
			return;
		}
		if (!this.directionsService) {
			this.directionsService = new google.maps.DirectionsService();
		}

		request.travelMode = 'DRIVING';
		request.provideRouteAlternatives = false;

		request.drivingOptions = {
			departureTime: new Date(),
			trafficModel: options.optimize == 'timeWithTraffic' ? 'bestguess' : 'optimistic'
		};
		
		request.unitSystem = options.distanceUnit ? (options.distanceUnit.toLowerCase() == 'kilometer' ? google.maps.UnitSystem.METRIC : google.maps.UnitSystem.IMPERIAL) : google.maps.UnitSystem.IMPERIAL;

		request.waypoints = [];

		for (var i = 0; i < addresses.length; i++) {
			//origin
			if (i == 0) {
				request.origin = addresses[i].length && addresses[i].length == 2 ? addresses[i][0] + ',' + addresses[i][1] : addresses[i];
			}
			//destination
			else if (i == addresses.length - 1) {
				request.destination = addresses[i].length && addresses[i].length == 2 ? addresses[i][0] + ',' + addresses[i][1] : addresses[i];
			}
			//waypoint
			else {
				request.waypoints.push({
					location: options.destination = addresses[i].length && addresses[i].length == 2 ? addresses[i][0] + ',' + addresses[i][1] : addresses[i],
					stopover: true
				});
			}
		}

		// issue 2333
		request.origin = request.origin.replace(/(^.*)\s([a-z]{1}\d{1}[a-z]{1})(?:[\s]?)(\d{1}[a-z]{1}\d{1})$/gim, "$1 $2");
		request.destination = request.destination.replace(/(^.*)\s([a-z]{1}\d{1}[a-z]{1})(?:[\s]?)(\d{1}[a-z]{1}\d{1})$/gim, "$1 $2");


		this.directionsService.route(request, function (result, status) {
			if (status !== 'OK') {
				callback({errorDetails: status});
				return;
			}

			callback(result);
		});
	},

	geocode: function (addressOrQuery, centerResults, callback, zoomLevel) {
		var self = this;

		if (!this.geocoder) {
			this.geocoder = new google.maps.Geocoder;
		}

		if (!this.geocodeResults) {
			this.geocodeResults = {};
		}

		if (centerResults && this.geocodeResults[addressOrQuery]) {
			this.setCenter(this.geocodeResults[addressOrQuery].location, zoomLevel);

			if (callback) {
				callback(this.geocodeResults[addressOrQuery].results);
			}
			return;
		}

		var region = this.auth.appName == 'TREB' ? 'CA' : 'US';

		//always supply canadian region and correct postal code spacing
		if (this.auth.appName == 'TREB') {
			region = 'CA';
			addressOrQuery = addressOrQuery.replace(/([a-z]\d[a-z])(\d[a-z]\d)/gi, "$1 $2");
		}

		this.geocoder.geocode({ 'address': addressOrQuery, region: region}, function (results, status) {
			if (status == 'OK') {
				if (results && results.length > 0) {
					self.geocodeResults[addressOrQuery] = {
						location: results[0].geometry.location,
						results: results
					}
				
					if (centerResults) {
						self.setCenter(results[0].geometry.location, zoomLevel);
					}
				}

				if (callback) {
					callback(results);
				}
			}
		});
	},

	find: function (query, callback, failure) {
		var self = this;

		if (!this.placesService) {
			this.placesService = new google.maps.places.PlacesService(this.map);
		}

		this.placesService.radarSearch({
			keyword: query.what,
			bounds: this.map.getBounds()
		}, function (results, status) {
			if (status == google.maps.places.PlacesServiceStatus.OK) {
				callback(results);
			}
			else {
				failure('Unspecified Error Occured');
			}
		});
	},

	getPlaceDetails: function (place, cb) {
		this.placesService.getDetails(place, function (result, status) {
			if (status !== google.maps.places.PlacesServiceStatus.OK) {
				cb(status);
				return;
			}
			else {
				var html = '<span style="font-weight: bold; display: block; max-width: 250px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">' + result.name + '</span>' +
					(result.adr_address ? result.adr_address + '<br/>' : "") +
					(result.formatted_phone_number ? result.formatted_phone_number + '</br>' : "") +
					(result.website ? '<a href="' + result.website + '" target="_blank" style="display: block; max-width: 250px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">' + result.website + '</a>' : "");
				cb(html);
			}
		});
	},

	setShapes: function (shape) {

	},

	setPolygon: function (polygonPointsArray) {

		//support Well Known Text representation
		if (typeof polygonPointsArray == 'string') {
			var shapeData = polygonPointsArray
			//legacy polygons are not WKT representations
			if (shapeData.indexOf('((') == -1) {
				shapeData = 'POLYGON((' + shapeData + '))';
			}
			
			this.drawingTools.addShape(shapeData);
		}
		else {
			var shapeData = [];
			polygonPointsArray.forEach(function (point) {
				if (point.lat) {
					shapeData.push([point.lng(), point.lat()].join(' '));
				}
				else {
					shapeData.push(point[1] + ' ' + point[0]);
				}
			})

			this.drawingTools.addShape('POLYGON((' + shapeData.join(',') + '))');
		}
	},

	setRadius: function (radius, centerPoint) {
	},

	getShapeBounds: function () {
		return this.drawingTools.getShapeBounds();
	},

	setBoundsFromPushpins: function () {
		var pinLayer = this.layers['pinLayer'];
		var pinLen = (pinLayer || []).length;
		var self = this;
		var mapWidth = jQuery(this.map.getDiv()).width();

		//if the map state is not fully initialized, wait.
		if (!mapWidth || mapWidth < 10) {
			window.setTimeout(function () {
				self.setBoundsFromPushpins();
			}, 100);
			return;
		}

		this.clusterablePins = this.clusterablePins || [];
		if (pinLen > 0 || this.clusterablePins.length > 0) {
			var locations = [];
			var bounds = new google.maps.LatLngBounds();
			for (var i = 0; i < pinLen; i++) {
				var location = pinLayer[i].position;
				if (location.lat()) {
					locations.push(location);
					bounds.extend(location);
				}
			}

			for (var i = 0, l = this.clusterablePins.length; i < l; i++) {
				var pin = this.clusterablePins[i];
				if (pin.position) {
					locations.push(pin.position);
					bounds.extend(pin.position);
				}
			}


			if (bounds) {
				var zoomForSingleListing = this.zoomForSingleListing && this.zoomForSingleListing();

				if (locations.length == 1 && zoomForSingleListing) {
					this.setCenter(locations[0], zoomForSingleListing);
				}
				else {
					this.setBounds(bounds);
				}
			}
		}
	},

	setBoundsFromShapes: function () {
		var bounds = this.getShapeBounds();
		if (bounds) {
			this.setBounds(bounds);
		}
	},

	setBoundsFromBoundingBox: function (bbox) {
		var bounds = new google.maps.LatLngBounds();
		bounds.extend(new google.maps.LatLng(bbox[0], bbox[1]));
		bounds.extend(new google.maps.LatLng(bbox[2], bbox[3]));
		
		this.setBounds(bounds);
	},

	setBounds: function (bounds) {
		this.map.fitBounds(bounds);
	},

	initPrint: function () {
		var viewNum = 0;

		var mapStyle = this.map.getMapTypeId();
		if (mapStyle == 'roadmap') {
			viewNum = 0;
		}
		else if (mapStyle == 'hybrid') {
			viewNum = 1;
		}
		else if (mapStyle == 'satellite') {
			viewNum = 2;
		}

		return viewNum;
	}

}, {
	Instances: [],
	//JSONP callback expected in mapControlSource, currently unusued
	MapReady: function () {
		return true;
	},

	// standard pushpins (depreciated)
	// use cssClass
	PushpinIcons: {
		'red': 'Images/Icons/PNG/24/84.png',
		'magenta': 'Images/Icons/PNG/24/150.png',
		'cyan': 'Images/Icons/PNG/24/152.png',
		'green': 'Images/Icons/PNG/24/86.png',
		'blue': 'Images/Icons/PNG/24/88.png',
		'yellow': 'Images/Icons/PNG/24/82.png',
		'gray': 'Images/Icons/PNG/24/151.png'
	}
});













if (!('SDS' in window)) { window.SDS = {}; }
SDS.GoogleMapIFrame = Base.extend({
	constructor: function (init) {
		window.__bingMapInstance = this;

		SDS.BingMap.Instances.push(this);
		this.instanceIndex = SDS.BingMap.Instances.length;

		this.container = init.container;

		//basic events
		this.changeHandler = init.changeHandler || null;
		this.loadHandler = init.loadHandler || null;
		this.clickHandler = init.clickHandler || null;
		this.resizeHandler = init.resizeHandler || null;
		this.mapShapeChangeHandler = init.mapShapeChangeHandler || null;
		this.viewChangeStartHandler = init.viewChangeStartHandler || null;
		this.clearShapeHandler = init.clearShapeHandler || null;
		this.drawingModeChangeHandler = init.drawingModeChangeHandler || null;
		this.features = init.features;

		this.init = init;

		//one frame at a time
		window.SDSBingMapInitialization = init;
		this.modulePath = init.modulePath || '../../';
		this.initIFrame();
	},
	initIFrame: function () {
		this.iframeID = 'sds-bingmap-frame-' + this.instanceIndex;
		jQuery(this.container.$getElement ? this.container.$getElement() : this.container)
			.append('<iframe name="' + this.iframeID + '" id="' + this.iframeID + '" src="' + this.modulePath + 'Controls/Map/BingMapIFrame.html" width="100%" height="100%" style="display:none" onload="this.style.display=\'block\';" allowTransparency="true" frameborder="0" marginheight="0" marginwidth="0" style=""></iframe>');

	},
	getInstance: function () {
		if (!this.iframe) {
			this.iframe = jQuery('#' + this.iframeID).get(0).contentWindow.SDSBingMapInstance;
		}
		return this.iframe;
	},

	clear: function (layerName) {
		this.getInstance().clear(layerName);
	},

	clearShapes: function (quiet) {
		this.getInstance().clearShapes(quiet);
	},

	clearPushpins: function () {
		this.getInstance().clearPushpins();
	},


	removePushpin: function (pin, layer) {
		this.getInstance().removePushpin(pin, layer);
	},

	addPushpin: function (options) {
		this.getInstance().addPushpin(options);
	},

	createPushpin: function (options, clustered) {
		this.getInstance().createPushpin(options, clustered);
	},

	addLayer: function (layerName, index, overwrite) {
		this.getInstance().addLayer(layerName, index, overwrite);
	},

	addPolyline: function (coordinates, options) {
		this.getInstance().addPolyline(coordinates, options);
	},

	toggleDrawingTools: function (visible) {
		this.getInstance().toggleDrawingTools(visible);
	},

	getShapes: function (asShapes) {
		return this.getInstance().getShapes();
	},

	hasShapes: function () {
		return this.getInstance().hasShapes();
	},

	mapLoaded: function () {
		if (this.loadHandler) {
			this.loadHandler();
		}
	},

	mapChanged: function (changeObject) {
		if (this.changeHandler) {
			this.changeHandler(changeObject);
		}
	},

	drawingChanged: function (evtType, shapes) {
		if (this.mapShapeChangeHandler) {
			this.mapShapeChangeHandler(shapes);
		}
		else {
			this.mapChanged(true);
		}
	},

	drawingCleared: function () {
		this.clearPushpins();
		if (this.clearShapeHandler) {
			this.clearShapeHandler();
		}
	},

	drawingModeChanged: function () {
		if (this.drawingModeChangeHandler) {
			this.drawingModeChangeHandler();
		}
	},

	getBounds: function () {
		return this.getInstance().getBounds();
	},

	getBoundingRectangle: function (asBinaryString) {
		return this.getInstance().getBoundingRectangle(asBinaryString);
	},

	getCenter: function () {
		return this.getInstance().getCenter();
	},

	getZoomLevel: function () {
		return this.getInstance().getZoomLevel();
	},

	getMapStyle: function () {
		return this.getInstance().getMapStyle();
	},

	setCenter: function (latLng, zoom, mapTypeId) {
		this.getInstance().setCenter(latLng, zoom, mapTypeId);
	},

	setCenterFromGeocodeResults: function (results, zoomLevel) {
		this.getInstance().setCenterFromGeocodeResults(results, zoomLevel);
	},

	SetScaleBarDistanceUnit: function (val) {
		this.getInstance().SetScaleBarDistanceUnit(val);
	},

	getCredentials: function (callback) {
		throw new Exception("cannot get credentials on iframe instance");
	},

	getDirections: function (addresses, options, callback) {
		this.getInstance().getDirections(addresses, options, callback);
	},

	geocode: function (addressOrQuery, centerResults, callback, zoomLevel) {
		this.getInstance().geocode(addressOrQuery, centerResults, callback, zoomLevel);
	},

	find: function (query, callback, failure) {
		this.getInstance().find(query, callback, failure);
	},

	setShapes: function (shape) {
		this.getInstance().setShapes(shape);
	},

	setPolygon: function (polygonPointsArray) {
		this.getInstance().setPolygon(polygonPointsArray);
	},

	setRadius: function (radius, centerPoint) {
		this.getInstance().setRadius(polygonPointsArray);
	},

	getShapeBounds: function () {
		return this.getInstance().getShapeBounds();
	},

	setBoundsFromPushpins: function () {
		this.getInstance().setBoundsFromPushpins();
	},

	setBoundsFromShapes: function () {
		this.getInstance().setBoundsFromShapes();
	},

	setBoundsFromBoundingBox: function (bbox) {
		this.getInstance().setBoundsFromBoundingBox(bbox);
	},

	setBounds: function (bounds) {
		this.getInstance().setBounds(bounds);
	},

	getDirections: function (addresses, options, callback) {
		this.getInstance().getDirections(addresses, options, callback);
	},

	geocode: function (addressOrQuery, centerResults, callback, zoomLevel) {
		this.getInstance().geocode(addressOrQuery, centerResults, callback, zoomLevel);
	},

	displayInfobox: function (ev) {
		this.getInstance().displayInfobox(ev);
	}
});


SDS.GoogleMap.DrawingTools = Base.extend({
	constructor: function (options) {
		var self = this;
		this.map = options.map;
		this.modulePath = options.modulePath;
		this.changed = options.changed || function (shapes) { _log (shapes) }
		this.drawingCleared = options.drawingCleared || function () { };
		this.drawingModeChangeHandler = options.drawingModeChanged;
		this.defaultUnits = options.defaultUnits;

		this.shapeFormat = options.format || 'WKT';

		this.drawing = false;
		this._shapes = [];

		this.shapeOptions = {
			fillColor: '#245080',
			draggable: false,
			editable: true,
			strokeWeight: 1
		};
		this.drawingManager = new google.maps.drawing.DrawingManager({
			drawingControl: false,
			circleOptions: this.shapeOptions,
			polygonOptions: this.shapeOptions,
			rectangleOptions: this.shapeOptions
		});

		this.unionHandler = options.unionHandler;
		this.excludeHandler = options.excludeHandler;

		this.drawingManager.setMap(this.map);
		this.map.data.addListener('setgeometry', function (event) {
			self._shapesChanged();
		});

		this._createControls();
	},

	clearShapes: function (quiet) {
		var self = this;

		jQuery('.clear, .exclude, .union', this.drawingToolsElement).addClass('disabled');
		this._clearDrawingMode();

		if (!this._shapes || this._shapes.length == 0) {
			return;
		}

		//remove features
		this.map.data.forEach(function (feature) {
			self.map.data.remove(feature);
		});

		//remove overlays
		for (var i = 0, l = this._shapes.length; i < l; i++) {
			if (this._shapes[i].setMap) {
				if (this._shapes[i]._radiusBorderMarker) {
					this._shapes[i]._radiusBorderMarker.setMap(null);
					this._shapes[i]._radiusCenterMarker.setMap(null);
				}
				this._shapes[i].setMap(null);
			}
		}
		this._shapes = [];

		if (!quiet) {
			this._shapesChanged();
			if (this.drawingCleared) {
				this.drawingCleared();
			}
		}
	},

	getSelectedShape: function (callback) {
		var self = this;
		if (this._selected) {
			if (this._selected.setMap) {
				var polygon = this._overlayToPolygon(self._selected);
				return callback(Terraformer.WKT.convert(polygon));
			}

			this._selected.toGeoJson(function (geoJson) {
				callback(Terraformer.WKT.convert(geoJson.geometry));
			});
		}
	},

	getShapes: function (callback) {
		var self = this;
		this.shapes = [];

		this.map.data.toGeoJson(function (geoJson) {
			var output = [];
			if (self.shapeFormat == 'WKT') {
				for (var i = 0, l = geoJson.features.length; i < l; i++) {
					//only return valid polygons
					if ((geoJson.features[i].geometry.type || '').toLowerCase() == 'polygon' && geoJson.features[i].geometry.coordinates[0].length <= 3) {
						continue;
					}

					output.push(Terraformer.WKT.convert(geoJson.features[i].geometry));
				}

				for (var i = 0, l = self._shapes.length; i < l; i++) {
					if (!self._shapes[i].setMap) { continue; }

					var polygon = self._overlayToPolygon(self._shapes[i]);

					//only return valid polygons
					if ((polygon.type || '').toLowerCase() == 'polygon' && polygon.coordinates[0].length <= 3) {
						continue;
					}

					output.push(Terraformer.WKT.convert(polygon));
				}
			}
			else {
				for (var i = 0, l = geoJson.features.length; i < l; i++) {
					output.push(geoJson.features[i].geometry);
				}

				for (var i = 0, l = self._shapes.length; i < l; i++) {
					if (!self._shapes[i].setMap) { continue; }

					output.push(self._overlayToPolygon(self._shapes[i]));
				}
			}

			self.shapes = output;
			return callback(output);
		});
	},

	addShape: function (shape) {
		try {
			if (typeof shape == 'object') {
				this._addGeoJson(shape);
			}
			else if (shape.indexOf('{') != '-1') {
				this._addGeoJson(JSON.parse(shape));
			}
			else {
				var geoJson = Terraformer.WKT.parse(shape);
				this._addGeoJson(geoJson);
			}
		}
		catch (e) {
			_log(e);
		}
	},

	_createControls: function () {
		var self = this;
		var backgroundStyle = 'background-image: url(\'' + this.modulePath + 'External/GoogleMaps/DrawingTools_ToolbarIcons.png\'); background-repeat: no-repeat';

		var group = jQuery('<ul class="drawing-controls custom"></ul>');
		var polygonControl = jQuery('<li class="polygon" data-type="POLYGON" style="' + backgroundStyle + '" title="Draw a polygon"><span>P</span></li>');
		var circleControl = jQuery('<li class="circle" data-type="CIRCLE" style="' + backgroundStyle + '" title="Draw a circle"><span>C</span></li>');
		var rectangleControl = jQuery('<li class="rectangle" data-type="RECTANGLE" style="' + backgroundStyle + '" title="Draw a rectangle"><span>R</span></li>');
		var clearControl = jQuery('<li class="clear disabled" data-type="clear" style="' + backgroundStyle + '" title="Erase all shapes"><span>E</span></li>');
		

		group.append(polygonControl);
		group.append(circleControl);
		group.append(rectangleControl);
		group.append(jQuery('<li class="separator"><span>S></span></li>'));

		if (this.unionHandler) {
			group.append(jQuery('<li class="union disabled" data-type="union" style="' + backgroundStyle + '" title="Select a shape to combine with any intersecting shapes"><span>U</span></li>'));
			group.append(jQuery('<li class="exclude disabled" data-type="exclude" style="' + backgroundStyle + '" title="Select a shape to exclude from any intersecting shapes"><span>E</span></li>'));
			group.append(jQuery('<li class="separator"><span>S></span></li>'));
		}

		group.append(clearControl);

		this.drawingToolsElement = group.get(0);
		this.drawingToolsElement.index = 1;

		jQuery('li', group).on('click', function () {
			self._toggleDrawingMode(jQuery(this).data('type'));
		});

		this.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(this.drawingToolsElement);

		this.map.data.setStyle(function (feature) {
			if (feature) {

			}
			return {
				fillColor: '#245080',
				draggable: false,
				editable: true,
				strokeWeight: 1,
				clickable: false
			}
		});

	},

	_clearDrawingMode: function () {
		this.map.data.setDrawingMode(null);
		this.drawingManager.setDrawingMode(null);
		google.maps.event.clearListeners(this.map.data, 'addfeature');
		google.maps.event.clearListeners(this.drawingManager, 'overlaycomplete');

		this.map.setOptions({ draggable: true });
		this.map.setOptions({ draggableCursor: '' });

		if (this.__drawHandles) {
			for (var i = 0; i < this.__drawHandles.length; i++) {
				google.maps.event.removeListener(this.__drawHandles[i]);
			}
		}
		if (this.__selectHandles) {
			for (var i = 0; i < this.__selectHandles.length; i++) {
				google.maps.event.removeListener(this.__selectHandles[i]);
			}
		}
		if (this._selected) {
			delete this._selected.selected;
		}

		jQuery('.selected', this.drawingToolsElement).removeClass('selected');
	},

	_unionOrExclude: function (item) {
		var self = this;
		var type = this._drawingMode;
		
		this.getSelectedShape(function (shape){
			self._clearDrawingMode();
			if (type == 'exclude') {
				self.excludeHandler(shape);
			}
			else {
				self.unionHandler(shape);
			}
		});
	},

	overlayOrFeatureClicked: function (item) {
		if (this._drawingMode == 'union' || this._drawingMode == 'exclude') {
			this._unionOrExclude(item);
		}
	},

	drawingModeChanged: function (mode) {
		var prevMode = this._drawingMode;
		this._drawingMode = mode || '';

		if (this._drawingMode != prevMode) {
			if (prevMode == 'union' || prevMode == 'exclude') {
				this._shapes.forEach(function (s) {
					if (s.setMap) {
						s.setOptions({ clickable: false });
					}
				});
				this.map.data.setStyle(function (feature) {
					return {
						clickable: false,
						fillColor: '#245080',
						draggable: false,
						editable: true,
						strokeWeight: 1
					}
				});
			}
			else if (prevMode == 'circle') {
				this.map.setOptions({ draggable: true });
			}
		}
		if (this.drawingModeChangeHandler) {
			this.drawingModeChangeHandler((mode || '').toLowerCase());
		}
	},

	_toggleDrawingMode: function (type) {
		var self = this;
		if (!this.__drawHandles) {
			this.__drawHandles = [];
		}

		this._clearDrawingMode();
		this.drawingModeChanged((type || '').toLowerCase());

		jQuery('.selected', this.drawingToolsElement).removeClass('selected');

		if (type && jQuery('.' + type.toLowerCase(), this.drawingToolsElement).hasClass('disabled')){
			return;
		}
		if (type == 'clear') {
			return this.clearShapes();
		}

		if (type == 'union' || type == 'exclude') {
			jQuery('.' + type.toLowerCase(), this.drawingToolsElement).addClass('selected');
			
			this._shapes.forEach(function (s) {
				if (s.setMap) {
					s.setOptions({ clickable: true });
				}
			});
			this.map.data.setStyle(function (feature) {
				return {
					clickable: true,
					fillColor: '#245080',
					draggable: false,
					editable: true,
					strokeWeight: 1
				}
			});
			return;
		}

		if (type == 'RECTANGLE') {
			this.drawingManager.setDrawingMode(google.maps.drawing.OverlayType[type]);
			this.map.data.setDrawingMode(null);
			this.__drawHandles.push(google.maps.event.addListener(this.drawingManager, 'overlaycomplete', function (event) {
				self._featureAdded(event);
			}));

			jQuery('.' + type.toLowerCase(), this.drawingToolsElement).addClass('selected');
		}
		//custom drawing mode with a radius
		else if (type == 'CIRCLE') {
			jQuery('.' + type.toLowerCase(), this.drawingToolsElement).addClass('selected');
			this.map.setOptions({ draggable: false });
			this.map.setOptions({ draggableCursor: "url(https://maps.gstatic.com/mapfiles/crosshair.cur), auto" });
			//start the circle
			this.__drawHandles.push(google.maps.event.addListenerOnce(self.map, 'mousedown', function (event) {
				self.__circle = new google.maps.Circle({
					fillColor: '#245080',
					draggable: false,
					editable: false,
					strokeWeight: 1,
					clickable: false,
					map: self.map,
					radius: 1,
					center: event.latLng,
					zIndex: 1
				});
				self.__drawHandles.push(self.map.addListener('mousemove', function (event) {
					var radius = google.maps.geometry.spherical.computeDistanceBetween(self.__circle.getCenter(), event.latLng);
					self.__circle.setRadius(radius);
					self._displayRadius(self.__circle, event.latLng, radius);
				}));
			}));

			self.__drawHandles.push(google.maps.event.addListenerOnce(self.map, 'mouseup', function (event) {
				self.map.setOptions({ draggableCursor: '' });
				self._displayRadius(null);
				self._clearDrawingMode();
				self._circleAdded(self.__circle);
			}));

		}
		else if (type == 'POLYGON') {
			this.drawingManager.setDrawingMode(null);
			this.map.data.setDrawingMode("Polygon");
			this.__drawHandles.push(this.map.data.addListener('addfeature', function (event) {
				self._featureAdded(event);
			}));

			jQuery('.' + type.toLowerCase(), this.drawingToolsElement).addClass('selected');
		}
		else {
			this._clearDrawingMode();
			
		}
	},

	_getRadiusLabelContent: function (radius) {
		var _radius = this.defaultUnits == 'mi' ? (radius * 0.000621371).toFixed(1) + 'mi' : (radius / 1000).toFixed(2) + 'km';
		return '<div class="radius-marker" style="vertical-align: middle; background-color: #fff; width: 70px; line-height: 24px; height: 24px; overflow: hidden; border: solid 1px #DDD; border-radius: 3px; text-align: center;">' + _radius + '</div>';
	},

	_decorateCircle: function (circle) {
		var self = this;
		if (circle.getCenter) {

			if (!this._radiusLabel) {
				this._radiusLabel = new InfoBox(
				{
					closeBoxURL: '',
					pane: "floatPane",
					enableEventPropagation: true,
					disableAutoPan: true,
					pixelOffset: new google.maps.Size(-35, -35)
				});
			}

			var centerLatLng = circle.getCenter();
			var borderLatLng = new google.maps.LatLng(centerLatLng.lat(), circle.getBounds().getNorthEast().lng());
			circle._radiusPolyline = new google.maps.Polyline({
				strokeColor: '#245080',
				strokeWeight: 1,
				strokeOpacity: 0.7,
				path: [centerLatLng, borderLatLng],
				map: this.map
			});
			circle._radiusPolyline.setVisible(false);

			circle._radiusCenterMarker = new google.maps.Marker({
				position: centerLatLng,
				icon: {
					path: google.maps.SymbolPath.CIRCLE,
					scale: 5,
					strokeWeight: 1,
					fillColor: 'white',
					fillOpacity: 1
				},
				zIndex: 3,
				draggable: true,
				map: this.map
			});

			circle._radiusBorderMarker = new google.maps.Marker({
				position: borderLatLng,
				icon: {
					path: google.maps.SymbolPath.CIRCLE,
					scale: 5,
					strokeWeight: 1,
					fillColor: 'white',
					fillOpacity: 1
				},
				zIndex: 3,
				draggable: true,
				map: this.map,
				enableEventPropagation: true
			});

			circle._radiusCenterMarker.parent = circle;
			circle._radiusBorderMarker.parent = circle;

			circle._radiusCenterMarker.addListener('drag', function (event) {
				this.parent.setCenter(event.latLng);
				this.parent.dragging = true;
				self.isEditing = true;

				var bounds = circle.getBounds();
				var position = new google.maps.LatLng(event.latLng.lat(), bounds.getNorthEast().lng());
				this.parent._radiusBorderMarker.setPosition(position);
			});

			circle._radiusBorderMarker.addListener('drag', function (event) {
				this.parent.dragging = true;
				self.isEditing = true;

				var radius = google.maps.geometry.spherical.computeDistanceBetween(this.parent.getCenter(), event.latLng);
				this.parent.setRadius(radius);
				this.parent._radiusPolyline.setPath([circle.getCenter(), event.latLng]);
				this.parent._radiusPolyline.setVisible(true);
				
				self._radiusLabel.setPosition(event.latLng);
				self._radiusLabel.setContent(self._getRadiusLabelContent(radius));

				if (!self._radiusLabel.getVisible()) {
					self._radiusLabel.setVisible(true);
					self._radiusLabel.open(self.map, circle._radiusBorderMarker);
				}
			});


			circle._radiusCenterMarker.addListener('dragend', function () {
				this.parent.dragging = false;
				self.isEditing = false;
				self._shapesChanged();
			});
			
			circle._radiusBorderMarker.addListener('dragend', function (event) {
				this.parent.dragging = false;
				self.isEditing = false;
				this.parent.setRadius(google.maps.geometry.spherical.computeDistanceBetween(this.parent.getCenter(), event.latLng));
				this.parent._radiusPolyline.setVisible(false);
				self._radiusLabel.setVisible(false);
				self._shapesChanged();
			});
		}
	},
	_displayRadius: function (circle, borderLatLng, radius) {
		var self = this;
		var newMarkers = false;

		if (!circle) {
			if (this._radiusLabel) {
				this._radiusLabel.setVisible(false);
			}
			return;
		}
		var centerLatLng = circle.getCenter();
		
		var content = this._getRadiusLabelContent(radius);

		if (!circle._radiusPolyline) {

			newMarkers = true;
			this._decorateCircle(circle);
		}

		this._radiusLabel.setContent(content);
		this._radiusLabel.setPosition(borderLatLng);
		this._radiusLabel.setVisible(true);

		circle._radiusPolyline.setPath([centerLatLng, borderLatLng]);
		circle._radiusCenterMarker.setPosition(centerLatLng);
		circle._radiusBorderMarker.setPosition(borderLatLng);

		if (newMarkers || !circle._radiusPolyline.getVisible()) {
			this._radiusLabel.open(this.map, this._radiusBorderMarker);
			this._radiusLabel.setVisible(true);
			circle._radiusPolyline.setVisible(true);
			circle._radiusCenterMarker.setVisible(true);
			circle._radiusBorderMarker.setVisible(true);

			this.__drawHandles.push(google.maps.event.addListenerOnce(circle._radiusBorderMarker, 'mouseup', function (event) {
				self.map.setOptions({ draggableCursor: '' });
				self._displayRadius(null);
				self._clearDrawingMode();
				self._circleAdded(circle);
			}));
		}

	},

	_circleAdded: function (circle) {
		if (circle) {
			if (!circle.radius || circle.radius <= 1) {
				circle.setMap(null);
				if (circle._radiusPolyline) { circle._radiusPolyline.setMap(null); }
				if (circle._radiusBorderMarker) { circle._radiusBorderMarker.setMap(null); }
				if (circle._radiusCenterMarker) { circle._radiusCenterMarker.setMap(null); }
				return;
			}

			var self = this;

			circle._radiusPolyline.setVisible(false);

			this._shapes.push(circle);

			this._toggleDrawingMode(null);

			this._shapesChanged();


			google.maps.event.addListener(circle, 'click', function (overlay) {
				this.selected = true;
				self._selected = this;
				self.overlayOrFeatureClicked(this);
			});


			if (this._shapes.length > 1) {
				jQuery('.exclude, .union', this.drawingToolsElement).removeClass('disabled');
			}

			jQuery('.clear', this.drawingToolsElement).removeClass('disabled');

		}
	},

	_featureAdded: function (event, quiet) {
		var self = this;

		this._shapes.push(event.feature || event.overlay);

		this._toggleDrawingMode(null);

		if (!quiet) {
			this._shapesChanged();
		}

		if (event && event.feature) {
			if (!this._mapDataClick) {
				this._mapDataClick = this.map.data.addListener('click', function (event) {
					event.feature.selected = true;
					self._selected = event.feature;
					self.overlayOrFeatureClicked(event.feature);
				});
			}
		}

		if (event && typeof event.overlay != 'undefined') {
			if (event.overlay.radius) {
				google.maps.event.addListener(event.overlay, 'radius_changed', function (overlay) {
					self._shapesChanged();
				});
				google.maps.event.addListener(event.overlay, 'center_changed', function (overlay) {
					self._shapesChanged();
				});
			}
			else {
				google.maps.event.addListener(event.overlay, 'bounds_changed', function (overlay) {
					self._shapesChanged();
				});
			}
			google.maps.event.addListener(event.overlay, 'click', function (event) {
				this.selected = true;
				self._selected = this;
				self.overlayOrFeatureClicked(this);
			});

			event.overlay.setOptions({ clickable: false });
		}

		if (this._shapes.length > 1) {
			jQuery('.exclude, .union', this.drawingToolsElement).removeClass('disabled');
		}

		jQuery('.clear', this.drawingToolsElement).removeClass('disabled');
	},

	_shapesChanged: function () {
		var zIndex = 0;
		//adjust zindex of all shapes to ensure the shapes are in the order drawn or added
		for (var i = 0; i < this._shapes.length; i++) {
			zIndex++;
			if (!this._shapes[i] || (this._shapes[i].length && this._shapes[i].length == 0)) { continue; }
			if (this._shapes[i].setMap) {
				this._shapes[i].setOptions({ zIndex: zIndex });
			}
			else {
				if (this._shapes[i].length && this._shapes[i].length > 0) {
					for (var x = 0; x < this._shapes[i].length; x++) {
						zIndex++;
						this.map.data.overrideStyle(this._shapes[i][x], { zIndex: zIndex });
					}
				}
				else {
					this.map.data.overrideStyle(this._shapes[i], { zIndex: zIndex})
				}
			}
		}

		if (this.changed) {
			this.getShapes(this.changed);
		}
	},

	_addGeoJson: function (geoJson) {
		if (!geoJson.type || geoJson.type.toLowerCase().indexOf('feature') != 0) {
			geoJson = {
				type: 'Feature',
				geometry: geoJson
			};
		}

		var features = this.map.data.addGeoJson(geoJson);

		//convert to circle or rectangle
		var _shape = this._getOverlayFromFeature(features);

		if (_shape) {
			this._decorateCircle(_shape);
			this._featureAdded({ overlay: _shape });
		}
		else {
			this._featureAdded({ feature: features });
		}
	},

	_overlayToPolygon: function (overlay) {
		if (overlay.radius) {
			return this._circleToPolygon(overlay);
		}
		return this._rectangleToPolygon(overlay);
	},

	_rectangleToPolygon: function (rectangle) {
		var bounds = rectangle.bounds;

		var ne = bounds.getNorthEast();
		var sw = bounds.getSouthWest();
		var nw = new google.maps.LatLng(ne.lat(), sw.lng());
		var se = new google.maps.LatLng(sw.lat(), ne.lng());

		var points = [];
		points.push([nw.lng(), nw.lat()]);
		points.push([sw.lng(), sw.lat()]);
		points.push([se.lng(), se.lat()]);
		points.push([ne.lng(), ne.lat()]);
		points.push([nw.lng(), nw.lat()]);

		return {
			type: 'Polygon',
			coordinates: [points]
		};
	},

	_circleToPolygon: function (circle) {
		var numSides = 35;
		var points = [];
		var degreeStep = 360 / numSides;

		for (var i = 0; i < numSides; i++) {
			var gpos = google.maps.geometry.spherical.computeOffset(circle.center, circle.radius, degreeStep * i);
			points.push([gpos.lng(), gpos.lat()]);
		};

		// Duplicate the last point to close the geojson ring
		points.push(points[0]);

		return {
			type: 'Polygon',
			coordinates: [points]
		};
	},

	_getFeatureBounds: function (feature) {
		var bounds = new google.maps.LatLngBounds();
		feature.getGeometry().getArray().forEach(function (path) {

			//iterate over the points in the path
			path.getArray().forEach(function (latLng) {

				//extend the bounds
				bounds.extend(latLng);
			});

		});
		return bounds;
	},

	_getOverlayFromFeature: function (feature) {
		feature = feature.length && feature.length > 0 ? feature[0] : feature;

		var bounds = this._getFeatureBounds(feature);
		var paths = feature.getGeometry().getArray();
		var latLngs = paths[0].getArray();

		var northEast = bounds.getNorthEast();
		var southWest = bounds.getSouthWest();
		var center = bounds.getCenter();

		var centerWest = new google.maps.LatLng(center.lat(), southWest.lng());
		var centerEast = new google.maps.LatLng(center.lat(), northEast.lng());

		//shape is a circle?
		if (paths.length == 1 && latLngs.length >= 15) {
			var center = bounds.getCenter();
			var radius = google.maps.geometry.spherical.computeDistanceBetween(centerWest, centerEast) / 2;

			/**
			 * createCirclePath appears to create greater variation in radial distance the larger the circle
			 * verify points within large circular paths to within 1m per km in radial length and
			 * smaller circular paths to within 1% of radius
			 **/

			var radialKM = Math.ceil(radius / 1000);
			var tolerance = radialKM < 100 ? radius * 0.01 : radius * (radialKM * 0.001);

			//quickest way to test these is to test distance to the center (within tolerance)
			for (var i = 0, l = latLngs.length; i < l; i++) {
				var distance = google.maps.geometry.spherical.computeDistanceBetween(center, latLngs[i]);
				//is a polygon
				if (Math.abs(Math.floor(distance) - Math.floor(radius)) > tolerance) {
					return null;
				}
			}

			var options = jQuery.extend({}, this.shapeOptions);
			options.center = center;
			options.radius = radius;
			options.map = this.map;
			options.editable = false;
			options.clickable = false;

			this.map.data.remove(feature);

			return new google.maps.Circle(options);

		}
		else if (paths.length == 1 && (latLngs.length == 4 || latLngs.length == 5)) {

			var horizontalVariation = latLngs[0].lng() == latLngs[1].lng() ? true : false;
			var evenMethod = horizontalVariation ? 'lat' : 'lng';
			var oddMethod = horizontalVariation ? 'lng' : 'lat';
			
			var isRect =
						latLngs[0][oddMethod]() == latLngs[1][oddMethod]() &&
						latLngs[1][evenMethod]() == latLngs[2][evenMethod]() &&
						latLngs[2][oddMethod]() == latLngs[3][oddMethod]() &&
						latLngs[3][evenMethod]() == latLngs[0][evenMethod]();

			
			if (isRect) {
				var options = jQuery.extend({}, this.shapeOptions);

				options.map = this.map;
				options.bounds = bounds;
				options.clickable = false;

				this.map.data.remove(feature);
				return new google.maps.Rectangle(options);
			}
		}

		return null;
	},

	getShapeBounds: function () {
		var bounds = new google.maps.LatLngBounds();
		this.map.data.forEach(function(feature){
			feature.getGeometry().getArray().forEach(function (path) {

				//iterate over the points in the path
				path.getArray().forEach(function (latLng) {

					//extend the bounds
					bounds.extend(latLng);
				});

			});
		});

		for (var i = 0; i < this._shapes.length; i++) {
			if (!this._shapes[i].setMap) { continue; }
			var shapeBounds = this._shapes[i].getBounds();
			bounds.extend(shapeBounds.getNorthEast());
			bounds.extend(shapeBounds.getSouthWest());
		}

		return bounds;
	}
});

function _log(a, b) {
	if (console && console.log) {
		console.log(a, b);
	}
	if (console && console.log2) {
		console.log2(a, b);
	}
}
 
 
if (!('SDS' in window)) { window.SDS = {}; }

SDS.SDSMap = function (init) {
	if (init.type == 'bing') {
		if (!SDS.SDSMap.instances) { SDS.BingMap.instances; }
		return new SDS.BingMap(init);
	}
	else if (init.type == 'google') {
		if (!SDS.SDSMap.instances) { SDS.GoogleMap.instances; }
		return new SDS.GoogleMap(init);
	}
	else {
		throw new Error("unknown map provider in SDS.SDSMap (" + init.type + ")");
	}
}

SDS.SDSMapIFrame = function (init) {
	if (init.type == 'bing') {
		if (!SDS.SDSMap.instances) { SDS.BingMap.instances = []; }
		return new SDS.BingMapIFrame(init);
	}
	else if (init.type == 'google') {
		if (!SDS.SDSMap.instances) { SDS.GoogleMap.instances = []; }
		return new SDS.GoogleMapIFrame(init);
	}
	else {
		throw new Error("unknown map provider in SDS.SDSMapIFrame (" + init.type + ")");
	}
}

 
 
/// <reference path="../REModel.js" />

REModel.Services.Service = Base.extend({
	auth: null,

	constructor: function (serviceUrl, auth) {
		if (!serviceUrl) {
		
			//correct serviceRoot if misconfigured
			if (REModel.Services.Service.serviceRoot == '../../Services/') {
				//if serviceRoot is not defined for /Web2 pages the default fails
				if (location.href.toLowerCase().indexOf('/web2') != -1) {
					REModel.Services.Service.serviceRoot = '../../REModel/Services/';
				}
				//../../Services fails for /pages/treb/otherpage/otherpage.aspx
				else if (location.href.match(/\/pages\/\w{1,}\/\w{1,}\/\w{1,}.aspx/i)) {
					REModel.Services.Service.serviceRoot = '../../../Web2/REModel/Services/';
				}
				// *always* use web2 for services
				else {
					REModel.Services.Service.serviceRoot = '../../Web2/REModel/Services/';
				}
			}
			var serviceUrl = REModel.Services.Service.serviceRoot + "REModel.svc/";
		}
		this.serviceUrl = serviceUrl;
		if (typeof auth != "undefined") { this.auth = auth; }
		else {
			this.auth = REModel.Session.getAuth();
		}
	},

	invokeGet: function (method, params, success, error, doNotStrip, returnRawData) {
		return this.invoke("GET", method, params, success, error, doNotStrip, null, returnRawData);
	},

	invokePost: function (method, params, success, error, doNotStrip, returnRawData) {
		return this.invoke("POST", method, params, success, error, doNotStrip, null, returnRawData);
	},

	invoke: function (type, method, params, success, error, doNotStrip, returnURL, returnRawData) {
		if (typeof REModel.Services.Service.onBeforeInvoke == 'function') { REModel.Services.Service.onBeforeInvoke.call(this); }

		var isWCF = true;
		if (type) { type = type.toUpperCase(); }
		else { var type = "GET"; }
		var data = null;
		if (type == "POST") {
			data = isWCF ? JSON.stringifyWcf(params) : JSON.stringify(params);
		}
		else if (type == "GET") {
			var query = [];

			if (this.version) { params.version = this.version; }

			for (var name in params) {
				if (params.hasOwnProperty(name)) {
					var param = params[name];
					if (param === null || typeof param == "undefined") { continue; }
					var value = isWCF ? JSON.stringifyWcf(param) : JSON.stringify(param);
					value = encodeURIComponent(value);
					query.push(name + '=' + value)
				}
			}

			data = query.join('&');
		}

		// Service endpoint URL    
		var url = this.serviceUrl + method;

		if (type == "GET" && returnURL) {
			return url + "?" + data;
		}

		var service = this;

		// maintain a count of current XHR requests
		REModel.Services.Service.XHRCount = REModel.Services.Service.XHRCount || 0;
		REModel.Services.Service.XHRCount++;

		var xhr = jQuery.ajax({
			url: url,
			data: data,
			type: type,
			processData: false,
			contentType: "application/json",
			timeout: 90000,
			dataType: "text",
			success: function (result) {
				REModel.Services.Service.XHRCount = REModel.Services.Service.XHRCount - 1;

				if (returnRawData === true) { // Used for format method as it's raw text
					if (success) { success(result); }
					return;
				}

				if (result && result.length > 0 && result.charAt(0) != '{') {
					//if (result.indexOf('<title>401 - Unauthorized: Access is denied due to invalid credentials.</title>') >= 0) {
					//	if (REModel.Services.Service.authFailed && !REModel.Services.Service._attemptAuth) {
					//		REModel.Services.Service._attemptAuth = true;
					//		REModel.Services.Service.authFailed(function() {
					//			service.invoke(type, method, params, success, error, doNotStrip);
					//		});
					//		return;
					//	}
					//}
					//REModel.Services.Service._attemptAuth = false;
					if (error) { error("Invalid JSON: " + result, service, null); }
					return;
				}
				//REModel.Services.Service._attemptAuth = false;

				// Use json library so we can fix up MS AJAX dates
				var obj = JSON.parseWithMsAjaxDate(result);

				if (obj.ExceptionDetail) {
					if (error) { error(obj.ExceptionDetail, service, null); }
					return;
				}

				if (!success) {
					return;
				}

				// Bare message IS result
				if (doNotStrip) {
					delete obj.__type;
					success(obj);
					return;
				}

				// Wrapped message contains top level object node
				// strip it off
				for (var name in obj) {
					// Fix null reference error for certain service calls
					if (obj[name]) {
						delete obj[name].__type;
					}
					success(obj[name]);
					return;
				}
			},
			error: function (xhr, status) {
				REModel.Services.Service.XHRCount = REModel.Services.Service.XHRCount - 1;

				var e = null;
				if (xhr.readyState == 4) {
					var response = xhr.responseText;
					if (response && response.charAt(0) == '{') {
						e = JSON.parseWithMsAjaxDate(response);
					}
					if (e) {
						if (xhr.status && xhr.status != 200) {
							e = xhr.status + " " + xhr.statusText + "\r\n" + xhr.responseText;
						}
						else {
							e = "Callback Error: " + status;
						}
						//alert(response);
						e.detail = response;
						var strResponse = new String(response);
						if (strResponse.indexOf("CheckAuth") != -1) {
							window.location = REModel.Services.Service.serviceLogoutUrl;
						}
					}

					// Status should only be set to 0 when a network
					// problem exists or a request was aborted
					if (xhr.status === 0) {
						// Swallow the error
						return;
					}
				}

				if (!e) {
					e = "Callback Error: " + status;
				}
				if (error) {
					//alert(e.detail);
					error(e, service, xhr);
				}
			}
		});

		return new REModel.Services.RequestHandle(xhr);
	}
}, {
	convertToWcfDictionary: function (obj) {
		if (!Array.isArray) {
			Array.isArray = function (vArg) {
				return Object.prototype.toString.call(vArg) === "[object Array]";
			};
		}

		var wcfDict = [];
		// If the object is an array, assume an array of dictionaries.
		if (Array.isArray(obj)) {
			for (var i = 0, len = obj.length; i < len; ++i) {
				var itemArray = [];
				wcfDict.push(itemArray);
				var item = obj[i];
				for (var name in item) {
					if (item.hasOwnProperty(name)) {
						var value = item[name];
						itemArray.push({ Key: name, Value: value });
					}
				}
			}
		}
		// Otherwise just a single dictionary.
		else {
			for (var name in obj) {
				if (obj.hasOwnProperty(name)) {
					var value = obj[name];
					wcfDict.push({ Key: name, Value: value });
				}
			}
		}
		return wcfDict;
	},

	setLogoutUrl: function (url) {
		REModel.Services.Service.serviceLogoutUrl = url;
	},

	serviceLogoutUrl: "../../../Pages/Login/Logout.aspx",

	serviceRoot: "../../Services/", // todo: experimental
	//serviceRoot: "http://localhost:55555/Services/" // todo: change before committing
	//serviceRoot: "http://localhost:55555/REModel/"
	//serviceRoot: "http://svn.stratusdata.com/REModel/"
	//serviceRoot: "../../External/proxy.php?mode=native&send_cookies=1&url=http://jamie-pc.local/REModel/"
	//serviceRoot: "../../External/proxy.php?mode=native&send_cookies=1&url=http://svn.stratusdata.com/REModel/"

	Util: {
		/**
	* @param {object} obj
	**/
		toQueryString: function (obj) {
			if (typeof (obj) === 'undefined' || obj == null || typeof (obj) === 'string' || parseFloat(obj) === obj) {
				return '';
			}
			var queryString = [];
			REModel.Services.Service.Util._toQueryStringImpl(obj, '', queryString);
			return queryString.join('&').split('%20').join('+');
		},

		/**
		* @param {object} obj
		* @param {context} context
		* @param {string} queryString
		* @private
		**/
		_toQueryStringImpl: function (obj, context, queryString) {
			if (typeof (obj) === 'string' || parseFloat(obj) === obj) {
				queryString.push(encodeURIComponent(context) + '=' + encodeURIComponent(obj));
			} else {
				// Try to process the object as an array.
				if (REModel.Services.Service.Util.isArray(obj)) {
					for (var k = 0; k < obj.length; k++) {
						REModel.Services.Service.Util._toQueryStringImpl(obj[k], context + '.' + (1 + k), queryString);
					}
				} else {
					for (var property in obj) {
						var value = obj[property];
						if (!(value === null || value === undefined) && typeof (value) !== 'function') {
							var valueContext = context ? context + '.' + property : property;
							REModel.Services.Service.Util._toQueryStringImpl(value, valueContext, queryString);
						}
					}
				}
			}
		},
		/**
		* determine whether an object is an array
		* @param {object} obj object to test
		**/
		isArray: function (obj) {
			if (typeof (obj.length) !== 'undefined' && parseInt(obj.length) == obj.length && obj.length >= 0) {
				if (obj.length == 0) {
					return true;
				}
				try {
					var value = obj[obj.length - 1];
					return true;
				} catch (e) {
					return false;
				}
			} else {
				return false;
			}
		}
	}
});

var __reISO = /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/;
var __reMsAjax = /^\/Date\((d|-|.*)\)[\/|\\]$/;

function __msAjaxDateReplacer(key, value) {
	if (!value ||
		typeof value != 'string' ||
		value.lastIndexOf('/Date(', 0) !== 0) { return value; }
	var a = __reMsAjax.exec(value);
	if (!a) { return value; }
	var b = a[1].split(/[-+,.]/);
	return new Date(b[0] ? +b[0] : 0 - +b[1]);
}

function __dateReplacer(key, value) {
	if (!value || typeof value !== 'string') { return value; }
	var a = reISO.exec(value);
	if (a) { return new Date(Date.UTC(+a[1], +a[2] - 1, +a[3], +a[4], +a[5], +a[6])); }
	a = reMsAjax.exec(value);
	if (!a) { return value; }
	var b = a[1].split(/[-+,.]/);
	return new Date(b[0] ? +b[0] : 0 - +b[1]);
}

JSON.parseWithDate = function (json) {
	/// <summary>
	/// parses a JSON string and turns ISO or MSAJAX date strings
	/// into native JS date objects
	/// </summary>    
	/// <param name="json" type="var">json with dates to parse</param>        
	/// </param>
	/// <returns type="value, array or object" />
	return JSON.parse(json, __dateReplacer);
};

JSON.parseWithMsAjaxDate = function (json) {
	/// <summary>
	/// parses a JSON string and turns MSAJAX date strings
	/// into native JS date objects
	/// </summary>    
	/// <param name="json" type="var">json with dates to parse</param>        
	/// </param>
	/// <returns type="value, array or object" />
	return JSON.parse(json, __msAjaxDateReplacer);
};

JSON.stringifyWcf = function(json) {
	/// <summary>
	/// Wcf specific stringify that encodes dates in the
	/// a WCF compatible format ("/Date(9991231231)/")
	/// Note: this format works ONLY with WCF. 
	///       ASMX can use ISO dates as of .NET 3.5 SP1
	/// </summary>
	/// <param name="key" type="var">property name</param>
	/// <param name="value" type="var">value of the property</param>         
	return JSON.stringify(json, function (key, value) {
		if (value !== null && typeof value != "undefined") { delete value.__type; }
		if (typeof value == "string") {
			var a = __reISO.exec(value);
			if (a) {
				var val = '/Date(' + new Date(Date.UTC(+a[1], +a[2] - 1, +a[3], +a[4], +a[5], +a[6])).getTime() + ')/';
				this[key] = val;
				return val;
			}
		}
		return value;
	});
};

JSON.dateStringToDate = function (dtString) {
	/// <summary>
	/// Converts a JSON ISO or MSAJAX string into a date object
	/// </summary>    
	/// <param name="" type="var">Date String</param>
	/// <returns type="date or null if invalid" /> 
	var a = __reISO.exec(dtString);
	if (a) return new Date(Date.UTC(+a[1], +a[2] - 1, +a[3], +a[4], +a[5], +a[6]));
	a = __reMsAjax.exec(dtString);
	if (a) {
		var b = a[1].split(/[-,.]/);
		return new Date(+b[0]);
	}
	return null;
};
 
 
/**
 *	@class REModel.Services.RequestHandle
 * Wrapper class for XHR objects
 * @namespace REModel.Services
 * @author Jason Swartout
 * @qa needs-review
 **/
REModel.Services.RequestHandle = Base.extend({
	constructor: function (xhr) {
		// Use private functions to restrict access
		// to the base xhr object.
		this.abort = function () {
			if (xhr) {
				return xhr.abort(); 
			}
		};

		this.state = function () {
			var state = -1;
			if (xhr) {
				state = xhr.readyState;
			}
			return state;
		};

		this.destroy = function () {
			this.abort();
			xhr = null;
		};
	}
}); 
 
/**
* @class REModel.Services.RequestManager
* Manager class to track and interface with RequestHandle objects
* @namespace REModel.Services
* @author Jason Swartout
* @qa needs-review
**/
REModel.Services.RequestManager = Base.extend({
	constructor: function () {

	},

	/**
	* @private
	**/
	requestHandlesByID: {},

	currentRequestHandleID: null,

	/**
	* Generate a unique id
	* @returns {string} Unique identifer
	**/
	getUid: function () {
		var base = (new Date()).getTime();
		var id = base;
		var i = 1;
		while (!this.requestHandlesByID[id] && i < 50) {
			id = base + '.' + i;
			i++;
		}
		this.requestHandlesByID[id] = {};
		this.currentRequestHandleID = id;
		return id;
	},

	abortActiveRequests: function () {
		var r = this.requestHandlesByID;
		var requests = [];
		for (var n in r) {
			if (!r.hasOwnProperty(n)) { continue; }
			if (r[n] && r[n].state && r[n].state() != 4 && r[n].state() != -1) {
				r[n].abort();
				requests.push(r[n]);
				delete this.requestHandlesByID[n];
			}
		}
		return requests;
	},

	isMostRecentRequest: function (id) {
		return (this.currentRequestHandleID == id);
	},

	getActiveRequests: function () {
		var r = this.requestHandlesByID;
		var requests = [];
		for (var n in r) {
			if (!r.hasOwnProperty(n)) { continue; }
			if (r[n] && r[n].state && r[n].state() != 4 && r[n].state() != -1) {
				requests.push(r[n]);
			}
		}
		return requests;
	},

	add: function (id, requestHandle) {
		this.requestHandlesByID[id] = requestHandle;
	},

	getByID: function (id) {
		return this.requestHandlesByID[id];
	}
}); 
 

REModel.Services.PdfService = REModel.Services.Service.extend({
	constructor: function (serviceUrl, auth) {
		this.base(serviceUrl, auth);
	},

	getRenderedDraft: function (renderData, draft, success, error) {
		this.invokePost("getRenderedDraft",
			{
				auth: this.auth,
				renderData: renderData,
				draft: draft
			},
			success, error, false
		);
	},
	getRenderedForm: function (renderData, success, error) {
		this.invokePost("getRenderedForm",
			{
				auth: this.auth,
				renderData: renderData
			},
			success, error, false
		);
	},
	getRenderedList: function (listData, success, error) {
		this.invokePost("getRenderedList",
			{
				auth: this.auth,
				listData: listData
			},
			success, error, false
		);
	},
	getRenderedLinkListings: function (renderData, link, success, error) {
		this.invokePost("getRenderedLinkListings",
			{
				auth: this.auth,
				renderData: renderData,
				link: link
			},
			success, error, false
		);
	},
	getRenderedHtml: function (renderData, success, error) {
		this.invokePost("getRenderedHtml",
			{
				auth: this.auth,
				renderData: renderData
			},
			success, error, false
		);
	},
	getRenderedPhotos: function (renderData, success, error) {
		this.invokePost("getRenderedPhotos",
			{
				auth: this.auth,
				renderData: renderData
			},
			success, error, false
		);
	},
	getRenderedMapList: function (mapData, success, error) {
		this.invokePost("getRenderedMapList",
			{
				auth: this.auth,
				mapData: mapData
			},
			success, error, false
		);
	},
	getRenderedDrivingDirections: function (mapData, success, error) {
		this.invokePost("getRenderedDrivingDirections",
			{
				auth: this.auth,
				mapData: mapData
			},
			success, error, false
		);
	},
	getRenderedDraftAsImages: function (renderData, draft, success, error) {
		this.invokePost("getRenderedDraftAsImages",
			{
				auth: this.auth,
				renderData: renderData,
				draft: draft
			},
			success, error, false
		);
	},
	getRenderedFormAsImages: function (renderData, success, error) {
		this.invokePost("getRenderedFormAsImages",
			{
				auth: this.auth,
				renderData: renderData
			},
			success, error, false
		);
	},
		getRenderedListAsImages: function (listData, success, error) {
			this.invokePost("getRenderedListAsImages",
			{
				auth: this.auth,
				listData: listData
			},
			success, error, false
		);
		},
		getRenderedLinkListingsAsImages: function (renderData, link, success, error) {
			this.invokePost("getRenderedLinkListingsAsImages",
			{
				auth: this.auth,
				renderData: renderData,
				link: link
			},
			success, error, false
		);
		},
		getRenderedHtmlAsImages: function (renderData, success, error) {
			this.invokePost("getRenderedHtmlAsImages",
			{
				auth: this.auth,
				renderData: renderData
			},
			success, error, false
		);
		},
		getRenderedPhotosAsImages: function (renderData, success, error) {
			this.invokePost("getRenderedPhotosAsImages",
			{
				auth: this.auth,
				renderData: renderData
			},
			success, error, false
		);
		},
		getRenderedMapListAsImages: function (mapData, success, error) {
			this.invokePost("getRenderedMapListAsImages",
			{
				auth: this.auth,
				mapData: mapData
			},
			success, error, false
		);
		},
		getRenderedDrivingDirectionsAsImages: function (mapData, success, error) {
			this.invokePost("getRenderedDrivingDirectionsAsImages",
			{
				auth: this.auth,
				mapData: mapData
			},
			success, error, false
		);
		}
});
	 
 
/*
* jQuery appear plugin
*
* Copyright (c) 2012 Andrey Sidorov
* licensed under MIT license.
*
* https://github.com/morr/jquery.appear/
*
* Version: 0.2.1
*/
(function ($) {
	var data = {};
	var check_binded = false;
	var check_lock = false;
	var defaults = {
		interval: 250
	}
	var $window = $(window);
	var $document = $(document);

	function process() {
		check_lock = false;
		for (var selector in data) {
			var $appeared = $(selector).filter(function () {
				return $(this).is(':appeared');
			});

			if ($appeared.length) {
				if (data[selector]) {
					data[selector]($appeared);
				} else {
					$appeared.first().trigger('appear', [$appeared]);
				}
			}
		}
	}

	// "appeared" custom filter
	$.expr[':']['appeared'] = function (element) {
		var $element = $(element);
		if (!$element.is(':visible')) {
			return false;
		}

		var window_left = $window.scrollLeft();
		var window_top = $window.scrollTop();
		var offset = $element.offset();
		var left = offset.left;
		var top = offset.top;

		if (top + $element.height() >= window_top &&
        top - ($element.data('appear-offset') || 450) <= window_top + $window.height()) {
			return true;
		} else {
			return false;
		}
	}

	$.fn.extend({
		// watching for element's appearance in browser viewport
		appear: function (callback, options) {
			$.extend(defaults, options || {});
			if (!check_binded) {
				var on_check = function () {
					if (check_lock) {
						return;
					}
					check_lock = true;

					setTimeout(process, defaults.interval);
				};

				$(window).scroll(on_check).resize(on_check);
				this.parents().each(function () {
					$this = $(this);
					if ($this.css('overflow') == 'scroll' || $this.css('overflow-x') == 'scroll' || $this.css('overflow-y') == 'scroll' || $this.css('overflow-y') == 'auto' || $this.css('overflow-x') == 'auto') {
						$this.scroll(on_check).resize(on_check);
					}
				});
				check_binded = true;
			}

			if (options && options.force_process) {
				setTimeout(process, defaults.interval);
			}
			data[this.selector] = callback;
			return $(this.selector);
		}
	});

	$.extend({
		// force elements's appearance check
		force_appear: function () {
			if (check_binded) {
				process();
				return true;
			};
			return false;
		}
	});
})(jQuery);
 
 
(function($){$.extend({tablesorter:new
function(){var parsers=[],widgets=[];this.defaults={cssHeader:"header",cssAsc:"headerSortUp",cssDesc:"headerSortDown",cssChildRow:"expand-child",sortInitialOrder:"asc",sortMultiSortKey:"shiftKey",sortForce:null,sortAppend:null,sortLocaleCompare:true,textExtraction:"simple",parsers:{},widgets:[],widgetZebra:{css:["even","odd"]},headers:{},widthFixed:false,cancelSelection:true,sortList:[],headerList:[],dateFormat:"us",decimal:'/\.|\,/g',onRenderHeader:null,selectorHeaders:'thead th',debug:false};function benchmark(s,d){log(s+","+(new Date().getTime()-d.getTime())+"ms");}this.benchmark=benchmark;function log(s){if(typeof console!="undefined"&&typeof console.debug!="undefined"){console.log(s);}else{alert(s);}}function buildParserCache(table,$headers){if(table.config.debug){var parsersDebug="";}if(table.tBodies.length==0)return;var rows=table.tBodies[0].rows;if(rows[0]){var list=[],cells=rows[0].cells,l=cells.length;for(var i=0;i<l;i++){var p=false;if($.metadata&&($($headers[i]).metadata()&&$($headers[i]).metadata().sorter)){p=getParserById($($headers[i]).metadata().sorter);}else if((table.config.headers[i]&&table.config.headers[i].sorter)){p=getParserById(table.config.headers[i].sorter);}if(!p){p=detectParserForColumn(table,rows,-1,i);}if(table.config.debug){parsersDebug+="column:"+i+" parser:"+p.id+"\n";}list.push(p);}}if(table.config.debug){log(parsersDebug);}return list;};function detectParserForColumn(table,rows,rowIndex,cellIndex){var l=parsers.length,node=false,nodeValue=false,keepLooking=true;while(nodeValue==''&&keepLooking){rowIndex++;if(rows[rowIndex]){node=getNodeFromRowAndCellIndex(rows,rowIndex,cellIndex);nodeValue=trimAndGetNodeText(table.config,node);if(table.config.debug){log('Checking if value was empty on row:'+rowIndex);}}else{keepLooking=false;}}for(var i=1;i<l;i++){if(parsers[i].is(nodeValue,table,node)){return parsers[i];}}return parsers[0];}function getNodeFromRowAndCellIndex(rows,rowIndex,cellIndex){return rows[rowIndex].cells[cellIndex];}function trimAndGetNodeText(config,node){return $.trim(getElementText(config,node));}function getParserById(name){var l=parsers.length;for(var i=0;i<l;i++){if(parsers[i].id.toLowerCase()==name.toLowerCase()){return parsers[i];}}return false;}function buildCache(table){if(table.config.debug){var cacheTime=new Date();}var totalRows=(table.tBodies[0]&&table.tBodies[0].rows.length)||0,totalCells=(table.tBodies[0].rows[0]&&table.tBodies[0].rows[0].cells.length)||0,parsers=table.config.parsers,cache={row:[],normalized:[]};for(var i=0;i<totalRows;++i){var c=$(table.tBodies[0].rows[i]),cols=[];if(c.hasClass(table.config.cssChildRow)){cache.row[cache.row.length-1]=cache.row[cache.row.length-1].add(c);continue;}cache.row.push(c);for(var j=0;j<totalCells;++j){cols.push(parsers[j].format(getElementText(table.config,c[0].cells[j]),table,c[0].cells[j]));}cols.push(cache.normalized.length);cache.normalized.push(cols);cols=null;};if(table.config.debug){benchmark("Building cache for "+totalRows+" rows:",cacheTime);}return cache;};function getElementText(config,node){var text="";if(!node)return"";if(!config.supportsTextContent)config.supportsTextContent=node.textContent||false;if(config.textExtraction=="simple"){if(config.supportsTextContent){text=node.textContent;}else{if(node.childNodes[0]&&node.childNodes[0].hasChildNodes()){text=node.childNodes[0].innerHTML;}else{text=node.innerHTML;}}}else{if(typeof(config.textExtraction)=="function"){text=config.textExtraction(node);}else{text=$(node).text();}}return text;}function appendToTable(table,cache){if(table.config.debug){var appendTime=new Date()}var c=cache,r=c.row,n=c.normalized,totalRows=n.length,checkCell=(n[0].length-1),tableBody=$(table.tBodies[0]),rows=[];for(var i=0;i<totalRows;i++){var pos=n[i][checkCell];rows.push(r[pos]);if(!table.config.appender){var l=r[pos].length;for(var j=0;j<l;j++){tableBody[0].appendChild(r[pos][j]);}}}if(table.config.appender){table.config.appender(table,rows);}rows=null;if(table.config.debug){benchmark("Rebuilt table:",appendTime);}applyWidget(table);setTimeout(function(){$(table).trigger("sortEnd");},0);};function buildHeaders(table){if(table.config.debug){var time=new Date();}var meta=($.metadata)?true:false;var header_index=computeTableHeaderCellIndexes(table);$tableHeaders=$(table.config.selectorHeaders,table).each(function(index){this.column=header_index[this.parentNode.rowIndex+"-"+this.cellIndex];this.order=formatSortingOrder(table.config.sortInitialOrder);this.count=this.order;if(checkHeaderMetadata(this)||checkHeaderOptions(table,index))this.sortDisabled=true;if(checkHeaderOptionsSortingLocked(table,index))this.order=this.lockedOrder=checkHeaderOptionsSortingLocked(table,index);if(!this.sortDisabled){var $th=$(this).addClass(table.config.cssHeader);if(table.config.onRenderHeader)table.config.onRenderHeader.apply($th);}table.config.headerList[index]=this;});if(table.config.debug){benchmark("Built headers:",time);log($tableHeaders);}return $tableHeaders;};function computeTableHeaderCellIndexes(t){var matrix=[];var lookup={};var thead=t.getElementsByTagName('THEAD')[0];var trs=thead.getElementsByTagName('TR');for(var i=0;i<trs.length;i++){var cells=trs[i].cells;for(var j=0;j<cells.length;j++){var c=cells[j];var rowIndex=c.parentNode.rowIndex;var cellId=rowIndex+"-"+c.cellIndex;var rowSpan=c.rowSpan||1;var colSpan=c.colSpan||1
			var firstAvailCol; if (typeof (matrix[rowIndex]) == "undefined") { matrix[rowIndex] = []; } for (var k = 0; k < matrix[rowIndex].length + 1; k++) { if (typeof (matrix[rowIndex][k]) == "undefined") { firstAvailCol = k; break; } } lookup[cellId] = firstAvailCol; for (var k = rowIndex; k < rowIndex + rowSpan; k++) { if (typeof (matrix[k]) == "undefined") { matrix[k] = []; } var matrixrow = matrix[k]; for (var l = firstAvailCol; l < firstAvailCol + colSpan; l++) { matrixrow[l] = "x"; } } 
		} 
	} return lookup;
} function checkCellColSpan(table, rows, row) { var arr = [], r = table.tHead.rows, c = r[row].cells; for (var i = 0; i < c.length; i++) { var cell = c[i]; if (cell.colSpan > 1) { arr = arr.concat(checkCellColSpan(table, headerArr, row++)); } else { if (table.tHead.length == 1 || (cell.rowSpan > 1 || !r[row + 1])) { arr.push(cell); } } } return arr; }; function checkHeaderMetadata(cell) { if (($.metadata) && ($(cell).metadata().sorter === false)) { return true; }; return false; } function checkHeaderOptions(table, i) { if ((table.config.headers[i]) && (table.config.headers[i].sorter === false)) { return true; }; return false; } function checkHeaderOptionsSortingLocked(table, i) { if ((table.config.headers[i]) && (table.config.headers[i].lockedOrder)) return table.config.headers[i].lockedOrder; return false; } function applyWidget(table) { var c = table.config.widgets; var l = c.length; for (var i = 0; i < l; i++) { getWidgetById(c[i]).format(table); } } function getWidgetById(name) { var l = widgets.length; for (var i = 0; i < l; i++) { if (widgets[i].id.toLowerCase() == name.toLowerCase()) { return widgets[i]; } } }; function formatSortingOrder(v) { if (typeof (v) != "Number") { return (v.toLowerCase() == "desc") ? 1 : 0; } else { return (v == 1) ? 1 : 0; } } function isValueInArray(v, a) { var l = a.length; for (var i = 0; i < l; i++) { if (a[i][0] == v) { return true; } } return false; } function setHeadersCss(table, $headers, list, css) { $headers.removeClass(css[0]).removeClass(css[1]); var h = []; $headers.each(function (offset) { if (!this.sortDisabled) { h[this.column] = $(this); } }); var l = list.length; for (var i = 0; i < l; i++) { h[list[i][0]].addClass(css[list[i][1]]); } } function fixColumnWidth(table, $headers) { var c = table.config; if (c.widthFixed) { var colgroup = $('<colgroup>'); $("tr:first td", table.tBodies[0]).each(function () { colgroup.append($('<col>').css('width', $(this).width())); }); $(table).prepend(colgroup); }; } function updateHeaderSortCount(table, sortList) { var c = table.config, l = sortList.length; for (var i = 0; i < l; i++) { var s = sortList[i], o = c.headerList[s[0]]; o.count = s[1]; o.count++; } } function multisort(table, sortList, cache) { if (table.config.debug) { var sortTime = new Date(); } var dynamicExp = "var sortWrapper = function(a,b) {", l = sortList.length; for (var i = 0; i < l; i++) { var c = sortList[i][0]; var order = sortList[i][1]; var s = (table.config.parsers[c].type == "text") ? ((order == 0) ? makeSortFunction("text", "asc", c) : makeSortFunction("text", "desc", c)) : ((order == 0) ? makeSortFunction("numeric", "asc", c) : makeSortFunction("numeric", "desc", c)); var e = "e" + i; dynamicExp += "var " + e + " = " + s; dynamicExp += "if(" + e + ") { return " + e + "; } "; dynamicExp += "else { "; } var orgOrderCol = cache.normalized[0].length - 1; dynamicExp += "return a[" + orgOrderCol + "]-b[" + orgOrderCol + "];"; for (var i = 0; i < l; i++) { dynamicExp += "}; "; } dynamicExp += "return 0; "; dynamicExp += "}; "; if (table.config.debug) { benchmark("Evaling expression:" + dynamicExp, new Date()); } eval(dynamicExp); cache.normalized.sort(sortWrapper); if (table.config.debug) { benchmark("Sorting on " + sortList.toString() + " and dir " + order + " time:", sortTime); } return cache; }; function makeSortFunction(type, direction, index) { var a = "a[" + index + "]", b = "b[" + index + "]"; if (type == 'text' && direction == 'asc') { return "(" + a + " == " + b + " ? 0 : (" + a + " === null ? Number.POSITIVE_INFINITY : (" + b + " === null ? Number.NEGATIVE_INFINITY : (" + a + " < " + b + ") ? -1 : 1 )));"; } else if (type == 'text' && direction == 'desc') { return "(" + a + " == " + b + " ? 0 : (" + a + " === null ? Number.POSITIVE_INFINITY : (" + b + " === null ? Number.NEGATIVE_INFINITY : (" + b + " < " + a + ") ? -1 : 1 )));"; } else if (type == 'numeric' && direction == 'asc') { return "(" + a + " === null && " + b + " === null) ? 0 :(" + a + " === null ? Number.POSITIVE_INFINITY : (" + b + " === null ? Number.NEGATIVE_INFINITY : " + a + " - " + b + "));"; } else if (type == 'numeric' && direction == 'desc') { return "(" + a + " === null && " + b + " === null) ? 0 :(" + a + " === null ? Number.POSITIVE_INFINITY : (" + b + " === null ? Number.NEGATIVE_INFINITY : " + b + " - " + a + "));"; } }; function makeSortText(i) { return "((a[" + i + "] < b[" + i + "]) ? -1 : ((a[" + i + "] > b[" + i + "]) ? 1 : 0));"; }; function makeSortTextDesc(i) { return "((b[" + i + "] < a[" + i + "]) ? -1 : ((b[" + i + "] > a[" + i + "]) ? 1 : 0));"; }; function makeSortNumeric(i) { return "a[" + i + "]-b[" + i + "];"; }; function makeSortNumericDesc(i) { return "b[" + i + "]-a[" + i + "];"; }; function sortText(a, b) { if (table.config.sortLocaleCompare) return a.localeCompare(b); return ((a < b) ? -1 : ((a > b) ? 1 : 0)); }; function sortTextDesc(a, b) { if (table.config.sortLocaleCompare) return b.localeCompare(a); return ((b < a) ? -1 : ((b > a) ? 1 : 0)); }; function sortNumeric(a, b) { return a - b; }; function sortNumericDesc(a, b) { return b - a; }; function getCachedSortType(parsers, i) { return parsers[i].type; }; this.construct = function (settings) { return this.each(function () { if (!this.tHead || !this.tBodies) return; var $this, $document, $headers, cache, config, shiftDown = 0, sortOrder; this.config = {}; config = $.extend(this.config, $.tablesorter.defaults, settings); $this = $(this); $.data(this, "tablesorter", config); $headers = buildHeaders(this); this.config.parsers = buildParserCache(this, $headers); cache = buildCache(this); var sortCSS = [config.cssDesc, config.cssAsc]; fixColumnWidth(this); $headers.click(function (e) { var totalRows = ($this[0].tBodies[0] && $this[0].tBodies[0].rows.length) || 0; if (!this.sortDisabled && totalRows > 0) { $this.trigger("sortStart"); var $cell = $(this); var i = this.column; this.order = this.count++ % 2; if (this.lockedOrder) this.order = this.lockedOrder; if (!e[config.sortMultiSortKey]) { config.sortList = []; if (config.sortForce != null) { var a = config.sortForce; for (var j = 0; j < a.length; j++) { if (a[j][0] != i) { config.sortList.push(a[j]); } } } config.sortList.push([i, this.order]); } else { if (isValueInArray(i, config.sortList)) { for (var j = 0; j < config.sortList.length; j++) { var s = config.sortList[j], o = config.headerList[s[0]]; if (s[0] == i) { o.count = s[1]; o.count++; s[1] = o.count % 2; } } } else { config.sortList.push([i, this.order]); } }; setTimeout(function () { setHeadersCss($this[0], $headers, config.sortList, sortCSS); appendToTable($this[0], multisort($this[0], config.sortList, cache)); }, 1); return false; } }).mousedown(function () { if (config.cancelSelection) { this.onselectstart = function () { return false }; return false; } }); $this.bind("update", function () { var me = this; setTimeout(function () { me.config.parsers = buildParserCache(me, $headers); cache = buildCache(me); }, 1); }).bind("updateCell", function (e, cell) { var config = this.config; var pos = [(cell.parentNode.rowIndex - 1), cell.cellIndex]; cache.normalized[pos[0]][pos[1]] = config.parsers[pos[1]].format(getElementText(config, cell), cell); }).bind("sorton", function (e, list) { $(this).trigger("sortStart"); config.sortList = list; var sortList = config.sortList; updateHeaderSortCount(this, sortList); setHeadersCss(this, $headers, sortList, sortCSS); appendToTable(this, multisort(this, sortList, cache)); }).bind("appendCache", function () { appendToTable(this, cache); }).bind("applyWidgetId", function (e, id) { getWidgetById(id).format(this); }).bind("applyWidgets", function () { applyWidget(this); }); if ($.metadata && ($(this).metadata() && $(this).metadata().sortlist)) { config.sortList = $(this).metadata().sortlist; } if (config.sortList.length > 0) { $this.trigger("sorton", [config.sortList]); } applyWidget(this); }); }; this.addParser = function (parser) { var l = parsers.length, a = true; for (var i = 0; i < l; i++) { if (parsers[i].id.toLowerCase() == parser.id.toLowerCase()) { a = false; } } if (a) { parsers.push(parser); }; }; this.addWidget = function (widget) { widgets.push(widget); }; this.formatFloat = function (s) { var i = parseFloat(s); return (isNaN(i)) ? 0 : i; }; this.formatInt = function (s) { var i = parseInt(s); return (isNaN(i)) ? 0 : i; }; this.isDigit = function (s, config) { return /^[-+]?\d*$/.test($.trim(s.replace(/[,.']/g, ''))); }; this.clearTableBody = function (table) { if ($.browser.msie) { function empty() { while (this.firstChild) this.removeChild(this.firstChild); } empty.apply(table.tBodies[0]); } else { table.tBodies[0].innerHTML = ""; } };
} 
}); $.fn.extend({ tablesorter: $.tablesorter.construct }); var ts = $.tablesorter; ts.addParser({ id: "text", is: function (s) { return true; }, format: function (s) { return $.trim(s.toLocaleLowerCase()); }, type: "text" }); ts.addParser({ id: "digit", is: function (s, table) { var c = table.config; return $.tablesorter.isDigit(s, c); }, format: function (s) { return $.tablesorter.formatFloat(s); }, type: "numeric" });
ts.addParser({
	id: "currency",
	is: function (s) {
		return /^[$?.]/.test(s);
	},
	format: function (s) {
		s = s.replace('.', '');
		return $.tablesorter.formatFloat(s.replace(new RegExp(/[^0-9.]/g), ""));
	},
	type: "numeric"
});ts.addParser({id:"ipAddress",is:function(s){return/^\d{2,3}[\.]\d{2,3}[\.]\d{2,3}[\.]\d{2,3}$/.test(s);},format:function(s){var a=s.split("."),r="",l=a.length;for(var i=0;i<l;i++){var item=a[i];if(item.length==2){r+="0"+item;}else{r+=item;}}return $.tablesorter.formatFloat(r);},type:"numeric"});ts.addParser({id:"url",is:function(s){return/^(https?|ftp|file):\/\/$/.test(s);},format:function(s){return jQuery.trim(s.replace(new RegExp(/(https?|ftp|file):\/\//),''));},type:"text"});ts.addParser({id:"isoDate",is:function(s){return/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(s);},format:function(s){return $.tablesorter.formatFloat((s!="")?new Date(s.replace(new RegExp(/-/g),"/")).getTime():"0");},type:"numeric"});ts.addParser({id:"percent",is:function(s){return/\%$/.test($.trim(s));},format:function(s){return $.tablesorter.formatFloat(s.replace(new RegExp(/%/g),""));},type:"numeric"});ts.addParser({id:"usLongDate",is:function(s){return s.match(new RegExp(/^[A-Za-z]{3,10}\.? [0-9]{1,2}, ([0-9]{4}|'?[0-9]{2}) (([0-2]?[0-9]:[0-5][0-9])|([0-1]?[0-9]:[0-5][0-9]\s(AM|PM)))$/));},format:function(s){return $.tablesorter.formatFloat(new Date(s).getTime());},type:"numeric"});ts.addParser({id:"shortDate",is:function(s){return/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/.test(s);},format:function(s,table){var c=table.config;s=s.replace(/\-/g,"/");if(c.dateFormat=="us"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,"$3/$1/$2");}else if(c.dateFormat=="uk"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,"$3/$2/$1");}else if(c.dateFormat=="dd/mm/yy"||c.dateFormat=="dd-mm-yy"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})/,"$1/$2/$3");}return $.tablesorter.formatFloat(new Date(s).getTime());},type:"numeric"});ts.addParser({id:"time",is:function(s){return/^(([0-2]?[0-9]:[0-5][0-9])|([0-1]?[0-9]:[0-5][0-9]\s(am|pm)))$/.test(s);},format:function(s){return $.tablesorter.formatFloat(new Date("2000/01/01 "+s).getTime());},type:"numeric"});ts.addParser({id:"metadata",is:function(s){return false;},format:function(s,table,cell){var c=table.config,p=(!c.parserMetadataName)?'sortValue':c.parserMetadataName;return $(cell).metadata()[p];},type:"numeric"});ts.addWidget({id:"zebra",format:function(table){if(table.config.debug){var time=new Date();}var $tr,row=-1,odd;$("tr:visible",table.tBodies[0]).each(function(i){$tr=$(this);if(!$tr.hasClass(table.config.cssChildRow))row++;odd=(row%2==0);$tr.removeClass(table.config.widgetZebra.css[odd?0:1]).addClass(table.config.widgetZebra.css[odd?1:0])});if(table.config.debug){$.tablesorter.benchmark("Applying Zebra widget",time);}}});})(jQuery); 
 
var CustomInfobox = function (map, options) { var _map = map, _content, _anchor, _infoboxContainerId, _handlerId; var _options = { arrowColor: "#fff", arrowLength: 20, arrowWidth: 30, borderColor: "#000", color: "#fff", minHeight: 50, minWidth: 100, offset: { x: 0, y: 0 }, orientation: 0, showArrow: true, showCloseButton: true, tether: false }; function _init() { _infoboxContainerId = map.getRootElement().parentNode.id + "_infobox"; $("body").append("<div id='" + _infoboxContainerId + "' style='position:absolute;z-index:10000;display:none;'></div>"); _enableTethering(_options.tether); _setOptions(options) } function _createArrow(direction) { var html = ["<div id='", _infoboxContainerId, "_arrow' style='position:relative;float:left;width:0;height:0;line-height:0;border-style:solid;"]; var w = _options.arrowWidth * 0.5; switch (direction) { case 0: html.push("border-width:0 ", w, "px ", _options.arrowLength, "px ", w, "px;"); html.push("border-color:transparent transparent ", _options.arrowColor, " transparent;"); break; case 1: html.push("border-width:", w, "px 0 ", w, "px ", _options.arrowLength, "px;"); html.push("border-color:transparent transparent transparent ", _options.arrowColor, ";"); break; case 2: html.push("border-width:", _options.arrowLength, "px ", w, "px 0 ", w, "px;"); html.push("border-color:", _options.arrowColor, " transparent transparent transparent;"); break; case 3: html.push("border-width:", w, "px ", _options.arrowLength, "px ", w, "px 0;"); html.push("border-color:transparent ", _options.arrowColor, " transparent transparent;"); break } html.push("'></div>"); return html.join("") } function _enableTethering(tether) { if (_handlerId != null) { Microsoft.Maps.Events.removeHandler(_handlerId) } if (tether) { _handlerId = Microsoft.Maps.Events.addThrottledHandler(_map, "viewchange", _render, 40) } else { _handlerId = Microsoft.Maps.Events.addHandler(_map, "viewchangestart", _hide) } } function _hide() { _anchor = null; _content = null; _render() } function _render() { var container = $("#" + _infoboxContainerId); if (container != null && _anchor != null && _content != null) { if (!_map.getBounds().contains(_anchor)) { container.css("display", "none") } else { container.css("display", ""); var pinPixel = _map.tryLocationToPixel(_anchor, Microsoft.Maps.PixelReference.control), screenX = _map.getPageX() + pinPixel.x, screenY = _map.getPageY() + pinPixel.y; var key = (_map.getHeight() * 0.5 < pinPixel.y) ? 2 : 0; key += (_map.getWidth() * 0.5 < pinPixel.x) ? 1 : 0; var contents = ["<div id='", _infoboxContainerId, "_content' style='position:relative;float:left;border:1px solid ", _options.borderColor, ";background-color:", _options.color, ";min-width:", _options.minWidth, "px;min-height:", _options.minHeight, "px;'>", _content, "</div>"]; var arrowX = 0, arrowY = 0, html; if (_options.showArrow) { if (_options.orientation) { arrowX = _options.arrowWidth; arrowY = _options.arrowLength; if (key > 1) { html = contents.join("") + _createArrow(2) } else { html = _createArrow(0) + contents.join("") } } else { arrowX = _options.arrowLength; arrowY = _options.arrowWidth; if (key % 2) { html = contents.join("") + _createArrow(1) } else { html = _createArrow(3) + contents.join("") } } } else { html = contents.join("") } container.html(html); var contentContainer = $("#" + _infoboxContainerId + "_content"); if (_options.showCloseButton) { contentContainer.append("<span id='" + _infoboxContainerId + "_closeBtn' href='javascript:void()' style='position:absolute;right:5px;top:2px;cursor:pointer;font:bold 18px Arial;line-height:12px;'>x</span>"); $("#" + _infoboxContainerId + "_closeBtn").click(function () { _hide() }) } var contentX = contentContainer.outerWidth(), contentY = contentContainer.outerHeight(); var w = 0, h = 0, arrowOffsetTop = 0, arrowOffsetLeft = 0; if (_options.orientation) { w = contentX; h = contentY + arrowY; if (key % 2) { arrowOffsetLeft = w - _options.arrowWidth; screenX += _options.offset.x - w + _options.arrowWidth * 0.5 } else { screenX += _options.offset.x - _options.arrowWidth * 0.5 } if (key > 1) { screenY -= h + _options.offset.y } else { screenY -= _options.offset.y } } else { w = arrowX + contentX + 2; h = Math.max(contentY, arrowY); if (key % 2) { screenX += _options.offset.x - w } else { screenX += _options.offset.x } if (key > 1) { arrowOffsetTop = h - _options.arrowWidth; screenY -= h - _options.arrowWidth * 0.5 + _options.offset.y } else { screenY -= (_options.arrowWidth * 0.5 + _options.offset.y) } } if (_options.showArrow) { var arrow = $("#" + _infoboxContainerId + "_arrow"); arrow.css({ "margin-left": Math.ceil(arrowOffsetLeft) + "px", "margin-top": Math.ceil(arrowOffsetTop) + "px" }) } container.css({ width: Math.ceil(w) + "px", height: Math.ceil(h) + "px", top: screenY, left: screenX }) } } else { if (container != null) { container.html(""); container.css("display", "none") } } } function _setOptions(options) { var tetherVal = _options.tether; for (attrname in options) { _options[attrname] = options[attrname] } if (tetherVal != _options.tether) { _enableTethering(_options.tether) } _render() } this.hide = function () { _hide() }; this.show = function (latlong, content) { _anchor = latlong; _content = content; _render() }; this.getOptions = function () { return _options }; this.setOptions = function (options) { _setOptions(options) }; _init() }; 
 


jQuery(document).ready(function () {
    $.facebox.settings.ziBase = 20000;

    jQuery(document).on('click', '.prev', function () {

		var $t = jQuery(this);
		var p = $t.parents('.multi-photo');

		var t = p.find('img.multi-photo');
		var idx = t.data('mp-index') || 0;
		var md = t.data('multi-photos');

		if (md) {
			md = md["multi-photos"];
		}

		idx = (idx - 2) % md.length;

		if (idx < 0) {
			idx = md.length - 1;
		}

		t.attr('src', md[idx].url);
		t.data('mp-index', ++idx);

		p.find('.info').text(idx + ' of ' + md.length);

		return false;

	});

    jQuery(document).on('click', '.next' , function () {
		var $t = jQuery(this);
		var p = $t.parents('.multi-photo');

		var t = p.find('img.multi-photo');
		var idx = t.data('mp-index') || 0;
		var md = t.data('multi-photos');

		if (md) {
			md = md["multi-photos"];
		}

		idx = idx % md.length;

		t.attr('src', md[idx].url);
		t.data('mp-index', ++idx);

		p.find('.info').text(idx + ' of ' + md.length);

		return false;
	});

	jQuery('.link-item').appear(function (targets) {
		targets.not('.loaded');
		targets.addClass('loaded');

		targets.each(function (i, t) {
			var target = jQuery(t);
			var dataUrl = target.attr('data-deferred-load');
			if (dataUrl) {
				target.removeAttr('data-deferred-load');
				target.attr('data-deferred-loaded', dataUrl);

				dataUrl += '&units=' + jQuery('#units').val();

				target.addClass('loading');
				target.append('<div></div>').find('div:last').load(dataUrl, function () {
				    target.removeClass('loading').css('min-width', '0px').css('min-height', '0px');
				    target.find('.header').addClass("loaded");
					var mps = target.find('img.multi-photo');

					if (mps.length) {
						mps.each(function (i, mp) {
							jQuery(mp).data('mp-index', 1);


							var md = jQuery(mp).data('multi-photos');

							if (md && md["multi-photos"].length > 1) {
							    md = md["multi-photos"];
							    jQuery(mp).parent().append('<span class="multi-photo-help"><span class="bg"></span><span class="info">1 of ' + md.length + '</span><span class="nav"><a href="#" class="prev">Previous</a><a href="#" class="next">Next</a></span></span>').addClass('multi-photo');
							}

						});
					}
				});
			}

		});

	});

	var mps = jQuery('img.multi-photo');

	if (mps.length) {
		mps.each(function (i, mp) {
			jQuery(mp).data('mp-index', 1);

			var md = jQuery(mp).data('multi-photos');

			if (md && md["multi-photos"].length > 1) {
			    md = md["multi-photos"];
			    jQuery(mp).parent().append('<span class="multi-photo-help"><span class="bg"></span><span class="info">1 of ' + md.length + '</span><span class="nav"><a href="#" class="prev">Previous</a><a href="#" class="next">Next</a></span></span>').addClass('multi-photo');
			}

		});
	}

	$.force_appear();

	if (document.getElementById('map')) {
		var api_key = window.bingApiKey;
		SDS.Maps.Map.create('map', { key: api_key, clientID: window.googleClientID, channelID: window.googleChannelID });
	}

	jQuery('.data-list').tablesorter({
		cssAsc: 'sort-asc',
		cssDesc: 'sort-desc'
	}).bind("sortEnd", function () {
		jQuery('.reports').hide();
		jQuery('.data-list tbody').hide();
		jQuery('.data-list tbody tr').each(function (i, o) {
			jQuery(o).removeClass('even odd').addClass(i % 2 == 0 ? 'even' : 'odd').find('.data-list-row-number').text(i + 1);
			var id = jQuery(o).data('identifier');

			var listItem = jQuery('.link-item[data-identifier=' + id + ']');
			listItem.find('.map-marker-index').text(i + 1);
			jQuery('.reports').append(listItem);
		});

		SDS.Maps.Map.addPushPins();

		$.force_appear();

		jQuery('.data-list tbody').show();
		jQuery('.reports').show();



	});


});


function handleSwitchDisplayUnits(caller) {
	var value = jQuery(caller).val();

	jQuery('.link-item').each(function (i, o) {
		var $o = jQuery(o);
		$o.removeClass('loaded').attr('data-deferred-load', $o.attr('data-deferred-loaded')).children('div:not(.header)').remove();
	});

	$.force_appear();
};


var pdfStorePath = window.rootUrl + "Temp/Public/PdfStore/";

/**
* the service can return the pdfStorePath if it was passed in
* only prepend pdfStorePath if it does not already exist in the url
* @param {string} url
* @return string url
**/
var formatPdfStorePath = function (url) {
	if (url.indexOf("~/") === 0) {
		return window.rootUrl + url.substring(2);
	}
	else if (url.indexOf('http') === 0) {
		return url;
	}
	else {
		return window.pdfStorePath + url;
	}
}

var PdfPrint = Base.extend({
	entityName: null,
	userData: null,
	formId: null,
	mlsNums: null,
	externalStyles: null,
	includeHeaders: null,
	includeFooters: null,
	mimeType: "application/pdf",
	pdfStorePath: "~/Temp/Public/PdfStore/",
	targetDiv: "PdfDiv",
	targetFrame: "PdfFrame",
	constructor: function () {
	},
	init: function (entityName, userData, formId, mlsNums, type, externalStyles, includeHeader, includeFooter) {
		this.entityName = entityName;
		this.userData = userData;
		this.formId = formId;
		this.mlsNums = mlsNums;
		this.type = type;
		this.externalStyles = externalStyles;
		this.includeHeader = includeHeader;
		this.includeFooter = includeFooter;
	},
	printLinkPage: function (params, show, download) {
		var self = this;

	    showSpinner(jQuery('#MasterDynamicBody'));	    

		var displayUnits = typeof (window.displayUnits) !== 'undefined' ? window.displayUnits : null;
		if (!displayUnits && jQuery('#units').length > 0) {
			displayUnits = jQuery('#units').val();
		}

		var _includeHeader = getEntityKey().appName == 'TREB';
		var _includeFooter = true;

		var renderData = {
			entityKey: getEntityKey(),
			userKey: getUserKey(),
			connectionKey: getConnectionKey(),
			metadata: params.dataMap,
			criteriaName: params.criteriaName,
			formId: params.formId,
			photoGalleryFormID: params.photoGalleryFormID,
			columnSetID: window.columnSetID || 0,
			mlsNums: params.mlsNums,
			externalStyles: "",
			includeHeader: _includeHeader,
			includeFooter: _includeFooter,
			pdfStorePath: this.pdfStorePath,
			displayColumns: params.columns,
			columnNames: params.columnNames,
			orientation: 0,
			sortOrder: params.sortOrder,
			mapPushpinData: params.pushpins,
			mapCenter: params.mapCenter,
			mapZoom: params.mapZoom,
			showListingsOnMap: true,
			forDisplay: download || show,
			forDownload: download || false,
			includeCriteria: params.includeCriteria,
			searchConditions: params.searchConditions,
			mapShapes: params.currentShape ? [params.currentShape] : [],
			mapLocations: params.mapLocations,
			mapPlaces: params.mapPlaces,
			mapView: params.mapView,
			includeMap: params.includeMap,
			keyColumnName: params.keyColumnName,
			displayUnits: displayUnits
		};
		var callback = this.getPdf;
		if (show) {
			callback = this.showPdf;
		}
		if (download) {
			callback = this.download;
		}
		var isChrome = typeof window.chrome != 'undefined';
		//if safari desktop, use a popup
		var usePopup = (navigator.appVersion.indexOf("Mac") != -1 && jQuery.browser.safari && !isChrome);
		//if firefox [19-20], use a popup
		usePopup = usePopup || (jQuery.browser.mozilla && parseInt(jQuery.browser.version, 10) >= 19);

		if ((!show && !download) && usePopup) {
			SDS.Print.PdfPrint2.safariPrintOpen();
		}

		//preview
		if (show && !download) {
			var service = new REModel.Services.PdfService(window.rootUrl + "Pages/Public/Services/Pdf.svc/");
			var printFn = function () {
			    jQuery(document).trigger('close.facebox', 'print-preview-dialog');
			    self.printLinkPage(params, false, false);
			}
			service.getRenderedLinkListingsAsImages(
                renderData,
                params.link,
                function (urls) { callback(urls, printFn); },
                printFailed);
		}
		//print and download
		else {
			var service = new REModel.Services.PdfService(window.rootUrl + "Pages/Public/Services/Pdf.svc/");
			service.getRenderedLinkListings(renderData, params.link, callback, printFailed);
		}

	},

	printPdf: function () {
		var x = jQuery('#' + this.targetFrame);
		if (jQuery.browser.msie) {
			x.get(0).contentWindow.document.getElementById('PdfObj').print();
			return;
		}
		x.get(0).contentWindow.print();
	},
	stateChangeCallback: function () {
		if (!jQuery.browser.msie || document.getElementById('PdfFrame').readyState == 'complete') {
			// Timeout is needed for Firefox to trigger
			setTimeout('printPdf()', 250);
		}
	},
	download: function (url) {
		jQuery('#PdfFrame').remove();
		hideSpinner();
		var downloadPath = window.rootUrl + "Pages/Public/Download.aspx?file=" + window.formatPdfStorePath(url);
		jQuery('#PdfFrame').remove();

		if (url.indexOf('http') == 0) {
			downloadPath = url;
		}

		var buttons = [];
		buttons.push({
			Text: 'Cancel',
			Type: SDS.Controls.MessageBox.ButtonType.Cancel
		});

		var content = [];
		content.push('<div id="DownloadReadyContent">');
		content.push('<p>Your download is ready. Click below to download it.</p>');
		content.push('<div id="DownloadLinkContainer"></div>');
		content.push('</div>');

		downloadReadyBox = new SDS.Controls.MessageBox(content.join(''),
		{
			buttons: buttons,
			title: 'Download Ready',
			id: 'download-ready-dialog'
		}
	);

		downloadReadyBox.show();

		jQuery('#download-ready-dialog').css('top', (jQuery(window).scrollTop() + 10) + 'px');

		//var linkContent = [];

		if (window.currentAppName.toLowerCase() !== 'treb') {
			var buttonElement = '<button class="image-button" onclick="downloadReadyBox.hide(); window.location=\'' + downloadPath + '\';"><span>Download</span></button>';
			//	linkContent.push('<a href="');
			//	linkContent.push(downloadPath);
			//	linkContent.push('" onclick="');
			//	linkContent.push('downloadReadyBox.hide();');
			//	linkContent.push('">Download</a>');

			//var downloadLinkContainer = jQuery('#download-ready-dialog #DownloadLinkContainer');
			//downloadLinkContainer.html(buttonElement);
			jQuery('div.dialog-toolbar', downloadReadyBox.element).prepend(buttonElement);
			//downloadLinkContainer.html(linkContent.join(''));
			//jQuery('#PdfDiv').html('<iframe id="' + 'PdfFrame' + '" type="application/pdf" style="width:1000px;height:500px;position:absolute;left:-9999px;"></iframe>');
			//jQuery('#PdfFrame').attr('src', downloadPath);
			//jQuery('#PdfFrame').attr('data', downloadPath);
		}
	},
	getPdf: function (url) {
		jQuery('#PdfFrame').remove();
		if (handleChromeOrFirefoxOnMac() != null) {
			hideSpinner();
		}
		jQuery('#PdfDiv').html('<iframe id="' + 'PdfFrame' + '" type="application/pdf" style="width:1000px;height:500px;position:absolute;left:-9999px;"></iframe>');
		var hasAcrobat = detectAcrobat();

		if (SDS.Print.PdfPrint2.safariPrintWindow) {
			hideSpinner();
			SDS.Print.PdfPrint2.safariPrintLoad(url.replace("~/", window.rootUrl || "../../"), false);
			return;
		}

		jQuery('#PdfFrame').load(function () {
			if (/Edge\/\d/.test(navigator.userAgent)) {
				jQuery('#PdfDiv').show();
			}
			setTimeout(function () {
				hideSpinner();
				if (/Edge\/\d/.test(navigator.userAgent)) {
					jQuery('#PdfDiv').hide();
				}
				if (!hasAcrobat) {
					jQuery('#PdfFrame').get(0).contentWindow.print();
				}
			}, 250);
		});
		// IE doesn't trigger iFrame's load event, so we have to work around it
		if (jQuery.browser.msie) {
			setTimeout(function () { hideSpinner(); }, 1500);
		}
		// Firefox on Stage is failing to hide the spinner (but OK on RC)
		// For now, manually force it closed
		// todo: Fix the actual cause
		if (jQuery.browser.mozilla && hasAcrobat) {
			setTimeout(function () { hideSpinner(); }, 1500);
		}

		jQuery('#PdfFrame').attr('src', formatPdfStorePath(url));
		jQuery('#PdfFrame').attr('data', formatPdfStorePath(url));
	},
	showPdf: function (urls, printFn) {
		var targetId = "printPreviewDiv";

		var windowWidth = jQuery(window).width();
		var windowHeight = jQuery(window).height();

		var previewBox = new SDS.Controls.PageBox("Print Preview",
			'<div id="' + targetId + '" style="overflow:scroll;width:' + (windowWidth - 80) + 'px;height:' + (windowHeight - 200) + 'px;"><ul style="text-align:center;list-style-type:none;margin-left:0px;padding-left:0px;"></ul></div>', { bodyClass: "", id: "print-preview-dialog" });
		previewBox.show();

		jQuery('#print-preview-dialog .footer #print-preview-print').remove();
		jQuery('#print-preview-dialog .footer').prepend('<a href="javascript:void();" id="print-preview-print" class="facebox-footer-button"><img class="image" style="display:none;" title="print" src="null"/><div class="print-image-div"></div></a>');
		jQuery("#print-preview-dialog #print-preview-print").click(printFn);

		//var dialog = jQuery('#print-preview-dialog');
		//dialog.css('top', (jQuery(window).scrollTop() + 10) + 'px');

		hideSpinner();

		var target = jQuery('#' + targetId + ' > ul');


		for (var i = 0, len = urls.length; i < len; ++i) {
			var url = urls[i];
			target.append('<li><img style="width:' + (windowWidth - 100) + 'px;" src="' + formatPdfStorePath(url) + '"/></li>');
		}
	}

	/*showPdf: function (url) {
	if (handleChromeOrFirefoxOnMac() != null) {
	hideSpinner();
	this.getPdf(url);
	return;
	}
	jQuery('#PdfFrame').remove();
	var pdfStorePath = rootUrl + "Temp/Public/PdfStore/";
	jQuery(".site-actions-print").addClass('disabled');
	jQuery(".site-actions-print a").attr("href", "javascript:noAction();");
	var windowWidth = jQuery(window).width();
	var windowHeight = jQuery(window).height();


	var previewBox = new SDS.Controls.PageBox("Print Preview",
	'<iframe id="' + 'PdfFrame' + '" type="application/pdf" style="width:' + (windowWidth - 50) + 'px;height:' + (windowHeight - 200) + 'px;"></iframe>', { bodyClass: "body-dark", id: "print-preview-dialog" });
	previewBox.show();
	jQuery(document).bind('close.facebox', function () {
	jQuery('#PdfFrame').remove();
	jQuery(".site-actions-print").removeClass("disabled");
	jQuery(".site-actions-print a").attr("href", "javascript:clickPrint();");

	var o = jQuery('#print-preview-dialog_overlay');
	o.addClass('facebox_overlay');
	o.remove();
	});
	// Fix some display errors
	var overlay = jQuery('#print-preview-dialog_overlay');
	overlay.removeClass('facebox_overlay');
	overlay.css('position', 'fixed');
	overlay.css('height', '100%');
	overlay.css('width', '100%');
	overlay.css('left', '0px');
	overlay.css('top', '0px');

	var dialog = jQuery('#print-preview-dialog');
	dialog.css('top', (jQuery(window).scrollTop() + 10) + 'px');

	hideSpinner();
	var options = '#page=1&view=fitH,0';
	options = '#page=1&zoom=80';
	jQuery('#PdfFrame').attr('src', window.pdfStorePath + url + options);
	jQuery('#PdfFrame').attr('data', window.pdfStorePath + url + options);
	hideSpinner();
	}*/
});

function showSpinner(parent) {
	var spinnerText = '<center>Preparing to print or download...</center>';

	if (window.currentAppName.toLowerCase() === 'treb') {
		spinnerText = '<center>Preparing to print...</center>';
	}

	spinner.setText(spinnerText);

	spinner.show();
	// force the spinner to stay on the screen no matter where we scroll
	// Do this after showing the dialog because .show() sets a default position
	var spinnerContainer = jQuery('.spinner-container');
	spinnerContainer.css('position', 'fixed');
	spinnerContainer.css('top', (jQuery(window).scrollTop() + 10) + 'px');
}
function hideSpinner() {
	spinner.hide();
}
function printFailed(data) {
	hideSpinner();
	(new SDS.Controls.PageBox("There was a Problem", '<p>We were unable to render the requested printout. Please submit a bug report and include the following information:<br /><br /><p><textarea style="width:300px;height:200px;">"Failed to render print data: ' + data._message + data._statusCode + data._timedOut + data._stackTrace + '</textarea></p><p>(You can select all text by clicking in the box and press CTRL-A (Windows) or META-A (Mac)</p>', { bodyClass: "body-dark" })).show();
}
function detectAcrobat() {
	var acrobat = new Object();
	acrobat.installed = false;
	if (navigator.plugins && navigator.plugins.length) {
		var hasChromePDF = false;
		for (var x = 0, l = navigator.plugins.length; x < l; ++x) {
			if (navigator.plugins[x].description.indexOf('Adobe Acrobat') != -1 || navigator.plugins[x].description.indexOf('Adobe PDF') != -1 || navigator.plugins[x].name.indexOf('Adobe Acrobat') != -1) {
				acrobat.installed = true;
			}
			if (navigator.plugins[x].name.indexOf('Chrome PDF') != -1) {
				hasChromePDF = true;
			}
		}
		//if chrome and adobe acrobat, chrome uses Chrome Pdf Viewer
		if (hasChromePDF && acrobat.installed) {
			acrobat.installed = false;
		}
	}
	else if (window.ActiveXObject) {
		for (x = 2; x < 10; x++) {
			try {
				oAcro = eval("new ActiveXObject('PDF.PdfCtrl." + x + "');");
				if (oAcro) {
					acrobat.installed = true;
				}
			}
			catch (e) { }
		}

		try {
			oAcro4 = new ActiveXObject('PDF.PdfCtrl.1');
			if (oAcro4) {
				acrobat.installed = true;
			}
		}
		catch (e) { }

		try {
			oAcro7 = new ActiveXObject('AcroPDF.PDF.1'); // Detects 7 and 8
			if (oAcro7) {
				acrobat.installed = true;
			}
		}
		catch (e) { }
	}
	return acrobat.installed;
}
function handleChromeOrFirefoxOnMac() {
	// Detect Firefox and Chrome on Mac
	if (navigator.appVersion.indexOf("Mac") != -1
		&& jQuery.browser.mozilla) {
		return ("<p>Important: Your print or preview will open using your browser's file download feature. Select 'Open with Preview' to view or print it.</p>");
	}
	if (navigator.appVersion.indexOf("Mac") != -1
		&& navigator.userAgent.toLowerCase().indexOf("chrome") > -1) {
		return ("<p>Important: Your print or preview will open using your browser's file download feature. Click on the button at the bottom of the screen to view or print it in Mac Preview.</p>");
	}
	return null;
}
var pdfPrint = new PdfPrint();

var spinner = new SDS.Controls.Spinner({ container: document.body, options: { delay: 0 } });

function getEntityKey() {
	return { entityName: "Listing", appName: window.currentAppName, metadataName: window.currentAppName };
}

function getUserKey() {
	return { appName: window.currentAppName, userID: "_guest" };
}

function getConnectionKey() {
	return { appName: window.currentAppName, connectionName: window.currentAppName, metadataName: window.currentAppName };
}

	function getSelectedKeys() {
		var all_ids = jQuery('.data-list tbody tr').map(function (i, o) { return jQuery(o).data('identifier'); });
		var selected_ids = jQuery('.data-list tbody tr:has(:selected)').map(function (i, o) { return jQuery(o).data('identifier'); });

		if (selected_ids && selected_ids.length) {
			return selected_ids;
		}

		return all_ids;
	}

	function elementInViewport(el) {
		if (!el || !el.getBoundingClientRect) { return false; }
		var r = el.getBoundingClientRect();
		var html = document.documentElement;

		return (r.bottom >= 0 && r.right >= 0 && r.top <= html.clientHeight && r.left <= html.clientWidth);
	}

	function getUniqueLocationsFromPins(pins) {
		var uniquePinLocations = {};
		var il = pins.getLength();

		for (var i = 0; i < il; i++) {
			var location = pins.get(i).getLocation();
			var locationStringIndex = JSON.stringify(location);
			uniquePinLocations[locationStringIndex] = location;
		}

		var points = [];
		for (var stringLocation in uniquePinLocations) {
			points.push(uniquePinLocations[stringLocation]);
		}

		return points;
	}

	function handlePrintClick(mlNum) {
		//use .link-item instead of .data-list because not all links will contain a map and list
		var results = jQuery('.reports .link-item');

		var printListBoxOptions = {
			download: false,
			printPreviewCallback: printPreviewCallback,
			printCallback: printCallback,
			selectedListing: mlNum,
			numListings: results.length,
			hasMap: document.getElementById('map'),
			showHelp: false
		};
		var dialog = new SDS.Controls.PrintLinkBox(printListBoxOptions);
		dialog.showDialog();
	}


	function handleDownloadClick(mlNum) {
		//use .link-item instead of .data-list because not all links will contain a map and list
		var results = jQuery('.reports .link-item');

		var printListBoxOptions = {
			download: true,
			downloadCallback: downloadCallback,
			selectedListing: mlNum,
			numListings: results.length,
			hasMap: document.getElementById('map'),
			showHelp: false
		};
		var dialog = new SDS.Controls.PrintLinkBox(printListBoxOptions);
		dialog.showDialog();
	}


	function getPrintData(data) {
		var listings = null;

		var columnMap = window.columnMap;
		//use .link-item instead of .data-list because not all links will contain a map and list
		var results = jQuery('.reports .link-item');

		if (data.ThisListing) {
			var thisListing = results.filter('[data-identifier=\'' + data.CurMlNum + '\']').get(0);
			listings = [thisListing];
		} else {
			listings = results;
		}

		// workaround for weird boundary condition where if there is exactly 1 listing in the link, 
		// data.ThisListing is set, but data.CurMlNum is not.
		if (results.length == 1 || listings[0] == null) {
			listings = results;
		}

		var metdataMap = window.metadataMap;
		var selectedMlnums = [];
		for (var i = 0; i < listings.length; i++) {
			selectedMlnums.push(jQuery(listings[i]).data('identifier'));
		}

		var columns = [];
		var colItms = [];
		var colIds = [];
		jQuery('.data-list thead th[data-metadata]').each(function (i, o) {
			var metadata = jQuery(o).data('metadata');
			metadata.displayName = jQuery(o).text();
			columns.push(metadata);

			colItms.push({
				name: metadata.name,
				headerText: metadata.displayName,
				width: metadata.width,
				clusterPos: 0,
				clusterLength: 1
			});

			colIds.push(metadata.name);
		});

		var map = SDS.Maps.Map.map;
		var mapCenter = { latitude: 0, longitude: 0 };
		var mapZoom = 0;
		if (map) {
			mapCenter = map.getCenter();
			mapZoom = map.getZoomLevel();
			mapCenter = {
				longitude: mapCenter.lng ? mapCenter.lng() : mapCenter.longitude,
				latitude: mapCenter.lat ? mapCenter.lat() : mapCenter.latitude
			};
			var viewNum = map.initPrint();
			if (typeof(viewNum) == 'undefined') {
				return;
			}
		}

		//make sure mapZoom is inside a valid range
		if (mapZoom < 1) {
			mapZoom = 1;
		}
		else if (mapZoom > 21) {
			mapZoom = 21;
		}

		return {
			listingCols: colIds,
			dataMap: {},
			selectedMlnums: selectedMlnums,
			colNames: colIds,
			colIds: colIds,
			colItms: colItms,
			sortOrder: [],
			mapCenter: mapCenter,
			mapZoom: mapZoom,
			viewNum: viewNum
		};
	}

	function downloadCallback(data) {
		var printData = getPrintData(data);
		if (!printData) {
			return;
		}

		pdfPrint.printLinkPage({
			criteriaName: "",
			mlsNums: printData.selectedMlnums,
			columns: printData.colIds,
			columnNames: printData.colItms,
			sortOrder: [],
			pushpins: [],
			mapCenter: { x: printData.mapCenter.longitude, y: printData.mapCenter.latitude },
			mapZoom: Math.round(printData.mapZoom, 10),
			mapLocations: null,
			mapPlaces: null,
			mapView: printData.viewNum,
			currentShape: null,
			link: window._link,
			includeMap: data.IncludeMap,
			keyColumnName: 'ml_num',
			formId: window.formID,
			photoGalleryFormID: window.photoGalleryFormID
		}, true, true);
	}
	function printPreviewCallback(data) {
		var printData = getPrintData(data);
		if (!printData) {
			return;
		}

		pdfPrint.printLinkPage({
			criteriaName: "",
			mlsNums: printData.selectedMlnums,
			columns: printData.colIds,
			columnNames: printData.colItms,
			sortOrder: [],
			pushpins: [],
			mapCenter: { x: printData.mapCenter.longitude, y: printData.mapCenter.latitude },
			mapZoom: Math.round(printData.mapZoom, 10),
			mapLocations: null,
			mapPlaces: null,
			mapView: printData.viewNum,
			currentShape: null,
			link: window._link,
			includeMap: data.IncludeMap,
			keyColumnName: 'ml_num',
			formId: window.formID,
			photoGalleryFormID: window.photoGalleryFormID
		}, true);
	}
	function printCallback(data) {
		var printData = getPrintData(data);
		if (!printData) {
			return;
		}

		pdfPrint.printLinkPage({
			criteriaName: "",
			mlsNums: printData.selectedMlnums,
			columns: printData.colIds,
			columnNames: printData.colItms,
			sortOrder: [],
			pushpins: [],
			mapCenter: { x: printData.mapCenter.longitude, y: printData.mapCenter.latitude },
			mapZoom: Math.round(printData.mapZoom, 10),
			mapLocations: null,
			mapPlaces: null,
			mapView: printData.viewNum,
			currentShape: null,
			link: window._link,
			includeMap: data.IncludeMap,
			keyColumnName: 'ml_num',
			formId: window.formID,
			photoGalleryFormID: window.photoGalleryFormID
		}, false);
	}


	if (!('SDS' in window)) {
		SDS = {};
	}


	SDS.Page = {};
	SDS.Page.getCurrent = function () { return null; }

	function formatMoney(n, c, d, t) {
		if (n == null || typeof n == "undefined") { return ""; }
		var c = isNaN(c = Math.abs(c)) ? 2 : c, d = d == undefined ? "," : d, t = t == undefined ? "." : t, s = n < 0 ? "-" : "", i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "", j = (j = i.length) > 3 ? j % 3 : 0;
		var val = '$' + s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");

		//issue 18960
		if (val.length > 3 && val.slice(-3) == ".00") {
			val = val.substring(0, val.length - 3);
		}

		return val;
	};

	SDS.Utility.registerNamespace('SDS.Print');

	SDS.Print.PdfPrint2 = Base.extend({}, {
		mimeType: "application/pdf",
		pdfStorePath: "~/Temp/PdfStore/",
		targetDiv: "PdfDiv",
		targetFrame: "PdfFrame",
		targetObj: "PdfObj",
		getHandlersObject: function () {
			return {
				getPdf: SDS.Print.PdfPrint2.getPdf,
				showPdf: SDS.Print.PdfPrint2.showPdf,
				download: SDS.Print.PdfPrint2.download,
				printFailed: SDS.Print.PdfPrint2.printFailed
			};
		},
		getPdfStorePath: function () {
			return SDS.Print.PdfPrint2.pdfStorePath;
		},

		getPdfStorePathAsync: function (success, failure) {
			// allows us to put the path in an app setting rather than hard-coding it here.
			if (success) {
				success.call(this, this.pdfStorePath);
			}
		},

		printPdf: function () {
			var x = jQuery('#' + SDS.Print.PdfPrint2.targetFrame);
			if (jQuery.browser.msie) {
				x.get(0).contentWindow.document.getElementById(SDS.Print.PdfPrint2.targetObj).print();
				return;
			}
			x.get(0).contentWindow.print();
		},
		stateChangeCallback: function () {
			if (!jQuery.browser.msie || document.getElementById(SDS.Print.PdfPrint2.targetFrame).readyState == 'complete') {
				// Timeout is needed for Firefox to trigger
				setTimeout('SDS.Print.PdfPrint2.printPdf()', 250);
			}
		},
		download: function (url) {
			jQuery('#' + SDS.Print.PdfPrint2.targetFrame).remove();
			hideSpinner();
			var pdfStorePath = window.rootUrl + "Temp/PdfStore/";
			var downloadPath = window.rootUrl + "Pages/Public/Download.aspx?file=" + new String(url).replace('~/', window.rootUrl || '../../');
			jQuery('#PdfFrame').remove();

			if (url.indexOf('http') == 0) {
				downloadPath = url;
			}

			var buttons = [];
			buttons.push({
				Text: 'Cancel',
				Type: SDS.Controls.MessageBox.ButtonType.Cancel
			});

			var content = [];
			content.push('<div id="DownloadReadyContent">');
			content.push('<p>Your download is ready. Click below to download it.</p>');
			content.push('<div id="DownloadLinkContainer"></div>');
			content.push('</div>');

			downloadReadyBox = new SDS.Controls.MessageBox(content.join(''),
		{
			buttons: buttons,
			title: 'Download Ready',
			id: 'download-ready-dialog'
		}
	);
			downloadReadyBox.show();

			jQuery('#download-ready-dialog').css('top', (jQuery(window).scrollTop() + 10) + 'px');

			var buttonElement = '<button class="image-button" onclick="downloadReadyBox.hide(); window.location=\'' + downloadPath + '\';"><span>Download</span></button>';
			jQuery('div.dialog-toolbar', downloadReadyBox.element).prepend(buttonElement);


		},
		getPdf: function (url) {
			jQuery('#' + SDS.Print.PdfPrint2.targetFrame).remove();

			if (SDS.Print.PdfPrint2.handleChromeOrFirefoxOnMac() != null) {
				SDS.Print.PdfPrint2.hideSpinner();
			}

			var hasAcrobat = SDS.Print.PdfPrint2.detectAcrobat();
			var isChrome = typeof window.chrome != 'undefined';

			var isMac = navigator.appVersion.indexOf("Mac") != -1;
			var isWin8 = navigator.userAgent.indexOf('Windows NT 6.2') != -1;

			if (SDS.Print.PdfPrint2.safariPrintWindow) {
				SDS.Print.PdfPrint2.hideSpinner();
				SDS.Print.PdfPrint2.safariPrintLoad(url.replace("~/", window.rootUrl || "../../"), false);
				return;
			}

			var pdfFrame = jQuery('<iframe id="' + SDS.Print.PdfPrint2.targetFrame + '" type="application/pdf" style="width:1000px;height:500px;position:absolute;left:-9999px;display:none;"></iframe>')
			.load(function () {
				setTimeout(function () {
					hideSpinner();

					if (macSafari || hasAcrobat || isChrome) { return; }

					jQuery('#' + SDS.Print.PdfPrint2.targetFrame).get(0).contentWindow.print();

				}, 250);
			})
			.appendTo('#' + SDS.Print.PdfPrint2.targetDiv);

			// IE doesn't trigger iFrame's load event, so we have to work around it
			if (jQuery.browser.msie) {
				pdfFrame.contents().ready(function () {
					setTimeout(function () {
						hideSpinner();
					}, 250);
				});
			}


			// Firefox on Stage is failing to hide the spinner (but OK on RC)
			if (jQuery.browser.mozilla && hasAcrobat) {
				setTimeout(function () { hideSpinner(); }, 1500);
			}

			// Win8 without Acrobat Reader opens in TWINUI and load state is never detected
			// and
			// Firefox + Mac opens in preview and load state is never detected		
			if ((isWin8 && !hasAcrobat) || (jQuery.browser.mozilla && isMac)) {
				setTimeout(function () { hideSpinner(); }, 1500);
			}


			//var pdfStorePath = "../../Temp/PdfStore/";

			pdfFrame.attr('src', url.replace("~/", window.rootUrl || "../../"))
			.attr('data', url.replace("~/", window.rootUrl || "../../"))
			.attr('style', 'height:0;width:0;');
		},
		showPdf: function (urls) {
			var targetId = "printPreviewDiv";

			var windowWidth = jQuery(window).width();
			var windowHeight = jQuery(window).height();

			var previewBox = new SDS.Controls.PageBox("Print Preview",
			'<div id="' + targetId + '" style="overflow:scroll;width:' + (windowWidth - 80) + 'px;height:' + (windowHeight - 200) + 'px;"><ul style="text-align:center;list-style-type:none;margin-left:0px;padding-left:0px;"></ul></div>', { bodyClass: "", id: "print-preview-dialog" });
			previewBox.show();

			SDS.Print.PdfPrint2.hideSpinner();

			var pdfStorePath = "../../Temp/pdfStore/";

			var target = jQuery('#' + targetId + ' > ul');

			for (var i = 0, len = urls.length; i < len; ++i) {
				var url = urls[i];
				//add a spinner for the loading of the first image
				if (i == 0) {
					SDS.Print.PdfPrint2.showSpinner(jQuery('.facebox-popup:first', '#print-preview-dialog'), null, "Please Wait . . .");
					var image = jQuery(document.createElement('img'))
					.css({ 'width': (windowWidth - 100) + 'px' })
					.attr('src', url.replace("~/", window.rootUrl || "../../"))
					.load(function () {
						SDS.Print.PdfPrint2.hideSpinner();
					})
					.error(function () {
						SDS.Print.PdfPrint2.hideSpinner();
					});
					target.append('<li>').append(image);
				}
				else {
					target.append('<li><img style="width:' + (windowWidth - 100) + 'px;" src="' + url.replace("~/", window.rootUrl || "../../") + '"/></li>');
				}
			}
		},
		//	showPdf: function (url) {
		//		if (SDS.Print.PdfPrint2.handleChromeOrFirefoxOnMac() != null) {
		//			SDS.Print.PdfPrint2.hideSpinner();
		//			SDS.Print.PdfPrint2.getPdf.call(this, url);
		//			return;
		//		}
		//		jQuery('#' + SDS.Print.PdfPrint2.targetFrame).remove();
		//		var pdfStorePath = rootUrl + "Temp/PdfStore/";
		//		jQuery(".site-actions-print").addClass('disabled');
		//		jQuery(".site-actions-print a").attr("href", "javascript:noAction();");
		//		jQuery(".site-actions-export").addClass("disabled");
		//		var windowWidth = jQuery(window).width();
		//		var windowHeight = jQuery(window).height();

		//		var previewBox = new SDS.Controls.PageBox("Print Preview",
		//				'<iframe id="' + SDS.Print.PdfPrint2.targetFrame + '" type="application/pdf" style="width:' + (windowWidth - 50) + 'px;height:' + (windowHeight - 200) + 'px;"></iframe>', { bodyClass: "body-dark", id: "print-preview-dialog" });
		//		previewBox.show();
		//		jQuery(document).bind('close.facebox', function () {
		//			jQuery('#' + SDS.Print.PdfPrint2.targetFrame).remove();
		//			jQuery(".site-actions-print").removeClass("disabled");
		//			jQuery(".site-actions-print a").attr("href", "javascript:clickPrint();");
		//			jQuery(".site-actions-export").removeClass("disabled");

		//		});
		//		SDS.Print.PdfPrint2.hideSpinner();
		//		var pdfStorePath = "../../Temp/PdfStore/";
		//		var options = '#page=1&view=fitH,0';
		//		options = '#page=1&zoom=80';
		//		jQuery('#' + SDS.Print.PdfPrint2.targetFrame).attr('src', pdfStorePath + url + options);
		//		jQuery('#' + SDS.Print.PdfPrint2.targetFrame).attr('data', pdfStorePath + url + options);
		//		SDS.Print.PdfPrint2.hideSpinner();
		//	},
		printFailed: function (data) {
			var message = "";
			if (typeof (data) == 'object') {
				for (var prop in data) {
					if (data.hasOwnProperty(prop)) {
						messsage += '\n' + data[prop];
					}
				}
			}
			else {
				message = data;
			}

			SDS.Print.PdfPrint2.hideSpinner();
			(new SDS.Controls.PageBox("There was a Problem", '<p>We were unable to render the requested printout. Please submit a bug report and include the following information:<br /><br /><p><textarea style="width:300px;height:200px;">"Failed to render print data: ' + message + '</textarea></p><p>(You can select all text by clicking in the box and press CTRL-A (Windows) or META-A (Mac)</p>', { bodyClass: "body-dark" })).show();
		},
		// Spinner Control
		showSpinner: function (parent, show, labelContent) {
			
			var actionText = 'print';
			if (show === 'Download') {
				actionText = 'Download';
			}
			SDS.Print.PdfPrint2.spinner = new SDS.Controls.Spinner({ container: parent.get(0), text: typeof (labelContent) != 'undefined' ? labelContent : 'Preparing to ' + actionText + '...' });
			var spinnerContainer = jQuery('.spinner-container');
			spinnerContainer.css('top', '10px');
			spinnerContainer.css('color', 'Black');
			SDS.Print.PdfPrint2.spinner.show();
			var spinnerLabel = jQuery('.spinner-label');
			spinnerLabel.css('color', 'Black');
		},
		hideSpinner: function () {
			jQuery('.spinner-container').css('display', 'none');
			if (SDS.Print.PdfPrint2.spinner != null) {
				SDS.Print.PdfPrint2.spinner.hide();
				SDS.Print.PdfPrint2.spinner = null;
			}
		},
		// Environment Detection
		detectAcrobat: function () {
			var acrobat = new Object();
			acrobat.installed = false;
			if (navigator.plugins && navigator.plugins.length) {
				var hasChromePDF = false;
				for (var x = 0, l = navigator.plugins.length; x < l; ++x) {
					if (navigator.plugins[x].description.indexOf('Adobe Acrobat') != -1 || navigator.plugins[x].description.indexOf('Adobe PDF') != -1 || navigator.plugins[x].name.indexOf('Adobe Acrobat') != -1) {
						acrobat.installed = true;
					}
					if (navigator.plugins[x].name.indexOf('Chrome PDF') != -1) {
						hasChromePDF = true;
					}
				}
				//if chrome and adobe acrobat, chrome uses Chrome Pdf Viewer
				if (hasChromePDF && acrobat.installed) {
					acrobat.installed = false;
				}
			}
			else if (window.ActiveXObject) {
				for (x = 2; x < 10; x++) {
					try {
						oAcro = eval("new ActiveXObject('PDF.PdfCtrl." + x + "');");
						if (oAcro) {
							acrobat.installed = true;
						}
					}
					catch (e) { }
				}

				try {
					oAcro4 = new ActiveXObject('PDF.PdfCtrl.1');
					if (oAcro4) {
						acrobat.installed = true;
					}
				}
				catch (e) { }

				try {
					oAcro7 = new ActiveXObject('AcroPDF.PDF.1'); // Detects 7 and 8
					if (oAcro7) {
						acrobat.installed = true;
					}
				}
				catch (e) { }
			}
			return acrobat.installed;
		},
		handleChromeOrFirefoxOnMac: function () {
			// Detect Firefox and Chrome on Mac
			if (navigator.appVersion.indexOf("Mac") != -1
			&& jQuery.browser.mozilla) {
				return ("<p>Important: Your print or preview will open using your browser's file download feature. Select 'Open with Preview' to view or print it.</p>");
			}
			if (navigator.appVersion.indexOf("Mac") != -1
			&& navigator.userAgent.toLowerCase().indexOf("chrome") > -1) {
				return ("<p>Important: Your print or preview will open using your browser's file download feature. Click on the button at the bottom of the screen to view or print it in Mac Preview.</p>");
			}
			return null;
		},
		addGlobalParams: function (params, show) {
			// todo: These params should be set by the caller, not PdfPrint
			var context = new SDS.Dynamic.Context(SDS.Page.ClientContext.items.dynamicContext);
			var criteriaName = context.store.criteria.name;
			var keyFactory = new SDS.KeyFactory(window.currentAppName);

			var keyColumnName = window.storage.getFromEntityKey(getEntityKey()).get('keyPropertyName');
			params.entityKey = params.entityKey || keyFactory.createEntityKey(context.get('entityName'), context.get('metadataName'));
			params.userKey = params.userKey || getUserKey();
			params.connectionKey = params.connectionKey || getConnectionKey();
			params.pdfStorePath = SDS.Print.PdfPrint2.pdfStorePath;
			params.forDisplay = (show == true && show !== 'Download' ? true : false);
			params.keyColumnName = params.keyColumnName || keyColumnName;
		},
		callPrint: function (params, show, serviceMethod, parent) {
			var spinnerParent = jQuery('#MasterDynamicBody');

			if (parent) {
				spinnerParent = parent;
			}

			SDS.Print.PdfPrint2.showSpinner(spinnerParent, show);

			//if safari desktop, use a popup
			var isChrome = typeof window.chrome != 'undefined';
			var usePopup = (navigator.appVersion.indexOf("Mac") != -1 && jQuery.browser.safari && !isChrome);
			//if firefox [19-20], use a popup
			usePopup = usePopup || (jQuery.browser.mozilla && parseInt(jQuery.browser.version, 10) >= 19);

			if (!show && usePopup) {
				SDS.Print.PdfPrint2.safariPrintOpen();
			}

			SDS.Print.PdfPrint2.addGlobalParams(params, show);
			var handlers = SDS.Print.PdfPrint2.getHandlersObject();
			var printObject = SDS.Print.PrintFactory.getPrintObject(params, serviceMethod, show, handlers);
			printObject.print();
		},
		// Individual handlers for different types of printout
		printForm: function (params, show) {
			SDS.Print.PdfPrint2.callPrint(params, show, 'SDS.Pdf.PdfService.getRenderedForm' + (show && show !== 'Download' ? 'AsImages' : ''));
		},
		printList: function (params, show) {
			SDS.Print.PdfPrint2.callPrint(params, show, 'SDS.Pdf.PdfService.getRenderedList' + (show && show !== 'Download' ? 'AsImages' : ''));
		},
		printPhotos: function (params, show) {
			SDS.Print.PdfPrint2.callPrint(params, show, 'SDS.Pdf.PdfService.getRenderedPhotos' + (show && show !== 'Download' ? 'AsImages' : ''), jQuery('#PhotosContainer'));
		},
		printMapList: function (params, show) {
			SDS.Print.PdfPrint2.callPrint(params, show, 'SDS.Pdf.PdfService.getRenderedMapList' + (show && show !== 'Download' ? 'AsImages' : ''));
		},
		printLinkPage: function (params, show) {
			SDS.Print.PdfPrint2.callPrint(params, show, 'SDS.Pdf.PdfService.getRenderedLinkListings' + (show && show !== 'Download' ? 'AsImages' : ''));
		},
		printDirections: function (params, show) {
			SDS.Print.PdfPrint2.callPrint(params, show, 'SDS.Pdf.PdfService.getRenderedDrivingDirections' + (show && show !== 'Download' ? 'AsImages' : ''), jQuery('#directions-dialog'));
		},
		printStatistics: function (params, show) {
			SDS.Print.PdfPrint2.callPrint(params, show, 'SDS.Pdf.PdfService.getRenderedHtml' + (show && show !== 'Download' ? 'AsImages' : ''), jQuery('#StatisticsContainer'));
		},

		/**
		* Open a window (prior to XHR requests) for Safari PDF viewing
		* @note  Safari popup blocker kills window.open requests that are after or a result of 
		* @method
		**/
		safariPrintOpen: function () {
			var host = window.location.href.split('/');
			host.pop();
			host = host.join('/');

			var printContent = [
			'<html>',
			'<head>',
			'<title>Please Wait</title>',
			'<link id="ctl00_ctl00_ThemeStylesheet" rel="stylesheet" type="text/css" href="', host, window.rootUrl + 'Styles/Themes/Default/Theme.min.css">',
			'<link id="ctl00_ctl00_ThemeStylesheet" rel="stylesheet" type="text/css" href="', host, window.rootUrl + 'Pages/Dynamic/Results.css">',
			'</head>',
			'<body>',
			'<div class="spinner-container" style="padding-top: 50px; margin: 50px auto; text-align:center;font-size:11px;font-family: Lucida Sans,Lucida Sans Unicode,Lucida Grande,Geneva,Arial,Sans-Serif;">',
			'<div class="spinner-label" style="color: black; "><span>Preparing to print...</span></div>',
			'<img width="32" height="32" src="' + window.rootUrl + 'Images/SpinnerWhite.gif"></div>',
		'</body><html>'];

			try {
				if (SDS.Print.PdfPrint2.safariPrintWindow && (!SDS.Print.PdfPrint2.safariPrintWindow.closed || SDS.Print.PdfPrint2.safariPrintWindow.document)) {
					SDS.Print.PdfPrint2.safariPrintWindow.close();
				}
			}
			catch (e) { }

			//center the window if possible
			var width = 1024;
			var height = 768;
			if (window.outerWidth < width) {
				window.height = 800;
				window.width = 600;
			}
			//ensure in bounds of the screen
			if (screen.width < width) {
				width = screen.width - 20;
				height = screen.height - 20;
			}

			var left = window.outerWidth > width ? window.screenX + ((window.outerWidth - width) / 2) : window.screenX;
			var top = window.outerHeight > height ? window.screenY + ((window.outerHeight - height) / 2) : window.screenY;

			SDS.Print.PdfPrint2.safariPrintWindow = window.open('about:blank', 'safariPrintWindow', 'left=' + left + ',top=' + top + ',width=' + width + ',height=' + height + ',toolbar=1,scrollbars=1,status=0,resizable=1');
			if (SDS.Print.PdfPrint2.safariPrintWindow) {
				SDS.Print.PdfPrint2.safariPrintWindow.document.open();
				SDS.Print.PdfPrint2.safariPrintWindow.document.write(printContent.join(''));
			}

		},

		safariPrintLoad: function (url, viewOnly) {
			//note:  this condition should not exist if safariPrintOpen is called prior
			if (!SDS.Print.PdfPrint2.safariPrintWindow) {
				SDS.Print.PdfPrint2.safariPrintWindow = window.open(url, 'safariPrintWindow', 'left=0,left=0,width=640,height=480,toolbar=1,scrollbars=1,status=0,resizable=1');
			}
			else {
				SDS.Print.PdfPrint2.safariPrintWindow.location.href = url;
			}

			if (viewOnly || SDS.Print.PdfPrint2.detectAcrobat()) {
				return;
			}
						
			//poll the new window until readyState is complete		
			var readyStateTimer = setInterval(function () {
				var doc = SDS.Print.PdfPrint2.safariPrintWindow.document;
				var href = doc.location.href;
				if (href.indexOf('.html') != -1) {
					return;
				}

				if (doc && /loaded|complete/.test(doc.readyState)) {
					SDS.Print.PdfPrint2.safariPrintWindow.print(); // call the onload handler
					clearInterval(readyStateTimer);
				}
			}, 1750);
		}
	}); 
 

if (!('SDS' in window)) {
	SDS = {};
}

if (!('Maps' in SDS)) {
	SDS.Maps = {};
}

SDS.Maps.Map = {
	create: function (element, options) {
		options = options || {};
		options.key = options.key || '';
		var self = this;

		if (typeof element == 'string') {
			element = document.getElementById(element);
		}

		var self = this;

		if (!this.map) {
			self.mapContainer = element;
			self._initialZoom = options.clientID ? 17 : 15;
			self.map = SDS.SDSMap({
				container: self.mapContainer,
				modulePath: 'Links/',
				type: options.clientID ? 'google' : 'bing',
				key: options.key,
				clientID: options.clientID,
				channelID: options.channelID,
				location: { latitude: 0, longitude: 0 },
				zoom: self._initialZoom,
				features: {
					drawing: false,
					logUsage: true,
					directions: false,
					clusters: currentAppName == 'TREB',
					mapArt: currentAppName == 'TREB',
					defaultUnits: currentAppName == 'TREB' ? 'km' : 'mi'
				},
				initialType: currentAppName == 'TREB' ? 'road' : null,
				loadHandler: function () {
					self.addPushPins(self.map);
				},

				showLegendHandler: jQuery.proxy(self.showLegend, self),
				zoomForSingleListing: function () {
					return self._initialZoom;
				}
			});
		}
	},

	addPushPins: function (map) {
		map = map || this.map;
		var self = this;

		map.clearPushpins();

		var el = jQuery('.data-list tbody tr');
		var count = el.length;
		var pins = [];
		var locations = [];

		el.each(function (i, o) {
			var $o = jQuery(o);
			var lt = $o.data('lt');
			var ln = $o.data('ln');
			var lsc = $o.data('map-class');

			var pinObject = {
				Name: '',
				Latitude: lt,
				Longitude: ln,
				lsc: lsc,
				$o: $o,
				index: (i + 1),
				identifier: $o.data('identifier')
			};

			//only map listings that have coordinates
			if (!(lt && ln)) {
				return true;
			}

			map.addPushpin({
				location: [lt, ln],
				data: pinObject,
				cssClass: 'map-pushpin ' + self.getPushpinClass(pinObject[_mapIcons.propertyName]),
				label: (i + 1).toString(),
				mouseover: function (ev) {
					var pushpin = ev.target || ev;
					pushpin.mouseovercancel = false;
					RenderMapInfoboxStaticContent(self.map, pushpin, self.getInfoboxContent(pushpin));
				},
				mouseout: function (ev) {
					var pushpin = ev.target || ev;
					pushpin.mouseovercancel = true;
					//HideMapInfobox(self.map, pushpin);
				},
				click: function (ev) {
					var pushpin = ev.target || ev;
					if (!self.map.infoboxVisible) {
						pushpin.mouseovercancel = false;
						RenderMapInfoboxStaticContent(self.map, pushpin, self.getInfoboxContent(pushpin));
					}
					else {
						pushpin.mouseovercancel = true;
						HideMapInfobox(self.map, pushpin);
					}
				}
			});
		});

		this.map.setBoundsFromPushpins();
	},

	getInfoboxContent: function (pin) {
		var config = SDS.Web.Pages.Public.Link.Config.get(getEntityKey().appName);
		if (!pin.data && pin.getMarkers) {
			var markers = pin.getMarkers();
			pin.data = [];
			for (var i = 0; i < markers.length; i++) {
				pin.data.push(markers[i].data[0]);
			}
		}
		if (pin.data.length > 1) {
			pin.data.sort(function (pin1, pin2) {
				return pin1.index - pin2.index;
			});
			pin.getPushpinClass = this.getPushpinClass;
			return config.getPopupForms(pin);
		}
		else {
			var $r = pin.data[0].$o;
			var data = $r.data('pop-up');
			data.index = pin.data[0].index;
			data.pinCssClass = this.getPushpinClass(data[_mapIcons.propertyName]);
			var id = $r.data('identifier') + '';
			return config.getPopupForm(id, data);
		}
	},

	getPushpinClass: function (keyPropertyValue) {
		keyPropertyValue = (keyPropertyValue || '').toLowerCase();
		keyPropertyValue = keyPropertyValue.replace('status-', '');
		if (!window._mapIcons.mapIconUrls.classDictionary) {
			window._mapIcons.mapIconUrls.classDictionary = {};
			var key;
			for (var i = 0; i < window._mapIcons.mapIconUrls.length; i++) {
				var key = jQuery.trim(window._mapIcons.mapIconUrls[i].value);
				if (key != null && key != "") {
					//console.log2(window._mapIcons)
					window._mapIcons.mapIconUrls.classDictionary[key] = window._mapIcons.mapIconUrls[i].urlName.toLowerCase();
				}
			}
		}

		var mapIconClass = window._mapIcons.mapIconUrls.classDictionary[keyPropertyValue];
		return (mapIconClass ? 'map-pushpin-' + mapIconClass : '');
	},

	showLegend: function () {
		var content = [
			'<div id="LegendForm"><table><tbody>'
		];

		legendIcons = [];
		jQuery(window._mapIcons.mapIconUrls).each(function () {
			array = jQuery.grep(legendIcons, function (m) {
				return m.url == this.url && m.visibleName == this.visibleName;
			}.bind(this));

			if (array.length == 0) {
				content.push('<tr><td style="padding-top:2px; padding-bottom:2px;"><img src="' + this.url.replace('~/', rootUrl) + '"></td><td style="text-align:left; padding-left:8px;">' + this.visibleName + '</td></tr>');
				legendIcons.push(this);
			}
		});

		content.push('</tbody></table></div>');
		content = content.join('');

		var msgBox = new SDS.Controls.MessageBox(
			content,
			{
				id: 'map-legend-dialog',
				buttons: [
					{
						Text: 'Close',
						Type: SDS.Controls.MessageBox.ButtonType.OK
					}
				],
				title: 'Map Legend'
			}
		);
		msgBox.show();
	}
}; 
 
var HelpUtility = {
	getCurrentVirtualPageID: function () {
		var page = (SDS.Page.getCurrent() || {});
		var name = page.name;
		return name;
	},
	getCurrentTabID: function () {
		var currentTabLinks = jQuery('.master-section-tabs li.ui-tabs-selected > a');
		if (currentTabLinks && currentTabLinks.length > 0) {
			var currentTabLink = currentTabLinks[0];
			if (currentTabLink.hash) { return currentTabLink.hash.substr(1); }
		}
		return null;
	},
	getCurrentDialogIDs: function () {
		var currentDialogs = [];

		jQuery(".facebox").each(function () {
			var dialog = jQuery(this);
			if (dialog.css("display") == 'block') {
				currentDialogs.push({ id: dialog.attr('id'), zIndex: (dialog.css('z-index') || 0) });
			}
		});

		currentDialogs.sort(function (a, b) { return b - a; });

		return jQuery.map(currentDialogs, function (o) { return o.id; });
	},
	getDynamicPanelIsOpen: function () {
		if (jQuery('.master-dynamic-panel').is(':visible')) {
			return true;
		}
		else {
			return false;
		}
	},
	getHelpID: function () {
		var helpID = '';
		helpID += window.helpIDPage;

		var virtualPageID = HelpUtility.getCurrentVirtualPageID();
		var tabID = HelpUtility.getCurrentTabID();
		var dialogIDs = HelpUtility.getCurrentDialogIDs();
		var dynamicPanel = HelpUtility.getDynamicPanelIsOpen();

		if (virtualPageID) {
			helpID += '/';
			helpID += virtualPageID;
		}
		else if (tabID) {
			helpID += '/';
			helpID += tabID;
		}

		if (dialogIDs && dialogIDs.length > 0) {
			helpID += '/';
			helpID += dialogIDs.join('/');
		}

		if (dynamicPanel) {
			helpID += '/';
			helpID += 'dp';
		}

		if (window.helpIDSuffix) {
			helpID += '/';
			helpID += window.helpIDSuffix;
		}

		if (helpID == 'Pages/Dynamic/Results.aspx/List') {
			var search = SDS.Page.ClientContext.items.dynamicContext.criteria;
			if (search.searchRef == 'EntityListSearch') {
				helpID += '/';
				helpID += search.name.replace(/ /g, '-');
			}
		}
		helpID = helpID.replace(/\//g, '%2f');
		return helpID;
	},
	getOpenOptions: function () {
		var width = 774;
		var height = 630;

		var left = screen.width - width;
		var top = screen.height / 2 - height / 2;

		var options = "location=no";
		options += ",toolbar=no";
		options += ",menubar=no";
		options += ",status=yes";
		options += ",scrollbars=yes";
		options += ",resizable=yes";
		options += ",width=" + width;
		options += ",height=" + height;
		options += ",left=" + left;
		options += ",screenX=" + left;
		options += ",top=" + top;
		options += ",screenY=" + top;

		return options;
	},
	showHelp: function (helpId, entityName, path) {
		helpId = HelpUtility.getHelpID();

		var evt = window.event; // Only works in IE
		if (evt && evt.altKey) {
			alert(helpId);
			return false;
		}

		var options = HelpUtility.getOpenOptions();

		// At this point we should make a service call to get the window dimensions then call finishShowHelp on success of that.
		// todo: Implement the behavior described above.
		HelpUtility.finishShowHelp(helpId, options, entityName, path);
	},
	finishShowHelp: function (helpId, options, entityName, path) {
		if (!entityName || entityName === 'undefined' || entityName === '') {
			var entityName = 'Listing';
		}

		var url = 'Help.aspx?EntityName=' + entityName + '&HelpID=' + helpId;
		if (path) {
			url += '&HelpPath=' + path;
		}

		window.open(url, 'StratusMLSHelp', options);
	}
};


 
 

if (typeof (SDS) === 'undefined') { var SDS = {}; }
if (typeof SDS.Web == 'undefined') { SDS.Web = {}; }
if (typeof SDS.Web.Pages == 'undefined') { SDS.Web.Pages = {}; }
if (typeof SDS.Web.Pages.Public == 'undefined') { SDS.Web.Pages.Public = {}; }
if (typeof SDS.Web.Pages.Public.Link == 'undefined') { SDS.Web.Pages.Public.Link = {}; }


SDS.Web.Pages.Public.Link.Config = Base.extend({
	/**
	* @constructor
	* @param {object} init
	**/
	constructor: function (init) {
		this.appName = init.appName;
		this.name = init.name;
	},

	appName: null,
	name: null,

	/**
	* Returns whether or not to display units select
	* 
	* @abstract
	* @return boolean
	**/
	showUnitsSelect: function () {
		throw new Error("Not Implemented");
	}
});

/**
* Registers a customer config object
* @param {Object} customer
**/
SDS.Web.Pages.Public.Link.Config.register = function (customer) {
	if (typeof this._registry == "undefined") { this._registry = {}; }
	this._registry[customer.appName.toUpperCase()] = customer;
};

/**
* Returns a customer config object based on appName
* @param {string} appName
* @return {Object} customer config
**/
SDS.Web.Pages.Public.Link.Config.get = function (appName) {
	if (typeof this._registry == "undefined") { return null; }
	return this._registry[appName.toUpperCase()];
};


SDS.Web.Pages.Public.Link.MLSLIConfig = SDS.Web.Pages.Public.Link.Config.extend({

	/**
	* Calls this.base with appName and name
	* @method
	**/
	constructor: function () {
		this.base({ appName: "MLSLI", name: "Multiple Listing Service of Long Island" });
	},

	/**
	* Returns whether or not to display units select
	* 
	* @return boolean
	**/
	showUnitsSelect: function () {
		return false;
	},

	getPopupForms: function (pin) {
		var listingInfo = [];
		for (var i = 0, l = pin.data.length; i < l; i++) {
			var $r = pin.data[i].$o;
			var data = $r.data('pop-up');
			data.pinCssClass = pin.getPushpinClass(data[_mapIcons.propertyName])
			var id = $r.data('identifier') + '';
			listingInfo.push(this.getPopupForm(id, data));
		}
		var infoBoxTitle = '<h4 style="margin: 0px 0px 5px 0px;">' + l + ' Overlapping Listings:</h4>';
		var op = [
			'<div style="padding:0px 0px 10px 10px;">',
				infoBoxTitle,
				'<div style="width:100%; overflow-x: auto; overflow-y: auto; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd;">',
					listingInfo.join('<hr style="border-width: 0px; border-top:1px solid #ddd"/>'),
				'</div>',
			'</div>'
		];
		return op.join('');
	},

	getPopupForm: function (id, data) {
	    var lsc = (data.lsc || '').toLowerCase();
	    var price = formatMoney((lsc == 'cl') ? data.sp_dol : ((data.lsc == 're') ? data.rp_dol : data.lp_dol), 0, '.', ',');
	    var br = data.br;
	    var bth = data.bth;
	    var style = data.style;
	    var index = data.index;
	    var pinCssClass = data.pinCssClass;


	    var mapStyle = style + (br ? ', ' + br + ' Beds' : '') + (bth ? ', ' + bth + ' Baths' : '');

	    return [
			'<div class="pop-up-form">',
				'<div class="infobox-pushpin map-pushpin map-pushpin ' + pinCssClass + '"><div class="text">' + index + '</div></div>',
				'<div>',
					'<img src="' + window.rootUrl + 'photos/FULL/1/' + id.substring(id.length - 3) + '/' + (id || '').replace('*', 'P') + '.jpg" onerror="this.src=window.rootUrl+\'Images/PhotoNotAvailable.png\';" width="165" height="110" />',
				'</div>',
				'<div>',
					'<label>ML#:</label> <a href="#' + id + '">' + id + '</a>',
				'</div>',
				'<div>' + price + '</div><div>' + data.addr + '</div><div>' + data.town + ', ' + (data.ste || 'NY') + ' ' + data.zip + '</div><div>' + mapStyle + '</div>',
				'<br /><a href="#' + id + '">Detail View</a>',
			'</div><hr class="clearfix" />'
	    ].join('');
	}
});
SDS.Web.Pages.Public.Link.Config.register(new SDS.Web.Pages.Public.Link.MLSLIConfig());

SDS.Web.Pages.Public.Link.TREBConfig = SDS.Web.Pages.Public.Link.Config.extend({

	/**
	* Calls this.base with appName and name
	* @method
	**/
	constructor: function () {
		this.base({ appName: "TREB", name: "Toronto Real Estate Board" });
	},

	/**
	* Returns whether or not to display units select
	* 
	* @return boolean
	**/
	showUnitsSelect: function () {
		return true;
	},

	getPopupForms: function (pin) {
		var listingInfo = [];
		for (var i = 0, l = pin.data.length; i < l; i++) {
			var $r = pin.data[i].$o;
			var data = $r.data('pop-up');
			data.index = pin.data[i].index;
			var id = $r.data('identifier') + '';
			listingInfo.push(this.getPopupForm(id, data));
		}
		var op = [
			'<div style="padding:0px 0px 10px 10px;">',
				'<div style="width:100%; overflow-x: auto; overflow-y: auto; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd;">',
					listingInfo.join('<hr style="border-width: 0px; border-top:1px solid #ddd"/>'),
				'</div>',
			'</div>'
		];
		return op.join('');
	},
	getPopupForm: function (id, data) {
	    var l = (data['class'] || '').toLowerCase();

	    if (l == 'com') {
	        return '<div class="pop-up-form"><div><img src="' + window.rootUrl + 'photos/FULL/1/' + id.substring(id.length - 3) + '/' + id + '.jpg" onerror="this.src=window.rootUrl+\'Images/PhotoNotAvailable.png\';" width="165" height="110" /></div><div>' + formatMoney(data.lp_dol, 2, '.', ',') + ' ' + data.lp_code + '</div><div><label>MLS#:</label><a href="#' + id + '">' + id + '</a></div><div>' + data.type_own1_out + '</div><div>' + data.tot_area + ' ' + data.tot_areacd + '</div><div>' + data.addr + ' ' + data.apt_num + '</div><div>' + data.municipality + ' ' + (data.province || 'ON') + ' ' + data.zip + '</div><br /><a href="#' + id + '">Property Detail</a></div><hr class="clearfix" />';
	    } else {
	        var br = data.br;
	        var bth = data.bath_tot;
	        var style = data.style;
	        var index = data.index;
	        var pinCssClass = data.pinCssClass;

	        var mapStyle = (br ? br + ' Br ' : '') + (bth ? bth + ' Wr ' : '') + style;

	        return [
				'<div class="pop-up-form">',
					'<div class="infobox-pushpin map-pushpin map-pushpin ' + pinCssClass + '"><div class="text">' + index + '</div></div>',
					'<div>',
						'<img src="' + window.rootUrl + 'photos/FULL/1/' + id.substring(id.length - 3) + '/' + id + '.jpg" onerror="this.src=window.rootUrl+\'Images/PhotoNotAvailable.png\';" width="165" height="110" />',
					'</div><div>',
						formatMoney(data.lp_dol, 2, '.', ','),
					'</div><div>',
						'<label>MLS#:</label><a href="#' + id + '">' + id + '</a>',
					'</div><div>',
						mapStyle,
					'</div><div>',
						'<label>LSC:</label>' + data.lsc,
					'</div><div>',
						data.addr + ' ' + data.apt_num,
					'</div><div>',
						data.municipality + ' ' + (data.province || 'ON') + ' ' + data.zip,
					'</div><br />',
					'<a href="#' + id + '">Property Detail</a>',
				'</div><hr class="clearfix" />'
	        ].join('');
		}
	}
});
SDS.Web.Pages.Public.Link.Config.register(new SDS.Web.Pages.Public.Link.TREBConfig());